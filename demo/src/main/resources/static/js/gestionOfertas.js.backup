document.addEventListener('DOMContentLoaded', function () {
    // Variable global para almacenar ofertas cargadas
    let ofertas = [];
    
    // Referencias a elementos principales
    const btnShowForm = document.getElementById('btn-show-form');
    const formContainer = document.getElementById('form-container');
    const btnCloseForm = document.getElementById('btn-close-form');
    const btnCancelForm = document.getElementById('btn-cancel-form');
    const tipoOfertaSelect = document.getElementById('tipoOferta');
    const otorgaCertificadoCheckbox = document.getElementById('otorgaCertificado');
    const certificadoFields = document.getElementById('certificado-fields');

    // Elementos para upload de imagen
    const imagenInput = document.getElementById('imagen');
    const imagePreview = document.getElementById('image-preview');
    const uploadPlaceholder = document.querySelector('.upload-placeholder');

    // Elementos para horarios
    const btnAddHorario = document.getElementById('btn-add-horario');
    const horariosTableBody = document.querySelector('#horarios-table tbody');
    const diaSelect = document.getElementById('dia-semana');
    const horaDesdeInput = document.getElementById('hora-desde');
    const horaHastaInput = document.getElementById('hora-hasta');

    // Elementos para filtros
    const searchInput = document.getElementById('search-input');
    const filtroTipo = document.getElementById('filtro-tipo');
    const filtroModalidad = document.getElementById('filtro-modalidad');
    const filtroEstado = document.getElementById('filtro-estado');
    const filtroCertificado = document.getElementById('filtro-certificado');
    const filtroCostoMin = document.getElementById('filtro-costo-min');
    const filtroCostoMax = document.getElementById('filtro-costo-max');
    const btnApplyFilters = document.getElementById('btn-apply-filters');
    const btnClearFilters = document.getElementById('btn-clear-filters');

    // Elemento para categor√≠as
    const btnAsignarCategorias = document.getElementById('btn-asignar-categorias');

    // ========== MODAL DE CATEGOR√çAS ==========
    
    const categoriaModal = {
        element: document.getElementById('categoriaModal'),
        
        show() {
            if (this.element) {
                this.element.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                // Cargar categor√≠as cuando se abre el modal
                console.log('üìÇ Abriendo modal, cargando categor√≠as...');
                categoriaController.cargarCategorias();
            } else {
                console.error('Modal de categor√≠as no encontrado');
            }
        },
        
        hide() {
            if (this.element) {
                this.element.style.display = 'none';
                document.body.style.overflow = 'auto';
                categoriaController.cancelarEdicion();
            }
        }
    };

    const categoriaController = {
        isEditing: false,
        

        async cargarCategorias() {
            try {
                console.log('üì° Iniciando carga de categor√≠as...');
                this.mostrarLoading(true);
                
                const response = await fetch('/api/categorias', {
                    credentials: 'include'
                });
                
                console.log('üì® Respuesta de /api/categorias:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                const categorias = await response.json();
                console.log('‚úÖ Categor√≠as recibidas:', categorias);
                
                this.mostrarCategorias(categorias);
                
            } catch (error) {
                console.error('üí• Error cargando categor√≠as:', error);
                this.mostrarError('Error al cargar las categor√≠as: ' + error.message);
            } finally {
                this.mostrarLoading(false);
            }
        },

        mostrarCategorias(categorias) {
            console.log('üé® Mostrando categor√≠as en la tabla...');
            
            const tbody = document.getElementById('categoriasTableBody');
            const table = document.getElementById('categoriasTable');
            const loading = document.getElementById('categoriasLoading');
            const contador = document.getElementById('contadorCategorias');
            
            if (!tbody) {
                console.error('‚ùå No se encontr√≥ categoriasTableBody');
                return;
            }
            
            // Ocultar loading
            if (loading) {
                loading.style.display = 'none';
            }
            
            tbody.innerHTML = '';
            
            if (!categorias || categorias.length === 0) {
                console.log('üì≠ No hay categor√≠as para mostrar');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center text-muted">
                            <i class="fas fa-inbox"></i> No hay categor√≠as registradas
                        </td>
                    </tr>
                `;
            } else {
                console.log(`üìä Mostrando ${categorias.length} categor√≠as`);
                categorias.forEach((categoria) => {
                    const tr = document.createElement('tr');
                    // Escapar comillas para evitar errores
                    const nombreEscapado = (categoria.nombre || '').replace(/'/g, "\\'");
                    const descripcionEscapada = (categoria.descripcion || '').replace(/'/g, "\\'");
                    
                    tr.innerHTML = `
                        <td>
                            <strong>${categoria.nombre || 'Sin nombre'}</strong>
                        </td>
                        <td>${categoria.descripcion || 'Sin descripci√≥n'}</td>
                        <td class="text-center">
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-primary" 
                                        onclick="categoriaController.editarCategoria(${categoria.idCategoria}, '${nombreEscapado}', '${descripcionEscapada}')"
                                        title="Editar categor√≠a">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button type="button" class="btn btn-outline-danger" 
                                        onclick="categoriaController.eliminarCategoria(${categoria.idCategoria})"
                                        title="Eliminar categor√≠a">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
            
            if (contador) {
                contador.textContent = `Total: ${categorias ? categorias.length : 0} categor√≠as`;
            }
            
            if (table) {
                table.style.display = 'table';
                console.log('‚úÖ Tabla de categor√≠as mostrada');
            }
        },

        mostrarLoading(mostrar) {
            const loading = document.getElementById('categoriasLoading');
            const table = document.getElementById('categoriasTable');
            
            if (loading) {
                loading.style.display = mostrar ? 'block' : 'none';
            }
            if (table && !mostrar) {
                table.style.display = 'table';
            }
        },

        mostrarError(mensaje) {
            const errorDiv = document.getElementById('categoriasError');
            if (errorDiv) {
                errorDiv.textContent = mensaje;
                errorDiv.style.display = 'block';
                
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            }
        },

        mostrarAlerta(mensaje, tipo = 'success') {
            const alertDiv = document.getElementById('categoriaAlert');
            if (alertDiv) {
                const alertClass = tipo === 'success' ? 'alert-success' : 'alert-danger';
                const icon = tipo === 'success' ? 'check' : 'exclamation';
                
                alertDiv.innerHTML = `
                    <div class="alert ${alertClass}">
                        <i class="fas fa-${icon}-circle"></i>
                        ${mensaje}
                    </div>
                `;
                alertDiv.style.display = 'block';
                
                console.log(`üì¢ Alerta [${tipo}]: ${mensaje}`);
                
                // Auto-ocultar despu√©s de 5 segundos
                setTimeout(() => {
                    alertDiv.innerHTML = '';
                    alertDiv.style.display = 'none';
                }, 5000);
            } else {
                console.error('No se encontr√≥ el contenedor de alertas');
                // Fallback: usar alert nativo
                alert(mensaje);
            }
        },

        
        async guardarCategoria() {
            console.log('üíæ Guardando categor√≠a...');
            
            const nombre = document.getElementById('categoriaNombre').value.trim();
            const descripcion = document.getElementById('categoriaDescripcion').value.trim();
            const id = document.getElementById('categoriaId').value;
        
            if (!nombre || !descripcion) {
                alert('Por favor completa todos los campos');
                return;
            }
        
            try {
                const categoriaData = { nombre, descripcion };
                let url = '/api/categorias';
                let method = 'POST';
        
                // SI hay ID, es una edici√≥n
                if (id) {
                    url = `/api/categorias/${id}`;
                    method = 'PUT';
                    categoriaData.idCategoria = parseInt(id);
                    console.log('‚úèÔ∏è Editando categor√≠a existente ID:', id);
                } else {
                    console.log('üÜï Creando nueva categor√≠a');
                }
                
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                const response = await fetch(url, {
                    method: method,
                    headers: headers,
                    credentials: 'include',
                    body: JSON.stringify(categoriaData)
                });
        
                if (response.ok) {
                    const categoriaGuardada = await response.json();
                    
                    if (id) {
                        alert('‚úÖ Categor√≠a actualizada correctamente!');
                        console.log('‚úÖ Categor√≠a actualizada:', categoriaGuardada);
                    } else {
                        alert('‚úÖ Categor√≠a creada correctamente!');
                        console.log('‚úÖ Categor√≠a creada:', categoriaGuardada);
                    }
                    
                    // LIMPIAR FORMULARIO Y RESTABLECER BOT√ìN
                    this.cancelarEdicion();
                    
                    // Recargar la lista
                    this.cargarCategorias();
                } else {
                    throw new Error('Error del servidor: ' + response.status);
                }
        
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error: ' + error.message);
            }
        },

        editarCategoria(id, nombre, descripcion) {
            console.log('‚úèÔ∏è Iniciando edici√≥n de categor√≠a ID:', id);
            this.isEditing = true;
            
            // Establecer valores en el formulario
            document.getElementById('categoriaId').value = id;
            document.getElementById('categoriaNombre').value = nombre || '';
            document.getElementById('categoriaDescripcion').value = descripcion || '';
            
            // Cambiar texto del bot√≥n
            document.getElementById('btnGuardarText').textContent = 'Actualizar Categor√≠a';
            
            // Cambiar t√≠tulo de la secci√≥n
            const tituloSeccion = document.querySelector('.categoria-form-section h4');
            if (tituloSeccion) {
                tituloSeccion.innerHTML = '<i class="fas fa-edit"></i> Editando Categor√≠a';
            }
            
            // Hacer scroll al formulario para mejor UX
            document.querySelector('.categoria-form-section').scrollIntoView({ 
                behavior: 'smooth' 
            });
            
            console.log('üìù Formulario listo para edici√≥n');
        },

        cancelarEdicion() {
            console.log('‚Ü©Ô∏è Cancelando edici√≥n y limpiando formulario');
            this.isEditing = false;
            
            // Limpiar formulario
            document.getElementById('categoriaForm').reset();
            document.getElementById('categoriaId').value = '';
            
            // Restablecer texto del bot√≥n
            document.getElementById('btnGuardarText').textContent = 'Crear Categor√≠a';
            
            // Opcional: Restablecer el t√≠tulo de la secci√≥n
            const tituloSeccion = document.querySelector('.categoria-form-section h4');
            if (tituloSeccion) {
                tituloSeccion.innerHTML = '<i class="fas fa-plus"></i> Nueva Categor√≠a';
            }
        },

        async eliminarCategoria(id) {
            if (!confirm('¬øEst√°s seguro de que deseas eliminar esta categor√≠a?')) {
                return;
            }

            try {
                const response = await fetch(`/api/categorias/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]')?.content || ''
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `Error ${response.status}`);
                }

                this.mostrarAlerta('Categor√≠a eliminada correctamente');
                this.cargarCategorias();

            } catch (error) {
                console.error('Error eliminando categor√≠a:', error);
                this.mostrarError('Error al eliminar la categor√≠a: ' + error.message);
            }
        }
    };

    // Cerrar modal al hacer clic fuera
    document.addEventListener('click', (e) => {
        if (e.target === document.getElementById('categoriaModal')) {
            categoriaModal.hide();
        }
    });
    

    // Manejo del bot√≥n de asignar categor√≠as
    if (btnAsignarCategorias) {
        btnAsignarCategorias.addEventListener('click', function() {
            categoriaModal.show();
        });
    }

    // Inicializaci√≥n
    initializeFormHandlers();
    initializeImageUpload();
    initializeHorarios();
    initializeCertificado();
    initializeTipoOferta();
    initializeCategorias();
    initializeFilters();
    initializeTable();

    // Mostrar/ocultar formulario
    function initializeFormHandlers() {
        if (btnShowForm) {
            btnShowForm.addEventListener('click', function () {
                showForm();
            });
        }

        if (btnCloseForm) {
            btnCloseForm.addEventListener('click', function () {
                hideForm();
            });
        }

        if (btnCancelForm) {
            btnCancelForm.addEventListener('click', function () {
                hideForm();
            });
        }
    }

    function showForm() {
        formContainer.style.display = 'block';
        setTimeout(() => {
            formContainer.classList.add('show');
        }, 10);
    }

    function hideForm() {
        formContainer.classList.remove('show');
        setTimeout(() => {
            formContainer.style.display = 'none';
        }, 500);
        resetForm();
    }

    function resetForm() {
        document.getElementById('oferta-form').reset();
        hideAllTipoSpecificFields();
        resetImageUpload();
        clearHorariosTable();
        hideCertificadoFields();
        resetCategorias();
    }

    function resetCategorias() {
        if (window.resetCategorias) {
            window.resetCategorias();
        }
    }

    // Manejo del upload de imagen
    function initializeImageUpload() {
        if (imagenInput) {
            imagenInput.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    if (file.size > 5 * 1024 * 1024) { // 5MB
                        alert('El archivo es demasiado grande. El tama√±o m√°ximo es 5MB.');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        imagePreview.src = e.target.result;
                        imagePreview.style.display = 'block';
                        uploadPlaceholder.style.display = 'none';
                    }
                    reader.readAsDataURL(file);
                }
            });
        }
    }

    function resetImageUpload() {
        if (imagePreview && uploadPlaceholder) {
            imagePreview.style.display = 'none';
            uploadPlaceholder.style.display = 'flex';
            imagePreview.src = '';
        }
    }

    // Manejo de campos espec√≠ficos por tipo de oferta
    function initializeTipoOferta() {
        if (tipoOfertaSelect) {
            tipoOfertaSelect.addEventListener('change', function () {
                const selectedType = this.value;
                hideAllTipoSpecificFields();
                showCostFields(selectedType);
                showTipoSpecificFields(selectedType);
            });
        }
    }

    function hideAllTipoSpecificFields() {
        const tipoSpecificSections = document.querySelectorAll('.tipo-specific');
        tipoSpecificSections.forEach(section => {
            section.style.display = 'none';
        });

        // Ocultar campos de costo espec√≠ficos
        hideCostFields();
    }

    function showTipoSpecificFields(tipo) {
        const fieldsMap = {
            'CURSO': '#fields-curso',
            'FORMACION': '#fields-formacion',
            'CHARLA': '#fields-charla',
            'SEMINARIO': '#fields-seminario'
        };

        const sectionId = fieldsMap[tipo];
        if (sectionId) {
            const section = document.querySelector(sectionId);
            if (section) {
                section.style.display = 'block';
            }
        }
    }

    function showCostFields(tipo) {
        const costFields = ['grupo-costo-cuota', 'grupo-nro-cuotas', 'grupo-costo-mora', 'grupo-dia-vencimiento'];
        
        if (tipo === 'CURSO' || tipo === 'FORMACION') {
            costFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) field.style.display = 'block';
            });
        }
    }

    function hideCostFields() {
        const costFields = ['grupo-costo-cuota', 'grupo-nro-cuotas', 'grupo-costo-mora', 'grupo-dia-vencimiento'];
        costFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) field.style.display = 'none';
        });
    }

    // Manejo de certificaci√≥n
    function initializeCertificado() {
        if (otorgaCertificadoCheckbox) {
            otorgaCertificadoCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    showCertificadoFields();
                } else {
                    hideCertificadoFields();
                }
            });
        }
    }

    function showCertificadoFields() {
        if (certificadoFields) {
            certificadoFields.style.display = 'block';
        }
    }

    function hideCertificadoFields() {
        if (certificadoFields) {
            certificadoFields.style.display = 'none';
        }
    }

    // Manejo de categor√≠as con combobox
    function initializeCategorias() {
        const categoriaSelect = document.getElementById('categoria-select');
        const selectedCategoriesContainer = document.getElementById('selected-categories');
        const selectedChipsContainer = document.getElementById('selected-chips');
        let selectedCategories = [];

        // Mapeo de iconos para cada categor√≠a
        const categoryIcons = {
            programacion: 'fas fa-code',
            diseno: 'fas fa-palette',
            marketing: 'fas fa-chart-line',
            administracion: 'fas fa-briefcase',
            idiomas: 'fas fa-language',
            oficios: 'fas fa-tools',
            salud: 'fas fa-heartbeat',
            tecnologia: 'fas fa-microchip',
            finanzas: 'fas fa-dollar-sign',
            educacion: 'fas fa-graduation-cap',
            arte: 'fas fa-paint-brush',
            gastronomia: 'fas fa-utensils'
        };

        if (categoriaSelect) {
            categoriaSelect.addEventListener('change', function() {
                const selectedValue = this.value;
                const selectedText = this.options[this.selectedIndex].text;
                
                if (selectedValue && !selectedCategories.some(cat => cat.value === selectedValue)) {
                    selectedCategories.push({
                        value: selectedValue,
                        text: selectedText,
                        icon: categoryIcons[selectedValue] || 'fas fa-tag'
                    });
                    
                    updateSelectedCategories();
                    this.value = ''; // Resetear el select
                }
            });
        }

        function updateSelectedCategories() {
            if (selectedCategories.length > 0) {
                selectedCategoriesContainer.classList.add('show');
                selectedChipsContainer.innerHTML = selectedCategories.map(cat => `
                    <div class="category-chip" data-category="${cat.value}">
                        <i class="${cat.icon}"></i>
                        <span>${cat.text}</span>
                        <button type="button" class="chip-remove" onclick="removeCategory('${cat.value}')">
                            √ó
                        </button>
                    </div>
                `).join('');
            } else {
                selectedCategoriesContainer.classList.remove('show');
            }
        }

        // Funci√≥n global para remover categor√≠as
        window.removeCategory = function(value) {
            selectedCategories = selectedCategories.filter(cat => cat.value !== value);
            updateSelectedCategories();
        };

        // Funci√≥n para obtener las categor√≠as seleccionadas (para el formulario)
        window.getSelectedCategories = function() {
            return selectedCategories.map(cat => cat.value);
        };

        // Funci√≥n para resetear categor√≠as
        window.resetCategorias = function() {
            selectedCategories = [];
            selectedCategoriesContainer.classList.remove('show');
            selectedChipsContainer.innerHTML = '';
            if (categoriaSelect) {
                categoriaSelect.value = '';
            }
        };
    }

    // Manejo de horarios
    function initializeHorarios() {
        if (btnAddHorario) {
            btnAddHorario.addEventListener('click', function() {
                addHorario();
            });
        }

        if (horariosTableBody) {
            horariosTableBody.addEventListener('click', function(event) {
                if (event.target.closest('.btn-delete-horario')) {
                    event.target.closest('tr').remove();
                }
            });
        }
    }

    function addHorario() {
        const dia = diaSelect.value;
        const horaDesde = horaDesdeInput.value;
        const horaHasta = horaHastaInput.value;

        if (!dia || !horaDesde || !horaHasta) {
            alert('Por favor, complete todos los campos del horario.');
            return;
        }

        if (horaDesde >= horaHasta) {
            alert('La hora de inicio debe ser anterior a la hora de fin.');
            return;
        }

        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td>${dia}</td>
            <td>${horaDesde} - ${horaHasta}</td>
            <td class="actions">
                <button type="button" class="btn-icon btn-delete btn-delete-horario" title="Eliminar">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        horariosTableBody.appendChild(newRow);

        // Limpiar campos
        diaSelect.value = '';
        horaDesdeInput.value = '';
        horaHastaInput.value = '';
    }

    function clearHorariosTable() {
        if (horariosTableBody) {
            horariosTableBody.innerHTML = '';
        }
    }

    // B√∫squeda de docentes (simulada)
    function initializeDocenteSearch() {
        const docenteSearchInputs = document.querySelectorAll('[id^="docente-search"]');
        
        docenteSearchInputs.forEach(input => {
            let searchTimeout;
            
            input.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const query = this.value;
                const resultsContainer = this.nextElementSibling;

                if (query.length < 3) {
                    resultsContainer.style.display = 'none';
                    return;
                }

                searchTimeout = setTimeout(() => {
                    searchDocentes(query, resultsContainer);
                }, 300);
            });

            // Ocultar resultados al hacer clic fuera
            document.addEventListener('click', function(event) {
                if (!input.contains(event.target)) {
                    const resultsContainer = input.nextElementSibling;
                    if (resultsContainer) {
                        resultsContainer.style.display = 'none';
                    }
                }
            });
        });
    }

    function searchDocentes(query, resultsContainer) {
        // Simulaci√≥n de b√∫squeda de docentes
        const mockDocentes = [
            { id: 1, nombre: 'Juan P√©rez', especialidad: 'Programaci√≥n', dni: '12345678' },
            { id: 2, nombre: 'Mar√≠a Garc√≠a', especialidad: 'Dise√±o', dni: '87654321' },
            { id: 3, nombre: 'Carlos Rodr√≠guez', especialidad: 'Marketing', dni: '11223344' }
        ];

        const filteredDocentes = mockDocentes.filter(docente => 
            docente.nombre.toLowerCase().includes(query.toLowerCase()) ||
            docente.dni.includes(query)
        );

        resultsContainer.innerHTML = '';
        if (filteredDocentes.length > 0) {
            filteredDocentes.forEach(docente => {
                const resultDiv = document.createElement('div');
                resultDiv.textContent = `${docente.nombre} - ${docente.especialidad} (DNI: ${docente.dni})`;
                resultDiv.onclick = () => addDocente(docente, resultsContainer);
                resultsContainer.appendChild(resultDiv);
            });
            resultsContainer.style.display = 'block';
        } else {
            resultsContainer.style.display = 'none';
        }
    }

    function addDocente(docente, resultsContainer) {
        // L√≥gica para agregar docente a la tabla correspondiente
        console.log('Agregar docente:', docente);
        resultsContainer.style.display = 'none';
        
        // Limpiar input
        const input = resultsContainer.previousElementSibling;
        if (input) input.value = '';
    }

    // Filtros y b√∫squeda
    function initializeFilters() {
        if (searchInput) {
            let searchTimeout;
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    applyFilters();
                }, 300);
            });
        }

        if (btnApplyFilters) {
            btnApplyFilters.addEventListener('click', applyFilters);
        }

        if (btnClearFilters) {
            btnClearFilters.addEventListener('click', clearFilters);
        }
    }

    function applyFilters() {
        const filters = {
            search: searchInput ? searchInput.value.toLowerCase() : '',
            tipo: filtroTipo ? filtroTipo.value : '',
            modalidad: filtroModalidad ? filtroModalidad.value : '',
            estado: filtroEstado ? filtroEstado.value : '',
            certificado: filtroCertificado ? filtroCertificado.value : '',
            costoMin: filtroCostoMin ? parseFloat(filtroCostoMin.value) || 0 : 0,
            costoMax: filtroCostoMax ? parseFloat(filtroCostoMax.value) || Infinity : Infinity
        };

        // Aplicar filtros a la tabla
        filterTable(filters);
    }

    function clearFilters() {
        if (searchInput) searchInput.value = '';
        if (filtroTipo) filtroTipo.value = '';
        if (filtroModalidad) filtroModalidad.value = '';
        if (filtroEstado) filtroEstado.value = '';
        if (filtroCertificado) filtroCertificado.value = '';
        if (filtroCostoMin) filtroCostoMin.value = '';
        if (filtroCostoMax) filtroCostoMax.value = '';
        
        // Mostrar todas las filas
        const table = document.getElementById('ofertas-table');
        if (table) {
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                row.style.display = '';
            });
            updateTableStats(rows.length);
        }
    }

    function filterTable(filters) {
        const table = document.getElementById('ofertas-table');
        if (!table) return;

        const rows = table.querySelectorAll('tbody tr');
        let visibleCount = 0;

        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length === 0) return;

            const nombre = cells[1].textContent.toLowerCase();
            const tipo = cells[2].textContent.trim();
            const modalidad = cells[3].textContent.trim();
            const costo = parseFloat(cells[6].textContent.replace(/[^0-9.]/g, '')) || 0;
            
            let visible = true;

            // Aplicar filtros
            if (filters.search && !nombre.includes(filters.search)) {
                visible = false;
            }
            if (filters.tipo && !tipo.includes(filters.tipo)) {
                visible = false;
            }
            if (filters.modalidad && !modalidad.includes(filters.modalidad)) {
                visible = false;
            }
            if (costo < filters.costoMin || costo > filters.costoMax) {
                visible = false;
            }

            row.style.display = visible ? '' : 'none';
            if (visible) visibleCount++;
        });

        updateTableStats(visibleCount);
    }

    function updateTableStats(count) {
        const totalElement = document.getElementById('total-ofertas');
        if (totalElement) {
            totalElement.textContent = count;
        }
    }

    // Inicializar tabla
    function initializeTable() {
        const table = document.getElementById('ofertas-table');
        if (table) {
            // Agregar eventos para botones de acci√≥n
            table.addEventListener('click', function(event) {
                const target = event.target.closest('.btn-icon');
                if (!target) return;

                const row = target.closest('tr');
                const id = row.cells[0].textContent;
                const nombre = row.cells[1].textContent;

                if (target.classList.contains('btn-edit')) {
                    editOferta(id, nombre);
                } else if (target.classList.contains('btn-view')) {
                    viewOferta(id, nombre);
                } else if (target.classList.contains('btn-delete')) {
                    deleteOferta(id, nombre);
                }
            });
        }
    }

    function editOferta(id, nombre) {
        console.log(`Editar oferta ${id}: ${nombre}`);
        // Implementar l√≥gica de edici√≥n
    }

    function viewOferta(id, nombre) {
        console.log(`Ver oferta ${id}: ${nombre}`);
        // Implementar l√≥gica de visualizaci√≥n
    }

    function deleteOferta(id, nombre) {
        if (confirm(`¬øEst√° seguro de que desea eliminar la oferta "${nombre}"?`)) {
            console.log(`Eliminar oferta ${id}: ${nombre}`);
            // Implementar l√≥gica de eliminaci√≥n
        }
    }

    // Validaci√≥n del formulario mejorada
    function validateForm() {
        const tipoOferta = document.getElementById('tipoOferta').value;
        const nombre = document.getElementById('nombre').value.trim();
        const fechaInicio = document.getElementById('fechaInicio').value;
        const fechaFin = document.getElementById('fechaFin').value;
        
        let isValid = true;
        let errors = [];
        
        // Validaciones b√°sicas
        if (!tipoOferta) {
            errors.push('Debe seleccionar un tipo de oferta');
            markFieldError('tipoOferta');
            isValid = false;
        }
        
        if (!nombre) {
            errors.push('El nombre es obligatorio');
            markFieldError('nombre');
            isValid = false;
        }
        
        if (!fechaInicio) {
            errors.push('La fecha de inicio es obligatoria');
            markFieldError('fechaInicio');
            isValid = false;
        }
        
        if (!fechaFin) {
            errors.push('La fecha de fin es obligatoria');
            markFieldError('fechaFin');
            isValid = false;
        }
        
        // Validar que fecha fin sea posterior a fecha inicio
        if (fechaInicio && fechaFin && new Date(fechaFin) <= new Date(fechaInicio)) {
            errors.push('La fecha de fin debe ser posterior a la fecha de inicio');
            markFieldError('fechaFin');
            isValid = false;
        }
        
        // Validaciones espec√≠ficas por tipo
        if (tipoOferta === 'CURSO') {
            const temario = document.getElementById('temario')?.value.trim();
            if (!temario) {
                errors.push('El temario del curso es obligatorio');
                markFieldError('temario');
                isValid = false;
            }
        }
        
        if (tipoOferta === 'FORMACION') {
            const plan = document.getElementById('planFormacion')?.value.trim();
            if (!plan) {
                errors.push('El plan de formaci√≥n es obligatorio');
                markFieldError('planFormacion');
                isValid = false;
            }
        }
        
        if (tipoOferta === 'CHARLA') {
            const lugar = document.getElementById('lugarCharla')?.value.trim();
            const enlace = document.getElementById('enlaceCharla')?.value.trim();
            if (!lugar && !enlace) {
                errors.push('Debe especificar el lugar (presencial) o enlace (virtual) para la charla');
                markFieldError('lugarCharla');
                markFieldError('enlaceCharla');
                isValid = false;
            }
        }
        
        if (tipoOferta === 'SEMINARIO') {
            const lugar = document.getElementById('lugarSeminario')?.value.trim();
            const enlace = document.getElementById('enlaceSeminario')?.value.trim();
            if (!lugar && !enlace) {
                errors.push('Debe especificar el lugar (presencial) o enlace (virtual) para el seminario');
                markFieldError('lugarSeminario');
                markFieldError('enlaceSeminario');
                isValid = false;
            }
        }
        
        // Mostrar errores si los hay
        if (!isValid) {
            showNotification('Errores en el formulario:\n‚Ä¢ ' + errors.join('\n‚Ä¢ '), 'error');
        }
        
        return isValid;
    }
    
    function markFieldError(fieldId) {
        const field = document.getElementById(fieldId);
        if (field) {
            field.style.borderColor = 'var(--danger-color)';
            field.addEventListener('input', function() {
                this.style.borderColor = '';
            }, { once: true });
        }
    }

    // Manejo del env√≠o del formulario
    const form = document.getElementById('oferta-form');
    if (form) {
        form.addEventListener('submit', function(event) {
            event.preventDefault(); // Evitar env√≠o normal del formulario
            
            if (!validateForm()) {
                showNotification('Por favor, complete todos los campos requeridos.', 'error');
                return;
            }

            // Enviar formulario via AJAX
            submitOfertaForm();
        });
    }
    
    // Funci√≥n para enviar el formulario via AJAX
    function submitOfertaForm() {
        const form = document.getElementById('oferta-form');
        const formData = new FormData(form);
        
        // Mostrar indicador de carga
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Registrando...';
        
        fetch('/admin/ofertas/registrar', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('‚úÖ Oferta registrada exitosamente', 'success');
                
                // Cerrar formulario y recargar tabla
                hideForm();
                loadOfertas();
                
                // Limpiar formulario
                form.reset();
                hideAllTipoSpecificFields();
                
                // Reset imagen
                if (imagePreview) {
                    imagePreview.style.display = 'none';
                    if (uploadPlaceholder) {
                        uploadPlaceholder.style.display = 'flex';
                    }
                }
                
            } else {
                showNotification(`‚ùå Error: ${data.message}`, 'error');
            }
        })
        .catch(error => {
            console.error('Error al enviar formulario:', error);
            showNotification('‚ùå Error de conexi√≥n al registrar la oferta', 'error');
        })
        .finally(() => {
            // Restaurar bot√≥n
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        });
    }

    // Funci√≥n para cargar ofertas en la tabla
    function loadOfertas() {
        console.log('üîÑ Cargando ofertas desde el servidor...');
        
        fetch('/admin/ofertas/listar')
        .then(response => {
            if (!response.ok) {
                throw new Error(`Error ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('üìä Datos recibidos:', data);
            
            // Manejar diferentes estructuras de respuesta
            if (Array.isArray(data)) {
                // Si la respuesta es directamente un array
                populateTable(data);
            } else if (data.data && Array.isArray(data.data)) {
                // Si la respuesta tiene estructura {data: [...]}
                populateTable(data.data);
            } else if (data.ofertas && Array.isArray(data.ofertas)) {
                // Si la respuesta tiene estructura {ofertas: [...]}
                populateTable(data.ofertas);
            } else if (data.success !== undefined) {
                // Si la respuesta tiene estructura {success: true, data: [...]}
                if (data.success && data.data) {
                    populateTable(data.data);
                } else {
                    throw new Error(data.message || 'Error en la respuesta del servidor');
                }
            } else {
                throw new Error('Formato de respuesta no reconocido');
            }
        })
        .catch(error => {
            console.error('Error cargando ofertas:', error);
            showNotification('Error al cargar ofertas: ' + error.message, 'error');
        });
    }

    // Funci√≥n para poblar la tabla con datos
    function populateTable(data) {
        console.log('üìã Poblando tabla con', data.length, 'ofertas');
        
        // Actualizar variable global
        ofertas = data;
        
        const tableBody = document.querySelector('#ofertas-table tbody');
        if (!tableBody) {
            console.error('No se encontr√≥ el tbody de la tabla');
            return;
        }

        // Limpiar tabla existente
        tableBody.innerHTML = '';

        if (ofertas.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="10" class="text-center">No hay ofertas registradas</td>
                </tr>
            `;
            updateTableStats(0);
            return;
        }

        // Crear filas para cada oferta (8 columnas: Nombre, Tipo, Modalidad, Cupos, Inicio, Fin, Estado, Acciones)
        ofertas.forEach(oferta => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${oferta.nombre || 'Sin nombre'}</td>
                <td><span class="status-badge status-${(oferta.tipo || 'curso').toLowerCase()}">${(oferta.tipo || 'CURSO').toUpperCase()}</span></td>
                <td><span class="status-badge status-${(oferta.modalidad || 'presencial').toLowerCase()}">${(oferta.modalidad || 'PRESENCIAL').toUpperCase()}</span></td>
                <td class="cupos ${oferta.cupos && oferta.cupos > 0 ? 'text-success fw-bold' : 'text-danger fw-bold'}">${oferta.cupos != null ? oferta.cupos : 'N/A'}</td>
                <td>${oferta.fechaInicio ? new Date(oferta.fechaInicio).toLocaleDateString() : 'N/A'}</td>
                <td>${oferta.fechaFin ? new Date(oferta.fechaFin).toLocaleDateString() : 'N/A'}</td>
                <td><span class="status-badge status-${(oferta.estado || 'activa').toLowerCase()}">${(oferta.estado || 'ACTIVA').toUpperCase()}</span></td>
                <td class="actions">
                    <button class="btn-icon btn-view" onclick="viewOferta(${oferta.idOferta}, '${oferta.nombre || ''}')" title="Ver">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn-icon btn-edit" onclick="editOferta(${oferta.idOferta}, '${oferta.nombre || ''}')" title="Editar">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn-icon btn-delete" onclick="deleteOferta(${oferta.idOferta}, '${oferta.nombre || ''}')" title="Eliminar">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            tableBody.appendChild(row);
        });

        updateTableStats(ofertas.length);
    }

    // Funci√≥n para mostrar notificaciones
    function showNotification(message, type) {
        // Crear elemento de notificaci√≥n
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
            <div class="notification-content">
                <span>${message}</span>
                <button class="notification-close">&times;</button>
            </div>
        `;
        
        // Agregar al DOM
        document.body.appendChild(notification);
        
        // Auto-remover despu√©s de 5 segundos
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 5000);
        
        // Permitir cerrar manualmente
        notification.querySelector('.notification-close').addEventListener('click', () => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        });
    }

    // Inicializar b√∫squeda de docentes despu√©s de que el DOM est√© listo
    setTimeout(initializeDocenteSearch, 100);

    // Cargar ofertas existentes al inicializar la p√°gina
    loadOfertas();

    // Mostrar formulario autom√°ticamente si estamos en modo edici√≥n
    const esEdicion = window.location.href.includes('/editar/') || document.querySelector('input[name="esEdicion"]');
    if (esEdicion && formContainer) {
        formContainer.style.display = 'block';
        document.getElementById('btn-show-form').style.display = 'none';
    }

    window.categoriaModal = categoriaModal;
    window.categoriaController = categoriaController;
    
    console.log('‚úÖ categor√≠aModal definido:', typeof categoriaModal);
    console.log('‚úÖ categor√≠aController definido:', typeof categoriaController);

    console.log('Gesti√≥n de Ofertas inicializada correctamente');

});

// =================== FUNCIONES PARA GESTI√ìN DE OFERTAS ===================

/**
 * Mostrar modal con detalles de la oferta
 */
function mostrarDetalleOferta(button) {
    try {
        // Obtener datos del bot√≥n
        const id = button.getAttribute('data-id');
        const nombre = button.getAttribute('data-nombre');
        const descripcion = button.getAttribute('data-descripcion');
        const tipo = button.getAttribute('data-tipo');
        const modalidad = button.getAttribute('data-modalidad');
        const cupos = button.getAttribute('data-cupos');
        const fechaInicio = button.getAttribute('data-fecha-inicio');
        const fechaFin = button.getAttribute('data-fecha-fin');
        const estado = button.getAttribute('data-estado');
        const costo = button.getAttribute('data-costo');
        const certificado = button.getAttribute('data-certificado');
        const objetivo = button.getAttribute('data-objetivo');
        const duracion = button.getAttribute('data-duracion');
        const categorias = button.getAttribute('data-categorias');

        // Llenar el modal con los datos
        document.getElementById('detalle-nombre').textContent = nombre || '-';
        document.getElementById('detalle-descripcion').textContent = descripcion || '-';
        
        // Configurar badges con clases apropiadas
        const tipoElement = document.getElementById('detalle-tipo');
        tipoElement.textContent = tipo || '-';
        tipoElement.className = 'status-badge status-' + (tipo ? tipo.toLowerCase() : '');
        
        const modalidadElement = document.getElementById('detalle-modalidad');
        modalidadElement.textContent = modalidad || '-';
        modalidadElement.className = 'status-badge status-' + (modalidad ? modalidad.toLowerCase() : '');
        
        const estadoElement = document.getElementById('detalle-estado');
        estadoElement.textContent = estado || '-';
        estadoElement.className = 'status-badge status-' + (estado ? estado.toLowerCase() : '');
        
        document.getElementById('detalle-cupos').textContent = cupos || '-';
        document.getElementById('detalle-fecha-inicio').textContent = fechaInicio || '-';
        document.getElementById('detalle-fecha-fin').textContent = fechaFin || '-';
        document.getElementById('detalle-costo').textContent = costo || '-';
        document.getElementById('detalle-certificado').textContent = certificado === 'true' ? 'S√≠' : 'No';
        document.getElementById('detalle-objetivo').textContent = objetivo || '-';
        document.getElementById('detalle-duracion').textContent = duracion || '-';
        document.getElementById('detalle-categorias').textContent = categorias || 'Sin categor√≠as';

        // Configurar bot√≥n de editar
        const btnEditar = document.getElementById('btn-editar-oferta');
        btnEditar.href = `/admin/ofertas/editar/${id}`;
        
        // Configurar bot√≥n de eliminar
        const btnEliminar = document.getElementById('btn-eliminar-oferta');
        btnEliminar.setAttribute('data-id', id);
        btnEliminar.setAttribute('data-nombre', nombre);

        // Mostrar el modal
        const modal = document.getElementById('detalleOfertaModal');
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
    } catch (error) {
        console.error('Error al mostrar detalles de la oferta:', error);
        mostrarNotificacion('Error al cargar los detalles de la oferta', 'error');
    }
}

/**
 * Cerrar modal de detalles
 */
function cerrarModalDetalle() {
    const modal = document.getElementById('detalleOfertaModal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
}

/**
 * Confirmar eliminaci√≥n de oferta
 */
function confirmarEliminacion(button) {
    const id = button.getAttribute('data-id');
    const nombre = button.getAttribute('data-nombre');
    
    // Configurar modal de confirmaci√≥n
    document.getElementById('nombre-oferta-eliminar').textContent = nombre;
    document.getElementById('btn-confirmar-eliminar').setAttribute('data-id', id);
    
    // Mostrar modal de confirmaci√≥n
    const modal = document.getElementById('confirmDeleteModal');
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

/**
 * Eliminar oferta desde el modal de detalles
 */
function eliminarOfertaDesdeModal() {
    const btnEliminar = document.getElementById('btn-eliminar-oferta');
    const id = btnEliminar.getAttribute('data-id');
    const nombre = btnEliminar.getAttribute('data-nombre');
    
    // Cerrar modal de detalles
    cerrarModalDetalle();
    
    // Configurar y mostrar modal de confirmaci√≥n
    document.getElementById('nombre-oferta-eliminar').textContent = nombre;
    document.getElementById('btn-confirmar-eliminar').setAttribute('data-id', id);
    
    const modal = document.getElementById('confirmDeleteModal');
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

/**
 * Cerrar modal de confirmaci√≥n
 */
function cerrarModalConfirmacion() {
    const modal = document.getElementById('confirmDeleteModal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
}

/**
 * Ejecutar eliminaci√≥n de la oferta
 */
function ejecutarEliminacion() {
    const btnConfirmar = document.getElementById('btn-confirmar-eliminar');
    const id = btnConfirmar.getAttribute('data-id');
    
    if (!id) {
        mostrarNotificacion('Error: ID de oferta no encontrado', 'error');
        return;
    }
    
    // Deshabilitar bot√≥n para evitar doble clic
    btnConfirmar.disabled = true;
    btnConfirmar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Eliminando...';
    
    // Realizar petici√≥n de eliminaci√≥n
    fetch(`/admin/ofertas/eliminar/${id}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            mostrarNotificacion('Oferta eliminada correctamente', 'success');
            // Cerrar modal
            cerrarModalConfirmacion();
            // Recargar la p√°gina para actualizar la tabla
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            mostrarNotificacion(data.message || 'Error al eliminar la oferta', 'error');
        }
    })
    .catch(error => {
        console.error('Error al eliminar oferta:', error);
        mostrarNotificacion('Error de conexi√≥n al eliminar la oferta', 'error');
    })
    .finally(() => {
        // Restaurar bot√≥n
        btnConfirmar.disabled = false;
        btnConfirmar.innerHTML = '<i class="fas fa-trash"></i> Eliminar';
    });
}

/**
 * Mostrar notificaci√≥n (reutiliza la funci√≥n existente si est√° disponible)
 */
function mostrarNotificacion(mensaje, tipo = 'info') {
    // Si existe la funci√≥n de notificaciones de categor√≠as, usarla
    if (typeof mostrarNotificacionCategoria === 'function') {
        mostrarNotificacionCategoria(mensaje, tipo);
        return;
    }
    
    // Fallback: mostrar alerta simple
    if (tipo === 'error') {
        alert('Error: ' + mensaje);
    } else {
        alert(mensaje);
    }
}

// Cerrar modales al hacer clic fuera de ellos
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal-overlay')) {
        if (e.target.id === 'detalleOfertaModal') {
            cerrarModalDetalle();
        } else if (e.target.id === 'confirmDeleteModal') {
            cerrarModalConfirmacion();
        }
    }
});

// Cerrar modales con la tecla Escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const modalDetalle = document.getElementById('detalleOfertaModal');
        const modalConfirm = document.getElementById('confirmDeleteModal');
        
        if (modalDetalle.style.display === 'flex') {
            cerrarModalDetalle();
        } else if (modalConfirm.style.display === 'flex') {
            cerrarModalConfirmacion();
        }
    }
});

// ================= FUNCIONES PARA ACCIONES DE TABLA =================

function verOferta(button) {
    const id = button.getAttribute('data-id');
    
    if (!id) {
        showNotification('‚ùå ID de oferta no v√°lido', 'error');
        return;
    }
    
    // Buscar la oferta en los datos cargados
    const oferta = ofertas.find(o => o.idOferta == id);
    
    if (oferta) {
        mostrarDetalleOferta(oferta);
    } else {
        // Si no est√° en memoria, cargar desde servidor
        fetch(`/admin/ofertas/${id}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarDetalleOferta(data.oferta);
                } else {
                    showNotification('‚ùå Error al cargar la oferta', 'error');
                }
            })
            .catch(error => {
                console.error('Error al cargar oferta:', error);
                showNotification('‚ùå Error de conexi√≥n', 'error');
            });
    }
}

function modificarOferta(button) {
    const id = button.getAttribute('data-id');
    
    if (!id) {
        showNotification('‚ùå ID de oferta no v√°lido', 'error');
        return;
    }
    
    // Cargar datos de la oferta para edici√≥n
    fetch(`/admin/ofertas/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                cargarOfertaEnFormulario(data.oferta);
                showForm(); // Mostrar formulario de edici√≥n
                
                // Scroll al formulario
                document.getElementById('form-container').scrollIntoView({ 
                    behavior: 'smooth' 
                });
                
                showNotification('üìù Oferta cargada para edici√≥n', 'info');
            } else {
                showNotification('‚ùå Error al cargar la oferta para edici√≥n', 'error');
            }
        })
        .catch(error => {
            console.error('Error al cargar oferta:', error);
            showNotification('‚ùå Error de conexi√≥n', 'error');
        });
}

function mostrarDetalleOferta(oferta) {
    // Aqu√≠ puedes mostrar un modal con los detalles
    // Por ahora, mostraremos la informaci√≥n en una notificaci√≥n ampliada
    const detalles = `
üìã DETALLES DE LA OFERTA

üè∑Ô∏è Nombre: ${oferta.nombre}
üìÖ Tipo: ${oferta.tipo || 'No especificado'}
üéØ Modalidad: ${oferta.modalidad || 'No especificada'}
üë• Cupos: ${oferta.cupos || 'Ilimitados'}
üí∞ Costo: ${oferta.costoInscripcion ? '$' + oferta.costoInscripcion : 'Gratis'}
üìÖ Inicio: ${oferta.fechaInicio || 'No definida'}
üìÖ Fin: ${oferta.fechaFin || 'No definida'}
üìä Estado: ${oferta.estado || 'No definido'}

üìù Descripci√≥n:
${oferta.descripcion || 'Sin descripci√≥n'}
    `;
    
    // Crear modal temporal o usar el existente
    alert(detalles); // Temporal, idealmente usar un modal
}

function cargarOfertaEnFormulario(oferta) {
    // Llenar campos b√°sicos
    document.getElementById('nombre').value = oferta.nombre || '';
    document.getElementById('descripcion').value = oferta.descripcion || '';
    document.getElementById('cupos').value = oferta.cupos || '';
    document.getElementById('costo').value = oferta.costoInscripcion || '';
    document.getElementById('fechaInicio').value = oferta.fechaInicio || '';
    document.getElementById('fechaFin').value = oferta.fechaFin || '';
    document.getElementById('modalidad').value = oferta.modalidad || '';
    
    // Determinar y configurar tipo
    const tipoOferta = determinarTipoOferta(oferta);
    document.getElementById('tipoOferta').value = tipoOferta;
    
    // Mostrar campos espec√≠ficos del tipo
    hideAllTipoSpecificFields();
    showTipoSpecificFields(tipoOferta);
    showCostFields(tipoOferta);
    
    // Llenar campos espec√≠ficos seg√∫n el tipo
    cargarCamposEspecificos(oferta, tipoOferta);
    
    // Marcar como edici√≥n
    const form = document.getElementById('oferta-form');
    const hiddenId = document.createElement('input');
    hiddenId.type = 'hidden';
    hiddenId.name = 'idOferta';
    hiddenId.value = oferta.idOferta;
    form.appendChild(hiddenId);
    
    // Cambiar t√≠tulo del formulario
    const formTitle = document.querySelector('.form-header h3');
    if (formTitle) {
        formTitle.innerHTML = '<i class="fas fa-edit"></i> Editar Oferta Acad√©mica';
    }
}

function determinarTipoOferta(oferta) {
    // L√≥gica para determinar el tipo basado en los campos presentes
    if (oferta.temario !== undefined) return 'CURSO';
    if (oferta.plan !== undefined) return 'FORMACION';
    if (oferta.disertantes !== undefined && oferta.duracionEstimada !== undefined) return 'CHARLA';
    if (oferta.disertantes !== undefined && oferta.duracionMinutos !== undefined) return 'SEMINARIO';
    
    return 'CURSO'; // Por defecto
}

function cargarCamposEspecificos(oferta, tipo) {
    switch (tipo) {
        case 'CURSO':
            if (document.getElementById('temario')) {
                document.getElementById('temario').value = oferta.temario || '';
            }
            if (document.getElementById('costoCuota')) {
                document.getElementById('costoCuota').value = oferta.costoCuota || '';
            }
            break;
            
        case 'FORMACION':
            if (document.getElementById('planFormacion')) {
                document.getElementById('planFormacion').value = oferta.plan || '';
            }
            break;
            
        case 'CHARLA':
            if (document.getElementById('lugarCharla')) {
                document.getElementById('lugarCharla').value = oferta.lugar || '';
            }
            if (document.getElementById('enlaceCharla')) {
                document.getElementById('enlaceCharla').value = oferta.enlace || '';
            }
            if (document.getElementById('duracionEstimada')) {
                document.getElementById('duracionEstimada').value = oferta.duracionEstimada || '';
            }
            if (oferta.disertantes && document.getElementById('disertantesCharla')) {
                document.getElementById('disertantesCharla').value = oferta.disertantes.join(', ');
            }
            break;
            
        case 'SEMINARIO':
            if (document.getElementById('lugarSeminario')) {
                document.getElementById('lugarSeminario').value = oferta.lugar || '';
            }
            if (document.getElementById('enlaceSeminario')) {
                document.getElementById('enlaceSeminario').value = oferta.enlace || '';
            }
            if (document.getElementById('duracionMinutos')) {
                document.getElementById('duracionMinutos').value = oferta.duracionMinutos || '';
            }
            if (oferta.disertantes && document.getElementById('disertantesSeminario')) {
                document.getElementById('disertantesSeminario').value = oferta.disertantes.join(', ');
            }
            break;
    }
}