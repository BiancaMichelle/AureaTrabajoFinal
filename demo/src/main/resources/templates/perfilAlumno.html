<!DOCTYPE html>
<html lang="es"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil de Usuario</title>
    <!-- Incluyendo Tailwind CSS para un diseño rápido y moderno -->
    <th:block th:if="${@environment.getProperty('app.useTailwindCdn','true') == 'true'}">
        <script src="https://cdn.tailwindcss.com"></script>
    </th:block>
    <!-- Incluyendo la fuente Inter de Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Estilos específicos para esta página -->
    <th:block layout:fragment="styles">
        <style>
            /* Aplicando la fuente Inter al cuerpo del documento */
            body {
                font-family: 'Inter', sans-serif;
            }
            /* Estilos para la navegación */
            .nav-link {
                display: flex;
                align-items: center;
                padding: 12px 16px;
                border-radius: 8px;
                font-weight: 500;
                transition: all 0.2s ease;
                cursor: pointer;
            }
            .nav-link.active {
                color: white;
                background-color: #1e293b;
                font-weight: 600;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            }
            .nav-link:not(.active) {
                color: #4b5563;
            }
            .nav-link:not(.active):hover {
                background-color: #f3f4f6;
            }

            /* ===== NOTIFICACIONES ESTILO GESTION OFERTAS ===== */
            .notification-area {
                position: fixed;
                top: 80px; /* Ajuste para no tapar el header si es sticky, o 20px si no */
                right: 20px;
                z-index: 10000;
                max-width: 400px;
                display: none;
            }

            .notification {
                min-width: 300px;
                max-width: 400px;
                background: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                border-left: 4px solid #10b981;
                transform: translateX(400px);
                opacity: 0;
                transition: all 0.3s ease;
                padding: 16px;
                display: flex;
                align-items: center;
                gap: 12px;
                margin-bottom: 10px;
            }

            .notification.show {
                transform: translateX(0);
                opacity: 1;
            }

            .notification-success {
                border-left-color: #10b981;
            }

            .notification-success .notification-icon {
                color: #10b981;
            }

            .notification-error {
                border-left-color: #ef4444;
            }

            .notification-error .notification-icon {
                color: #ef4444;
            }

            .notification-warning {
                border-left-color: #f59e0b;
            }

            .notification-warning .notification-icon {
                color: #f59e0b;
            }

            .notification-message {
                flex: 1;
                font-weight: 500;
                color: #374151;
                font-size: 0.95rem;
                line-height: 1.4;
            }

            .notification-close {
                background: none;
                border: none;
                padding: 4px;
                cursor: pointer;
                color: #9ca3af;
                transition: all 0.2s ease;
                border-radius: 4px;
            }

            .notification-close:hover {
                color: #374151;
                background-color: #f3f4f6;
            }

            .notification-icon {
                font-size: 1.5em;
            }
        </style>
    </th:block>
</head>

<body class="bg-gray-50 text-gray-800">

    <div layout:fragment="content">
        <!-- Area de Notificaciones Personalizada -->
        <div id="notification-area" class="notification-area">
            <div id="notification" class="notification">
                <i id="notification-icon" class="fas fa-check-circle notification-icon"></i>
                <span id="notification-message" class="notification-message">Mensaje de notificación</span>
                <button type="button" id="notification-close" class="notification-close" onclick="ocultarNotificacion()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <div class="container mx-auto p-4 md:p-8">
            <div class="flex flex-col md:flex-row bg-white rounded-xl shadow-sm border border-gray-200 min-h-[80vh]">
                
                <!-- Barra Lateral de Navegación -->
                <aside class="w-full md:w-1/4 lg:w-1/5 p-6 border-b md:border-b-0 md:border-r border-gray-200">
                    <div class="flex flex-col items-center text-center">
                        <!-- Foto de perfil con edición -->
                        <div class="relative w-28 h-28 mb-4">
                            <div class="w-full h-full rounded-full bg-slate-800 overflow-hidden border-2 border-transparent transition-all" id="profile-container">
                                <img id="profile-preview" th:src="${usuario.foto != null and !usuario.foto.isEmpty() ? usuario.foto : '/img/perfil-de-usuario.jpg'}" alt="Foto de perfil" class="w-full h-full object-cover">
                            </div>
                            
                            <!-- Botón editar foto (vinculado al form principal) -->
                            <label for="foto-input" id="btn-change-photo" class="hidden absolute bottom-0 right-0 bg-white p-2 rounded-full shadow-md cursor-pointer hover:bg-gray-100 transition-colors border border-gray-200 z-10" title="Cambiar foto de perfil">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                <input type="file" id="foto-input" name="foto" form="perfil-form" class="hidden" accept="image/*" onchange="previewImage(this)">
                            </label>
                        </div>

                        <h2 class="text-xl font-bold text-gray-900" th:text="${usuario.nombre + ' ' + usuario.apellido}">Nombre Apellido</h2>
                        <p class="text-sm text-gray-500 mt-1" th:text="${usuario.dni}">DNI</p>
                    </div>
                    
                    <!-- Menú de navegación -->
                    <nav class="mt-8">
                        <ul class="space-y-2">
                            <li>
                                <div class="nav-link active" data-section="perfil">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" /></svg>
                                    Perfil
                                </div>
                            </li>
                            <li>
                                <div class="nav-link" data-section="datos-academicos">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path d="M10.394 2.08a1 1 0 00-.788 0l-7 3.5a1 1 0 00.002 1.84L9 9.583V14.5a1 1 0 00.553.894l2 1a1 1 0 001.447-.894V9.583l6.293-3.146a1 1 0 00.002-1.84l-7-3.5zM6 6.38l4 2v3.74l-4-2V6.38zm8 0l-4 2v3.74l4-2V6.38z" /></svg>
                                    Datos académicos
                                </div>
                            </li>
                            <!-- Datos de pago eliminado -->
                            <li>
                                <div class="nav-link" data-section="seguridad">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 1.944A11.954 11.954 0 0122 13.954a11.954 11.954 0 01-22 0A11.954 11.954 0 0110 1.944zM10 4a9.954 9.954 0 00-9 10c0 4.418 3.582 8 8 8s8-3.582 8-8c0-5.523-4.477-10-10-10zm0 4a1 1 0 100 2 1 1 0 000-2zm0 3a1 1 0 011 1v5a1 1 0 11-2 0v-5a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                    Seguridad de la cuenta
                                </div>
                            </li>
                        </ul>
                    </nav>
                </aside>

                <!-- Contenido Principal -->
                <main class="w-full md:w-3/4 lg:w-4/5 p-6 md:p-10">
                    <form id="perfil-form" class="h-full" th:action="@{/alumno/perfil/actualizar}" method="post" enctype="multipart/form-data">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <input type="hidden" name="idUsuario" th:value="${usuario.id}" />

                        <!-- SECCIÓN PERFIL PÚBLICO -->
                        <div id="perfil" class="section-content">
                            <div class="border-b border-gray-200 pb-6 flex items-start justify-between">
                                <div>
                                    <h1 class="text-3xl font-bold text-gray-900">Perfil público</h1>
                                    <p class="mt-1 text-gray-500">Añade información sobre ti para que los demás puedan conocerte.</p>
                                </div>
                                <button type="button" id="btn-edit" class="btn-edit inline-flex items-center px-3 py-2 text-sm font-medium text-slate-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500" title="Editar">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/></svg>
                                    Editar
                                </button>
                            </div>

                            <!-- Campos de Perfil -->
                            <div class="mt-8 space-y-8">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label for="first-name" class="block text-sm font-medium text-gray-700">Nombre</label>
                                        <input type="text" id="first-name" name="nombre" th:value="${usuario.nombre}" 
                                               class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-slate-500 focus:border-slate-500 sm:text-sm" readonly required pattern="^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$" title="Solo letras y espacios">
                                    </div>
                                    <div>
                                        <label for="last-name" class="block text-sm font-medium text-gray-700">Apellidos</label>
                                        <input type="text" id="last-name" name="apellido" th:value="${usuario.apellido}" 
                                               class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-slate-500 focus:border-slate-500 sm:text-sm" readonly required pattern="^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$" title="Solo letras y espacios">
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Correo electrónico</label>
                                        <input type="email" name="correo" th:value="${usuario.correo}" 
                                               class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm sm:text-sm" readonly required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Teléfono</label>
                                        <input type="tel" name="numTelefono" th:value="${usuario.numTelefono}" 
                                               class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm sm:text-sm" readonly required pattern="^[\d\s\-\(\)\+]{10,}$" title="Debe tener al menos 10 dígitos">
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Fecha de Nacimiento</label>
                                        <input type="date" name="fechaNacimiento" th:value="${#temporals.format(usuario.fechaNacimiento, 'yyyy-MM-dd')}" 
                                               class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm sm:text-sm" readonly required>
                                    </div>
                                    </div>

                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">País</label>
                                        <input type="text" th:value="${usuario.pais?.nombre}" 
                                               class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm sm:text-sm" readonly>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Provincia</label>
                                        <input type="text" th:value="${usuario.provincia?.nombre}" 
                                               class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm sm:text-sm" readonly>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Ciudad</label>
                                        <input type="text" th:value="${usuario.ciudad?.nombre}" 
                                               class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm sm:text-sm" readonly>
                                    </div>
                                </div>

                                <div>
                                    <label for="headline" class="block text-sm font-medium text-gray-700">Titular</label>
                                    <input type="text" name="headline" id="headline" placeholder="Ej: Desarrollador Web Full Stack | Experto en React" 
                                           class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-slate-500 focus:border-slate-500 sm:text-sm">
                                    <p class="mt-2 text-xs text-gray-500">Aparecerá debajo de tu nombre en tu perfil.</p>
                                </div>

                                <div>
                                    <label for="biography" class="block text-sm font-medium text-gray-700">Biografía</label>
                                    <textarea id="biography" name="biography" rows="6" 
                                              class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-slate-500 focus:border-slate-500 sm:text-sm" 
                                              placeholder="Cuéntanos un poco sobre ti..."></textarea>
                                </div>

                                <div>
                                    <label for="website" class="block text-sm font-medium text-gray-700">Sitio web</label>
                                    <div class="mt-1 flex rounded-md shadow-sm">
                                        <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm">https://</span>
                                        <input type="text" name="website" id="website" 
                                               class="flex-1 min-w-0 block w-full px-3 py-2 rounded-none rounded-r-md focus:ring-slate-500 focus:border-slate-500 sm:text-sm border-gray-300">
                                    </div>
                                </div>
                                
                                <div class="pt-5 flex justify-end gap-3 actions-container">
                                    <button type="button" class="btn-cancel hidden inline-flex justify-center py-2 px-6 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-slate-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500">Cancelar</button>
                                    <button type="submit" class="btn-save hidden inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-slate-800 hover:bg-slate-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500">Guardar</button>
                                </div>
                            </div>
                        </div>

                        <!-- SECCIÓN DATOS ACADÉMICOS -->
                        <div id="datos-academicos" class="section-content hidden">
                            <div class="border-b border-gray-200 pb-6 flex items-start justify-between">
                                <div>
                                    <h1 class="text-3xl font-bold text-gray-900">Datos Académicos</h1>
                                    <p class="mt-1 text-gray-500">Información sobre tu formación académica.</p>
                                </div>
                                <button type="button" class="btn-edit inline-flex items-center px-3 py-2 text-sm font-medium text-slate-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500" title="Editar">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/></svg>
                                    Editar
                                </button>
                            </div>

                            <div class="mt-8 space-y-6">
                                <div th:if="${alumno != null}">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Últimos Estudios Alcanzados</label>
                                        <!-- Modo Visualización: Muestra el valor actual tal cual está en BD -->
                                        <input type="text" id="ultimosEstudiosDisplay" th:value="${alumno.ultimosEstudios}" 
                                               class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm sm:text-sm input-academic" readonly>
                                        
                                        <!-- Modo Edición: Select con opciones predefinidas -->
                                        <select id="ultimosEstudiosSelect" name="ultimosEstudios" 
                                                class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm sm:text-sm input-academic hidden" disabled>
                                            <option value="" disabled th:selected="${alumno.ultimosEstudios == null}">Seleccione nivel de estudios</option>
                                            <option value="Secundaria" th:selected="${alumno.ultimosEstudios == 'Secundaria'}">Secundaria</option>
                                            <option value="Terciario" th:selected="${alumno.ultimosEstudios == 'Terciario'}">Terciario</option>
                                            <option value="Universitario" th:selected="${alumno.ultimosEstudios == 'Universitario'}">Universitario</option>
                                            <option value="Posgrado" th:selected="${alumno.ultimosEstudios == 'Posgrado'}">Posgrado</option>
                                        </select>
                                    </div>

                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700">Colegio de Egreso</label>
                                        <input type="text" id="colegioEgreso" name="colegioEgreso" th:value="${alumno.colegioEgreso}" 
                                               class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm sm:text-sm input-academic" readonly>
                                    </div>

                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700">Año de Egreso</label>
                                        <input type="number" id="añoEgreso" name="añoEgreso" th:value="${alumno.añoEgreso}" 
                                               class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm sm:text-sm input-academic" readonly>
                                    </div>

                                    <div class="pt-5 flex justify-end gap-3 actions-container">
                                        <button type="button" class="btn-cancel hidden inline-flex justify-center py-2 px-6 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-slate-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500">Cancelar</button>
                                        <button type="submit" class="btn-save hidden inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-slate-800 hover:bg-slate-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500">Guardar</button>
                                    </div>
                                </div>
                                
                                <div th:unless="${alumno != null}" class="text-center py-8">
                                    <p class="text-gray-500">No hay datos académicos disponibles.</p>
                                </div>
                            </div>
                        </div>

                        <!-- SECCIÓN SEGURIDAD -->
                        <div id="seguridad" class="section-content hidden">
                        <div class="border-b border-gray-200 pb-6">
                            <h1 class="text-3xl font-bold text-gray-900">Seguridad de la Cuenta</h1>
                            <p class="mt-1 text-gray-500">Gestiona la seguridad de tu cuenta y contraseña.</p>
                        </div>

                        <div class="mt-8 space-y-6">
                            <!-- Cambio de Contraseña -->
                            <div class="bg-white border border-gray-200 rounded-lg p-6">
                                <h3 class="text-lg font-medium text-gray-900">Cambiar Contraseña</h3>
                                <p class="mt-1 text-sm text-gray-500">Actualiza tu contraseña regularmente para mantener tu cuenta segura.</p>
                                
                                <div class="mt-4 space-y-4">
                                    <div>
                                        <label for="current-password" class="block text-sm font-medium text-gray-700">Contraseña Actual</label>
                                        <input type="password" id="current-password" 
                                               class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-slate-500 focus:border-slate-500 sm:text-sm">
                                    </div>
                                    <div>
                                        <label for="new-password" class="block text-sm font-medium text-gray-700">Nueva Contraseña</label>
                                        <input type="password" id="new-password" 
                                               class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-slate-500 focus:border-slate-500 sm:text-sm">
                                        <div id="password-feedback" class="mt-2 text-xs text-gray-600 space-y-1">
                                            <div id="pwd-length" class="pwd-rule">● 8 caracteres mínimo</div>
                                            <div id="pwd-upper" class="pwd-rule">● 1 mayúscula</div>
                                            <div id="pwd-special" class="pwd-rule">● 1 carácter especial</div>
                                        </div>
                                    </div>
                                    <div>
                                        <label for="confirm-password" class="block text-sm font-medium text-gray-700">Confirmar Nueva Contraseña</label>
                                        <input type="password" id="confirm-password" 
                                               class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-slate-500 focus:border-slate-500 sm:text-sm">
                                        <small id="confirm-feedback" class="block mt-1 text-xs"></small>
                                    </div>
                                </div>
                                
                                <div class="mt-6">
                                    <div id="password-error" class="hidden rounded-md bg-red-50 p-4 mb-4">
                                        <div class="flex">
                                            <div class="flex-shrink-0">
                                                <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                                </svg>
                                            </div>
                                            <div class="ml-3">
                                                <h3 class="text-sm font-medium text-red-800" id="password-error-text">Error</h3>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="button" id="btn-update-password" class="inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-slate-800 hover:bg-slate-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500">
                                        Actualizar Contraseña
                                    </button>
                                </div>
                            </div>

                            <!-- Información de Seguridad -->
                            <div class="bg-white border border-gray-200 rounded-lg p-6">
                                <h3 class="text-lg font-medium text-gray-900">Información de Seguridad</h3>
                                <div class="mt-4 space-y-3">
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-700">Fecha de registro</span>
                                        <span class="text-sm font-medium text-gray-900" th:text="${#temporals.format(usuario.fechaRegistro, 'dd/MM/yyyy HH:mm')}"></span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-700">Estado de la cuenta</span>
                                        <span class="text-sm font-medium text-green-600" th:text="${usuario.estado}"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <!-- JavaScript para navegación entre secciones -->
        <script th:inline="javascript">
            // Funciones de Notificación Estilo Gestión Ofertas
            function mostrarNotificacion(mensaje, tipo = 'success') {
                const notificationArea = document.getElementById('notification-area');
                const notification = document.getElementById('notification');
                const notificationIcon = document.getElementById('notification-icon');
                const notificationMessage = document.getElementById('notification-message');
                
                if (!notificationArea || !notification || !notificationIcon || !notificationMessage) {
                    console.error('Elementos de notificación no encontrados en el DOM');
                    return;
                }

                // Configurar icono según tipo
                let iconClass = 'fas fa-check-circle notification-icon';
                if (tipo === 'error') {
                    iconClass = 'fas fa-exclamation-circle notification-icon';
                } else if (tipo === 'warning') {
                    iconClass = 'fas fa-exclamation-triangle notification-icon';
                }
                
                notificationIcon.className = iconClass;
                notificationMessage.textContent = mensaje;
                
                // Limpiar clases anteriores y agregar nueva
                notification.className = 'notification notification-' + tipo;
                
                // Mostrar notificación
                notificationArea.style.display = 'block';
                
                // Pequeño delay para permitir que el display:block se aplique antes de la transición
                setTimeout(() => {
                    notification.classList.add('show');
                }, 10);
                
                // Auto-ocultar después de 5 segundos
                setTimeout(() => {
                    ocultarNotificacion();
                }, 5000);
            }

            function ocultarNotificacion() {
                const notificationArea = document.getElementById('notification-area');
                const notification = document.getElementById('notification');
                
                if (notification) {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notificationArea) {
                            notificationArea.style.display = 'none';
                        }
                    }, 300); // Esperar a que termine la transición
                }
            }

            window.ocultarNotificacion = ocultarNotificacion; // Hacerla global para el onclick

            document.addEventListener('DOMContentLoaded', function() {
                // Notificaciones Iniciales (desde Flash Attributes)
                const mensaje = /*[[${mensaje}]]*/ null;
                const tipo = /*[[${tipo}]]*/ null;

                if (mensaje) {
                    // Usar la nueva función de notificación
                    mostrarNotificacion(mensaje, tipo || 'success');
                }

                // Obtener tab activa de la URL
                const urlParams = new URLSearchParams(window.location.search);
                const activeTab = urlParams.get('tab') || 'perfil';

                // Mostrar la sección correspondiente
                showSection(activeTab);

                // Marcar el link activo inicialmente
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                    if(link.getAttribute('data-section') === activeTab) {
                        link.classList.add('active');
                    }
                });

                // Manejar clics en el menú lateral
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        const sectionId = this.getAttribute('data-section');
                        showSection(sectionId);
                        
                        // Actualizar URL sin recargar (opcional, para UX)
                        const newUrl = new URL(window.location);
                        newUrl.searchParams.set('tab', sectionId);
                        window.history.pushState({}, '', newUrl);
                        
                        // Actualizar clase activa en el menú
                        document.querySelectorAll('.nav-link').forEach(item => {
                            item.classList.remove('active');
                        });
                        this.classList.add('active');
                    });
                });
                
                function showSection(sectionId) {
                    // Ocultar todas las secciones
                    document.querySelectorAll('.section-content').forEach(section => {
                        section.classList.add('hidden');
                    });
                    
                    // Mostrar la sección seleccionada
                    const targetSection = document.getElementById(sectionId);
                    if (targetSection) {
                        targetSection.classList.remove('hidden');
                    }
                }

                // Configurar date max (16 años)
                const fechaInput = document.querySelector('input[name="fechaNacimiento"]');
                if (fechaInput) {
                    const hoy = new Date();
                    const hace16 = new Date(hoy.getFullYear() - 16, hoy.getMonth(), hoy.getDate());
                    const maxDate = hace16.toISOString().split('T')[0];
                    fechaInput.setAttribute('max', maxDate);
                }

                // Toggle edición UNIFICADO
                const form = document.getElementById('perfil-form');
                
                // Función global para previsualizar
                window.previewImage = function(input) {
                    if (input.files && input.files[0]) {
                        var reader = new FileReader();
                        reader.onload = function(e) {
                            document.getElementById('profile-preview').src = e.target.result;
                        }
                        reader.readAsDataURL(input.files[0]);
                    }
                };
                
                // Seleccionar todos los botones por clase
                const editBtns = document.querySelectorAll('.btn-edit');
                const saveBtns = document.querySelectorAll('.btn-save');
                const cancelBtns = document.querySelectorAll('.btn-cancel');

                // Campos editables (Perfil + Académico)
                const editableFields = [
                    document.getElementById('first-name'),
                    document.getElementById('last-name'),
                    form ? form.querySelector('input[name="correo"]') : null,
                    form ? form.querySelector('input[name="numTelefono"]') : null,
                    form ? form.querySelector('input[name="fechaNacimiento"]') : null,
                    // Nuevos campos académicos
                    // document.getElementById('ultimosEstudios'), // Reemplazado por lógica especial
                    document.getElementById('colegioEgreso'),
                    document.getElementById('añoEgreso')
                ];

                let initialValues = {};

                function setEditMode(editing) {
                    // Toggle boton foto
                    const btnChangePhoto = document.getElementById('btn-change-photo');
                    if(btnChangePhoto) btnChangePhoto.classList.toggle('hidden', !editing);

                    // Lógica especial para Últimos Estudios (Input vs Select)
                    const estudiosDisplay = document.getElementById('ultimosEstudiosDisplay');
                    const estudiosSelect = document.getElementById('ultimosEstudiosSelect');
                    
                    if (estudiosDisplay && estudiosSelect) {
                        if (editing) {
                            estudiosDisplay.classList.add('hidden');
                            estudiosSelect.classList.remove('hidden');
                            estudiosSelect.disabled = false;
                            
                            // Intentar pre-seleccionar si el texto coincide
                            const currentVal = estudiosDisplay.value;
                            if (currentVal) {
                                Array.from(estudiosSelect.options).forEach(opt => {
                                    if (opt.value.toLowerCase() === currentVal.toLowerCase()) {
                                        estudiosSelect.value = opt.value;
                                    }
                                });
                            }
                        } else {
                            estudiosDisplay.classList.remove('hidden');
                            estudiosSelect.classList.add('hidden');
                            estudiosSelect.disabled = true;
                        }
                    }

                    editableFields.forEach(el => {
                        if (!el) return;
                        if (el.tagName === 'SELECT') {
                            el.disabled = !editing;
                        } else {
                            el.readOnly = !editing;
                        }
                        el.classList.toggle('bg-white', editing);
                        el.classList.toggle('bg-gray-50', !editing);
                        
                        // Feedback visual opcional
                        if(editing && !el.readOnly && !el.disabled) {
                            el.classList.add('ring-2', 'ring-slate-100');
                        } else {
                            el.classList.remove('ring-2', 'ring-slate-100');
                        }
                    });
                    
                    // Toggle botones en todas las secciones
                    saveBtns.forEach(btn => btn.classList.toggle('hidden', !editing));
                    cancelBtns.forEach(btn => btn.classList.toggle('hidden', !editing));
                    editBtns.forEach(btn => btn.classList.toggle('hidden', editing));
                }

                function captureInitialValues() {
                    initialValues = {};
                    editableFields.forEach(el => {
                        if (!el) return;
                        const key = el.name || el.id;
                        initialValues[key] = el.value;
                    });
                }

                // Asignar eventos a todos los botones de editar
                editBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        captureInitialValues();
                        setEditMode(true);
                    });
                });

                // Asignar eventos a todos los botones de cancelar
                cancelBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        // Restaurar valores iniciales
                        editableFields.forEach(el => {
                            if (!el) return;
                            const key = el.name || el.id;
                            if (initialValues[key] !== undefined) {
                                el.value = initialValues[key];
                            }
                        });
                        setEditMode(false);
                    });
                });

                // Envío normal del formulario
                if (form) {
                    form.addEventListener('submit', function(e) {
                        // Permitir submit
                    });
                }
                
                // --- Lógica de Seguridad (Cambio de Contraseña) ---
                // --- Lógica de Seguridad (Cambio de Contraseña) ---
                const btnUpdatePass = document.getElementById('btn-update-password');
                const pwdCurrent = document.getElementById('current-password');
                const pwdNew = document.getElementById('new-password');
                const pwdConfirm = document.getElementById('confirm-password');
                const ruleLength = document.getElementById('pwd-length');
                const ruleUpper = document.getElementById('pwd-upper');
                const ruleSpecial = document.getElementById('pwd-special');
                const confirmFeedback = document.getElementById('confirm-feedback');

                function setRuleState(el, ok) {
                    if (!el) return;
                    el.style.color = ok ? '#15803d' : '#ef4444';
                    el.style.fontWeight = ok ? '600' : '400';
                }

                function updatePasswordFeedbackPerfil() {
                    const val = pwdNew ? (pwdNew.value || '') : '';
                    const hasLength = val.length >= 8;
                    const hasUpper = /[A-Z]/.test(val);
                    const hasSpecial = /[^a-zA-Z0-9]/.test(val);

                    setRuleState(ruleLength, hasLength);
                    setRuleState(ruleUpper, hasUpper);
                    setRuleState(ruleSpecial, hasSpecial);

                    if (confirmFeedback && pwdConfirm) {
                        if (!pwdConfirm.value) {
                            confirmFeedback.textContent = '';
                        } else if (pwdConfirm.value === val) {
                            confirmFeedback.style.color = '#15803d';
                            confirmFeedback.textContent = 'Las contraseñas coinciden';
                        } else {
                            confirmFeedback.style.color = '#ef4444';
                            confirmFeedback.textContent = 'Las contraseñas no coinciden';
                        }
                    }
                }

                if (pwdNew) pwdNew.addEventListener('input', updatePasswordFeedbackPerfil);
                if (pwdConfirm) pwdConfirm.addEventListener('input', updatePasswordFeedbackPerfil);

                if (btnUpdatePass) {
                    btnUpdatePass.addEventListener('click', function() {
                        const currentPass = pwdCurrent ? pwdCurrent.value : '';
                        const newPass = pwdNew ? pwdNew.value : '';
                        const confirmPass = pwdConfirm ? pwdConfirm.value : '';
                        const errorDiv = document.getElementById('password-error');
                        const errorText = document.getElementById('password-error-text');
                        
                        // Reset error
                        if (errorDiv) errorDiv.classList.add('hidden');
                        
                        function showError(msg) {
                            if (errorText) errorText.textContent = msg;
                            if (errorDiv) errorDiv.classList.remove('hidden');
                        }
                        
                        // Validations
                        if (!currentPass || !newPass || !confirmPass) {
                            showError("Todos los campos son obligatorios");
                            return;
                        }
                        
                        if (newPass !== confirmPass) {
                            showError("Las contraseñas nuevas no coinciden");
                            return;
                        }
                        
                        const hasLength = newPass.length >= 8;
                        const hasUpper = /[A-Z]/.test(newPass);
                        const hasSpecial = /[^a-zA-Z0-9]/.test(newPass);
                        
                        if (!hasLength || !hasUpper || !hasSpecial) {
                            showError("La contraseña debe tener 8 caracteres, 1 mayúscula y 1 carácter especial");
                            return;
                        }
                        
                        // Create dynamic form to submit
                        const form = document.createElement('form');
                        form.method = 'POST';
                        form.action = '/alumno/perfil/seguridad/cambiar-password';
                        
                        // Add CSRF
                        const csrfToken = document.querySelector('input[name="_csrf"]');
                        if (csrfToken) {
                            const csrfInput = document.createElement('input');
                            csrfInput.type = 'hidden';
                            csrfInput.name = '_csrf';
                            csrfInput.value = csrfToken.value;
                            form.appendChild(csrfInput);
                        }
                        
                        // Add fields
                        const fields = {
                            passwordActual: currentPass,
                            passwordNueva: newPass
                        };
                        
                        for (const key in fields) {
                            const input = document.createElement('input');
                            input.type = 'hidden';
                            input.name = key;
                            input.value = fields[key];
                            form.appendChild(input);
                        }
                        
                        document.body.appendChild(form);
                        form.submit();
                    });
                }
            });
        </script>
    </div>
</body>
</html>