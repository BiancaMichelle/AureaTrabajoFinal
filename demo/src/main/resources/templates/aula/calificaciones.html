<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security" layout:decorate="~{layout/base}">
<head>
    <title>Calificaciones - Aula Virtual</title>
    <th:block th:if="${@environment.getProperty('app.useTailwindCdn','true') == 'true'}">
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            tailwind.config = {
                theme: {
                    extend: {
                        colors: {
                            customGrayLight: '#f8f9fa',
                            customGrayDark: '#343a40',
                            customGrayText: '#212529',
                            customBlue: '#007bff',
                            customGreen: '#28a745',
                        }
                    }
                }
            }
        </script>
    </th:block>
    <style>
        .nav-tab-active { border-bottom-color: white; color: white; font-weight: 600; }
        .nav-tab-inactive { border-bottom-width: 2px; border-color: transparent; color: #f3f4f6; }
        .nav-tab-inactive:hover { border-color: #d1d5db; color: white; }
    </style>
</head>

<body class="bg-customGrayLight font-sans text-customGrayText" layout:fragment="content">

    <!-- Header del Aula -->
    <header class="bg-customGrayDark text-white p-4 py-8 shadow-md relative z-10 w-full">
        <div class="max-w-7xl mx-auto flex justify-between items-center relative gap-4">
            <div>
                 <h1 class="text-3xl font-bold tracking-wider" th:text="${oferta.nombre}">Nombre Oferta</h1>
                 <p class="text-gray-300 text-sm mt-1" th:text="${oferta.descripcion}">Descripción</p>
            </div>
        </div>
    </header>

    <!-- Barra de Navegación -->
    <nav class="bg-customGreen border-b border-gray-200 shadow-sm relative z-10 mb-8 w-full sticky top-0">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center space-x-6">
                <!-- Ícono de búsqueda -->
                <div class="py-3 px-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>

                <a sec:authorize="hasAnyAuthority('DOCENTE', 'ADMIN')" th:href="@{/docente/aula/{id}(id=${oferta.idOferta})}" class="py-3 px-1 border-b-2 border-transparent text-gray-100 hover:border-gray-300 hover:text-white font-medium text-sm transition-colors duration-200 nav-tab-inactive">Contenido</a>
                <a sec:authorize="hasAuthority('ALUMNO') and !hasAnyAuthority('DOCENTE', 'ADMIN')" th:href="@{/alumno/aula/{id}(id=${oferta.idOferta})}" class="py-3 px-1 border-b-2 border-transparent text-gray-100 hover:border-gray-300 hover:text-white font-medium text-sm transition-colors duration-200 nav-tab-inactive">Contenido</a>
                
                <a sec:authorize="hasAnyAuthority('DOCENTE', 'ADMIN')" th:href="@{/aula/oferta/{id}/participantes(id=${oferta.idOferta})}" class="py-3 px-1 border-b-2 border-transparent text-gray-100 hover:border-gray-300 hover:text-white font-medium text-sm transition-colors duration-200 nav-tab-inactive">Participantes</a>

                <a th:href="@{/aula/oferta/{id}/asistencia(id=${oferta.idOferta})}" class="py-3 px-1 border-b-2 border-transparent text-gray-100 hover:border-gray-300 hover:text-white font-medium text-sm transition-colors duration-200 nav-tab-inactive">Asistencia</a>

                <a href="#" class="py-3 px-1 border-b-2 border-white text-white font-semibold text-sm nav-tab-active">Calificaciones</a>

                <a href="#" class="py-3 px-1 border-b-2 border-transparent text-gray-100 hover:border-gray-300 hover:text-white font-medium text-sm transition-colors duration-200 nav-tab-inactive">Calendario</a>
            </div>
        </div>
    </nav>

    <!-- Contenido Principal -->
    <main class="max-w-7xl mx-auto p-4 sm:px-6 lg:px-8">

        <!-- VISTA DOCENTE: TABLA GLOBAL -->
        <div sec:authorize="hasAnyAuthority('DOCENTE', 'ADMIN')" class="space-y-8">
            
            <!-- Tabla de Calificaciones -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center">
                    <h2 class="text-lg font-bold text-gray-800">Planilla de Calificaciones</h2>
                    <span class="text-sm text-gray-500">
                        <i class="fas fa-users mr-1"></i> <span th:text="${alumnos.size()}">0</span> alumnos
                    </span>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider sticky left-0 bg-gray-50 z-10 border-r">
                                    Alumno
                                </th>
                                <!-- Tareas Header -->
                                <th th:each="tarea : ${tareas}" scope="col" class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider min-w-[100px]">
                                    <div class="flex flex-col items-center">
                                        <i class="fas fa-file-alt text-blue-400 mb-1"></i>
                                        <span th:text="${tarea.titulo}" class="truncate max-w-[120px]" th:title="${tarea.titulo}">Tarea</span>
                                    </div>
                                </th>
                                <!-- Examenes Header -->
                                <th th:each="examen : ${examenes}" scope="col" class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider min-w-[100px]">
                                    <div class="flex flex-col items-center">
                                        <i class="fas fa-clipboard-check text-purple-400 mb-1"></i>
                                        <span th:text="${examen.titulo}" class="truncate max-w-[120px]" th:title="${examen.titulo}">Examen</span>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr th:each="alumno : ${alumnos}" class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap sticky left-0 bg-white z-10 border-r group-hover:bg-gray-50">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0 h-8 w-8">
                                            <div class="h-8 w-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-xs font-bold">
                                                <span th:text="${#strings.substring(alumno.nombre,0,1) + #strings.substring(alumno.apellido,0,1)}">AL</span>
                                            </div>
                                        </div>
                                        <div class="ml-3">
                                            <div class="text-sm font-medium text-gray-900" th:text="${alumno.apellido + ', ' + alumno.nombre}">Apellido, Nombre</div>
                                            <div class="text-xs text-gray-500" th:text="${alumno.dni}">DNI</div>
                                        </div>
                                    </div>
                                </td>
                                
                                <!-- Notas Tareas -->
                                <td th:each="tarea : ${tareas}" class="px-4 py-4 whitespace-nowrap text-center">
                                    <span th:if="${notasTareas.containsKey(alumno.id) and notasTareas.get(alumno.id).containsKey(tarea.idActividad)}"
                                          class="px-2 py-1 rounded-md text-sm font-bold bg-blue-50 text-blue-700">
                                        <span th:text="${notasTareas.get(alumno.id).get(tarea.idActividad)}"></span>
                                    </span>
                                    <span th:unless="${notasTareas.containsKey(alumno.id) and notasTareas.get(alumno.id).containsKey(tarea.idActividad)}"
                                          class="text-gray-300 text-xs">-</span>
                                </td>

                                <!-- Notas Examenes -->
                                <td th:each="examen : ${examenes}" class="px-4 py-4 whitespace-nowrap text-center">
                                    <span th:if="${notasExamenes.containsKey(alumno.id) and notasExamenes.get(alumno.id).containsKey(examen.idActividad)}"
                                          class="px-2 py-1 rounded-md text-sm font-bold bg-purple-50 text-purple-700">
                                        <span th:text="${#numbers.formatDecimal(notasExamenes.get(alumno.id).get(examen.idActividad), 1, 2)}"></span>
                                    </span>
                                    <span th:unless="${notasExamenes.containsKey(alumno.id) and notasExamenes.get(alumno.id).containsKey(examen.idActividad)}"
                                          class="text-gray-300 text-xs">-</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- SECCIÓN EXTRA: GESTIÓN DE CORRECCIÓN DE EXÁMENES -->
            <div class="pt-8 border-t border-gray-200">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-tasks text-customGreen mr-3"></i> Gestión de Correcciones
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div th:each="item : ${correccionExamenes}" class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-3 bg-purple-50 rounded-lg text-purple-600">
                                <i class="fas fa-clipboard-check text-xl"></i>
                            </div>
                            <span th:if="${item.pendientes > 0}" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-800 animate-pulse">
                                <span th:text="${item.pendientes}">0</span> pendientes
                            </span>
                            <span th:if="${item.pendientes == 0}" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                Al día
                            </span>
                        </div>
                        
                        <h3 class="text-lg font-bold text-gray-900 mb-1" th:text="${item.examen.titulo}">Título Examen</h3>
                        <p class="text-sm text-gray-500 mb-4" th:text="${#temporals.format(item.examen.fechaCierre, 'dd/MM/yyyy HH:mm')}">Cierre</p>
                        
                        <div class="flex items-center justify-between text-sm text-gray-500 mb-6 bg-gray-50 p-3 rounded-lg">
                            <div class="text-center">
                                <span class="block font-bold text-gray-800 text-lg" th:text="${item.total}">0</span>
                                <span class="text-xs">Intentos</span>
                            </div>
                            <div class="h-8 w-px bg-gray-300"></div>
                            <div class="text-center">
                                <span class="block font-bold text-green-600 text-lg" th:text="${item.finalizados}">0</span>
                                <span class="text-xs">Corregidos</span>
                            </div>
                        </div>
                        
                        <a th:href="@{/examen/{id}/intentos(id=${item.examen.idActividad})}" 
                           class="block w-full text-center px-4 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                            Ir a Corregir / Ver Notas
                        </a>
                    </div>
                    
                    <!-- Empty State for Correction -->
                    <div th:if="${correccionExamenes.empty}" class="col-span-full text-center py-10 bg-gray-50 rounded-xl border border-dashed border-gray-300">
                        <i class="fas fa-folder-open text-gray-400 text-4xl mb-3"></i>
                        <p class="text-gray-500">No hay exámenes registrados para corregir en este curso.</p>
                    </div>
                </div>
            </div>
            
        </div>

        <!-- VISTA ALUMNO (Simple) -->
        <div sec:authorize="!hasAnyAuthority('DOCENTE', 'ADMIN')" class="text-center py-20 bg-white rounded-lg border border-gray-200">
            <i class="fas fa-hard-hat text-yellow-500 text-5xl mb-4"></i>
            <h2 class="text-2xl font-bold text-gray-800">Sección en Construcción</h2>
            <p class="text-gray-600 mt-2">Pronto podrás consultar todas tus calificaciones aquí.</p>
            <a th:href="@{/alumno/aula/{id}(id=${oferta.idOferta})}" class="inline-block mt-6 text-blue-600 hover:underline">Volver al contenido</a>
        </div>

    </main>

</body>
</html>