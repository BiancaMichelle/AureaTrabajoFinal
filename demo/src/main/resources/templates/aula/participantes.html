<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" xmlns:sec="http://www.thymeleaf.org/extras/spring-security" layout:decorate="~{layout/base}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aula Virtual - Asistencia</title>
    <!-- CSRF Token -->
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />

    <!-- Tailwind CSS -->
    <th:block th:if="${@environment.getProperty('app.useTailwindCdn','true') == 'true'}">
        <script src="https://cdn.tailwindcss.com"></script>
    </th:block>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        customGrayLight: '#f8f9fa',
                        customGrayDark: '#343a40', 
                        customGrayText: '#212529',
                        customBlue: '#007bff',
                        customGreen: '#28a745'
                    }
                }
            }
        }
    </script>
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Animaciones suaves para el modal */
        .modal-enter {
            animation: modalFadeIn 0.3s ease-out forwards;
        }
        .modal-content-enter {
            animation: modalZoomIn 0.3s ease-out forwards;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes modalZoomIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Estilos base para estados */
        .btn-status.active {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-width: 2px;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen" layout:fragment="content">

    <!-- Header del Aula -->
    <header class="bg-customGrayDark text-white p-4 py-8 shadow-md relative z-10">
        <div class="max-w-7xl mx-auto flex justify-between items-center relative">
            <h1 class="text-3xl font-bold tracking-wider mx-auto" th:text="${oferta.nombre}">IMAGEN DEL CURSO</h1>
        </div>
    </header>

    <!-- Barra de Navegación -->
    <nav class="bg-customGreen border-b border-gray-200 shadow-sm relative z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center space-x-6">
                <!-- Ícono de búsqueda -->
                <div class="py-3 px-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
                
                <!-- 1. Contenido -->
                <a sec:authorize="hasAnyAuthority('DOCENTE', 'ADMIN')" 
                   th:href="@{/docente/aula/{id}(id=${oferta.idOferta})}" 
                   class="py-3 px-1 border-b-2 border-transparent text-gray-100 hover:border-gray-300 hover:text-white font-medium text-sm transition-colors duration-200 nav-tab-inactive">
                    Contenido
                </a>
                <a sec:authorize="hasAuthority('ALUMNO') and !hasAnyAuthority('DOCENTE', 'ADMIN')" 
                   th:href="@{/alumno/aula/{id}(id=${oferta.idOferta})}" 
                   class="py-3 px-1 border-b-2 border-transparent text-gray-100 hover:border-gray-300 hover:text-white font-medium text-sm transition-colors duration-200 nav-tab-inactive">
                    Contenido
                </a>
                
                <!-- 2. Participantes (Solo Docente/Admin) - ACTIVE -->
                <a sec:authorize="hasAnyAuthority('DOCENTE', 'ADMIN')"
                   href="#" 
                   class="py-3 px-1 border-b-2 border-white text-white font-semibold text-sm nav-tab-active">
                    Participantes
                </a>

                <!-- 3. Asistencia -->
                <a th:href="@{/aula/oferta/{id}/asistencia(id=${oferta.idOferta})}" 
                   class="py-3 px-1 border-b-2 border-transparent text-gray-100 hover:border-gray-300 hover:text-white font-medium text-sm transition-colors duration-200 nav-tab-inactive">
                    Asistencia
                </a>

                <!-- 4. Calificaciones -->
                <a th:href="@{/aula/oferta/{id}/calificaciones(id=${oferta.idOferta})}" 
                   class="py-3 px-1 border-b-2 border-transparent text-gray-100 hover:border-gray-300 hover:text-white font-medium text-sm transition-colors duration-200 nav-tab-inactive">
                    Calificaciones
                </a>

                <!-- 5. Calendario (removido) -->
            </div>
        </div>
    </nav>

    <!-- Contenido Principal -->
    <main class="max-w-7xl mx-auto p-8">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        
        <!-- Barra de herramientas -->
        <div class="p-4 border-b border-gray-100 flex flex-col sm:flex-row justify-between items-center gap-4">
            <h2 class="text-lg font-semibold text-gray-800" id="participants-count">Participantes (0)</h2>
            <div class="relative w-full sm:w-64">
                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                <input 
                    type="text" 
                    id="search-input"
                    placeholder="Buscar participante..." 
                    class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-400 transition-all text-sm"
                >
            </div>
        </div>

        <!-- Tabla -->
        <div class="overflow-x-auto">
            <table class="w-full text-left">
                <thead>
                    <tr class="bg-gray-50 border-b border-gray-100">
                        <th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">Usuario</th>
                        <th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">Rol</th>
                        <th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">Último Acceso</th>
                        <th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider text-right">Acciones</th>
                    </tr>
                </thead>
                <tbody id="users-table-body" class="divide-y divide-gray-100">
                    <!-- Las filas se generarán con JS -->
                </tbody>
            </table>
        </div>
        </div>
    </main>

    <!-- Modal de Asistencia -->
    <div id="attendance-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden modal-enter">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md overflow-hidden modal-content-enter transform transition-all">
            
            <!-- Header Modal -->
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h3 class="font-semibold text-gray-800">Registrar Asistencia</h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times-circle text-2xl"></i>
                </button>
            </div>

            <div class="p-6">
                <!-- Info Usuario en Modal -->
                <div class="flex items-center mb-6" id="modal-user-info">
                    <!-- Se llena con JS -->
                </div>

                <!-- Calendario -->
                <div class="mb-6">
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">
                        Seleccionar Fecha
                    </label>
                    <div class="bg-white rounded-lg border p-4 shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <button id="prev-month" class="p-1 hover:bg-gray-100 rounded-full w-8 h-8 flex items-center justify-center"><i class="fas fa-chevron-left"></i></button>
                            <span id="calendar-month-year" class="font-semibold text-gray-700"></span>
                            <button id="next-month" class="p-1 hover:bg-gray-100 rounded-full w-8 h-8 flex items-center justify-center"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <div class="grid grid-cols-7 gap-1 text-center text-sm mb-2 font-medium text-gray-400">
                            <span>D</span><span>L</span><span>M</span><span>M</span><span>J</span><span>V</span><span>S</span>
                        </div>
                        <div id="calendar-days" class="grid grid-cols-7 gap-1 text-center">
                            <!-- Días generados por JS -->
                        </div>
                    </div>
                </div>

                <!-- Selección de Clase -->
                <div id="class-selection" class="mb-6 hidden">
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">
                        Seleccionar Clase
                    </label>
                    <div id="class-options" class="space-y-2"></div>
                    <p id="class-selection-hint" class="text-xs text-gray-500 mt-2 hidden">
                        Seleccioná una clase para registrar la asistencia.
                    </p>
                </div>

                <!-- Acciones de Estado -->
                <div class="space-y-3">
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">
                        Estado para: <span id="selected-date-display" class="text-gray-900 font-bold"></span>
                    </label>
                    
                    <div class="grid grid-cols-3 gap-3">
                        <button onclick="setAttendanceStatus('present')" id="btn-present" class="btn-status flex flex-col items-center justify-center p-3 rounded-xl border border-gray-200 hover:bg-gray-50 text-gray-600 transition-all">
                            <i class="fas fa-check-circle mb-1 text-lg"></i>
                            <span class="text-sm font-medium">Presente</span>
                        </button>

                        <button onclick="setAttendanceStatus('late')" id="btn-late" class="btn-status flex flex-col items-center justify-center p-3 rounded-xl border border-gray-200 hover:bg-gray-50 text-gray-600 transition-all">
                            <i class="fas fa-clock mb-1 text-lg"></i>
                            <span class="text-sm font-medium">Tardanza</span>
                        </button>

                        <button onclick="setAttendanceStatus('absent')" id="btn-absent" class="btn-status flex flex-col items-center justify-center p-3 rounded-xl border border-gray-200 hover:bg-gray-50 text-gray-600 transition-all">
                            <i class="fas fa-exclamation-circle mb-1 text-lg"></i>
                            <span class="text-sm font-medium">Ausente</span>
                        </button>
                    </div>
                </div>

                <div id="feedback-msg" class="mt-4 text-center text-sm text-gray-500 hidden fade-in">
                    Estado actualizado correctamente.
                </div>

            </div>
            
            <div class="px-6 py-4 bg-gray-50 flex justify-end">
                <button id="close-modal-footer" class="bg-gray-800 text-white px-6 py-2 rounded-lg font-medium shadow-lg shadow-gray-200 hover:bg-gray-900 transition-all">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Calificaciones (Placeholder) -->
    <div id="grades-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden modal-enter">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl overflow-hidden modal-content-enter transform transition-all">
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h3 class="font-semibold text-gray-800">Calificaciones del Alumno</h3>
                <button onclick="document.getElementById('grades-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times-circle text-2xl"></i>
                </button>
            </div>
            <div class="p-6">
                <div id="grades-user-info" class="flex items-center mb-6"></div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-50 border-b border-gray-100">
                                <th class="px-4 py-3 text-xs font-semibold text-gray-500 uppercase">Actividad</th>
                                <th class="px-4 py-3 text-xs font-semibold text-gray-500 uppercase">Fecha</th>
                                <th class="px-4 py-3 text-xs font-semibold text-gray-500 uppercase text-center">Nota</th>
                                <th class="px-4 py-3 text-xs font-semibold text-gray-500 uppercase">Estado</th>
                            </tr>
                        </thead>
                        <tbody id="grades-table-body" class="text-sm"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Perfil (Placeholder) -->
    <div id="profile-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden modal-enter">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md overflow-hidden modal-content-enter transform transition-all">
            <div class="bg-gradient-to-r from-blue-500 to-indigo-600 p-6 text-white text-center">
                <div id="profile-avatar" class="w-20 h-20 rounded-full bg-white text-blue-600 flex items-center justify-center text-3xl font-bold mx-auto mb-3 shadow-lg border-4 border-white/30">
                    A
                </div>
                <h3 id="profile-name" class="font-bold text-xl">Nombre Alumno</h3>
                <p id="profile-email" class="text-blue-100 text-sm">email@ejemplo.com</p>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="text-center p-3 bg-gray-50 rounded-lg">
                        <span id="profile-attendance" class="block text-2xl font-bold text-gray-800">Sin asistencia</span>
                        <span class="text-xs text-gray-500 uppercase">Asistencia</span>
                    </div>
                     <div class="text-center p-3 bg-gray-50 rounded-lg">
                        <span id="profile-average" class="block text-2xl font-bold text-gray-800">Sin calificacion</span>
                        <span class="text-xs text-gray-500 uppercase">Promedio</span>
                    </div>
                </div>
                <div class="space-y-3">
                    <div class="flex items-center gap-3 text-sm text-gray-600">
                        <i class="fas fa-phone w-5 text-center text-gray-400"></i>
                        <span id="profile-phone">-</span>
                    </div>
                     <div class="flex items-center gap-3 text-sm text-gray-600">
                        <i class="fas fa-map-marker-alt w-5 text-center text-gray-400"></i>
                        <span id="profile-location">-</span>
                    </div>
                </div>
                <div class="mt-6">
                    <button onclick="document.getElementById('profile-modal').classList.add('hidden')" class="w-full bg-gray-100 text-gray-700 py-2 rounded-lg font-medium hover:bg-gray-200 transition-colors">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT -->
    <script th:inline="javascript">
        // --- DATOS ---
        const ofertaId = /*[[${oferta.idOferta}]]*/ 0;
        const DEFAULT_CLASS_KEY = '__default__';
        let users = [];
        let attendanceRecords = {};
        let calendarData = {};
        let classesByDate = {};
        let selectedClassId = null;

        // Estado Global de la App
        let selectedUser = null;
        let currentDate = new Date(); // Fecha seleccionada
        let viewDate = new Date();    // Mes visible en calendario

        // --- INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', () => {
            loadUsers();
            loadCalendarData();
            
            // Event Listeners
            document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            document.getElementById('close-modal-footer').addEventListener('click', closeModal);
            document.getElementById('prev-month').addEventListener('click', () => changeMonth(-1));
            document.getElementById('next-month').addEventListener('click', () => changeMonth(1));
            
            // Búsqueda
            document.getElementById('search-input').addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = users.filter(u => u.name.toLowerCase().includes(term));
                renderTable(filtered);
            });
        });

        async function loadUsers() {
            try {
                const response = await fetch(`/aula/api/oferta/${ofertaId}/usuarios`);
                users = await response.json();
                renderTable(users);
                document.getElementById('participants-count').innerText = `Participantes (${users.length})`;
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        async function loadCalendarData() {
            try {
                const response = await fetch(`/aula/api/oferta/${ofertaId}/calendario`);
                calendarData = await response.json();
                classesByDate = calendarData.clasesPorFecha || {};
            } catch (error) {
                console.error('Error loading calendar data:', error);
            }
        }

        function normalizeAttendance(rawRecords) {
            const normalized = {};
            if (!rawRecords) return normalized;

            Object.entries(rawRecords).forEach(([dateKey, value]) => {
                if (value && typeof value === 'object' && !Array.isArray(value)) {
                    normalized[dateKey] = { ...value };
                } else if (typeof value === 'string') {
                    normalized[dateKey] = { [DEFAULT_CLASS_KEY]: value };
                }
            });
            return normalized;
        }

        function getClassesForDate(dateKey) {
            const list = classesByDate && classesByDate[dateKey];
            if (!list) return [];
            return [...list].sort((a, b) => (a.horaInicio || '').localeCompare(b.horaInicio || ''));
        }

        function formatHour(hour) {
            if (!hour) return '';
            return hour.length >= 5 ? hour.substring(0, 5) : hour;
        }

        function buildStatusDots(statusMap) {
            if (!statusMap) return '';
            const orderMap = { present: 1, late: 2, absent: 3 };
            const uniqueStatuses = [...new Set(Object.values(statusMap))]
                .sort((a, b) => (orderMap[a] || 99) - (orderMap[b] || 99));
            return uniqueStatuses.map(status => {
                const colorClass = statusDotClass(status);
                return `<div class="w-1.5 h-1.5 ${colorClass} rounded-full mt-1"></div>`;
            }).join('');
        }

        function statusDotClass(status) {
            switch (status) {
                case 'present':
                    return 'bg-green-500';
                case 'late':
                    return 'bg-yellow-500';
                case 'absent':
                    return 'bg-red-500';
                default:
                    return 'bg-gray-300';
            }
        }

        // --- RENDERIZADO DE TABLA ---
        function renderTable(data) {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '';

            data.forEach(user => {
                const isProf = user.role === 'DOCENTE';
                const roleClass = isProf ? 'bg-indigo-50 text-indigo-700' : 'bg-gray-100 text-gray-700';
                const roleIcon = isProf ? 'fa-graduation-cap' : 'fa-users';

                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 transition-colors group';
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm ${user.color} mr-3">
                                ${user.avatar}
                            </div>
                            <div>
                                <div class="font-medium text-gray-900">${user.name}</div>
                                <div class="text-xs text-gray-500">${user.email || 'usuario@ejemplo.com'}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-medium ${roleClass}">
                            <i class="fas ${roleIcon} text-xs"></i>
                            ${user.role}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <div class="flex items-center gap-1.5">
                            <i class="far fa-clock text-gray-400"></i>
                            -
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">
                        <div class="flex justify-end gap-2">
                            <button onclick="openModal('${user.dni}')" class="text-blue-600 bg-blue-50 hover:bg-blue-100 p-2 rounded-md transition-colors" title="Asistencia">
                                <i class="far fa-calendar-check text-lg"></i>
                            </button>
                            <button onclick="openGrades('${user.dni}')" class="text-green-600 bg-green-50 hover:bg-green-100 p-2 rounded-md transition-colors" title="Calificaciones">
                                <i class="fas fa-star-half-alt text-lg"></i>
                            </button>
                            <button onclick="openProfile('${user.dni}')" class="text-gray-600 bg-gray-50 hover:bg-gray-100 p-2 rounded-md transition-colors" title="Ver Perfil">
                                <i class="far fa-id-card text-lg"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function formatDateTime(dateValue) {
            if (!dateValue) return '-';
            const dateObj = new Date(dateValue);
            if (Number.isNaN(dateObj.getTime())) return '-';
            return dateObj.toLocaleDateString('es-AR') + ' ' + dateObj.toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });
        }

        async function openGrades(userDni) {
            const user = users.find(u => u.dni === userDni);
            if (!user) return;
            
            const list = document.getElementById('grades-user-info');
            const tbody = document.getElementById('grades-table-body');
            if(list) {
                list.innerHTML = `
                    <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm ${user.color} mr-3">
                        ${user.avatar}
                    </div>
                    <div>
                         <h4 class="font-bold text-gray-900">${user.name}</h4>
                         <p class="text-xs text-gray-500">Historial Academico</p>
                    </div>
                `;
            }

            if (tbody) {
                tbody.innerHTML = `<tr><td colspan="4" class="px-4 py-6 text-center text-gray-500">Cargando...</td></tr>`;
            }

            try {
                const response = await fetch(`/aula/api/oferta/${ofertaId}/calificaciones/${userDni}`);
                const calificaciones = await response.json();

                if (!tbody) return;
                tbody.innerHTML = '';

                if (!Array.isArray(calificaciones) || calificaciones.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="4" class="px-4 py-6 text-center text-gray-500">Sin calificacion</td></tr>`;
                } else {
                    calificaciones.forEach(item => {
                        const nota = typeof item.nota === 'number' ? item.nota.toFixed(2) : item.nota;
                        const estado = Number(item.nota) >= 6
                            ? '<span class="bg-green-100 text-green-700 px-2 py-0.5 rounded-full text-xs">Aprobado</span>'
                            : '<span class="bg-red-100 text-red-700 px-2 py-0.5 rounded-full text-xs">Desaprobado</span>';

                        tbody.innerHTML += `
                            <tr class="border-b border-gray-50 hover:bg-gray-50">
                                <td class="px-4 py-3">${item.actividad || '-'}</td>
                                <td class="px-4 py-3">${formatDateTime(item.fecha)}</td>
                                <td class="px-4 py-3 text-center font-bold text-gray-800">${nota ?? '-'}</td>
                                <td class="px-4 py-3">${estado}</td>
                            </tr>
                        `;
                    });
                }
            } catch (error) {
                console.error('Error loading grades:', error);
                if (tbody) {
                    tbody.innerHTML = `<tr><td colspan="4" class="px-4 py-6 text-center text-red-500">Error al cargar calificaciones</td></tr>`;
                }
            }

            document.getElementById('grades-modal').classList.remove('hidden');
        }

        function openProfile(userDni) {
            const user = users.find(u => u.dni === userDni);
            if (!user) return;
            
            const nameEl = document.getElementById('profile-name');
            const emailEl = document.getElementById('profile-email');
            const avatarEl = document.getElementById('profile-avatar');
            const phoneEl = document.getElementById('profile-phone');
            const locationEl = document.getElementById('profile-location');
            const attendanceEl = document.getElementById('profile-attendance');
            const averageEl = document.getElementById('profile-average');

            if(nameEl) nameEl.innerText = user.name;
            if(emailEl) emailEl.innerText = user.email || '-';
            if(phoneEl) phoneEl.innerText = user.telefono || '-';
            if(attendanceEl) {
                attendanceEl.innerText = user.porcentajeAsistencia != null
                    ? `${Number(user.porcentajeAsistencia).toFixed(1)}%`
                    : 'Sin asistencia';
            }
            if(averageEl) {
                averageEl.innerText = user.promedioCalificaciones != null
                    ? Number(user.promedioCalificaciones).toFixed(2)
                    : 'Sin calificacion';
            }
            if(locationEl) {
                const ubicacion = [user.ciudad, user.provincia, user.pais]
                    .filter(v => v && `${v}`.trim() !== '')
                    .join(', ');
                locationEl.innerText = ubicacion || '-';
            }
            
            if(avatarEl) {
                avatarEl.innerText = user.avatar || user.name.charAt(0);
                avatarEl.className = `w-20 h-20 rounded-full flex items-center justify-center text-3xl font-bold mx-auto mb-3 shadow-lg border-4 border-white/30 text-white ${user.color.replace('bg-', 'bg-')}`; 
            }
            
            document.getElementById('profile-modal').classList.remove('hidden');
        }

        // --- LÓGICA DEL MODAL ---
        async function openModal(userDni) {
            selectedUser = users.find(u => u.dni === userDni);
            if (!selectedUser) return;

            // Establecer fecha inicial válida (primer día de clase o hoy si es válido)
            currentDate = findInitialDate();
            viewDate = new Date(currentDate);
            selectedClassId = null;

            // Llenar info de usuario
            const infoContainer = document.getElementById('modal-user-info');
            infoContainer.innerHTML = `
                <div class="w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg ${selectedUser.color} mr-4">
                    ${selectedUser.avatar}
                </div>
                <div>
                    <h4 class="font-bold text-gray-900 text-lg">${selectedUser.name}</h4>
                    <p class="text-sm text-gray-500">${selectedUser.role}</p>
                </div>
            `;

            // Cargar asistencia del usuario
            try {
                const response = await fetch(`/aula/api/oferta/${ofertaId}/asistencia/${userDni}`);
                const records = await response.json();
                attendanceRecords[userDni] = normalizeAttendance(records);
            } catch (error) {
                console.error('Error loading attendance:', error);
                attendanceRecords[userDni] = {};
            }

            // Mostrar modal
            const modal = document.getElementById('attendance-modal');
            modal.classList.remove('hidden');
            
            renderCalendar();
            updateStatusUI();
        }

        function closeModal() {
            document.getElementById('attendance-modal').classList.add('hidden');
            selectedUser = null;
            selectedClassId = null;
        }

        // --- LÓGICA DEL CALENDARIO ---
        const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        const daysOfWeek = ["DOMINGO", "LUNES", "MARTES", "MIERCOLES", "JUEVES", "VIERNES", "SABADO"];

        function parseLocalDate(dateStr) {
            if (!dateStr) return null;
            if (Array.isArray(dateStr)) {
                return new Date(dateStr[0], dateStr[1] - 1, dateStr[2]);
            }
            if (typeof dateStr === 'string' && dateStr.includes('-')) {
                const parts = dateStr.split('-');
                if (parts.length === 3) {
                     return new Date(parts[0], parts[1] - 1, parts[2]);
                }
            }
            return new Date(dateStr);
        }

        function findInitialDate() {
            const today = new Date();
            
            // Si hoy es día de clase, usar hoy
            if (isClassDay(today)) {
                return today;
            }
            
            // Si no hay datos de calendario, devolver hoy por defecto
            if (!calendarData.fechaInicio || !calendarData.fechaFin) return today;

            const start = new Date(calendarData.fechaInicio);
            const end = new Date(calendarData.fechaFin);
            // Considerar fecha de inscripción del usuario seleccionado, si existe
            const enrollment = selectedUser ? parseLocalDate(selectedUser.fechaInscripcion) : null;
            // Ajustar horas para comparar solo fechas
            start.setHours(0,0,0,0);
            end.setHours(0,0,0,0);
            today.setHours(0,0,0,0);
            if (enrollment) enrollment.setHours(0,0,0,0);

            // Si hoy es antes del inicio, buscar desde el inicio
            const effectiveStart = enrollment && enrollment > start ? enrollment : start;
            if (today < effectiveStart) {
                return findNextClassDay(effectiveStart);
            }

            // Si hoy es después del fin, devolver el último día de clase (o fin)
            if (today > end) {
                return end; 
            }

            // Si estamos dentro del rango pero hoy no es clase, buscar el siguiente
            return findNextClassDay(today);
        }

        function findNextClassDay(fromDate) {
            let nextDate = new Date(fromDate);
            // Buscar máximo 30 días adelante
            for (let i = 0; i < 30; i++) {
                if (isClassDay(nextDate)) return nextDate;
                nextDate.setDate(nextDate.getDate() + 1);
            }
            return fromDate; // Fallback si no encuentra nada
        }

        function changeMonth(offset) {
            viewDate.setMonth(viewDate.getMonth() + offset);
            renderCalendar();
        }

        function isClassDay(date) {
            if (!calendarData.fechaInicio || !calendarData.fechaFin) return false;
            
            const start = new Date(calendarData.fechaInicio);
            const end = new Date(calendarData.fechaFin);
            const today = new Date();
            // Considerar fecha de inscripción del usuario seleccionado
            const enrollment = selectedUser ? parseLocalDate(selectedUser.fechaInscripcion) : null;
            
            // Ajustar zona horaria para comparación de fechas
            start.setHours(0,0,0,0);
            end.setHours(0,0,0,0);
            today.setHours(0,0,0,0);
            if (enrollment) enrollment.setHours(0,0,0,0);
            
            const check = new Date(date);
            check.setHours(0,0,0,0);

            // Rango de oferta
            if (check < start || check > end) return false;
            // No permitir antes de la inscripción del alumno
            if (enrollment && check < enrollment) return false;
            
            // VALIDACIÓN: No permitir fechas futuras ("si no hay una clase todavía")
            if (check > today) return false;

            const dateKey = formatDateKey(check);
            if (classesByDate && classesByDate[dateKey] && classesByDate[dateKey].length > 0) {
                return true;
            }

            const dayName = daysOfWeek[date.getDay()];
            const scheduledDays = calendarData.diasClase || [];
            return scheduledDays.includes(dayName);
        }

        function renderCalendar() {
            const year = viewDate.getFullYear();
            const month = viewDate.getMonth();
            
            // Actualizar título mes
            document.getElementById('calendar-month-year').innerText = `${months[month]} ${year}`;

            // Calcular días
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDayIndex = new Date(year, month, 1).getDay(); // 0 = Domingo

            const daysContainer = document.getElementById('calendar-days');
            daysContainer.innerHTML = '';

            // Espacios vacíos antes del primer día
            for (let i = 0; i < firstDayIndex; i++) {
                const blank = document.createElement('div');
                daysContainer.appendChild(blank);
            }

            const userRecords = selectedUser ? (attendanceRecords[selectedUser.dni] || {}) : {};

            // Días del mes
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = formatDateKey(date);
                const isSelected = formatDateKey(currentDate) === dateStr;
                const recordMap = userRecords[dateStr];
                
                // Usar isClassDay para determinar si es seleccionable (incluye reglas de inscription)
                const isClass = isClassDay(date);

                const btn = document.createElement('button');
                
                let bgClass = 'hover:bg-gray-100 text-gray-700';
                if (isSelected) {
                    bgClass = 'bg-blue-600 text-white shadow-md';
                } else if (isClass) {
                    bgClass = 'bg-blue-50 text-blue-700 hover:bg-blue-100';
                } else {
                    bgClass = 'bg-gray-50 text-gray-400 cursor-not-allowed';
                }

                btn.className = `p-2 rounded-lg text-sm relative transition-all w-full flex flex-col items-center justify-center ${bgClass}`;
                
                // Contenido del botón
                const dotHTML = (!isSelected && recordMap) ? buildStatusDots(recordMap) : '';

                btn.innerHTML = `<span>${day}</span>${dotHTML}`;
                
                if (isClass) {
                    // Click en día
                    btn.onclick = () => {
                        currentDate = new Date(year, month, day);
                        renderCalendar(); // Re-renderizar para actualizar selección
                        updateStatusUI();
                    };
                } else {
                    btn.disabled = true;
                }

                daysContainer.appendChild(btn);
            }

            // Actualizar texto de fecha seleccionada
            const options = { weekday: 'long', day: 'numeric', month: 'long' };
            document.getElementById('selected-date-display').innerText = currentDate.toLocaleDateString('es-ES', options);
        }

        function renderClassOptions() {
            const selectionWrapper = document.getElementById('class-selection');
            const optionsContainer = document.getElementById('class-options');
            const hint = document.getElementById('class-selection-hint');
            if (!selectionWrapper || !optionsContainer) {
                return;
            }

            const dateKey = formatDateKey(currentDate);
            const classes = getClassesForDate(dateKey);

            if (classes.length === 0) {
                selectionWrapper.classList.add('hidden');
                optionsContainer.innerHTML = '';
                selectedClassId = DEFAULT_CLASS_KEY;
                if (hint) hint.classList.add('hidden');
                return;
            }

            selectionWrapper.classList.remove('hidden');

            // Siempre auto-seleccionar la primera clase si no hay una selección válida
            if (!selectedClassId || !classes.some(clase => clase.id === selectedClassId)) {
                selectedClassId = classes[0].id;
            }

            optionsContainer.innerHTML = '';
            classes.forEach(clase => {
                const isSelected = clase.id === selectedClassId;
                const button = document.createElement('button');
                button.type = 'button';
                button.className = `w-full text-left border rounded-xl p-3 transition-all ${isSelected ? 'border-blue-500 bg-blue-50 shadow-sm' : 'border-gray-200 bg-white hover:border-blue-300 hover:bg-blue-50/50'}`;

                const titulo = clase.titulo ? clase.titulo : 'Clase';
                const horaInicio = formatHour(clase.horaInicio);
                const horaFin = formatHour(clase.horaFin);
                const rango = horaFin ? `${horaInicio} - ${horaFin}` : horaInicio;

                button.innerHTML = `
                    <div class="flex items-center justify-between gap-2">
                        <div>
                            <p class="text-sm font-semibold text-gray-800">${titulo}</p>
                            <p class="text-xs text-gray-500">${rango}</p>
                        </div>
                        <i class="fas ${isSelected ? 'fa-circle-check text-blue-500' : 'fa-circle text-gray-300'} text-lg"></i>
                    </div>
                `;

                button.addEventListener('click', () => {
                    if (selectedClassId !== clase.id) {
                        selectedClassId = clase.id;
                        updateStatusUI();
                    }
                });

                optionsContainer.appendChild(button);
            });

            // Mostrar hint solo si hay más de una clase
            if (hint) {
                hint.classList.toggle('hidden', classes.length <= 1);
            }
        }

        // --- LÓGICA DE ASISTENCIA ---
        function updateStatusUI() {
            if (!selectedUser) return;
            const dateKey = formatDateKey(currentDate);
            const classes = getClassesForDate(dateKey);
            const isValidDay = isClassDay(currentDate);
            renderClassOptions();

            const classKey = classes.length > 0 ? selectedClassId : DEFAULT_CLASS_KEY;
            const statusMap = attendanceRecords[selectedUser.dni]?.[dateKey] || {};
            const status = classKey ? statusMap[classKey] : undefined;

            // Resetear estilos de botones
            const btns = {
                'present': document.getElementById('btn-present'),
                'late': document.getElementById('btn-late'),
                'absent': document.getElementById('btn-absent')
            };
            const icons = {
                'present': btns['present'].querySelector('i'),
                'late': btns['late'].querySelector('i'),
                'absent': btns['absent'].querySelector('i')
            };

            // Habilitar/Deshabilitar según si es día de clase
            Object.values(btns).forEach(btn => {
                if (!isValidDay || (classes.length > 0 && !selectedClassId)) {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                    btn.classList.remove('hover:bg-gray-50', 'cursor-pointer');
                } else {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    btn.classList.add('hover:bg-gray-50', 'cursor-pointer');
                }
                
                // Resetear clases visuales
                btn.className = btn.className.replace(/bg-\w+-50|border-\w+-500|text-\w+-700|ring-\w+-500|active|ring-1/g, '').trim();
                btn.classList.add('btn-status', 'flex', 'flex-col', 'items-center', 'justify-center', 'p-3', 'rounded-xl', 'border', 'border-gray-200', 'text-gray-600', 'transition-all');
                if (isValidDay) btn.classList.add('hover:bg-gray-50', 'cursor-pointer');
            });

            Object.values(icons).forEach(icon => {
                icon.className = icon.className.replace(/text-\w+-600/, 'text-gray-600');
                if(!icon.className.includes('text-gray-600')) icon.classList.add('text-gray-600');
            });

            // Si no es día válido, mostrar mensaje y salir
            if (!isValidDay || (classes.length > 0 && !selectedClassId)) {
                const feedback = document.getElementById('feedback-msg');
                feedback.innerText = !isValidDay ? "Este día no hay clases programadas." : "Seleccioná una clase para registrar la asistencia.";
                feedback.classList.remove('hidden');
                return;
            }

            // Aplicar estilo activo si hay status
            if (status) {
                const activeBtn = btns[status];
                const activeIcon = icons[status];
                
                activeBtn.classList.remove('border-gray-200', 'text-gray-600', 'hover:bg-gray-50');
                activeBtn.classList.add('active', 'ring-1');
                activeIcon.classList.remove('text-gray-600');

                if (status === 'present') {
                    activeBtn.classList.add('bg-green-50', 'border-green-500', 'text-green-700', 'ring-green-500');
                    activeIcon.classList.add('text-green-600');
                } else if (status === 'late') {
                    activeBtn.classList.add('bg-yellow-50', 'border-yellow-500', 'text-yellow-700', 'ring-yellow-500');
                    activeIcon.classList.add('text-yellow-600');
                } else if (status === 'absent') {
                    activeBtn.classList.add('bg-red-50', 'border-red-500', 'text-red-700', 'ring-red-500');
                    activeIcon.classList.add('text-red-600');
                }
            }
            
            // Ocultar mensaje de feedback al cambiar de fecha
            document.getElementById('feedback-msg').classList.add('hidden');
        }

        async function setAttendanceStatus(status) {
            if (!selectedUser) return;
            
            const dateKey = formatDateKey(currentDate);
            const classes = getClassesForDate(dateKey);
            const classKey = classes.length > 0 ? selectedClassId : DEFAULT_CLASS_KEY;

            if (classes.length > 0 && !classKey) {
                updateStatusUI();
                return;
            }

            const effectiveClassKey = classKey || DEFAULT_CLASS_KEY;
            const claseId = effectiveClassKey === DEFAULT_CLASS_KEY ? null : effectiveClassKey;
            
            // Inicializar registro del usuario si no existe
            if (!attendanceRecords[selectedUser.dni]) {
                attendanceRecords[selectedUser.dni] = {};
            }
            if (!attendanceRecords[selectedUser.dni][dateKey]) {
                attendanceRecords[selectedUser.dni][dateKey] = {};
            }

            // Deshabilitar botones mientras se hace la petición
            const btnIds = ['btn-present','btn-late','btn-absent'];
            const disabledBtns = btnIds.map(id => document.getElementById(id)).filter(Boolean);
            disabledBtns.forEach(b => { b.disabled = true; b.classList.add('opacity-60','cursor-not-allowed'); });

            // Mostrar feedback de guardado
            const feedback = document.getElementById('feedback-msg');
            feedback.innerText = 'Guardando...';
            feedback.classList.remove('hidden');

            // Guardar en servidor
            try {
                const csrfToken = document.querySelector('meta[name="_csrf"]').content;
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;
                
                const response = await fetch('/aula/api/asistencia/registrar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    },
                    body: JSON.stringify({
                        ofertaId: ofertaId,
                        dni: selectedUser.dni,
                        fecha: dateKey,
                        estado: status,
                        claseId: claseId
                    })
                });
                
                if (!response.ok) {
                    let msg = 'Error al guardar la asistencia';
                    try {
                        const err = await response.json();
                        if (err && err.message) msg = err.message;
                    } catch {}
                    throw new Error(msg);
                }

                // Confirmado por el servidor: guardar estado localmente y actualizar UI
                attendanceRecords[selectedUser.dni][dateKey][effectiveClassKey] = status;

                // Actualizar UI
                updateStatusUI();
                renderCalendar(); // Para mostrar el punto de color en el calendario

                // Mostrar feedback
                feedback.innerText = `Asistencia registrada: ${status === 'present' ? 'Presente' : status === 'late' ? 'Tardanza' : 'Ausente'}`;
                feedback.classList.remove('hidden');
            } catch (error) {
                console.error('Error saving attendance:', error);
                alert(error.message || 'Error al guardar la asistencia');
                // Ocultar feedback si falló
                feedback.classList.add('hidden');
            } finally {
                // Rehabilitar botones
                disabledBtns.forEach(b => { b.disabled = false; b.classList.remove('opacity-60','cursor-not-allowed'); });
            }
        }

        function formatDateKey(date) {
            // Construye YYYY-MM-DD usando hora local para evitar desfasajes por UTC
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

    </script>
</body>
</html>
