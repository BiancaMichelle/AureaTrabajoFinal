<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Espacio - Aurea</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .mi-espacio-container {
            max-width: 1400px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .welcome-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            border-radius: 16px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .welcome-section h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .welcome-section p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        .calendar-container {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .calendar-header h2 {
            font-size: 1.5rem;
            color: #2d3748;
            margin: 0;
        }

        .calendar-nav {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .calendar-nav button {
            background: #f7fafc;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            color: #4a5568;
        }

        .calendar-nav button:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .month-year {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2d3748;
            min-width: 150px;
            text-align: center;
        }

        .calendar {
            width: 100%;
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-bottom: 10px;
        }

        .weekday {
            text-align: center;
            font-weight: 600;
            color: #718096;
            font-size: 0.9rem;
            padding: 10px 0;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
        }

        .calendar-day {
            min-height: 100px;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            justify-content: flex-start;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.2s ease;
            position: relative;
            color: #2d3748;
            background: #f7fafc;
            padding: 6px;
            border: 1px solid #edf2f7;
        }
        
        .day-number {
            text-align: right;
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 0.9rem;
        }

        .calendar-day:hover {
            background: #edf2f7;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .calendar-day.today {
            background: #fff;
            border: 2px solid #667eea;
            color: #2d3748;
        }
        
        .calendar-day.today .day-number {
            color: #667eea;
            font-weight: 800;
        }

        .calendar-day.other-month {
            color: #cbd5e0;
            background: #fafbfc;
        }
        
        .day-events-container {
            display: flex;
            flex-direction: column;
            gap: 2px;
            overflow: hidden;
        }

        /* Panel lateral */
        .sidebar-panels {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .panel-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .panel-header i {
            font-size: 1.5rem;
            color: #667eea;
        }

        .panel-header h3 {
            margin: 0;
            font-size: 1.2rem;
            color: #2d3748;
        }

        .analysis-btn {
            width: 100%;
            background: #805ad5;
            color: #ffffff;
            font-weight: 700;
            border: none;
            border-radius: 10px;
            padding: 10px 14px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 6px 14px rgba(128, 90, 213, 0.28);
        }

        .analysis-btn:hover {
            background: #6b46c1;
            transform: translateY(-1px);
            box-shadow: 0 10px 18px rgba(128, 90, 213, 0.35);
        }

        .event-item {
            padding: 15px;
            background: #f7fafc;
            border-radius: 10px;
            margin-bottom: 12px;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }

        .event-item:hover {
            background: #edf2f7;
            transform: translateX(5px);
        }

        .event-item.urgent {
            border-left-color: #f56565;
        }

        .event-item.completed {
            border-left-color: #48bb78;
            opacity: 0.7;
        }

        .event-time {
            font-size: 0.85rem;
            color: #718096;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .event-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .event-description {
            font-size: 0.9rem;
            color: #718096;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 20px;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
        }

        .stat-icon.blue {
            background: #e6f0ff;
            color: #667eea;
        }

        .stat-icon.green {
            background: #e6f9f0;
            color: #48bb78;
        }

        .stat-icon.orange {
            background: #fff3e6;
            color: #ed8936;
        }

        .stat-icon.red {
            background: #ffe6e6;
            color: #f56565;
        }

        .stat-content h4 {
            margin: 0 0 5px 0;
            color: #718096;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .stat-content p {
            margin: 0;
            font-size: 2rem;
            font-weight: 700;
            color: #2d3748;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #a0aec0;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .empty-state p {
            margin: 0;
            font-size: 1rem;
        }

        .alert-pago {
            background-color: #fff5f5;
            color: #c53030;
            border-left: 5px solid #e53e3e;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            animation: slideDown 0.5s ease-out;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>

<div layout:fragment="content">
    <div class="mi-espacio-container">
        <!-- Alerta de Pagos -->
        <div th:if="${alertaPagoProximo}" class="alert-pago">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="background: #fed7d7; padding: 10px; border-radius: 50%;">
                    <i class="fas fa-file-invoice-dollar" style="color: #e53e3e; font-size: 1.5rem;"></i>
                </div>
                <div>
                    <h4 style="margin: 0; font-size: 1.1rem; font-weight: 700; color: #9b2c2c;">¡Atención! Vencimiento Próximo</h4>
                    <p style="margin: 5px 0 0 0; color: #742a2a;">Tenés cuotas que vencen en los próximos días. Evitá recargos por mora.</p>
                </div>
            </div>
            <a th:href="@{/alumno/mis-pagos}" style="background: #e53e3e; color: white; padding: 10px 20px; text-decoration: none; border-radius: 8px; font-weight: 600; transition: all 0.2s;">
                <i class="fas fa-arrow-right"></i> Ver y Pagar
            </a>
        </div>

        <!-- Sección de Bienvenida -->
        <div class="welcome-section">
            <h1 th:text="'¡Hola, ' + ${#strings.capitalize(#authentication.principal.usuario.nombre)} + '!'">¡Hola, Alumno!</h1>
            <p>Bienvenido a tu espacio personal. Aquí puedes ver un resumen de tu progreso y próximas actividades.</p>
        </div>

        <!-- Tarjetas de Estadísticas -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon blue">
                    <i class="fas fa-book-open"></i>
                </div>
                <div class="stat-content">
                    <h4>Cursos Activos</h4>
                    <p th:text="${cursosActivos}">0</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon green">
                    <i class="fas fa-tasks"></i>
                </div>
                <div class="stat-content">
                    <h4>Tareas Completadas</h4>
                    <p><span th:text="${tareasCompletadas}">0</span>/<span th:text="${totalTareas}">0</span></p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon orange">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-content">
                    <h4>Próximas Entregas</h4>
                    <p th:text="${#lists.size(proximasEntregas)}">0</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon red">
                    <i class="fas fa-certificate"></i>
                </div>
                <div class="stat-content">
                    <h4>Cursos Finalizados</h4>
                    <p th:text="${cursosCompletados}">0</p>
                </div>
            </div>
        </div>

        <!-- Grid Principal: Calendario y Sidebar -->
        <div class="dashboard-grid">
            <!-- Calendario -->
            <div class="calendar-container">
                <div class="calendar-header">
                    <h2><i class="fas fa-calendar-alt"></i> Mi Calendario</h2>
                    <div class="calendar-nav">
                        <button id="prevMonth" title="Mes anterior">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span class="month-year" id="monthYear"></span>
                        <button id="nextMonth" title="Mes siguiente">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        <button id="todayBtn" title="Ir a hoy" style="width: auto; padding: 0 20px;">
                            <i class="fas fa-calendar-day"></i> Hoy
                        </button>
                    </div>
                </div>

                <div class="calendar">
                    <div class="calendar-weekdays">
                        <div class="weekday">Dom</div>
                        <div class="weekday">Lun</div>
                        <div class="weekday">Mar</div>
                        <div class="weekday">Mié</div>
                        <div class="weekday">Jue</div>
                        <div class="weekday">Vie</div>
                        <div class="weekday">Sáb</div>
                    </div>
                    <div class="calendar-days" id="calendarDays">
                        <!-- Los días se generarán dinámicamente con JavaScript -->
                    </div>
                </div>
                
                <div id="selectedDateInfo" class="mt-4 p-4 rounded-lg hidden" style="background-color: #f8fafc; border: 1px solid #e2e8f0; padding: 1.5rem; margin-top: 1.5rem; display: none;">
                    <h4 id="selectedDateTitle" style="margin: 0 0 1rem 0; font-weight: 700; color: #2d3748; font-size: 1.1rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 0.5rem;"></h4>
                    <div id="selectedDateEvents" style="display: flex; flex-direction: column; gap: 0.75rem;"></div>
                </div>
            </div>

            <!-- Sidebar con Eventos -->
            <div class="sidebar-panels">
                
                <!-- Documentación de Ingreso -->
                <div class="panel" style="border-left: 4px solid #3182ce;">
                    <div class="panel-header">
                        <i class="fas fa-file-contract" style="color: #3182ce;"></i>
                        <h3>Documentación</h3>
                    </div>
                    <div>
                        <div th:if="${#lists.isEmpty(inscripciones)}">
                            <p class="text-sm text-gray-500 text-center py-2">No tienes inscripciones registradas.</p>
                        </div>

                        <div th:unless="${#lists.isEmpty(inscripciones)}">
                            <p class="text-sm text-gray-600 mb-3" style="font-size: 0.9rem; color: #718096; margin-bottom: 0.75rem;">
                                Estado de tus requisitos:
                            </p>
                            
                            <!-- Estado ÚNICO para todo el alumno -->
                            <div th:style="${alumno.documentacionEntregada} ? 'background-color: #f0fff4; border-radius: 8px; padding: 12px; border: 1px solid #c6f6d5; display: flex; align-items: center; gap: 10px; margin-bottom: 10px;' : 'background-color: #fffaf0; border-radius: 8px; padding: 12px; border: 1px solid #feebc8; display: flex; align-items: center; gap: 10px; margin-bottom: 10px;'">
                                <i th:class="${alumno.documentacionEntregada} ? 'fas fa-check-circle' : 'fas fa-exclamation-circle'"
                                   th:style="${alumno.documentacionEntregada} ? 'color: #48bb78; font-size: 1.5rem;' : 'color: #ed8936; font-size: 1.5rem;'"></i>
                                <div>
                                    <h5 th:text="${alumno.documentacionEntregada} ? 'Documentación Completa' : 'Documentación Pendiente'" 
                                        style="margin: 0; font-size: 0.95rem; font-weight: 700; color: #2d3748;">
                                        Estado
                                    </h5>
                                    <p style="margin: 0; font-size: 0.85rem; color: #4a5568;">
                                        <span th:text="${alumno.documentacionEntregada} ? 'Tus requisitos han sido verificados.' : 'Debes presentar tus documentos.'">Descripción</span>
                                    </p>
                                </div>
                            </div>
                        </div>

                        <button onclick="mostrarModalRequisitosGlobal()" type="button" style="width: 100%; padding: 10px; background-color: #4299e1; color: white; text-align: center; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 0.9rem; border: none; cursor: pointer; transition: background-color 0.2s;">
                            <i class="fas fa-list-ul me-2"></i> Ver Qué Debo Entregar
                        </button>
                    </div>
                </div>

                <!-- PANEL TEST IA -->
                <div class="panel" style="border-left: 4px solid #805ad5;">
                    <div class="panel-header">
                        <i class="fas fa-robot" style="color: #805ad5;"></i>
                        <h3>Asistente IA</h3>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600 mb-4">Analiza tu rendimiento y recibe consejos personalizados.</p>
                        <button onclick="triggerAnalysis()" class="analysis-btn">
                            <i class="fas fa-magic"></i> Ejecutar Análisis
                        </button>
                        <p id="analysis-status" class="text-xs text-center text-gray-500 mt-2 font-semibold"></p>
                    </div>
                </div>

                 <!-- Próximas Clases -->
                <div class="panel">
                    <div class="panel-header">
                        <i class="fas fa-video"></i>
                        <h3>Próximas Clases</h3>
                    </div>
                    <div>
                        <div th:each="clase : ${proximasClases}" class="event-item urgent">
                            <div class="event-time">
                                <i class="fas fa-clock"></i>
                                <span th:text="${#temporals.format(clase.inicio, 'dd/MM/yyyy HH:mm')}">Fecha</span>
                            </div>
                            <div class="event-title">
                                <a th:href="${clase.meetingUrl}" target="_blank" class="text-blue-600 hover:text-blue-800 flex items-center gap-2" th:if="${clase.meetingUrl}">
                                    <span th:text="${clase.titulo}">Título Clase</span>
                                    <i class="fas fa-external-link-alt text-xs"></i>
                                </a>
                                <span th:text="${clase.titulo}" th:unless="${clase.meetingUrl}">Título Clase</span>
                            </div>
                            <div class="event-description">
                                <span th:if="${clase.modulo != null}" th:text="${clase.modulo.curso.nombre}">Curso</span>
                                <span th:if="${clase.modulo == null && clase.curso != null}" th:text="${clase.curso.nombre}">Curso</span>
                            </div>
                        </div>
                        <div th:if="${#lists.isEmpty(proximasClases)}" class="text-center text-gray-500 py-4">
                            No hay clases próximas
                        </div>
                    </div>
                </div>

                <!-- Próximas Actividades / Tareas -->
                <div class="panel">
                    <div class="panel-header">
                        <i class="fas fa-tasks"></i>
                        <h3>Mis Tareas</h3>
                    </div>
                    <div class="activity-list" style="max-height: 400px; overflow-y: auto;">
                        <div th:if="${#lists.isEmpty(listaTareas)}" class="empty-state">
                            <p>No hay tareas asignadas.</p>
                        </div>
                        <div th:each="item : ${listaTareas}" class="activity-item" 
                             th:with="tarea=${item['tarea']}, estado=${item['estado']}, entregada=${item['entregada']}, calificacion=${item['calificacion']}">
                            
                            <!-- Icono según estado -->
                            <div class="activity-icon"
                                 th:classappend="${estado == 'COMPLETADA' ? 'green' : (estado == 'ATRASADA' ? 'red' : 'blue')}">
                                <i class="fas" th:classappend="${estado == 'COMPLETADA' ? 'fa-check' : (estado == 'ATRASADA' ? 'fa-exclamation' : 'fa-clock')}"></i>
                            </div>
                            
                            <div class="activity-details">
                                <p><strong th:text="${tarea.titulo}">Nombre de la Tarea</strong></p>
                                <span th:if="${tarea.modulo != null and tarea.modulo.curso != null}" 
                                      th:text="${tarea.modulo.curso.nombre}">Curso</span>
                                
                                <div class="mt-1 flex gap-2">
                                     <span th:if="${estado == 'COMPLETADA'}" class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded">Entregada</span>
                                     <span th:if="${estado == 'ATRASADA'}" class="text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded">Atrasada</span>
                                     <span th:if="${estado == 'PENDIENTE'}" class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded">Pendiente</span>
                                     
                                     <span th:if="${calificacion != null}" class="text-xs bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded" 
                                           th:text="'Nota: ' + ${calificacion}">Nota: 10</span>
                                </div>
                            </div>
                            
                            <div class="activity-time flex flex-col items-end">
                                <span th:if="${item['fecha'] != null}" 
                                      th:text="${#temporals.format(item['fecha'], 'dd/MM/yyyy')}">25/05</span>
                                <a th:if="${tarea.modulo != null && tarea.modulo.curso != null}" 
                                   th:href="@{/alumno/aula/{id}(id=${tarea.modulo.curso.idOferta})}" 
                                   class="text-xs text-blue-600 hover:underline mt-1">Ir al curso</a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Próximos Exámenes -->
                <div class="panel">
                    <div class="panel-header">
                        <i class="fas fa-pencil-alt"></i>
                        <h3>Próximos Exámenes</h3>
                    </div>
                    <div class="activity-list">
                        <div th:if="${#lists.isEmpty(proximosExamenes)}" class="empty-state">
                            <p>No hay exámenes próximos.</p>
                        </div>
                        <div th:each="examen : ${proximosExamenes}" class="activity-item">
                            <div class="activity-icon red">
                                <i class="fas fa-file-signature"></i>
                            </div>
                            <div class="activity-details">
                                <p><strong th:text="${examen.titulo}">Nombre del Examen</strong></p>
                                <span th:if="${examen.modulo != null and examen.modulo.curso != null}" 
                                      th:text="${examen.modulo.curso.nombre}">Nombre del Curso</span>
                                <span th:if="${examen.modulo == null}" class="text-xs text-gray-400">Sin curso asignado</span>
                            </div>
                            <div class="activity-time flex flex-col items-end">
                                <span th:if="${examen.fechaApertura != null}"
                                      th:text="${#temporals.format(examen.fechaApertura, 'dd/MM/yyyy HH:mm')}">Fecha</span>
                                <a th:if="${examen.modulo != null && examen.modulo.curso != null}"
                                   th:href="@{/alumno/aula/{id}(id=${examen.modulo.curso.idOferta})}"
                                   class="text-xs text-blue-600 hover:underline mt-1">Ir al curso</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function () {
            const monthYearElement = document.getElementById('monthYear');
            const calendarDaysElement = document.getElementById('calendarDays');
            const prevMonthButton = document.getElementById('prevMonth');
            const nextMonthButton = document.getElementById('nextMonth');
            const todayButton = document.getElementById('todayBtn');

            let currentDate = new Date();

            const events = JSON.parse(/*[[${eventsJson}]]*/ '[]');

            function getEventsForDay(date) {
                // Generar formato YYYY-MM-DD local para comparar strings
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const dateString = `${year}-${month}-${day}`;
                
                return events.filter(event => event.start === dateString);
            }


            function showDayDetails(date, events) {
                const infoPanel = document.getElementById('selectedDateInfo');
                const title = document.getElementById('selectedDateTitle');
                const list = document.getElementById('selectedDateEvents');

                if (!infoPanel) return;

                // Reset visual highlight on all days
                document.querySelectorAll('.calendar-day').forEach(el => {
                     el.style.transform = '';
                     el.style.zIndex = '';
                     el.style.boxShadow = '';
                     if(el.classList.contains('today')) {
                         // Keep today style
                     } else {
                         el.style.backgroundColor = '';
                     }
                });

                if (events.length === 0) {
                    infoPanel.style.display = 'none';
                    return;
                }

                infoPanel.style.display = 'block';
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                let dateStr = date.toLocaleDateString('es-ES', options);
                title.textContent = dateStr.charAt(0).toUpperCase() + dateStr.slice(1);

                list.innerHTML = '';
                events.forEach(evt => {
                    const item = document.createElement('div');
                    item.style.padding = '12px';
                    item.style.backgroundColor = 'white';
                    item.style.borderLeft = '4px solid';
                    item.style.borderRadius = '6px';
                    item.style.boxShadow = '0 2px 4px rgba(0,0,0,0.05)';
                    
                    let color = '#ccc';
                    if (evt.className && evt.className.includes('event-clase')) color = '#48bb78';
                    if (evt.className && evt.className.includes('event-entrega')) color = '#ed8936';
                    if (evt.className && evt.className.includes('event-examen')) color = '#f56565';
                    
                    item.style.borderLeftColor = color;
                    item.innerHTML = `<div style="font-weight:600; color:#2d3748; font-size: 0.95rem;">${evt.title}</div>`;
                    
                    list.appendChild(item);
                });
            }

            function renderCalendar() {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();

                monthYearElement.textContent = `${currentDate.toLocaleString('es-ES', { month: 'long' })} ${year}`.toUpperCase();

                calendarDaysElement.innerHTML = '';

                const firstDayOfMonth = new Date(year, month, 1);
                const lastDayOfMonth = new Date(year, month + 1, 0);
                const lastDayOfPrevMonth = new Date(year, month, 0);

                const startDayOfWeek = (firstDayOfMonth.getDay() + 6) % 7; // Lunes como primer día

                // Días del mes anterior
                for (let i = startDayOfWeek; i > 0; i--) {
                    const day = lastDayOfPrevMonth.getDate() - i + 1;
                    const dayElement = createDayElement(day, month - 1, year, ['other-month']);
                    calendarDaysElement.appendChild(dayElement);
                }

                // Días del mes actual
                for (let i = 1; i <= lastDayOfMonth.getDate(); i++) {
                    const dayDate = new Date(year, month, i);
                    const classList = [];
                    const today = new Date();
                    const isToday = i === today.getDate() && month === today.getMonth() && year === today.getFullYear();
                    
                    if (isToday) {
                        classList.push('today');
                    }

                    const dayEvents = getEventsForDay(dayDate);
                    const dayElement = createDayElement(i, month, year, classList);
                    
                    // Interaction
                    dayElement.style.cursor = 'pointer';
                    dayElement.addEventListener('click', function() {
                         // Find day element again in DOM or use 'this'
                         document.querySelectorAll('.calendar-day').forEach(d => {
                             d.style.boxShadow = '';
                             if(!d.classList.contains('today')) d.style.backgroundColor = '';
                         });
                         
                         if(!this.classList.contains('today')) {
                             this.style.backgroundColor = '#ebf8ff';
                         }
                         this.style.boxShadow = 'inset 0 0 0 2px #667eea';
                         
                         showDayDetails(dayDate, dayEvents);
                    });

                    if (dayEvents.length > 0) {
                        dayElement.title = dayEvents.map(e => e.title).join('\n');
                        
                        const eventsContainer = document.createElement('div');
                        eventsContainer.className = 'day-events-container';
                        
                        dayEvents.slice(0, 4).forEach(evt => {
                            const evtDiv = document.createElement('div');
                            
                            // Acortar título para mostrar
                            let displayText = evt.title;
                            if(displayText.startsWith("Clase: ")) displayText = displayText.substring(7);
                            if(displayText.startsWith("Entrega: ")) displayText = "Ent: " + displayText.substring(9);
                            if(displayText.startsWith("Examen: ")) displayText = "Ex: " + displayText.substring(8);
                            
                            evtDiv.textContent = displayText;
                            evtDiv.style.fontSize = '0.75rem';
                            evtDiv.style.whiteSpace = 'nowrap';
                            evtDiv.style.overflow = 'hidden';
                            evtDiv.style.textOverflow = 'ellipsis';
                            evtDiv.style.padding = '2px 4px';
                            evtDiv.style.borderRadius = '3px';
                            evtDiv.style.marginBottom = '2px';
                            evtDiv.style.fontWeight = '500';
                            
                            // Colores
                            if(evt.className && evt.className.includes('event-clase')) {
                                evtDiv.style.backgroundColor = '#def7ec'; // verde
                                evtDiv.style.color = '#03543f';
                            } else if(evt.className && evt.className.includes('event-entrega')) {
                                if (evt.className.includes('completed')) {
                                    evtDiv.style.backgroundColor = '#edf2f7'; // gris claro
                                    evtDiv.style.color = '#718096';
                                    evtDiv.style.textDecoration = 'line-through';
                                } else {
                                    evtDiv.style.backgroundColor = '#fef3c7'; // naranja
                                    evtDiv.style.color = '#92400e';
                                }
                            } else if(evt.className && evt.className.includes('event-examen')) {
                                evtDiv.style.backgroundColor = '#fde8e8'; // rojo
                                evtDiv.style.color = '#9b1c1c';
                            } else {
                                evtDiv.style.backgroundColor = '#e5e7eb';
                                evtDiv.style.color = '#374151';
                            }
                            
                            eventsContainer.appendChild(evtDiv);
                        });
                        
                        if(dayEvents.length > 4) {
                            const more = document.createElement('div');
                            more.textContent = `+ ${dayEvents.length - 4} más`;
                            more.style.fontSize = '0.7rem';
                            more.style.color = '#6b7280';
                            more.style.textAlign = 'center';
                            more.style.marginTop = '2px';
                            eventsContainer.appendChild(more);
                        }
                        
                        dayElement.appendChild(eventsContainer);
                    }
                    calendarDaysElement.appendChild(dayElement);
                }

                // Días del mes siguiente
                const remainingDays = 42 - calendarDaysElement.children.length;
                for (let i = 1; i <= remainingDays; i++) {
                    const dayElement = createDayElement(i, month + 1, year, ['other-month']);
                    calendarDaysElement.appendChild(dayElement);
                }
            }

            function createDayElement(day, month, year, classes = []) {
                const dayElement = document.createElement('div');
                dayElement.classList.add('calendar-day', ...classes);
                
                const dayNum = document.createElement('div');
                dayNum.className = 'day-number';
                dayNum.textContent = day;
                dayElement.appendChild(dayNum);

                dayElement.dataset.date = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                return dayElement;
            }

            prevMonthButton.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar();
            });

            nextMonthButton.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar();
            });

            if (todayButton) {
                todayButton.addEventListener('click', () => {
                    currentDate = new Date();
                    renderCalendar();
                });
            }

            renderCalendar();

            // Función para trigger manual del análisis IA
            window.triggerAnalysis = function() {
                const btn = document.querySelector('button[onclick="triggerAnalysis()"]');
                const status = document.getElementById('analysis-status');
                
                // Buscar instancia del chat (apuntando a window.aiChat o window.simpleChatInstance)
                const chatApp = window.aiChat || window.simpleChatInstance || (window.parent ? window.parent.aiChat : null);
                
                if (chatApp) {
                    // UI Feedback
                    if(btn) {
                        btn.disabled = true;
                        btn.classList.add('opacity-50', 'cursor-not-allowed');
                        const originalText = btn.innerHTML;
                        btn.innerHTML = '⏳ Procesando...';
                        
                        setTimeout(() => {
                            btn.disabled = false;
                            btn.classList.remove('opacity-50', 'cursor-not-allowed');
                            btn.innerHTML = originalText;
                        }, 3000);
                    }
                    
                    if(status) {
                        status.textContent = '✅ Abriendo asistente...';
                        status.className = 'text-xs text-center text-green-600 mt-2 font-bold';
                    }

                    // Open and trigger
                    if(chatApp.openChat) chatApp.openChat();
                    if(chatApp.triggerAnalysis) chatApp.triggerAnalysis();

                } else {
                    console.error("Asistente IA no encontrado");
                    if(status) {
                        status.textContent = '❌ Error: Asistente no disponible';
                        status.className = 'text-xs text-center text-red-600 mt-2 font-bold';
                    }
                }
            };
        });
    </script>
</div>
</html>
