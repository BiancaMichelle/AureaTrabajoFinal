<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" layout:decorate="~{layout/base}">
<head>
    <title th:text="${clase?.titulo ?: 'Videoconferencia'}">Videoconferencia</title>
    

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdn.tailwindcss.com"></script>
    

    <style>
        .video-container {
            position: relative;
            padding-bottom: 56.25%; 
            height: 0;
            overflow: hidden;
            background: #f3f4f6; 
            border-radius: 12px; 
            border: 1px solid #e5e7eb; 
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }
        /* Estilo mejorado para el mensaje de carga */
        .loading-message {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.7); /* Fondo blanco semitransparente */
            backdrop-filter: blur(4px); /* Efecto de desenfoque moderno */
            color: #1f2937; /* Texto gris oscuro */
            border-radius: 12px;
            z-index: 10;
        }
        .loading-message i {
            color: #3b82f6; /* Icono de spinner azul */
        }
    </style>
</head>
<body layout:fragment="content" class="bg-gray-50"> <!-- Fondo de p√°gina gris muy claro -->

    <div class="container mx-auto p-4 md:p-6 max-w-6xl">
        
        <!-- Encabezado -->
        <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-900" th:text="${clase?.titulo ?: 'Clase en vivo'}"></h1>
                <p class="text-lg text-gray-600 mt-1" th:if="${clase?.descripcion}" th:text="${clase.descripcion}"></p>
            </div>
            <div class="flex gap-3 flex-shrink-0">
                <!-- Bot√≥n para abrir en nueva pesta√±a (Estilo Primario) -->
                <a th:href="${meetingUrl}" 
                   target="_blank"
                   class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-5 py-2.5 rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-200 flex items-center gap-2 font-medium">
                    <i class="fas fa-external-link-alt"></i>
                    <span>Abrir en nueva pesta√±a</span>
                </a>
                <!-- Bot√≥n volver al aula (Estilo Secundario) -->
                <a th:href="@{/docente/aula/} + ${clase?.modulo?.curso?.idOferta}"
                   class="bg-white text-gray-700 px-5 py-2.5 rounded-lg border border-gray-300 hover:bg-gray-100 transition-colors duration-200 flex items-center gap-2 font-medium">
                    <i class="fas fa-arrow-left"></i>
                    <span>Volver al aula</span>
                </a>
            </div>
        </div>

        <!-- Informaci√≥n de la clase -->
        <div th:if="${clase}" class="bg-blue-50 border border-blue-200 rounded-xl p-5 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-sm">
                <div class="flex items-center gap-3">
                    <i class="fas fa-clock text-blue-600 text-lg"></i>
                    <span class="text-gray-700"><strong>Inicio:</strong> <span th:text="${#temporals.format(clase.inicio, 'dd/MM/yyyy HH:mm')}"></span></span>
                </div>
                <div class="flex items-center gap-3">
                    <i class="fas fa-hourglass-end text-blue-600 text-lg"></i>
                    <span class="text-gray-700"><strong>Fin:</strong> <span th:text="${#temporals.format(clase.fin, 'dd/MM/yyyy HH:mm')}"></span></span>
                </div>
                <div class="flex items-center gap-3">
                    <i class="fas fa-user-check text-blue-600 text-lg"></i>
                    <span class="text-gray-700"><strong>Asistencia:</strong> <span th:text="${clase.asistenciaAutomatica ? 'Autom√°tica' : 'Manual'}"></span></span>
                </div>
            </div>
        </div>

        <!-- Mensaje de error -->
        <div th:if="${error}" class="bg-red-50 border border-red-300 text-red-800 px-5 py-4 rounded-xl mb-6">
            <div class="flex items-center">
                <i class="fas fa-exclamation-triangle me-3 text-red-500 text-xl"></i>
                <div>
                    <strong class="font-bold">Error: </strong>
                    <span th:text="${error}"></span>
                </div>
            </div>
        </div>

        <!-- Videoconferencia integrada -->
        <div th:if="${meetingUrl}" class="bg-white rounded-xl shadow-xl p-4 md:p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-900 flex items-center">
                    <i class="fas fa-video me-2 text-blue-600"></i>
                    Sala de videoconferencia
                </h2>
                <!-- Indicador "Conectado" mejorado -->
                <div class="flex items-center bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-medium">
                    <i class="fas fa-circle text-xs me-2 animate-pulse"></i>
                    <span>Conectado</span>
                </div>
            </div>
            <div th:if="${esDocente}" class="bg-gradient-to-r from-green-500 to-green-600 text-white p-4 mb-4 rounded-lg">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <i class="fas fa-crown text-2xl mr-3"></i>
                        <div>
                            <h3 class="font-bold text-lg">Eres el Moderador de esta clase</h3>
                            <p class="text-green-100">Los alumnos podr√°n unirse autom√°ticamente</p>
                        </div>
                    </div>
                    <div class="bg-white text-green-600 px-3 py-1 rounded-full font-bold">
                        MODERADOR
                    </div>
                </div>
            </div>
            
            <!-- Iframe de la videoconferencia -->
            <div class="video-container mb-6">
                <!-- Mensaje de carga mejorado -->
                <div class="loading-message" id="loadingMessage">
                    <i class="fas fa-spinner fa-spin text-3xl mb-3"></i>
                    <p class="font-medium text-lg">Cargando sala de videoconferencia...</p>
                    <p class="text-sm">Esto puede tomar un momento.</p>
                </div>
                <iframe th:src="${meetingUrl + '#config.prejoinPageEnabled=false&config.startWithAudioMuted=true&config.startWithVideoMuted=false'}" 
                        allow="camera *; microphone *; fullscreen *; speaker *; display-capture *; autoplay *"
                        allowfullscreen="true"
                        sandbox="allow-same-origin allow-scripts allow-forms allow-modals allow-popups allow-presentation"
                        referrerpolicy="no-referrer-when-downgrade"
                        title="Sala de Jitsi Meet"
                        style="border-radius: 8px;">
                </iframe>
            </div>

            <!-- Recomendaciones (Estilo mejorado con iconos) -->
            <div class="bg-gray-50 rounded-xl p-5 border border-gray-200">
                <h3 class="font-semibold text-gray-800 mb-3 flex items-center text-md">
                    <i class="fas fa-lightbulb me-2 text-yellow-500"></i>
                    Recomendaciones para Jitsi Meet
                </h3>
                <ul class="text-gray-700 text-sm space-y-2">
                    <li class="flex items-center"><i class="fas fa-check-circle text-green-500 w-5 me-2"></i> <strong>Permite el acceso</strong> a c√°mara y micr√≥fono cuando el navegador lo solicite.</li>
                    <li class="flex items-center"><i class="fas fa-headphones text-blue-500 w-5 me-2"></i> Usa <strong>auriculares</strong> para evitar ecos y mejorar la calidad de audio.</li>
                    <li class="flex items-center"><i class="fas fa-wifi text-blue-500 w-5 me-2"></i> Aseg√∫rate de tener una <strong>conexi√≥n estable</strong> a internet.</li>
                    <li class="flex items-center"><i class="fas fa-mobile-alt text-purple-500 w-5 me-2"></i> <strong>Jitsi funciona mejor</strong> en Chrome, Firefox o Edge.</li>
                    <!-- Eliminado el punto sobre "Abrir en nueva pesta√±a" ya que Jitsi es m√°s estable -->
                </ul>
            </div>
        </div>

        <!-- Mensaje si no hay meeting URL (Estilo de "Estado Vac√≠o" mejorado) -->
        <div th:unless="${meetingUrl}" class="bg-white border border-gray-200 text-gray-700 px-6 py-12 rounded-xl text-center">
            <i class="fas fa-video-slash text-5xl mb-5 text-gray-400"></i>
            <h2 class="text-2xl font-semibold mb-2 text-gray-800">Sala no disponible</h2>
            <p class="mb-6 text-gray-600">No se pudo cargar la sala de videoconferencia para esta clase.</p>
            <a th:if="${clase?.modulo?.curso}" 
               th:href="@{/docente/aula/} + ${clase.modulo.curso.idOferta}"
               class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-2.5 rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-200 inline-flex items-center gap-2 font-medium">
                <i class="fas fa-arrow-left me-2"></i>
                <span>Volver al aula</span>
            </a>
        </div>
    </div>

    <script th:if="${esDocente}">
        document.addEventListener('DOMContentLoaded', function() {
            const panelDocente = document.getElementById('panelDocente');
            const btnPermitir = document.getElementById('btnPermitirAlumnos');
            const statusDiv = document.getElementById('confirmacionStatus');
            const claseId = '[[${clase.idClase}]]';
            let alumnosPermitidos = false;
            let docenteEnReunion = false;
            
            console.log('üéØ Inicializando detecci√≥n de join del docente');
    
            // ‚úÖ DETECCI√ìN INTELIGENTE DE CUANDO EL DOCENTE SE UNE
            function detectarJoinDeDocente() {
                const iframe = document.querySelector('iframe');
                if (!iframe) {
                    console.log('‚ùå No se encontr√≥ el iframe de Jitsi');
                    return;
                }
    
                // 1. Detectar cuando el iframe est√© completamente cargado
                iframe.addEventListener('load', function() {
                    console.log('üîÑ Iframe de Jitsi cargado, iniciando detecci√≥n...');
                    
                    // 2. Esperar a que Jitsi est√© listo
                    setTimeout(() => {
                        iniciarDeteccionInteraccion();
                    }, 2000);
                });
    
                // 3. Si el iframe ya est√° cargado
                if (iframe.contentDocument || iframe.contentWindow) {
                    console.log('‚ö° Iframe ya cargado, iniciando detecci√≥n inmediata');
                    iniciarDeteccionInteraccion();
                }
            }
    
            function iniciarDeteccionInteraccion() {
                console.log('üîç Iniciando detecci√≥n de interacci√≥n del docente...');
                
                let interaccionesDetectadas = 0;
                const interaccionesNecesarias = 2; // Requerir m√∫ltiples interacciones
    
                // Detectar clicks en toda la p√°gina (incluido el iframe)
                document.addEventListener('click', function() {
                    interaccionesDetectadas++;
                    console.log(`üéØ Interacci√≥n detectada (${interaccionesDetectadas}/${interaccionesNecesarias})`);
                    
                    if (interaccionesDetectadas >= interaccionesNecesarias && !docenteEnReunion) {
                        docenteSeUnio();
                    }
                });
    
                // Detectar teclas presionadas
                document.addEventListener('keydown', function() {
                    interaccionesDetectadas++;
                    console.log(`‚å®Ô∏è Tecla presionada (${interaccionesDetectadas}/${interaccionesNecesarias})`);
                    
                    if (interaccionesDetectadas >= interaccionesNecesarias && !docenteEnReunion) {
                        docenteSeUnio();
                    }
                });
    
                // Detectar movimiento del mouse (m√°s sensible)
                let movimientosMouse = 0;
                document.addEventListener('mousemove', function() {
                    movimientosMouse++;
                    if (movimientosMouse > 10 && !docenteEnReunion) {
                        interaccionesDetectadas = interaccionesNecesarias; // Forzar detecci√≥n
                        docenteSeUnio();
                    }
                });
    
                // Fallback: Si despu√©s de 15 segundos no detectamos interacci√≥n, 
                // asumimos que el docente se uni√≥ pero no mostramos el bot√≥n inmediatamente
                setTimeout(() => {
                    if (!docenteEnReunion) {
                        console.log('‚è∞ Fallback: Mostrando panel despu√©s de 15 segundos');
                        mostrarPanelConAdvertencia();
                    }
                }, 15000);
            }
    
            function docenteSeUnio() {
                if (docenteEnReunion) return;
                
                docenteEnReunion = true;
                console.log('‚úÖ Docente detectado en la reuni√≥n');
                
                // Mostrar el panel con animaci√≥n
                panelDocente.classList.remove('hidden');
                panelDocente.style.animation = 'slideInDown 0.5s ease-out';
                
                // Agregar estilos CSS para la animaci√≥n
                if (!document.querySelector('#docente-styles')) {
                    const styles = document.createElement('style');
                    styles.id = 'docente-styles';
                    styles.textContent = `
                        @keyframes slideInDown {
                            from {
                                transform: translateY(-20px);
                                opacity: 0;
                            }
                            to {
                                transform: translateY(0);
                                opacity: 1;
                            }
                        }
                        .pulse-alert {
                            animation: pulse 2s infinite;
                        }
                        @keyframes pulse {
                            0% { transform: scale(1); }
                            50% { transform: scale(1.05); }
                            100% { transform: scale(1); }
                        }
                    `;
                    document.head.appendChild(styles);
                }
            }
    
            function mostrarPanelConAdvertencia() {
                if (docenteEnReunion) return;
                
                console.log('‚ö†Ô∏è Mostrando panel con advertencia');
                panelDocente.classList.remove('hidden');
                
                // Cambiar el mensaje para indicar que es una confirmaci√≥n manual
                const titulo = panelDocente.querySelector('h2');
                const descripcion = panelDocente.querySelector('p');
                
                if (titulo) titulo.textContent = '‚ö†Ô∏è Confirmar participaci√≥n';
                if (descripcion) descripcion.textContent = 'Si ya est√°s en la reuni√≥n, permite que los alumnos se unan';
                
                // Hacer que el bot√≥n llame m√°s la atenci√≥n
                btnPermitir.classList.add('pulse-alert');
            }
    
            // ‚úÖ PERMITIR QUE LOS ALUMNOS SE UNAN
            btnPermitir.addEventListener('click', function() {
                if (alumnosPermitidos) return;
                
                console.log('üéì Docente permitiendo entrada de alumnos:', claseId);
                
                fetch('/clase/docente-entrar/' + claseId, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error en el servidor: ' + response.status);
                    }
                    return response.text();
                })
                .then(result => {
                    console.log('Respuesta del servidor:', result);
                    if (result === 'OK') {
                        statusDiv.innerHTML = '<p class="text-green-600 font-bold">‚úÖ ¬°Alumnos pueden unirse ahora!</p>';
                        btnPermitir.disabled = true;
                        btnPermitir.textContent = '‚úÖ Alumnos permitidos';
                        btnPermitir.classList.remove('bg-green-600', 'hover:bg-green-700', 'pulse-alert');
                        btnPermitir.classList.add('bg-gray-400');
                        alumnosPermitidos = true;
                        
                        // Ocultar el panel despu√©s de 3 segundos
                        setTimeout(() => {
                            panelDocente.style.transition = 'opacity 0.5s ease';
                            panelDocente.style.opacity = '0';
                            setTimeout(() => {
                                panelDocente.style.display = 'none';
                            }, 500);
                        }, 3000);
                    } else {
                        statusDiv.innerHTML = '<p class="text-red-600">‚ùå Error: ' + result + '</p>';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    statusDiv.innerHTML = '<p class="text-red-600">‚ùå Error de conexi√≥n: ' + error.message + '</p>';
                });
            });
            
            // ‚úÖ INICIAR DETECCI√ìN
            detectarJoinDeDocente();
        });
    </script>

    <script>
        // Ocultar mensaje de carga cuando el iframe se cargue
        document.addEventListener('DOMContentLoaded', function() {
            const iframe = document.querySelector('iframe');
            const loadingMessage = document.getElementById('loadingMessage');
            
            if (iframe && loadingMessage) {
                let loaded = false;
                
                iframe.addEventListener('load', function() {
                    loaded = true;
                    // Desvanecer suavemente
                    loadingMessage.style.transition = 'opacity 0.5s ease';
                    loadingMessage.style.opacity = '0';
                    setTimeout(() => {
                        loadingMessage.style.display = 'none';
                    }, 500); // Espera a que termine la transici√≥n
                });
                
                // Ocultar despu√©s de 7 segundos (aumentado) aunque no cargue
                // A veces el evento 'load' no se dispara si hay redirecciones
                setTimeout(function() {
                    if (!loaded) {
                        loadingMessage.style.transition = 'opacity 0.5s ease';
                        loadingMessage.style.opacity = '0';
                        setTimeout(() => {
                            loadingMessage.style.display = 'none';
                        }, 500);
                    }
                }, 7000);
            }
        });
    </script>
</body>
</html>

