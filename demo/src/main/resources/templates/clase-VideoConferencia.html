<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" layout:decorate="~{layout/base}">

<head>
    <title th:text="${clase?.titulo ?: 'Videoconferencia'}">Videoconferencia</title>

    <!-- Script de Jitsi externo, cargado din√°micamente seg√∫n dominio si es posible, o usar el gen√©rico -->
    <!-- Usamos 8x8.vc para mejor compatibilidad con JaaS -->
    <script src="https://8x8.vc/external_api.js"></script>
    
    <th:block th:if="${@environment.getProperty('app.useTailwindCdn','true') == 'true'}">
        <script src="https://cdn.tailwindcss.com"></script>
    </th:block>


    <style>
        .video-container {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            background: #f3f4f6;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }

        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Estilo mejorado para el mensaje de carga */
        .loading-message {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.7);
            /* Fondo blanco semitransparente */
            backdrop-filter: blur(4px);
            /* Efecto de desenfoque moderno */
            color: #1f2937;
            /* Texto gris oscuro */
            border-radius: 12px;
            z-index: 10;
            pointer-events: none;
            /* Permitir clicks en el iframe subyacente */
        }

        .loading-message i {
            color: #3b82f6;
            /* Icono de spinner azul */
        }
    </style>
</head>

<body layout:fragment="content" class="bg-gray-50"> <!-- Fondo de p√°gina gris muy claro -->

    <div class="container mx-auto p-4 md:p-6 max-w-6xl">

        <!-- Encabezado -->
        <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-900" th:text="${clase?.titulo ?: 'Clase en vivo'}"></h1>
                <p class="text-lg text-gray-600 mt-1" th:if="${clase?.descripcion}" th:text="${clase.descripcion}"></p>
            </div>
            <div class="flex gap-3 flex-shrink-0">
                <!-- Bot√≥n para abrir en nueva pesta√±a (Estilo Primario) -->
                <a th:href="${meetingUrl}" target="_blank"
                    class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-5 py-2.5 rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-200 flex items-center gap-2 font-medium">
                    <i class="fas fa-external-link-alt"></i>
                    <span>Abrir en nueva pesta√±a</span>
                </a>
                <!-- Bot√≥n volver al aula (Estilo Secundario) -->
                <a th:href="${esDocente} ? @{/docente/aula/} + ${clase?.modulo?.curso?.idOferta} : @{/alumno/aula/} + ${clase?.modulo?.curso?.idOferta}"
                    class="bg-white text-gray-700 px-5 py-2.5 rounded-lg border border-gray-300 hover:bg-gray-100 transition-colors duration-200 flex items-center gap-2 font-medium">
                    <i class="fas fa-arrow-left"></i>
                    <span>Volver al aula</span>
                </a>
            </div>
        </div>

        <!-- Informaci√≥n de la clase -->
        <div th:if="${clase}" class="bg-blue-50 border border-blue-200 rounded-xl p-5 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-sm">
                <div class="flex items-center gap-3">
                    <i class="fas fa-clock text-blue-600 text-lg"></i>
                    <span class="text-gray-700"><strong>Inicio:</strong> <span
                            th:text="${#temporals.format(clase.inicio, 'dd/MM/yyyy HH:mm')}"></span></span>
                </div>
                <div class="flex items-center gap-3">
                    <i class="fas fa-hourglass-end text-blue-600 text-lg"></i>
                    <span class="text-gray-700"><strong>Fin:</strong> <span
                            th:text="${#temporals.format(clase.fin, 'dd/MM/yyyy HH:mm')}"></span></span>
                </div>
                <div class="flex items-center gap-3">
                    <i class="fas fa-user-check text-blue-600 text-lg"></i>
                    <span class="text-gray-700"><strong>Asistencia:</strong> <span
                            th:text="${clase.asistenciaAutomatica ? 'Autom√°tica' : 'Manual'}"></span></span>
                </div>
            </div>
        </div>

        <!-- Aviso de asistencia autom√°tica por tiempo (solo alumnos) -->
        <div id="asistenciaAutoAviso"
            class="hidden bg-amber-50 border border-amber-200 text-amber-800 px-5 py-4 rounded-xl mb-6">
            <div class="flex items-center gap-3">
                <i class="fas fa-stopwatch text-amber-600 text-lg"></i>
                <div class="text-sm">
                    <strong>Asistencia autom√°tica:</strong>
                    Deb√©s permanecer al menos <span id="minutosRequeridosAviso" class="font-semibold">-</span> minutos
                    para que se registre tu asistencia.
                </div>
            </div>
        </div>

        <!-- Mensaje de error -->
        <div th:if="${error}" class="bg-red-50 border border-red-300 text-red-800 px-5 py-4 rounded-xl mb-6">
            <div class="flex items-center">
                <i class="fas fa-exclamation-triangle me-3 text-red-500 text-xl"></i>
                <div>
                    <strong class="font-bold">Error: </strong>
                    <span th:text="${error}"></span>
                </div>
            </div>
        </div>

        <!-- Modal Pregunta Asistencia -->
        <div id="modalPreguntaAsistencia" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center">
            <div class="bg-white rounded-xl shadow-2xl p-8 max-w-lg w-full relative transform transition-all scale-100">
                <div class="mb-6 text-center">
                    <div class="bg-blue-100 text-blue-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-question text-3xl"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900 mb-2">Control de Asistencia</h3>
                    <p class="text-gray-600">Por favor, respond√© la siguiente pregunta para confirmar tu asistencia.</p>
                </div>
                
                <div id="preguntaContainer" class="mb-6">
                    <p id="preguntaEnunciado" class="font-semibold text-lg mb-4 text-center"></p>
                    <div id="preguntaOpciones" class="space-y-3">
                        <!-- Opciones din√°micas -->
                    </div>
                </div>

                <!-- Timer -->
                <div class="w-full bg-gray-200 rounded-full h-2.5 mb-6">
                <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full" style="width: 100%"></div>
                </div>
                <p class="text-xs text-center text-gray-500 mb-4">Tiempo restante: <span id="timeRemaining">180</span>s</p>
            </div>
        </div>

        <!-- Videoconferencia integrada -->
        <div th:if="${meetingUrl}" class="bg-white rounded-xl shadow-xl p-4 md:p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-900 flex items-center">
                    <i class="fas fa-video me-2 text-blue-600"></i>
                    Sala de videoconferencia
                </h2>
                <div class="flex gap-2">
                    <!-- Indicador Docente -->
                    <div th:if="${esDocente}"
                        class="flex items-center bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm font-medium">
                        <i class="fas fa-chalkboard-teacher me-2"></i>
                        <span>Docente</span>
                    </div>
                    <!-- Indicador Transcripci√≥n Configurada -->
                    <div th:if="${clase.transcripcionHabilitada}"
                        class="flex items-center bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-sm font-medium"
                        title="Transcripci√≥n habilitada para esta clase">
                        <i class="fas fa-closed-captioning me-2"></i>
                        <span>Transcripci√≥n ON</span>
                    </div>
                    <!-- Indicador Transcribiendo (Din√°mico) -->
                    <div id="transcribingBadge"
                        class="hidden flex items-center bg-red-100 text-red-700 px-3 py-1 rounded-full text-sm font-medium animate-pulse">
                        <i class="fas fa-microphone me-2"></i>
                        <span>Transcribiendo...</span>
                    </div>
                    <!-- Indicador "Conectado" mejorado -->
                    <div
                        class="flex items-center bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-medium">
                        <i class="fas fa-circle text-xs me-2 animate-pulse"></i>
                        <span>Conectado</span>
                    </div>
                </div>
            </div>
            <div th:if="${esDocente}"
                class="bg-gradient-to-r from-green-500 to-green-600 text-white p-4 mb-4 rounded-lg">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <i class="fas fa-crown text-2xl mr-3"></i>
                        <div>
                            <h3 class="font-bold text-lg">Eres el Moderador de esta clase</h3>
                            <p class="text-green-100">Los alumnos podr√°n unirse autom√°ticamente</p>
                        </div>
                    </div>
                    <div class="bg-white text-green-600 px-3 py-1 rounded-full font-bold">
                        MODERADOR
                    </div>
                </div>
            </div>

            <!-- Iframe de la videoconferencia -->
            <div class="video-container mb-6" id="jitsi-container">
                <!-- Mensaje de carga mejorado -->
                <div class="loading-message" id="loadingMessage">
                    <i class="fas fa-spinner fa-spin text-3xl mb-3"></i>
                    <p class="font-medium text-lg">Cargando sala de videoconferencia...</p>
                    <p class="text-sm">Esto puede tomar un momento.</p>
                </div>
                <!-- El iframe ser√° inyectado por la API de Jitsi -->
            </div>

            <!-- Contenedor para mensaje de clase terminada (oculto inicialmente) -->
            <div id="classEndedMessage"
                class="hidden bg-white border border-gray-200 text-gray-700 px-6 py-12 rounded-xl text-center mb-6">
                <i class="fas fa-check-circle text-5xl mb-5 text-green-500"></i>
                <h2 id="endMessageTitle" class="text-2xl font-semibold mb-2 text-gray-800">La clase ha terminado</h2>
                <p class="mb-6 text-gray-600">Gracias por participar.</p>

                <!-- Status del Resumen IA -->
                <div id="summaryStatus" class="hidden mb-4 p-3 rounded-lg bg-blue-50 text-blue-700 font-medium">
                </div>

                <div class="flex justify-center gap-4">
                    <button onclick="descargarTranscripcion()" id="btnDescargarTranscripcion"
                        class="hidden bg-green-600 text-white px-6 py-2.5 rounded-lg shadow-md hover:bg-green-700 transition-all duration-200 inline-flex items-center gap-2 font-medium">
                        <i class="fas fa-file-download me-2"></i>
                        <span>Descargar Transcripci√≥n</span>
                    </button>
                </div>
            </div>

            <!-- Recomendaciones (Estilo mejorado con iconos) -->
            <div class="bg-gray-50 rounded-xl p-5 border border-gray-200">
                <h3 class="font-semibold text-gray-800 mb-3 flex items-center text-md">
                    <i class="fas fa-lightbulb me-2 text-yellow-500"></i>
                    Recomendaciones para Jitsi Meet
                </h3>
                <ul class="text-gray-700 text-sm space-y-2">
                    <li class="flex items-center"><i class="fas fa-check-circle text-green-500 w-5 me-2"></i>
                        <strong>Permite el acceso</strong> a c√°mara y micr√≥fono cuando el navegador lo solicite.
                    </li>
                    <li class="flex items-center"><i class="fas fa-headphones text-blue-500 w-5 me-2"></i> Usa
                        <strong>auriculares</strong> para evitar ecos y mejorar la calidad de audio.
                    </li>
                    <li class="flex items-center"><i class="fas fa-wifi text-blue-500 w-5 me-2"></i> Aseg√∫rate de tener
                        una <strong>conexi√≥n estable</strong> a internet.</li>
                    <li class="flex items-center"><i class="fas fa-mobile-alt text-purple-500 w-5 me-2"></i>
                        <strong>Jitsi funciona mejor</strong> en Chrome, Firefox o Edge.
                    </li>
                </ul>
            </div>
        </div>
        <script th:inline="javascript">
            // Datos del servidor
            const meetingUrl = /*[[${meetingUrl}]]*/ '';
            const defaultRoomName = /*[[${clase.roomName}]]*/ 'SalaPrueba';
            const isTeacher = /*[[${esDocente}]]*/ false;
            const transcripcionHabilitada = /*[[${clase.transcripcionHabilitada != null ? clase.transcripcionHabilitada : false}]]*/ false;
            const claseId = /*[[${clase.idClase}]]*/ '';
            const claseDuracionMinutos = /*[[${duracionMinutos != null ? duracionMinutos : 0}]]*/ 0;
            const claseInicioIso = /*[[${clase.inicio != null ? #temporals.format(clase.inicio, 'yyyy-MM-dd''T''HH:mm:ss') : ''}]]*/ '';
            const claseFinIso = /*[[${clase.fin != null ? #temporals.format(clase.fin, 'yyyy-MM-dd''T''HH:mm:ss') : ''}]]*/ '';
            // Obtener datos del usuario de manera segura con Thymeleaf
            const usuarioNombre = /*[[${usuario != null ? usuario.nombre + ' ' + usuario.apellido : 'Usuario Invitado'}]]*/ 'Usuario Invitado';
            const usuarioEmail = /*[[${usuario != null ? usuario.correo : 'email@example.com'}]]*/ 'email@example.com';
            
            // CSRF
            const csrfToken = document.querySelector("meta[name='_csrf']")?.getAttribute("content");
            const csrfHeader = document.querySelector("meta[name='_csrf_header']")?.getAttribute("content");

            // Configuraci√≥n din√°mica de Jitsi (Soporte para JaaS/8x8)
            let domain = "meet.jit.si";
            let roomName = defaultRoomName;
            let jwtToken = null;

            if (meetingUrl && meetingUrl.includes("8x8.vc")) {
                console.log("üîß Configurando modo JaaS (8x8.vc)");
                domain = "8x8.vc";
                try {
                    const urlObj = new URL(meetingUrl);
                    // Extraer el path completo (tenant/room) sin el slash inicial
                    roomName = urlObj.pathname.substring(1);
                    jwtToken = urlObj.searchParams.get("jwt");
                } catch (e) {
                    console.error("Error parseando URL de Jitsi:", e);
                }
            }

            const options = {
                roomName: roomName,
                width: '100%',
                height: '100%',
                parentNode: document.querySelector('#jitsi-container'),
                jwt: jwtToken, // Inyectar token si existe
                configOverwrite: {
                    prejoinPageEnabled: false,
                    startWithAudioMuted: true,
                    startWithVideoMuted: false
                },
                interfaceConfigOverwrite: {
                    // Opciones de interfaz
                    TOOLBAR_BUTTONS: [
                        'microphone', 'camera', 'closedcaptions', 'desktop', 'fullscreen',
                        'fodeviceselection', 'hangup', 'profile', 'chat', 'recording',
                        'livestreaming', 'etherpad', 'sharedvideo', 'settings', 'raisehand',
                        'videoquality', 'filmstrip', 'invite', 'feedback', 'stats', 'shortcuts',
                        'tileview', 'videobackgroundblur', 'download', 'help', 'mute-everyone',
                        'security'
                    ]
                },
                userInfo: {
                    displayName: isTeacher ? usuarioNombre + ' (Docente)' : usuarioNombre,
                    email: usuarioEmail
                }
            };

            // Fallback: Ocultar loading despu√©s de 5 segundos (por seguridad)
            // Se define ANTES de iniciar la API para asegurar que se ejecute incluso si hay error JS abajo
            const loadingTimeout = setTimeout(() => {
                const loadingMessage = document.getElementById('loadingMessage');
                if (loadingMessage) loadingMessage.style.display = 'none';
                console.warn("‚ö†Ô∏è Tiempo de espera de carga agotado (Fallback ejecutado)");
            }, 5000);

            let api = null;
            let programarCierreClase = null;

            function obtenerFechaFinClase() {
                if (!claseFinIso) return null;
                const fecha = new Date(claseFinIso);
                return Number.isNaN(fecha.getTime()) ? null : fecha;
            }

            try {
                if (typeof JitsiMeetExternalAPI === 'undefined') {
                    throw new Error("La librer√≠a de Jitsi no se ha cargado correctamente. Verifique su conexi√≥n a internet.");
                }

                console.log("üöÄ Iniciando Jitsi en:", domain, "Sala:", roomName);
                api = new JitsiMeetExternalAPI(domain, options);

                let hasJoined = false;
                let forcedExit = false;
                let classEndTimer = null;

                // Ocultar mensaje de carga cuando se carga la API
                api.addEventListener('videoConferenceJoined', () => {
                    console.log("‚úÖ Evento: videoConferenceJoined");
                    hasJoined = true;
                    clearTimeout(loadingTimeout); // Cancelar el fallback si carg√≥ bien
                    const loadingMessage = document.getElementById('loadingMessage');
                    if (loadingMessage) {
                        loadingMessage.style.display = 'none';
                    }

                    // Iniciar transcripci√≥n si es docente y est√° habilitada
                    if (isTeacher && transcripcionHabilitada) {
                        iniciarTranscripcion();
                    }

                    if (!isTeacher && asistenciaAutomatica) {
                        iniciarAsistenciaTiempo();
                    }
                });
                
                // Detectar expulsi√≥n o fin remoto
                api.addEventListener('participantKickedOut', (event) => {
                     if (event.kicked && event.kicked.local) {
                         console.log("‚ö†Ô∏è Usuario fue expulsado o la clase termin√≥ para todos");
                         forcedExit = true;
                     }
                });

                // Detectar cuando se termina la llamada
                api.addEventListener('videoConferenceLeft', () => {
                    console.log("üö™ Evento: videoConferenceLeft");
                    if (hasJoined) {
                        mostrarMensajeFinClase();
                        if (isTeacher && transcripcionHabilitada) {
                            detenerTranscripcion();
                        }
                        if (!isTeacher && asistenciaAutomatica) {
                            detenerAsistenciaTiempo();
                        }
                    }
                });

                api.addEventListener('readyToClose', () => {
                    console.log("üî¥ Evento: readyToClose");
                    forcedExit = true; // Asumimos fin global si el evento es readyToClose
                    if (hasJoined) {
                        mostrarMensajeFinClase();
                        if (isTeacher && transcripcionHabilitada) {
                            detenerTranscripcion();
                        }
                        if (!isTeacher && asistenciaAutomatica) {
                            detenerAsistenciaTiempo();
                        }
                    }
                });

                function mostrarMensajeFinClase() {
                    const container = document.getElementById('jitsi-container');
                    const message = document.getElementById('classEndedMessage');
                    const btnDescargar = document.getElementById('btnDescargarTranscripcion');
                    const title = document.getElementById('endMessageTitle'); // Elemento del t√≠tulo

                    if (container) container.style.display = 'none';
                    if (message) message.classList.remove('hidden');
                    
                    // L√≥gica del mensaje de salida
                    if (title) {
                        if (isTeacher) {
                             title.textContent = "La clase ha terminado";
                        } else {
                            if (forcedExit) {
                                title.textContent = "La clase ha terminado"; // Docente cort√≥
                            } else {
                                title.textContent = "Has abandonado la clase"; // Alumno sali√≥ voluntariamente
                            }
                        }
                    }

                    // Mostrar bot√≥n de descarga si hay transcripci√≥n y es docente
                    if (isTeacher && transcripcionHabilitada) {
                        if (btnDescargar) btnDescargar.classList.remove('hidden');
                        
                        // Enviar transcripci√≥n al servidor para generar resumen
                        enviarTranscripcionAlServidor();
                    }

                    // Eliminar la instancia de la API para limpiar recursos
                    if (api) {
                        api.dispose();
                    }
                }

                function forzarCierreClase() {
                    forcedExit = true;

                    // Si no se lleg√≥ a unir, igual mostramos el mensaje de cierre.
                    if (!hasJoined) {
                        if (!isTeacher && asistenciaAutomatica) {
                            detenerAsistenciaTiempo();
                        }
                        mostrarMensajeFinClase();
                        return;
                    }

                    // Si ya est√° unido, intentamos colgar para forzar el cierre y mostrar el mensaje.
                    try {
                        api.executeCommand('hangup');
                    } catch (e) {
                        console.warn("No se pudo ejecutar hangup, mostrando cierre manual:", e);
                        if (!isTeacher && asistenciaAutomatica) {
                            detenerAsistenciaTiempo();
                        }
                        mostrarMensajeFinClase();
                    }
                }

                function programarCierreClaseInternal() {
                    const fin = obtenerFechaFinClase();
                    if (!fin) return;
                    const msRestantes = fin.getTime() - Date.now();
                    if (classEndTimer) {
                        clearTimeout(classEndTimer);
                    }
                    if (msRestantes <= 0) {
                        forzarCierreClase();
                    } else {
                        classEndTimer = setTimeout(forzarCierreClase, msRestantes);
                    }
                }

                programarCierreClase = programarCierreClaseInternal;

            } catch (error) {
                console.error("‚ùå Error cr√≠tico al iniciar Jitsi:", error);
                const loadingMessage = document.getElementById('loadingMessage');
                if (loadingMessage) {
                    loadingMessage.innerHTML = `
                        <div class="text-center text-red-600 p-4">
                            <i class="fas fa-exclamation-circle text-3xl mb-2"></i>
                            <p class="font-bold">Error al cargar la videoconferencia</p>
                            <p class="text-sm mb-3">${error.message}</p>
                            <button onclick="location.reload()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">Recargar p√°gina</button>
                        </div>
                    `;
                }
            }

            // --- L√ìGICA DE TRANSCRIPCI√ìN ---
            let recognition;
            let isTranscribing = false;
            let fullTranscript = ""; // Variable para acumular el texto

            function iniciarTranscripcion() {
                if (!('webkitSpeechRecognition' in window)) {
                    console.warn("La API de reconocimiento de voz no es soportada en este navegador.");
                    return;
                }

                recognition = new webkitSpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'es-ES'; // Ajustar idioma seg√∫n necesidad

                recognition.onstart = function () {
                    isTranscribing = true;
                    console.log("üéôÔ∏è Transcripci√≥n iniciada...");
                    mostrarNotificacionTranscripcion(true);
                };

                recognition.onerror = function (event) {
                    console.error("Error en transcripci√≥n:", event.error);
                };

                recognition.onend = function () {
                    isTranscribing = false;
                    console.log("Transcripci√≥n detenida.");
                    mostrarNotificacionTranscripcion(false);
                };

                recognition.onresult = function (event) {
                    let interimTranscript = '';
                    let finalTranscript = '';

                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            const text = event.results[i][0].transcript;
                            finalTranscript += text;

                            // Acumular con timestamp
                            const now = new Date();
                            const timeString = now.toLocaleTimeString();
                            fullTranscript += `[${timeString}] ${text}\n`;

                            console.log("üìù Texto final:", finalTranscript);
                        } else {
                            interimTranscript += event.results[i][0].transcript;
                        }
                    }
                };

                recognition.start();
            }

            function detenerTranscripcion() {
                if (recognition && isTranscribing) {
                    recognition.stop();
                    mostrarNotificacionTranscripcion(false);
                }
            }

            function descargarTranscripcion() {
                if (!fullTranscript || fullTranscript.trim() === "") {
                    console.warn("No hay transcripci√≥n para descargar.");
                    return;
                }

                const blob = new Blob([fullTranscript], { type: "text/plain;charset=utf-8" });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;

                const fecha = new Date().toISOString().slice(0, 10);
                a.download = `Transcripcion_Clase_${fecha}.txt`;

                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }

            function enviarTranscripcionAlServidor() {
                if (!fullTranscript || fullTranscript.trim() === "") {
                    console.warn("No hay transcripci√≥n para enviar.");
                    return;
                }

                // Mostrar estado
                const statusDiv = document.getElementById('summaryStatus');
                if(statusDiv) {
                    statusDiv.classList.remove('hidden');
                    statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Generando resumen con IA...';
                }

                fetch(`/clase/finalizar-con-resumen/${claseId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain; charset=utf-8',
                        [csrfHeader]: csrfToken
                    },
                    body: fullTranscript
                })
                .then(response => {
                    if (!response.ok) throw new Error('Error en la respuesta del servidor');
                    return response.json();
                })
                .then(data => {
                    console.log("Resumen generado:", data);
                    if(statusDiv) {
                        statusDiv.innerHTML = '<i class="fas fa-check-circle text-green-500 me-2"></i> Resumen generado y guardado en el aula.';
                        statusDiv.classList.remove('bg-blue-50', 'text-blue-700');
                        statusDiv.classList.add('bg-green-50', 'text-green-700');
                    }
                })
                .catch(error => {
                    console.error("Error enviando transcripci√≥n:", error);
                    if(statusDiv) {
                        statusDiv.innerHTML = '<i class="fas fa-exclamation-circle text-red-500 me-2"></i> Error al generar resumen.';
                        statusDiv.classList.remove('bg-blue-50', 'text-blue-700');
                        statusDiv.classList.add('bg-red-50', 'text-red-700');
                    }
                });
            }

            function mostrarNotificacionTranscripcion(activa) {
                const badge = document.getElementById('transcribingBadge');
                if (badge) {
                    if (activa) {
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
            }

            // --- L√ìGICA DE ASISTENCIA AUTOM√ÅTICA ---
            const asistenciaAutomatica = /*[[${clase.asistenciaAutomatica}]]*/ false;
            const preguntasAleatorias = /*[[${clase.preguntasAleatorias}]]*/ false;
            let asistenciaTimer = null;
            let asistenciaTiempoConfirmada = false;
            let asistenciaRetryTimer = null;
            let asistenciaConfirmando = false;

            function obtenerMinutosRequeridos() {
                if (!claseDuracionMinutos || claseDuracionMinutos <= 0) {
                    return null;
                }
                return Math.floor(claseDuracionMinutos / 2) + 1; // m√°s de la mitad
            }

            function mostrarAvisoAsistenciaAutomatica() {
                const aviso = document.getElementById('asistenciaAutoAviso');
                const valor = document.getElementById('minutosRequeridosAviso');
                if (!aviso || !valor) return;
                if (isTeacher || !asistenciaAutomatica || preguntasAleatorias) {
                    aviso.classList.add('hidden');
                    return;
                }
                const minutosRequeridos = obtenerMinutosRequeridos();
                if (!minutosRequeridos) {
                    aviso.classList.add('hidden');
                    return;
                }
                valor.textContent = minutosRequeridos;
                aviso.classList.remove('hidden');
            }

            async function marcarIngresoAsistenciaTiempo() {
                try {
                    await fetch(`/api/clase/${claseId}/asistencia/ingreso`, {
                        method: 'POST',
                        headers: {
                            [csrfHeader]: csrfToken
                        }
                    });
                    console.log("üü¢ Ingreso de asistencia registrado");
                } catch (e) {
                    console.error("Error registrando ingreso de asistencia:", e);
                }
            }

            async function marcarSalidaAsistenciaTiempo() {
                try {
                    await fetch(`/api/clase/${claseId}/asistencia/salida`, {
                        method: 'POST',
                        headers: {
                            [csrfHeader]: csrfToken
                        }
                    });
                    console.log("üî¥ Salida de asistencia registrada");
                } catch (e) {
                    console.error("Error registrando salida de asistencia:", e);
                }
            }

            async function confirmarAsistenciaTiempo() {
                if (asistenciaTiempoConfirmada || asistenciaConfirmando) return false;
                asistenciaConfirmando = true;
                try {
                    const response = await fetch(`/api/clase/${claseId}/asistencia/confirmar`, {
                        method: 'POST',
                        headers: {
                            [csrfHeader]: csrfToken
                        }
                    });
                    const data = await response.json().catch(() => null);
                    if (response.ok && data && data.success) {
                        asistenciaTiempoConfirmada = true;
                        console.log("‚úÖ Asistencia autom√°tica por tiempo registrada");
                        return true;
                    } else {
                        console.log("‚è≥ Asistencia a√∫n no cumple el tiempo m√≠nimo");
                        return false;
                    }
                } catch (e) {
                    console.error("Error confirmando asistencia por tiempo:", e);
                    return false;
                } finally {
                    asistenciaConfirmando = false;
                }
            }

            function iniciarReintentosAsistencia() {
                if (asistenciaRetryTimer || asistenciaTiempoConfirmada) return;
                asistenciaRetryTimer = setInterval(async () => {
                    const ok = await confirmarAsistenciaTiempo();
                    if (ok) {
                        detenerReintentosAsistencia();
                    }
                }, 15000);
            }

            function detenerReintentosAsistencia() {
                if (asistenciaRetryTimer) {
                    clearInterval(asistenciaRetryTimer);
                    asistenciaRetryTimer = null;
                }
            }

            function iniciarAsistenciaTiempo() {
                if (!asistenciaAutomatica || isTeacher) {
                    return;
                }
                if (preguntasAleatorias) {
                    return;
                }
                const minutosRequeridos = obtenerMinutosRequeridos();
                if (!minutosRequeridos) {
                    return;
                }
                if (asistenciaTimer) {
                    clearTimeout(asistenciaTimer);
                }
                marcarIngresoAsistenciaTiempo();
                asistenciaTimer = setTimeout(() => {
                    confirmarAsistenciaTiempo().then(ok => {
                        if (!ok) {
                            iniciarReintentosAsistencia();
                        }
                    });
                }, minutosRequeridos * 60 * 1000);
            }

            async function detenerAsistenciaTiempo() {
                if (!asistenciaAutomatica || isTeacher) {
                    return;
                }
                if (asistenciaTimer) {
                    clearTimeout(asistenciaTimer);
                    asistenciaTimer = null;
                }
                detenerReintentosAsistencia();
                await marcarSalidaAsistenciaTiempo();
                if (!asistenciaTiempoConfirmada) {
                    await confirmarAsistenciaTiempo();
                }
            }

            mostrarAvisoAsistenciaAutomatica();
            if (typeof programarCierreClase === 'function') {
                programarCierreClase();
            }

            if (asistenciaAutomatica && preguntasAleatorias && !isTeacher) {
                console.log("‚è∞ Iniciando monitoreo de asistencia autom√°tica por preguntas");
                setInterval(verificarPreguntaAsistencia, 60000); // Check every minute
            }

            async function verificarPreguntaAsistencia() {
                try {
                    const response = await fetch(`/api/clase/${claseId}/verificar-pregunta`);
                    if (response.status === 200) {
                        const pregunta = await response.json();
                        mostrarPregunta(pregunta);
                    }
                } catch (e) {
                    console.error("Error verificando preguntas:", e);
                }
            }

            let currentRonda = 0;
            let questionTimer = null;

            function mostrarPregunta(pregunta) {
                currentRonda = pregunta.ronda;
                document.getElementById('preguntaEnunciado').textContent = pregunta.enunciado;
                
                const container = document.getElementById('preguntaOpciones');
                container.innerHTML = '';
                
                pregunta.opciones.forEach(op => {
                    const btn = document.createElement('button');
                    btn.className = "w-full text-left px-4 py-3 border border-gray-300 rounded-lg hover:bg-blue-50 hover:border-blue-500 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500";
                    btn.innerText = op;
                    btn.onclick = () => enviarRespuesta(op);
                    container.appendChild(btn);
                });

                const modal = document.getElementById('modalPreguntaAsistencia');
                modal.classList.remove('hidden');
                
                // Timer
                let timeLeft = pregunta.tiempoLimite || 180;
                const totalTime = timeLeft;
                clearInterval(questionTimer);
                
                questionTimer = setInterval(() => {
                    timeLeft--;
                    document.getElementById('timeRemaining').innerText = timeLeft;
                    document.getElementById('progressBar').style.width = ((timeLeft / totalTime) * 100) + "%";
                    
                    if (timeLeft <= 0) {
                        enviarRespuesta("TIMEOUT"); // Ocultar y marcar fallida
                    }
                }, 1000);
            }

            async function enviarRespuesta(respuesta) {
                clearInterval(questionTimer);
                document.getElementById('modalPreguntaAsistencia').classList.add('hidden');
                
                try {
                    await fetch(`/api/clase/${claseId}/responder-pregunta`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            [csrfHeader]: csrfToken
                        },
                        body: JSON.stringify({
                            ronda: currentRonda,
                            respuesta: respuesta
                        })
                    });
                    console.log("‚úÖ Respuesta de asistencia enviada");
                } catch (e) {
                    console.error("Error enviando respuesta:", e);
                }
            }
        </script>

        <script th:if="${esDocente}">
            // El script anterior de detecci√≥n de join del docente ya no es necesario 
            // con la API externa, pero si tienes l√≥gica espec√≠fica de "Permitir Alumnos"
            // que dependa de botones externos, puedes adaptarla aqu√≠ usando `api`
            // en lugar de detecci√≥n de iframe.
        </script>
</body>

</html>
