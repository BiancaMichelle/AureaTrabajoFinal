<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${nombreCharla} ?: 'Videoconferencia'">Videoconferencia</title>
    
    <!-- Script de Jitsi -->
    <script src="https://8x8.vc/external_api.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            overflow-x: hidden;
        }
        
        /* Banner superior con publicidad de Aurea */
        .aurea-banner {
            background-color: #0D1B2A;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
            z-index: 100;
        }
        
        .aurea-banner-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .aurea-logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .aurea-logo {
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: #0D1B2A;
        }
        
        .aurea-info h1 {
            color: white;
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .aurea-info p {
            color: rgba(255,255,255,0.9);
            font-size: 14px;
        }
        
        .aurea-cta {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .btn-visitar {
            background: white;
            color: #0D1B2A;
            padding: 12px 30px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .btn-visitar:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            color: #0D1B2A;
        }
        
        .charla-info {
            color: white;
            text-align: right;
        }
        
        .charla-info p {
            margin: 5px 0;
            font-size: 14px;
        }
        
        .charla-info strong {
            font-weight: 600;
        }
        
        /* Contenedor de la videoconferencia */
        .video-container {
            width: 100%;
            min-height: 600px;
            height: calc(100vh - 220px);
            position: relative;
            background: #1a1a1a;
        }
        
        #jitsi-container {
            width: 100%;
            height: 100%;
            min-height: 600px;
            position: relative;
        }
        
        .loading-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            z-index: 10;
            background: rgba(0,0,0,0.7);
            padding: 40px;
            border-radius: 10px;
        }
        
        .loading-message i {
            font-size: 48px;
            margin-bottom: 20px;
            animation: spin 2s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .aurea-banner-content {
                flex-direction: column;
                text-align: center;
            }
            
            .charla-info {
                text-align: center;
            }
            
            .aurea-info h1 {
                font-size: 20px;
            }
            
            .btn-visitar {
                padding: 10px 20px;
                font-size: 14px;
            }
        }
        
        /* Footer */
        .footer {
            background-color: #0D1B2A;
            color: white;
            padding: 25px 20px;
            margin-top: 0;
        }
        
        .footer-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 30px;
        }
        
        .footer-section {
            flex: 1;
            min-width: 250px;
        }
        
        .footer-section h4 {
            color: white;
            font-size: 16px;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .footer-section p {
            color: rgba(255,255,255,0.9);
            line-height: 1.5;
            margin: 5px 0;
            font-size: 13px;
        }
        
        .footer-section p i {
            margin-right: 8px;
            width: 16px;
        }
        
        @media (max-width: 768px) {
            .footer-container {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>
    
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Banner de Aurea -->
    <div class="aurea-banner">
        <div class="aurea-banner-content">
            <div class="aurea-logo-section">
                <div class="aurea-logo">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <div class="aurea-info">
                    <h1>Aurea - Espacio Virtual</h1>
                    <p>Tu plataforma de aprendizaje online</p>
                </div>
            </div>
            
            <div class="charla-info" th:if="${nombreCharla}">
                <p><strong th:text="${nombreCharla}">Nombre de la Charla</strong></p>
                <p th:if="${fecha}"><i class="fas fa-calendar"></i> <span th:text="${fecha}"></span></p>
                <p th:if="${hora}"><i class="fas fa-clock"></i> <span th:text="${hora}"></span></p>
            </div>
            
            <div class="aurea-cta">
                <a href="/" target="_blank" class="btn-visitar">
                    <i class="fas fa-home"></i> Visitar Aurea
                </a>
            </div>
        </div>
    </div>
    
    <!-- Videoconferencia -->
    <div class="video-container">
        <div id="jitsi-container">
            <div class="loading-message" id="loading-message">
                <i class="fas fa-spinner"></i>
                <p>Cargando videoconferencia...</p>
            </div>
        </div>
    </div>
    
    <script th:inline="javascript">
        /*<![CDATA[*/
        console.log('üîµ Script cargado - Iniciando configuraci√≥n');
        
        // Esperar a que el DOM y el script de Jitsi est√©n cargados
        window.addEventListener('DOMContentLoaded', function() {
            console.log('üü¢ DOM Cargado');
            
            const roomName = /*[[${roomName}]]*/ 'sala-ejemplo';
            const moderador = /*[[${moderador}]]*/ 'Moderador';
            const jitsiDomain = '8x8.vc';
            const appId = 'vpaas-magic-cookie-4d1e506aae2b471cbc2f0512a81b7ee8';
            
            console.log('üìã Datos recibidos:');
            console.log('   - Room Name:', roomName);
            console.log('   - Moderador:', moderador);
            console.log('   - Domain:', jitsiDomain);
            console.log('   - App ID:', appId);
            
            // Verificar elementos DOM
            const container = document.querySelector('#jitsi-container');
            const loadingMsg = document.getElementById('loading-message');
            console.log('   - Container encontrado:', !!container);
            console.log('   - Loading message encontrado:', !!loadingMsg);
            
            if (!container) {
                console.error('‚ùå No se encontr√≥ el contenedor #jitsi-container');
                return;
            }
            
            // Configuraci√≥n de Jitsi
            const options = {
                roomName: appId + '/' + roomName,
                parentNode: container,
                width: '100%',
                height: '100%',
                configOverwrite: {
                    startWithAudioMuted: false,
                    startWithVideoMuted: false,
                    enableWelcomePage: false,
                    prejoinPageEnabled: true,
                    disableDeepLinking: true
                },
                interfaceConfigOverwrite: {
                    SHOW_JITSI_WATERMARK: false,
                    SHOW_WATERMARK_FOR_GUESTS: false,
                    SHOW_BRAND_WATERMARK: false,
                    BRAND_WATERMARK_LINK: '',
                    DEFAULT_BACKGROUND: '#1a1a1a',
                    DISABLE_JOIN_LEAVE_NOTIFICATIONS: false,
                    HIDE_INVITE_MORE_HEADER: false
                },
                userInfo: {
                    displayName: moderador || 'Participante'
                }
            };
            
            console.log('üì¶ Configuraci√≥n de Jitsi preparada');
            
            // Verificar que JitsiMeetExternalAPI est√© disponible
            if (typeof JitsiMeetExternalAPI === 'undefined') {
                console.error('‚ùå JitsiMeetExternalAPI no est√° definido');
                if (loadingMsg) {
                    loadingMsg.innerHTML = `
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error: No se pudo cargar Jitsi</p>
                        <p style="font-size: 12px; margin-top: 10px;">Por favor, verifica tu conexi√≥n a internet</p>
                    `;
                }
                return;
            }
            
            console.log('‚úÖ JitsiMeetExternalAPI disponible');
            
            // Inicializar Jitsi
            try {
                console.log('üöÄ Iniciando Jitsi Meet...');
                console.log('   - Sala completa:', options.roomName);
                
                const api = new JitsiMeetExternalAPI(jitsiDomain, options);
                
                console.log('‚úÖ API de Jitsi inicializada');
                
                // Ocultar mensaje de carga cuando la conferencia est√© lista
                api.addEventListener('videoConferenceJoined', (event) => {
                    console.log('‚úÖ Usuario unido a la conferencia:', event);
                    if (loadingMsg) {
                        loadingMsg.style.display = 'none';
                    }
                });
                
                api.addEventListener('videoConferenceLeft', () => {
                    console.log('üëã Usuario sali√≥ de la conferencia');
                });
                
                api.addEventListener('readyToClose', () => {
                    console.log('üî¥ Videoconferencia cerrada');
                });
                
                // Timeout para ocultar mensaje de carga si tarda mucho
                setTimeout(() => {
                    if (loadingMsg && loadingMsg.style.display !== 'none') {
                        loadingMsg.style.display = 'none';
                        console.log('‚è∞ Timeout: ocultando mensaje de carga');
                    }
                }, 10000);
                
            } catch (error) {
                console.error('‚ùå Error al iniciar Jitsi:', error);
                console.error('   Stack:', error.stack);
                if (loadingMsg) {
                    loadingMsg.innerHTML = `
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error al cargar la videoconferencia</p>
                        <p style="font-size: 12px; margin-top: 10px;">` + error.message + `</p>
                        <button onclick="location.reload()" style="margin-top: 15px; padding: 10px 20px; background: white; color: #667eea; border: none; border-radius: 5px; cursor: pointer;">
                            Recargar p√°gina
                        </button>
                    `;
                }
            }
        });
        
        console.log('üîµ Event listener registrado');
        /*]]>*/
    </script>
    
    <!-- Footer -->
    <footer class="footer">
        <div class="footer-container">
            <div class="footer-section">
                <h4>ICEP - Instituto de Capacitaci√≥n y Extensi√≥n Profesional</h4>
                <p>Transformando la educaci√≥n online con excelencia acad√©mica.</p>
            </div>
        </div>
    </footer>
</body>
</html>
