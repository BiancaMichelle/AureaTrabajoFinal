<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" layout:decorate="~{layout/base}">

<head>
    <title th:text="${curso.nombre + ' - Aula del Curso'}">Aula del Curso</title>
    <!-- CSRF Token -->
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <th:block th:if="${@environment.getProperty('app.useTailwindCdn','true') == 'true'}">
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            tailwind.config = {
                theme: {
                    extend: {
                        colors: {
                            customGrayLight: '#f8f9fa',
                            customGrayDark: '#343a40',
                            customGrayText: '#212529',
                            customBlue: '#007bff',
                            customGreen: '#28a745'
                        }
                    }
                }
            }
        </script>
    </th:block>
    <style>
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #f8f9fa;
        }

        #overlay,
        #toolsOverlay {
            transition: opacity 0.3s ease-in-out;
        }

        #sidebar,
        #toolsSidebar {
            transition: transform 0.3s ease-in-out;
        }

        /* Bloqueo por mora: capa completa y tarjeta informativa */
        .mora-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.65);
            backdrop-filter: blur(4px);
            z-index: 5000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            pointer-events: auto;
        }

        .mora-card {
            background: #ffffff;
            border-radius: 14px;
            max-width: 640px;
            width: 100%;
            padding: 24px;
            text-align: center;
            box-shadow: 0 18px 48px rgba(0, 0, 0, 0.2);
            border: 1px solid #e2e8f0;
        }

        .mora-card h3 {
            font-size: 1.35rem;
            margin-bottom: 0.6rem;
            color: #0f172a;
        }

        .mora-card p {
            color: #475569;
            margin-bottom: 0.75rem;
        }

        .mora-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 999px;
            font-weight: 600;
            background: #fef2f2;
            color: #b91c1c;
            border: 1px solid #fecdd3;
            margin-bottom: 12px;
        }

        .mora-overlay .icon {
            font-size: 22px;
        }

        /* Evita interacción con el contenido cuando hay mora */
        .mora-locked #main-container,
        .mora-locked #toolsSidebar,
        .mora-locked #sidebar,
        .mora-locked #overlay,
        .mora-locked #toolsOverlay {
            pointer-events: none;
            filter: blur(1.5px);
            user-select: none;
        }

        .mora-locked {
            overflow: hidden;
        }

        /* Estilos específicos para la navegación */
        .nav-tab-active {
            border-bottom-color: white;
            color: white;
            font-weight: 600;
        }

        /* Toast notifications */
        .toast-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            background: #fff;
            color: #1f2937;
            padding: 14px 16px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.12);
            border-left: 4px solid #3b82f6;
            max-width: 360px;
            display: flex;
            gap: 10px;
            align-items: flex-start;
            animation: slideInRight 0.3s ease-out;
        }

        .toast-notification.toast-warning {
            border-left-color: #f59e0b;
        }

        .toast-notification.toast-error {
            border-left-color: #ef4444;
        }

        .toast-notification.toast-success {
            border-left-color: #22c55e;
        }

        .toast-notification .toast-close {
            background: transparent;
            border: none;
            color: #6b7280;
            font-size: 16px;
            cursor: pointer;
            margin-left: auto;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(120%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .edit-icon {
            display: none;
            position: absolute;
            top: 12px;
            right: 12px;
            width: 34px;
            height: 34px;
            border-radius: 9999px;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 123, 255, 0.12);
            color: #007bff;
            border: 1px solid rgba(0, 123, 255, 0.35);
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.2s ease;
            cursor: pointer;
            z-index: 5;
        }

        .edit-icon:hover {
            background-color: #007bff;
            color: white;
            transform: scale(1.05);
        }

        /* Posición específica para el icono de editar en módulos (para no solapar con el ojo) */
        .edit-icon[data-edit-type="module"] {
            right: 56px;
        }

        .editable-block {
            position: relative;
        }

        body.edit-mode .editable-block {
            padding-top: 3.5rem !important;
        }

        body.edit-mode .edit-icon {
            display: inline-flex;
        }

        .module-visibility-toggle {
            display: inline-flex;
            position: absolute;
            top: 12px;
            right: 12px;
            width: 34px;
            height: 34px;
            border-radius: 9999px;
            align-items: center;
            justify-content: center;
            background-color: rgba(40, 167, 69, 0.12);
            color: #28a745;
            border: 1px solid rgba(40, 167, 69, 0.35);
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.2s ease;
            cursor: default;
            opacity: 0.7;
            z-index: 5;
        }

        .module-visibility-toggle:hover {
            /* Keep basic hover styles but they might not trigger if cursor is default? 
               Actually hover triggers on elements regardless of cursor. 
               We should scope hover effects to edit-mode if we want them deactivated visually.
            */
        }

        body.edit-mode .module-visibility-toggle {
            cursor: pointer;
            opacity: 1;
        }

        body.edit-mode .module-visibility-toggle:hover {
            background-color: #28a745;
            color: white;
            transform: scale(1.05);
        }

        /* Activity Visibility Toggle */
        .activity-visibility-toggle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 34px;
            height: 34px;
            border-radius: 9999px;
            background-color: rgba(40, 167, 69, 0.12);
            color: #28a745;
            border: 1px solid rgba(40, 167, 69, 0.35);
            transition: all 0.2s ease;
            cursor: default;
            opacity: 0.7;
            margin-left: 0.5rem;
            margin-right: 0.25rem;
            flex-shrink: 0;
        }

        body.edit-mode .activity-visibility-toggle {
            cursor: pointer;
            opacity: 1;
        }

        body.edit-mode .activity-visibility-toggle:hover {
            background-color: #28a745;
            color: white;
            transform: scale(1.05);
        }

        body.edit-mode .module-visibility-toggle:not(:disabled) {
            cursor: pointer;
        }

        body.edit-mode .module-visibility-toggle:disabled {
            opacity: 0.85;
            cursor: default;
            pointer-events: none;
        }

        .delete-icon {
            display: none;
            position: absolute;
            top: 12px;
            right: 100px;
            width: 34px;
            height: 34px;
            border-radius: 9999px;
            align-items: center;
            justify-content: center;
            background-color: rgba(220, 53, 69, 0.12);
            color: #dc3545;
            border: 1px solid rgba(220, 53, 69, 0.35);
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.2s ease;
            cursor: pointer;
            z-index: 5;
        }

        /* Ajuste para elementos sin botón de visibilidad (clases y actividades) */
        .delete-icon.no-visibility {
            right: 56px;
        }

        .delete-icon:hover {
            background-color: #dc3545;
            color: white;
            transform: scale(1.05);
        }

        body.edit-mode .delete-icon {
            display: inline-flex;
        }

        #editModeHint {
            display: none;
        }

        body.edit-mode #editModeHint {
            display: flex;
        }

        body.edit-mode #toolsOverlay {
            pointer-events: none;
            background-color: rgba(13, 110, 253, 0.18) !important;
            opacity: 1 !important;
        }

        /* Moodle-like Theme Overrides */
        :root {
            --moodle-primary: #0f6cb4;
            --moodle-secondary: #f8f9fa;
            --moodle-text: #343a40;
            --moodle-border: #dee2e6;
            --moodle-hover: #e9ecef;
        }

        body {
            background-color: #f2f2f2;
            /* Light gray background like Moodle */
            color: var(--moodle-text);
        }

        /* Breadcrumbs */
        .breadcrumb-container {
            background: white;
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--moodle-border);
            margin-bottom: 2rem;
        }

        .breadcrumb-item+.breadcrumb-item::before {
            content: "/";
            color: #6c757d;
        }

        /* Course Header */
        .course-header-card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-bottom: 2rem;
            border-left: 5px solid var(--moodle-primary);
        }

        /* Module Cards */
        .moodle-module {
            background: white;
            border: 1px solid var(--moodle-border);
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }

        .moodle-module:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .module-header {
            padding: 1.25rem;
            border-bottom: 1px solid var(--moodle-border);
            background-color: #fff;
            border-radius: 0.5rem 0.5rem 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .module-title {
            color: var(--moodle-primary);
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
        }

        .module-content {
            padding: 1.25rem;
        }

        /* Activity Items */
        .activity-item {
            display: flex;
            align-items: flex-start;
            padding: 1rem;
            border-bottom: 1px solid #f1f1f1;
            transition: background-color 0.2s;
            position: relative;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-item:hover {
            background-color: #fcfcfc;
        }

        .activity-icon-container {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            margin-right: 1rem;
            flex-shrink: 0;
        }

        .activity-icon-container.pdf {
            background-color: #ffebee;
            color: #c62828;
        }

        .activity-icon-container.video {
            background-color: #e3f2fd;
            color: #1565c0;
        }

        .activity-icon-container.quiz {
            background-color: #f3e5f5;
            color: #7b1fa2;
        }

        .activity-icon-container.assignment {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .activity-icon-container.folder {
            background-color: #fff8e1;
            color: #fbc02d;
        }

        .activity-icon-container.generic {
            background-color: #eceff1;
            color: #546e7a;
        }

        .activity-icon {
            font-size: 1.5rem;
        }

        .activity-details h5 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: #2d3748;
        }

        .activity-details p {
            font-size: 0.875rem;
            color: #718096;
            margin-bottom: 0;
        }

        .activity-meta {
            font-size: 0.75rem;
            color: #a0aec0;
            margin-top: 0.5rem;
            display: flex;
            gap: 1rem;
        }

        /* Edit Mode Toggles */
        .edit-controls {
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            /* Hidden by default */
            transition: opacity 0.2s;
        }

        body.edit-mode .edit-controls {
            opacity: 1;
        }

    </style>
</head>

<body class="bg-customGrayLight font-sans text-customGrayText" layout:fragment="content">

    <div th:replace="~{fragments/modal-CrearClase}"></div>
    <!-- Panel Lateral Izquierdo (Herramientas de Modificación) -->
    <aside id="toolsSidebar"
        class="fixed top-0 left-0 h-full w-72 bg-white border-r border-gray-200 shadow-xl transform -translate-x-full z-40 overflow-y-auto">
        <div class="p-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-800">
                <i class="fas fa-tools me-2"></i>Herramientas
            </h2>
            <button id="closeToolsButton" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <nav class="p-4">
            <ul class="space-y-2">
                <li>
                    <button id="createModuleButton"
                        class="w-full text-left py-2 px-3 rounded-md bg-customGreen text-white hover:bg-green-700 transition-colors duration-150">
                        <i class="fas fa-folder-plus me-2"></i>Crear Módulo
                    </button>
                </li>
                <li>
                    <button id="createActivityButton"
                        class="w-full text-left py-2 px-3 rounded-md bg-customGreen text-white hover:bg-green-700 transition-colors duration-150">
                        <i class="fas fa-tasks me-2"></i>Crear Actividad
                    </button>
                </li>
                <li>
                    <button id="createClassButton"
                        class="w-full text-left py-2 px-3 rounded-md bg-customGreen text-white hover:bg-green-700 transition-colors duration-150">
                        <i class="fas fa-video me-2"></i>Crear Clase
                    </button>
                </li>
                <li>
                    <button id="toggleEditModeButton"
                        class="w-full text-left py-2 px-3 rounded-md bg-blue-100 text-customBlue hover:bg-blue-200 transition-colors duration-150">
                        <i class="fas fa-pen-to-square me-2"></i>Editar Contenido
                    </button>
                </li>
            </ul>
        </nav>
    </aside>

    <!-- Modal para crear módulo -->
    <div id="moduleModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[110] hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-xl max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-semibold mb-4">
                <i class="fas fa-folder-plus me-2"></i>Crear Nuevo Módulo
            </h3>
            <form id="createModuleForm"
                th:action="@{/crearModulo}" method="post"
                th:attr="data-curso-inicio=${curso.fechaInicio != null ? #temporals.format(curso.fechaInicio, 'yyyy-MM-dd') : ''},
                         data-curso-fin=${curso.fechaFin != null ? #temporals.format(curso.fechaFin, 'yyyy-MM-dd') : ''}">
                <input type="hidden" name="cursoId" th:value="${curso.idOferta}">
                <input type="hidden" name="_csrf" th:value="${_csrf.token}">

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">
                        <i class="fas fa-heading me-1"></i>Nombre del módulo *
                    </label>
                    <input type="text" name="nombre"
                        class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2"
                        placeholder="Ej: Módulo 1: Introducción" required>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">
                        <i class="fas fa-align-left me-1"></i>Descripción *
                    </label>
                    <textarea name="descripcion" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2"
                        rows="3" placeholder="Describe el contenido del módulo..." required></textarea>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">
                        <i class="fas fa-bullseye me-1"></i>Objetivos
                    </label>
                    <textarea name="objetivos" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2"
                        rows="2" placeholder="Objetivos del módulo (opcional)"></textarea>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">
                        <i class="fas fa-list me-1"></i>Temario
                    </label>
                    <textarea name="temario" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2"
                        rows="2" placeholder="Temas a tratar (opcional)"></textarea>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">
                        <i class="fas fa-book me-1"></i>Bibliografía
                    </label>
                    <textarea name="bibliografia" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2"
                        rows="2" placeholder="Bibliografía recomendada (opcional)"></textarea>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">
                            <i class="fas fa-calendar-alt me-1"></i>Fecha de Inicio
                        </label>
                        <input type="date" name="fechaInicio"
                            class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">
                            <i class="fas fa-calendar-check me-1"></i>Fecha de Fin
                        </label>
                        <input type="date" name="fechaFin"
                            class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="flex items-center">
                        <input type="checkbox" name="visibilidad" value="true" checked
                            class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <span class="ml-2 text-sm font-medium text-gray-700">
                            <i class="fas fa-eye me-1"></i>Módulo visible para estudiantes
                        </span>
                    </label>
                    <small class="text-gray-500 ml-6">Si está desmarcado, solo los docentes podrán verlo</small>
                </div>

                <div class="flex justify-end space-x-2 pt-4 border-t">
                    <button type="button" onclick="closeModuleModal()"
                        class="px-4 py-2 text-gray-600 hover:text-gray-800 border border-gray-300 rounded-md">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </button>
                    <button type="submit" class="px-4 py-2 bg-customGreen text-white rounded-md hover:bg-green-700">
                        <i class="fas fa-plus me-1"></i>Crear Módulo
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para editar módulo -->
    <div id="editModuleModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-start justify-between mb-4">
                <h3 class="text-lg font-semibold">
                    <i class="fas fa-pen-to-square me-2"></i>Editar módulo
                </h3>
                <button id="closeEditModuleButton" type="button"
                    class="text-gray-500 hover:text-gray-800 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="editModuleForm" th:action="@{/modulo/actualizar}" method="post"
                th:attr="data-curso-inicio=${curso.fechaInicio != null ? #temporals.format(curso.fechaInicio, 'yyyy-MM-dd') : ''},
                         data-curso-fin=${curso.fechaFin != null ? #temporals.format(curso.fechaFin, 'yyyy-MM-dd') : ''}">
                <input type="hidden" name="_csrf" th:value="${_csrf.token}">
                <input type="hidden" name="cursoId" th:value="${curso.idOferta}">
                <input type="hidden" name="moduloId" value="">

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">
                        <i class="fas fa-heading me-1"></i>Nombre del módulo *
                    </label>
                    <input type="text" name="nombre" required
                        class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2"
                        placeholder="Nombre del módulo">
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">
                        <i class="fas fa-align-left me-1"></i>Descripción *
                    </label>
                    <textarea name="descripcion" rows="3" required
                        class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2"
                        placeholder="Describe el contenido del módulo"></textarea>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">
                        <i class="fas fa-bullseye me-1"></i>Objetivos
                    </label>
                    <textarea name="objetivos" rows="2"
                        class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2"
                        placeholder="Objetivos del módulo"></textarea>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">
                        <i class="fas fa-list me-1"></i>Temario
                    </label>
                    <textarea name="temario" rows="2"
                        class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2"
                        placeholder="Temas a tratar"></textarea>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">
                        <i class="fas fa-book me-1"></i>Bibliografía
                    </label>
                    <textarea name="bibliografia" rows="2"
                        class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2"
                        placeholder="Bibliografía recomendada"></textarea>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">
                            <i class="fas fa-calendar-alt me-1"></i>Fecha de inicio
                        </label>
                        <input type="date" name="fechaInicio"
                            class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">
                            <i class="fas fa-calendar-check me-1"></i>Fecha de fin
                        </label>
                        <input type="date" name="fechaFin"
                            class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="flex items-center">
                        <input type="checkbox" name="visibilidad" value="true"
                            class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <span class="ml-2 text-sm font-medium text-gray-700">
                            <i class="fas fa-eye me-1"></i>Visible para estudiantes
                        </span>
                    </label>
                </div>

                <div class="flex justify-end space-x-2 pt-4 border-t">
                    <button type="button" onclick="closeEditModuleModal()"
                        class="px-4 py-2 text-gray-600 hover:text-gray-800 border border-gray-300 rounded-md">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </button>
                    <button type="submit" class="px-4 py-2 bg-customBlue text-white rounded-md hover:bg-blue-700">
                        <i class="fas fa-save me-1"></i>Actualizar módulo
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de confirmación para eliminar -->
    <div id="deleteConfirmModal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <div class="flex items-start mb-4">
                <div class="flex-shrink-0 w-12 h-12 rounded-full bg-red-100 flex items-center justify-center mr-4">
                    <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                </div>
                <div class="flex-1">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">¿Estás seguro?</h3>
                    <p class="text-sm text-gray-600">
                        ¿Estás seguro de que deseas eliminar
                        <span id="deleteItemType">este elemento</span>
                        "<span id="deleteItemName" class="font-semibold"></span>"?
                        Esta acción no se puede deshacer.
                    </p>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button type="button" onclick="closeDeleteModal()"
                    class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <button type="button" id="confirmDeleteButton"
                    class="px-4 py-2 bg-red-600 text-white hover:bg-red-700 rounded-md transition-colors">
                    <i class="fas fa-trash me-1"></i>Eliminar
                </button>
            </div>
        </div>
    </div>

    <!-- Header del Aula -->
    <header class="bg-customGrayDark text-white p-4 py-8 shadow-md relative z-10">
        <div class="max-w-7xl mx-auto flex justify-between items-center relative gap-4">
            <div>
                <h1 class="text-3xl font-bold tracking-wider" th:text="${curso.nombre}">IMAGEN DEL CURSO</h1>
                <p class="text-gray-300 text-sm mt-1" th:text="${curso.descripcion}">Descripción</p>
            </div>

            <div class="flex items-center gap-4">
                <!-- Info Fechas y Horarios -->
                <div
                    class="hidden md:flex flex-col bg-gray-800/60 backdrop-blur-sm px-4 py-2 rounded-lg border border-gray-600 text-xs shadow-sm">
                    <div class="flex items-center gap-2 mb-1" title="Vigencia del Cursado">
                        <i class="fas fa-calendar-alt text-green-400"></i>
                        <span class="font-mono text-gray-200">
                            <span th:text="${#temporals.format(curso.fechaInicio, 'dd/MM/yyyy')}">01/01</span>
                            <span class="mx-1 text-gray-500">➜</span>
                            <span th:text="${#temporals.format(curso.fechaFin, 'dd/MM/yyyy')}">31/12</span>
                        </span>
                    </div>
                    <div th:if="${not #lists.isEmpty(curso.horarios)}"
                        class="flex items-start gap-2 border-t border-gray-700 pt-1 mt-1">
                        <i class="fas fa-clock text-blue-400 mt-0.5"></i>
                        <div class="flex flex-col gap-0.5">
                            <span th:each="h : ${curso.horarios}" class="font-mono text-gray-300">
                                <span th:text="${#strings.substring(h.dia, 0, 3)}">LUN</span>
                                <span
                                    th:text="|${#strings.substring(h.horaInicio, 0, 5)} - ${#strings.substring(h.horaFin, 0, 5)}|">09:00
                                    - 11:00</span>
                            </span>
                        </div>
                    </div>
                </div>

                <div th:if="${puedeModificar}" class="flex items-center gap-2 flex-shrink-0">
                    <form th:action="@{/docente/aula/{ofertaId}/analizar-rendimiento(ofertaId=${curso.idOferta})}"
                        method="post" class="inline">
                        <button type="submit"
                            class="bg-yellow-600/80 hover:bg-yellow-600 text-white px-4 py-2 rounded-md shadow transition-colors text-sm font-medium flex items-center border border-yellow-500/50"
                            onclick="return confirm('¿Estás seguro de iniciar el análisis de rendimiento? Se enviarán alertas a los docentes.')">
                            <i class="fas fa-chart-line me-2"></i> Analizar
                        </button>
                    </form>
                    <button id="modifyCourseButton"
                        class="bg-blue-600/80 hover:bg-blue-600 text-white px-4 py-2 rounded-md shadow transition-colors text-sm font-medium flex items-center border border-blue-500/50">
                        <i class="fas fa-edit me-2"></i> Activar Edición
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Barra de Navegación -->
    <nav class="bg-customGreen border-b border-gray-200 shadow-sm relative z-10 mb-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center space-x-6">
                <!-- Ícono de búsqueda -->
                <div class="py-3 px-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>

                <!-- 1. Contenido (Activo) -->
                <a href="#" class="py-3 px-1 border-b-2 border-white text-white font-semibold text-sm nav-tab-active">
                    Contenido
                </a>

                <!-- 2. Participantes (Solo Docente/Admin) -->
                <a sec:authorize="hasAnyAuthority('DOCENTE', 'ADMIN')"
                    th:href="@{/aula/oferta/{id}/participantes(id=${curso.idOferta})}"
                    class="py-3 px-1 border-b-2 border-transparent text-gray-100 hover:border-gray-300 hover:text-white font-medium text-sm transition-colors duration-200 nav-tab-inactive">
                    Participantes
                </a>

                <!-- 3. Asistencia -->
                <a th:href="@{/aula/oferta/{id}/asistencia(id=${curso.idOferta})}"
                    class="py-3 px-1 border-b-2 border-transparent text-gray-100 hover:border-gray-300 hover:text-white font-medium text-sm transition-colors duration-200 nav-tab-inactive">
                    Asistencia
                </a>

                <!-- 4. Calificaciones -->
                <a th:href="@{/aula/oferta/{id}/calificaciones(id=${curso.idOferta})}"
                    class="py-3 px-1 border-b-2 border-transparent text-gray-100 hover:border-gray-300 hover:text-white font-medium text-sm transition-colors duration-200 nav-tab-inactive">
                    Calificaciones
                </a>


            </div>
        </div>
    </nav>

    <!-- Contenido principal -->
    <div id="main-container" class="relative min-h-screen pb-12">

        <!-- Breadcrumbs REMOVED -->

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">

                <!-- Columna Principal (Contenido) -->
                <div class="lg:col-span-3">

                    <!-- Old Course Header Removed -->

                    <!-- Navegación de Gestión (Docente) - Removed as integrated in Top Nav -->

                    <div id="editModeHint" role="status" aria-hidden="true" aria-live="polite"
                        class="hidden items-center gap-3 mb-6 px-4 py-3 rounded-md border border-dashed border-blue-400 bg-blue-50 text-blue-700 text-sm uppercase tracking-wide">
                        <i class="fas fa-pen-to-square"></i>
                        <span>Modo edición activo</span>
                    </div>

                    <!-- Lista de Módulos -->
                    <div id="courseContent">
                        <div th:each="modulo, moduloStat : ${modulos}" class="moodle-module editable-block"
                            th:data-modulo-id="${modulo.idModulo}" th:data-modulo-nombre="${modulo.nombre}"
                            th:data-modulo-descripcion="${modulo.descripcion != null ? modulo.descripcion : ''}"
                            th:data-modulo-objetivos="${modulo.objetivos != null ? modulo.objetivos : ''}"
                            th:data-modulo-temario="${modulo.temario != null ? modulo.temario : ''}"
                            th:data-modulo-bibliografia="${modulo.bibliografia != null ? modulo.bibliografia : ''}"
                            th:data-modulo-inicio="${#temporals.format(modulo.fechaInicioModulo, 'yyyy-MM-dd')}"
                            th:data-modulo-fin="${#temporals.format(modulo.fechaFinModulo, 'yyyy-MM-dd')}"
                            th:data-modulo-visible="${modulo.visibilidad != null ? modulo.visibilidad : false}">

                            <!-- Cabecera del Módulo -->
                            <div class="module-header">
                                <div>
                                    <h3 class="module-title" th:text="${modulo.nombre}">Módulo 1</h3>
                                    <span class="text-xs text-gray-500 font-medium uppercase tracking-wider"
                                        th:text="${#temporals.format(modulo.fechaInicioModulo, 'dd/MM/yyyy')} + ' - ' + ${#temporals.format(modulo.fechaFinModulo, 'dd/MM/yyyy')}">
                                        Fechas
                                    </span>
                                </div>
                                <button type="button" class="module-visibility-toggle text-gray-500 hover:text-blue-600"
                                    th:if="${puedeModificar}"
                                    th:attr="data-visible=${modulo.visibilidad != null ? modulo.visibilidad : false}">
                                    <i class="fas"
                                        th:classappend="${modulo.visibilidad != null ? (modulo.visibilidad ? ' fa-eye' : ' fa-eye-slash') : ' fa-eye-slash'}"></i>
                                </button>
                                <div class="edit-controls">
                                    <button type="button" class="edit-icon text-blue-600 hover:text-blue-800"
                                        data-edit-type="module" th:data-modulo-id="${modulo.idModulo}">
                                        <i class="fas fa-pen"></i>
                                    </button>
                                    <button type="button" class="delete-icon text-red-500 hover:text-red-700"
                                        data-delete-type="modulo" th:data-modulo-id="${modulo.idModulo}"
                                        th:data-modulo-nombre="${modulo.nombre}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="module-content">
                                <!-- Metadata Módulo (Top) -->
                                <div class="bg-blue-50/50 rounded-lg p-4 mb-6 border border-blue-100"
                                    th:if="${(modulo.descripcion != null and !modulo.descripcion.isEmpty()) or (modulo.objetivos != null and !modulo.objetivos.isEmpty()) or (modulo.fechaInicioModulo != null)}">

                                    <div th:if="${modulo.descripcion != null and !modulo.descripcion.isEmpty()}"
                                        class="mb-3">
                                        <h6
                                            class="text-xs font-bold text-gray-700 uppercase mb-1 flex items-center gap-2">
                                            <i class="fas fa-info-circle text-blue-500"></i> Descripción
                                        </h6>
                                        <p class="text-gray-600 text-sm leading-relaxed"
                                            th:text="${modulo.descripcion}"></p>
                                    </div>

                                    <div th:if="${modulo.objetivos != null and !modulo.objetivos.isEmpty()}"
                                        class="mb-3">
                                        <h6
                                            class="text-xs font-bold text-gray-700 uppercase mb-1 flex items-center gap-2">
                                            <i class="fas fa-bullseye text-blue-500"></i> Objetivos
                                        </h6>
                                        <div class="text-gray-600 text-sm leading-relaxed"
                                            th:utext="${modulo.objetivos}"></div>
                                    </div>

                                    <div th:if="${modulo.fechaInicioModulo != null}"
                                        class="flex items-center gap-2 text-xs text-gray-500 pt-2 border-t border-blue-100 mt-2">
                                        <i class="far fa-calendar-alt text-blue-500"></i>
                                        <span class="font-medium">Vigencia:</span>
                                        <span
                                            th:text="${#temporals.format(modulo.fechaInicioModulo, 'dd/MM/yyyy')}"></span>
                                        <span th:if="${modulo.fechaFinModulo != null}" class="mx-1">-</span>
                                        <span th:if="${modulo.fechaFinModulo != null}"
                                            th:text="${#temporals.format(modulo.fechaFinModulo, 'dd/MM/yyyy')}"></span>
                                    </div>
                                </div>

                                <!-- Clases -->
                                <div th:if="${not #lists.isEmpty(modulo.clases)}" class="mb-6">
                                    <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 ml-2">
                                        Clases en Vivo</h4>
                                    <div class="space-y-2">
                                        <div th:each="clase : ${modulo.clases}" class="activity-item editable-block"
                                            th:data-clase-id="${clase.idClase}" th:data-clase-titulo="${clase.titulo}"
                                            th:data-clase-descripcion="${clase.descripcion}"
                                            th:data-clase-inicio="${#temporals.format(clase.inicio, 'yyyy-MM-dd''T''HH:mm')}"
                                            th:data-clase-fin="${#temporals.format(clase.fin, 'yyyy-MM-dd''T''HH:mm')}">

                                            <div class="activity-icon-container video">
                                                <i class="fas fa-video activity-icon"></i>
                                            </div>

                                            <div class="flex-1 activity-details">
                                                <div class="flex justify-between items-start">
                                                    <div>
                                                        <h5 th:text="${clase.titulo}">Título Clase</h5>
                                                        <p th:text="${clase.descripcion}">Descripción</p>
                                                        <div class="activity-meta">
                                                            <span><i class="far fa-calendar me-1"></i> <span
                                                                    th:text="${#temporals.format(clase.inicio, 'dd/MM/yyyy HH:mm')}"></span></span>
                                                            <span th:if="${clase.meetingUrl}"
                                                                class="text-green-600 font-medium"><i
                                                                    class="fas fa-circle text-[8px] me-1"></i> En
                                                                vivo</span>
                                                        </div>
                                                    </div>
                                                    <a href="#" th:data-id="${clase.idClase}"
                                                        th:data-titulo="${clase.titulo}"
                                                        onclick="iniciarIngresoClase(this.getAttribute('data-id'), this.getAttribute('data-titulo')); return false;"
                                                        class="btn btn-sm rounded-pill px-3"
                                                        th:classappend="${docente != null} ? 'btn-primary text-white' : 'btn-outline-primary'"
                                                        th:text="${docente != null} ? 'Iniciar Clase' : 'Entrar'">
                                                        Entrar
                                                    </a>
                                                </div>
                                            </div>

                                            <div class="edit-controls ml-3">
                                                <button type="button" class="edit-icon text-blue-600"
                                                    data-edit-type="clase" th:data-clase-id="${clase.idClase}"><i
                                                        class="fas fa-pen"></i></button>
                                                <button type="button" class="delete-icon text-red-500"
                                                    data-delete-type="clase" th:data-clase-id="${clase.idClase}"
                                                    th:data-clase-nombre="${clase.titulo}"><i
                                                        class="fas fa-trash"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Actividades -->
                                <div th:if="${not #lists.isEmpty(modulo.actividades)}">
                                    <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 ml-2">
                                        Recursos y Actividades</h4>
                                    <div class="space-y-2">
                                        <div th:each="actividad : ${modulo.actividades}"
                                            th:if="${actividad instanceof T(com.example.demo.model.Material) ? actividad.carpeta == null : true}"
                                            class="activity-item editable-block"
                                            th:classappend="${actividad instanceof T(com.example.demo.model.Carpeta) ? 'flex-wrap' : ''}"
                                            th:data-actividad-id="${actividad.idActividad}"
                                            th:data-actividad-titulo="${actividad.titulo}"
                                            th:data-actividad-descripcion="${actividad.descripcion}"
                                            th:data-actividad-tipo="${actividad.tipoActividad}"
                                            th:data-actividad-contenido="${actividad.contenidoTextoActividad}"
                                            th:data-actividad-url="${actividad.urlActividad}"
                                            th:data-actividad-apertura="${actividad.fechaAperturaActividad != null ? #temporals.format(actividad.fechaAperturaActividad, 'yyyy-MM-dd''T''HH:mm:ss') : ''}"
                                            th:data-actividad-apertura-text="${actividad.fechaAperturaActividad != null ? #temporals.format(actividad.fechaAperturaActividad, 'dd/MM/yyyy HH:mm') : ''}">

                                            <!-- Icono Dinámico -->
                                            <div class="activity-icon-container"
                                                th:if="${!(actividad instanceof T(com.example.demo.model.Recurso) and actividad.tipo.name() == 'TEXTO')}"
                                                th:classappend="${actividad instanceof T(com.example.demo.model.Examen) ? 'quiz' : 
                                                                 (actividad instanceof T(com.example.demo.model.Tarea) ? 'assignment' : 
                                                                 (actividad instanceof T(com.example.demo.model.Carpeta) ? 'folder' : 
                                                                 (actividad instanceof T(com.example.demo.model.Recurso) and actividad.tipo.name() == 'ENLACE' ? 'generic' : 'pdf')))}">
                                                <i class="fas"
                                                    th:classappend="${actividad instanceof T(com.example.demo.model.Examen) ? 'fa-clipboard-check' : 
                                                                    (actividad instanceof T(com.example.demo.model.Tarea) ? 'fa-tasks' : 
                                                                    (actividad instanceof T(com.example.demo.model.Carpeta) ? 'fa-folder' : 
                                                                    (actividad instanceof T(com.example.demo.model.Recurso) and actividad.tipo.name() == 'ENLACE' ? 'fa-link' : 'fa-file-alt')))}"></i>
                                            </div>

                                            <div class="flex-1 activity-details">
                                                <div class="flex justify-between items-start">
                                                    <div class="w-full">
                                                        <th:block
                                                            th:unless="${actividad instanceof T(com.example.demo.model.Recurso) and actividad.tipo.name() == 'TEXTO'}">
                                                            <h5 th:if="${!(actividad instanceof T(com.example.demo.model.Recurso) and actividad.tipo.name() == 'ENLACE')}"
                                                                th:text="${actividad.titulo}">Título Actividad</h5>
                                                            <h5
                                                                th:if="${actividad instanceof T(com.example.demo.model.Recurso) and actividad.tipo.name() == 'ENLACE'}">
                                                                <a th:href="${actividad.url}" target="_blank"
                                                                    class="text-blue-600 hover:underline js-actividad-enlace">
                                                                    <i
                                                                        class="fas fa-external-link-alt text-xs me-1"></i>
                                                                    <span th:text="${actividad.titulo}">Link</span>
                                                                </a>
                                                            </h5>
                                                            <p th:text="${actividad.descripcion}">Descripción</p>
                                                        </th:block>

                                                        <div th:if="${actividad instanceof T(com.example.demo.model.Recurso) and actividad.tipo.name() == 'TEXTO'}"
                                                            class="mb-2">
                                                            <h5 th:if="${actividad.titulo != null and !actividad.titulo.isEmpty()}"
                                                                th:text="${actividad.titulo}" class="font-bold mb-2">
                                                            </h5>
                                                            <div th:utext="${actividad.contenidoTexto}"
                                                                class="text-gray-700"></div>
                                                        </div>

                                                        <!-- Detalles específicos -->
                                                        <div th:if="${actividad instanceof T(com.example.demo.model.Material)}"
                                                            class="mt-1">
                                                            <div th:each="archivo : ${actividad.archivos}"
                                                                class="text-xs text-gray-500 flex items-center gap-1">
                                                                <i class="fas fa-paperclip"></i> <span
                                                                    th:text="${archivo.nombre}">archivo.pdf</span>
                                                            </div>
                                                        </div>

                                                        <div th:if="${actividad instanceof T(com.example.demo.model.Examen)}"
                                                            class="activity-meta">
                                                            <span th:if="${actividad.fechaApertura}">Abre: <span
                                                                    th:text="${#temporals.format(actividad.fechaApertura, 'dd/MM/yyyy HH:mm')}"></span></span>
                                                            <span th:if="${actividad.tiempoRealizacion}"> • <span
                                                                    th:text="${actividad.tiempoRealizacion}"></span>
                                                                min</span>
                                                        </div>
                                                    </div>

                                                    <!-- Botones de Acción -->
                                                    <div>
                                                        <button
                                                            th:if="${actividad instanceof T(com.example.demo.model.Material)}"
                                                            th:attr="data-material-id=${actividad.idActividad}, data-material-nombre=${actividad.titulo}"
                                                            onclick="descargarMaterial(this)"
                                                            class="btn btn-sm btn-light text-gray-600 hover:text-blue-600">
                                                            <i class="fas fa-download"></i>
                                                        </button>

                                                        <th:block
                                                            th:if="${actividad instanceof T(com.example.demo.model.Tarea)}">
                                                            <button th:data-id="${actividad.idActividad}"
                                                                th:data-titulo="${actividad.titulo}"
                                                                th:data-descripcion="${actividad.descripcion}"
                                                                th:data-limite="${actividad.limiteEntrega}"
                                                                th:data-tardias="${actividad.entregasTardias}"
                                                                th:data-modificaciones="${actividad.modificaciones}"
                                                                th:data-entrega-id="${tareasEntregas != null && tareasEntregas.containsKey(actividad.idActividad) ? tareasEntregas.get(actividad.idActividad).idEntrega : ''}"
                                                                th:data-entrega-fecha="${tareasEntregas != null && tareasEntregas.containsKey(actividad.idActividad) ? tareasEntregas.get(actividad.idActividad).fechaEntrega : ''}"
                                                                th:data-entrega-calif="${tareasEntregas != null && tareasEntregas.containsKey(actividad.idActividad) ? tareasEntregas.get(actividad.idActividad).calificacion : ''}"
                                                                th:data-entrega-archivo="${tareasEntregas != null && tareasEntregas.containsKey(actividad.idActividad) ? tareasEntregas.get(actividad.idActividad).nombreArchivo : ''}"
                                                                th:data-entrega-texto="${tareasEntregas != null && tareasEntregas.containsKey(actividad.idActividad) ? tareasEntregas.get(actividad.idActividad).contenido : ''}"
                                                                th:data-tipo-entrega="${#strings.listJoin(actividad.tipoEntrega, ',')}"
                                                                onclick="abrirModalTarea(this)"
                                                                class="btn btn-sm btn-outline-primary rounded-pill px-3 js-ver-tarea">
                                                                Ver Tarea
                                                            </button>
                                                            <a th:if="${puedeModificar}"
                                                                th:href="@{/entrega/lista/{id}(id=${actividad.idActividad})}"
                                                                class="btn btn-sm btn-outline-success rounded-pill px-3 ml-1"
                                                                title="Corregir Entregas">
                                                                <i class="fas fa-check-double mr-1"></i>Corregir
                                                            </a>
                                                        </th:block>

                                                        <th:block
                                                            th:if="${actividad instanceof T(com.example.demo.model.Examen)}">
                                                            <a th:unless="${puedeModificar}"
                                                                th:href="@{/examen/realizar/{id}(id=${actividad.idActividad})}"
                                                                th:attr="data-examen-url=@{/examen/realizar/{id}(id=${actividad.idActividad})}"
                                                                class="btn btn-sm btn-outline-primary rounded-pill px-3 js-ver-examen">
                                                                Ver Examen
                                                            </a>
                                                            <a th:if="${puedeModificar}"
                                                                th:href="@{/examen/detalle/{id}(id=${actividad.idActividad})}"
                                                                class="btn btn-sm btn-outline-primary rounded-pill px-3">
                                                                Ver Examen
                                                            </a>
                                                        </th:block>

                                                        <button
                                                            th:if="${actividad instanceof T(com.example.demo.model.Carpeta)}"
                                                            th:attr="data-carpeta-id=${actividad.idActividad}"
                                                            onclick="toggleCarpetaInline(this)"
                                                            class="btn btn-sm btn-light text-yellow-600 toggle-folder-btn js-toggle-carpeta">
                                                            <i class="fas fa-folder"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>

                                            <button type="button"
                                                class="activity-visibility-toggle text-gray-500 hover:text-blue-600"
                                                th:if="${puedeModificar}"
                                                th:attr="data-visible=${actividad.visibilidad != null ? actividad.visibilidad : false}">
                                                <i class="fas"
                                                    th:classappend="${actividad.visibilidad != null ? (actividad.visibilidad ? ' fa-eye' : ' fa-eye-slash') : ' fa-eye-slash'}"></i>
                                            </button>

                                            <div class="edit-controls ml-3">
                                                <button type="button" class="edit-icon text-blue-600"
                                                    data-edit-type="actividad"
                                                    th:data-actividad-id="${actividad.idActividad}"
                                                    th:if="${!(actividad instanceof T(com.example.demo.model.Material))}"><i
                                                        class="fas fa-pen"></i></button>
                                                <button type="button" class="delete-icon text-red-500"
                                                    data-delete-type="actividad"
                                                    th:data-actividad-id="${actividad.idActividad}"
                                                    th:data-actividad-nombre="${actividad.titulo}"><i
                                                        class="fas fa-trash"></i></button>
                                            </div>

                                            <!-- Contenedor desplegable para Carpeta -->
                                            <div th:if="${actividad instanceof T(com.example.demo.model.Carpeta)}"
                                                th:id="'carpeta-content-' + ${actividad.idActividad}"
                                                class="w-full hidden mt-3 pl-4 border-l-4 border-yellow-100 bg-gray-50/50 rounded-r-lg">
                                                <div class="py-4 text-center text-gray-500 text-sm">
                                                    <i class="fas fa-spinner fa-spin me-2"></i>Cargando contenido...
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Empty State -->
                        <div th:if="${#lists.isEmpty(modulos)}"
                            class="text-center py-12 bg-white rounded-lg border border-dashed border-gray-300">
                            <i class="fas fa-book-open text-4xl text-gray-300 mb-3"></i>
                            <p class="text-gray-500">Este curso aún no tiene contenido.</p>
                        </div>
                    </div>
                </div>

                <!-- Columna Lateral (Widgets) -->
                <div class="lg:col-span-1 space-y-6">
                    <!-- Widget: Progreso (Solo visible para alumnos) -->
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200" th:if="${!puedeModificar}">
                        <h4 class="font-bold text-gray-700 mb-3 text-sm uppercase">Tu Progreso</h4>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 mb-1">
                            <div class="bg-blue-600 h-2.5 rounded-full"
                                th:style="'width: ' + ${progreso != null ? progreso : 0} + '%'"></div>
                        </div>
                        <div class="text-right text-xs text-gray-500"><span
                                th:text="${progreso != null ? progreso : 0} + '%'">0%</span> Completado</div>
                    </div>

                    <!-- Widget: Anuncios Recientes -->
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                        <h4 class="font-bold text-gray-700 mb-3 text-sm uppercase">Avisos Recientes</h4>
                        <div class="space-y-3">
                            <div th:if="${avisosRecientes == null || #lists.isEmpty(avisosRecientes)}"
                                class="text-sm text-gray-500">
                                <p>No hay avisos recientes para mostrar.</p>
                            </div>
                            <div th:each="aviso, avisoStat : ${avisosRecientes}"
                                th:if="${avisoStat.index < 5}"
                                class="text-sm border-l-2 pl-3"
                                th:classappend="${aviso.tipo == 'warning' ? ' border-amber-500' : (aviso.tipo == 'success' ? ' border-green-500' : ' border-blue-500')}">
                                <p class="font-medium text-gray-800" th:text="${aviso.titulo}">Aviso</p>
                                <p class="text-xs text-gray-500"
                                   th:text="${aviso.fecha != null ? #temporals.format(aviso.fecha, 'dd/MM/yyyy HH:mm') : ''}">Fecha</p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Fondo Oscuro para herramientas (Overlay) -->
    <div id="toolsOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 opacity-0 pointer-events-none"></div>

    <!-- Fondo Oscuro para índice (Overlay) -->
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 opacity-0 pointer-events-none"></div>

    <!-- Panel Lateral Derecho (Índice del Curso) -->
    <aside id="sidebar"
        class="fixed top-0 right-0 h-full w-72 bg-white border-l border-gray-200 shadow-xl transform translate-x-full z-40 overflow-y-auto">

        <!-- Cabecera del Panel -->
        <div class="flex justify-between items-center p-4 border-b border-gray-200 sticky top-0 bg-white">
            <h2 class="text-lg font-semibold text-gray-800">ÍNDICE DEL CURSO</h2>
            <button id="closeButton" class="text-gray-500 hover:text-gray-800 transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                </svg>
            </button>
        </div>

        <!-- Contenido del Índice -->
        <nav class="p-4">
            <ul class="space-y-1">
                <li>
                    <a href="#"
                        class="block py-2 px-3 rounded-md text-gray-700 hover:bg-gray-100 transition-colors duration-150">
                        Inicio
                    </a>
                </li>
                <li>
                    <a href="#"
                        class="block py-2 px-3 rounded-md text-gray-700 hover:bg-gray-100 transition-colors duration-150">
                        Anuncios
                    </a>
                </li>
                <!-- Módulos en el índice -->
                <li th:each="modulo : ${modulos}">
                    <a href="#"
                        class="block py-2 px-3 rounded-md text-gray-700 hover:bg-gray-100 transition-colors duration-150"
                        th:class="${moduloStat.first} ? 'text-customBlue bg-blue-50 font-semibold' : 'text-gray-700 hover:bg-gray-100'"
                        th:text="${'Módulo ' + moduloStat.count + ': ' + modulo.nombre}">
                        Módulo
                    </a>
                </li>
                <li>
                    <a href="#"
                        class="block py-2 px-3 rounded-md text-gray-700 hover:bg-gray-100 transition-colors duration-150">
                        Examen
                    </a>
                </li>
                <li>
                    <a href="#"
                        class="block py-2 px-3 rounded-md text-gray-700 hover:bg-gray-100 transition-colors duration-150">
                        Calificaciones
                    </a>
                </li>
                <li>
                    <a href="#"
                        class="block py-2 px-3 rounded-md text-gray-700 hover:bg-gray-100 transition-colors duration-150">
                        Foro de Dudas
                    </a>
                </li>
            </ul>
        </nav>
    </aside>



    <!-- Modal Reconfirmación Ingreso -->
    <div id="ingresoModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-lock text-blue-600 me-2"></i>Validación de Seguridad
            </h3>
            <p class="text-sm text-gray-600 mb-4">
                El sistema solicita validación para ingresar a la clase <strong id="modalClaseTitulo"></strong>.
            </p>

            <form id="ingresoForm" onsubmit="validarIngreso(event)">
                <input type="hidden" id="modalClaseId">

                <div class="mb-3">
                    <label class="block text-xs font-semibold text-gray-500 uppercase">DNI</label>
                    <input type="text" id="inputDniIngreso" required class="w-full border rounded px-3 py-2 mt-1"
                        th:value="${alumno != null ? alumno.dni : (docente != null ? docente.dni : '')}">
                </div>

                <div class="mb-4">
                    <label class="block text-xs font-semibold text-gray-500 uppercase">Contraseña</label>
                    <input type="password" id="inputPassIngreso" required class="w-full border rounded px-3 py-2 mt-1">
                </div>

                <div class="flex justify-end gap-2">
                    <button type="button" onclick="document.getElementById('ingresoModal').classList.add('hidden')"
                        class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">
                        Cancelar
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        Verificar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script th:inline="javascript">
        /*<![CDATA[*/
        // Obtener elementos del DOM
        const modifyCourseButton = document.getElementById('modifyCourseButton');
        const toolsSidebar = document.getElementById('toolsSidebar');
        const closeToolsButton = document.getElementById('closeToolsButton');
        const createModuleButton = document.getElementById('createModuleButton');
        const moduleModal = document.getElementById('moduleModal');
        const toolsOverlay = document.getElementById('toolsOverlay');
        const createClassButton = document.getElementById('createClassButton');
        const toggleEditModeButton = document.getElementById('toggleEditModeButton');
        const editModuleModal = document.getElementById('editModuleModal');
        const closeEditModuleButton = document.getElementById('closeEditModuleButton');
        const editModuleForm = document.getElementById('editModuleForm');
        const editModeHint = document.getElementById('editModeHint');
        const moduleVisibilityButtons = document.querySelectorAll('.module-visibility-toggle');
        const activityVisibilityButtons = document.querySelectorAll('.activity-visibility-toggle');
        const csrfTokenMeta = document.querySelector('meta[name="_csrf"]');
        const csrfHeaderMeta = document.querySelector('meta[name="_csrf_header"]');
        const csrfToken = csrfTokenMeta ? csrfTokenMeta.getAttribute('content') : '';
        const csrfHeader = csrfHeaderMeta ? csrfHeaderMeta.getAttribute('content') : '';
        const csrfParameterName = '_csrf'; // Default default parameter name for Spring Security
        let isEditModeEnabled = false;
        const modifyCourseDefaultMarkup = modifyCourseButton ? modifyCourseButton.innerHTML : '';
        function updateModifyCourseButtonLabel(enabled) {
            if (!modifyCourseButton) {
                return;
            }

            modifyCourseButton.innerHTML = enabled
                ? '<i class="fas fa-check me-1"></i>Terminar edicion'
                : modifyCourseDefaultMarkup;
        }

        function parseVisibilityFlag(value) {
            if (value === undefined || value === null) {
                return false;
            }
            return String(value).toLowerCase() === 'true' || value === true;
        }

        function updateVisibilityButtonState(button, visible) {
            if (!button) {
                return;
            }

            const icon = button.querySelector('i');
            if (icon) {
                icon.classList.toggle('fa-eye', visible);
                icon.classList.toggle('fa-eye-slash', !visible);
            }

            const stateValue = visible ? 'true' : 'false';
            button.dataset.visible = stateValue;
            button.setAttribute('data-visible', stateValue);
            button.setAttribute('aria-pressed', stateValue);

            const baseLabel = visible ? 'Visible para estudiantes' : 'Oculto para estudiantes';
            button.title = isEditModeEnabled ? `${baseLabel} · clic para cambiar` : baseLabel;
            button.setAttribute('aria-label', isEditModeEnabled ? `${baseLabel}. Presiona para cambiar` : baseLabel);
        }

        function refreshVisibilityButtons() {
            moduleVisibilityButtons.forEach((button) => {
                const visible = parseVisibilityFlag(button.dataset.visible);
                updateVisibilityButtonState(button, visible);
            });
            activityVisibilityButtons.forEach((button) => {
                const visible = parseVisibilityFlag(button.dataset.visible);
                updateVisibilityButtonState(button, visible);
            });
        }

        function mostrarToast(mensaje, tipo = 'warning', duracion = 6000) {
            const toast = document.createElement('div');
            toast.className = `toast-notification toast-${tipo}`;
            toast.innerHTML = `
                <i class="fas fa-info-circle text-${tipo === 'warning' ? 'yellow' : (tipo === 'error' ? 'red' : 'green')}-500 mt-0.5"></i>
                <div class="text-sm">${mensaje}</div>
                <button class="toast-close" aria-label="Cerrar">&times;</button>
            `;

            document.body.appendChild(toast);

            const close = () => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            };

            toast.querySelector('.toast-close').addEventListener('click', close);
            setTimeout(close, duracion);
        }

        function mostrarConfirmacionGlobal(titulo, mensaje, onConfirm, options) {
            if (window.ModalConfirmacion && typeof ModalConfirmacion.show === 'function') {
                ModalConfirmacion.show(titulo, mensaje, onConfirm, options);
            } else if (confirm(mensaje)) {
                if (onConfirm) onConfirm();
            }
        }

        function mostrarNotificacionGlobal(titulo, mensaje, tipo = 'success', onConfirm = null) {
            mostrarConfirmacionGlobal(titulo, mensaje, onConfirm, {
                type: tipo,
                confirmText: 'Aceptar',
                showCancel: false
            });
        }

        async function updateModuleVisibilityOnServer(moduloId, visible) {
            if (!moduloId) {
                throw new Error('Falta el identificador del módulo');
            }

            const payload = new URLSearchParams();
            payload.set('visibilidad', visible);

            const headers = {
                'Content-Type': 'application/x-www-form-urlencoded'
            };

            if (csrfHeader && csrfToken) {
                headers[csrfHeader] = csrfToken;
            }

            const response = await fetch(`/modulo/${moduloId}/visibilidad`, {
                method: 'POST',
                headers,
                body: payload.toString()
            });

            if (!response.ok) {
                throw new Error('Respuesta no válida del servidor');
            }

            const result = await response.json().catch(() => ({ success: true }));

            if (result && result.success === false) {
                throw new Error(result.message || 'No se pudo actualizar la visibilidad');
            }

            return result;
        }

        async function toggleModuleVisibility(card, button) {
            if (!card || !button) {
                return;
            }

            const moduloId = card.getAttribute('data-modulo-id');
            const currentVisible = parseVisibilityFlag(card.getAttribute('data-modulo-visible'));
            const nextVisible = !currentVisible;

            button.disabled = true;
            button.classList.add('opacity-60');

            try {
                await updateModuleVisibilityOnServer(moduloId, nextVisible);

                card.dataset.moduloVisible = String(nextVisible);
                card.setAttribute('data-modulo-visible', String(nextVisible));

                // Update button dataset to keep sync
                button.dataset.visible = String(nextVisible);

                updateVisibilityButtonState(button, nextVisible);
            } catch (error) {
                console.error('Error al actualizar visibilidad del módulo', error);
                alert('No se pudo actualizar la visibilidad del módulo. Intenta nuevamente.');
                updateVisibilityButtonState(button, currentVisible);
            } finally {
                button.disabled = false;
                button.classList.remove('opacity-60');
            }
        }

        async function updateActivityVisibilityOnServer(actividadId, visible) {
            if (!actividadId) {
                throw new Error('Falta el identificador de la actividad');
            }

            const payload = new URLSearchParams();
            payload.set('visibilidad', visible);

            const headers = {
                'Content-Type': 'application/x-www-form-urlencoded'
            };

            if (csrfHeader && csrfToken) {
                headers[csrfHeader] = csrfToken;
            }

            const response = await fetch(`/actividad/${actividadId}/visibilidad`, {
                method: 'POST',
                headers,
                body: payload.toString()
            });

            if (!response.ok) {
                throw new Error('Respuesta no válida del servidor');
            }

            const result = await response.json().catch(() => ({ success: true }));

            if (result && result.success === false) {
                throw new Error(result.message || 'No se pudo actualizar la visibilidad');
            }

            return result;
        }

        async function toggleActivityVisibility(button) {
            if (!button) {
                return;
            }

            const card = button.closest('.activity-item');
            const actividadId = card ? card.getAttribute('data-actividad-id') : null;

            if (!actividadId) {
                console.error("No se encontró el ID de la actividad");
                return;
            }

            const currentVisible = parseVisibilityFlag(button.dataset.visible);
            const nextVisible = !currentVisible;

            button.disabled = true;
            button.classList.add('opacity-60');

            try {
                await updateActivityVisibilityOnServer(actividadId, nextVisible);
                updateVisibilityButtonState(button, nextVisible);
            } catch (error) {
                console.error('Error al actualizar visibilidad de la actividad', error);
                alert('No se pudo actualizar la visibilidad de la actividad. Intenta nuevamente.');
                updateVisibilityButtonState(button, currentVisible);
            } finally {
                button.disabled = false;
                button.classList.remove('opacity-60');
            }
        }

        function registerVisibilityToggleHandlers() {
            moduleVisibilityButtons.forEach((button) => {
                const card = button.closest('div[data-modulo-id]');
                const initialVisible = card ? parseVisibilityFlag(card.getAttribute('data-modulo-visible')) : false;
                // Sync button state with card state
                button.dataset.visible = initialVisible;
                updateVisibilityButtonState(button, initialVisible);

                button.addEventListener('click', async (event) => {
                    event.preventDefault();
                    if (!isEditModeEnabled) {
                        return;
                    }
                    await toggleModuleVisibility(card, button);
                });
            });

            activityVisibilityButtons.forEach((button) => {
                const initialVisible = parseVisibilityFlag(button.dataset.visible);
                updateVisibilityButtonState(button, initialVisible);

                button.addEventListener('click', async (event) => {
                    event.preventDefault();
                    if (!isEditModeEnabled) {
                        return;
                    }
                    await toggleActivityVisibility(button);
                });
            });
        }

        function setEditModeState(enabled) {
            isEditModeEnabled = enabled;
            document.body.classList.toggle('edit-mode', enabled);

            if (toggleEditModeButton) {
                toggleEditModeButton.classList.toggle('bg-customBlue', enabled);
                toggleEditModeButton.classList.toggle('text-white', enabled);
                toggleEditModeButton.classList.toggle('hover:bg-blue-700', enabled);
                toggleEditModeButton.classList.toggle('bg-blue-100', !enabled);
                toggleEditModeButton.classList.toggle('text-customBlue', !enabled);
                toggleEditModeButton.classList.toggle('hover:bg-blue-200', !enabled);
                toggleEditModeButton.innerHTML = enabled
                    ? '<i class="fas fa-xmark me-2"></i>Salir del modo edición'
                    : '<i class="fas fa-pen-to-square me-2"></i>Editar Contenido';
            }

            if (editModeHint) {
                editModeHint.setAttribute('aria-hidden', enabled ? 'false' : 'true');
            }

            if (!enabled) {
                closeEditModuleModal();
            }

            updateModifyCourseButtonLabel(enabled);

            refreshVisibilityButtons();

            if (enabled) {
                closeToolsSidebar();
            }
        }

        if (toggleEditModeButton) {
            toggleEditModeButton.addEventListener('click', () => {
                setEditModeState(!isEditModeEnabled);
            });
        }

        function openEditModuleModal(targetCard) {
            if (!editModuleModal || !editModuleForm || !targetCard) {
                return;
            }

            const dataset = targetCard.dataset || {};

            const moduloId = dataset.moduloId || targetCard.getAttribute('data-modulo-id') || '';
            const nombre = dataset.moduloNombre || '';
            const descripcion = dataset.moduloDescripcion || '';
            const objetivos = dataset.moduloObjetivos || '';
            const temario = dataset.moduloTemario || '';
            const bibliografia = dataset.moduloBibliografia || '';
            const fechaInicio = dataset.moduloInicio || '';
            const fechaFin = dataset.moduloFin || '';
            const visibleFlag = dataset.moduloVisible ?? targetCard.getAttribute('data-modulo-visible');
            const visible = String(visibleFlag).toLowerCase() === 'true';

            const moduloIdInput = editModuleForm.querySelector('[name="moduloId"]');
            const nombreInput = editModuleForm.querySelector('[name="nombre"]');
            const descripcionInput = editModuleForm.querySelector('[name="descripcion"]');
            const objetivosInput = editModuleForm.querySelector('[name="objetivos"]');
            const temarioInput = editModuleForm.querySelector('[name="temario"]');
            const bibliografiaInput = editModuleForm.querySelector('[name="bibliografia"]');
            const fechaInicioInput = editModuleForm.querySelector('[name="fechaInicio"]');
            const fechaFinInput = editModuleForm.querySelector('[name="fechaFin"]');
            const visibilidadInput = editModuleForm.querySelector('[name="visibilidad"]');

            if (moduloIdInput) moduloIdInput.value = moduloId;
            if (nombreInput) nombreInput.value = nombre;
            if (descripcionInput) descripcionInput.value = descripcion;
            if (objetivosInput) objetivosInput.value = objetivos;
            if (temarioInput) temarioInput.value = temario;
            if (bibliografiaInput) bibliografiaInput.value = bibliografia;
            if (fechaInicioInput) fechaInicioInput.value = fechaInicio;
            if (fechaFinInput) fechaFinInput.value = fechaFin;
            if (visibilidadInput) visibilidadInput.checked = visible;

            editModuleModal.classList.remove('hidden');
        }

        function closeEditModuleModal() {
            if (!editModuleModal || !editModuleForm) {
                return;
            }

            editModuleModal.classList.add('hidden');
            editModuleForm.reset();
        }

        if (closeEditModuleButton) {
            closeEditModuleButton.addEventListener('click', closeEditModuleModal);
        }

        if (editModuleModal) {
            editModuleModal.addEventListener('click', (event) => {
                if (event.target === editModuleModal) {
                    closeEditModuleModal();
                }
            });
        }

        function decodeHtmlEntities(text) {
            if (!text) {
                return '';
            }
            const textarea = document.createElement('textarea');
            textarea.innerHTML = text;
            return textarea.value;
        }

        function mostrarModalTextoActividad(titulo, contenidoHtml) {
            const contenidoSeguro = decodeHtmlEntities(contenidoHtml || '');
            const modalHTML = `
                <div id="textoActividadModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[120]">
                    <div class="bg-white rounded-xl shadow-xl w-full max-w-2xl max-h-[80vh] overflow-hidden">
                        <div class="flex items-center justify-between px-5 py-3 border-b bg-gray-50">
                            <h3 class="text-lg font-semibold text-gray-800">
                                <i class="fas fa-align-left text-blue-600 me-2"></i>${escapeHtml(titulo || 'Sección de texto')}
                            </h3>
                            <button type="button" onclick="document.getElementById('textoActividadModal').remove()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="p-6 overflow-y-auto" style="max-height: calc(80vh - 56px);">
                            <div class="prose max-w-none text-gray-700">${contenidoSeguro}</div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function abrirActividadDesdeEdicion(card) {
            if (!card) {
                return;
            }

            const actividadId = card.getAttribute('data-actividad-id');
            const actividadTipo = (card.getAttribute('data-actividad-tipo') || '').toUpperCase();

            if (!actividadId) {
                alert('No se pudo identificar la actividad.');
                return;
            }

            if (actividadTipo === 'EXAMEN') {
                window.location.href = `/examen/detalle/${actividadId}`;
                return;
            }

            if (actividadTipo === 'TAREA') {
                const verTareaBtn = card.querySelector('.js-ver-tarea');
                if (verTareaBtn) {
                    verTareaBtn.click();
                    return;
                }
                alert('No se encontró el acceso a la tarea.');
                return;
            }

            if (actividadTipo === 'ENLACE' || actividadTipo === 'TEXTO') {
                abrirEditorRecursoDesdeCard(card);
                return;
            }

            if (actividadTipo === 'CARPETA') {
                const toggleBtn = card.querySelector('.js-toggle-carpeta');
                if (toggleBtn) {
                    toggleBtn.click();
                    return;
                }
                alert('No se encontró la carpeta.');
                return;
            }

            alert('La edición de esta actividad aún no está disponible.');
        }

        function registerEditButtons() {
            document.querySelectorAll('[data-edit-type="module"]').forEach((button) => {
                button.addEventListener('click', (event) => {
                    if (!isEditModeEnabled) {
                        return;
                    }
                    event.preventDefault();
                    // Buscamos el div contenedor que tiene todos los datos (nombre, descripcion, etc)
                    // Usamos 'div[data-modulo-id]' para evitar seleccionar el propio botón que también tiene el ID
                    const card = event.currentTarget.closest('div[data-modulo-id]');
                    openEditModuleModal(card);
                });
            });

            document.querySelectorAll('[data-edit-type="clase"]').forEach((button) => {
                button.addEventListener('click', (event) => {
                    if (!isEditModeEnabled) {
                        return;
                    }
                    event.preventDefault();
                    const claseId = button.getAttribute('data-clase-id');
                    openEditClassModal(claseId);
                });
            });

            document.querySelectorAll('[data-edit-type="actividad"]').forEach((button) => {
                button.addEventListener('click', (event) => {
                    if (!isEditModeEnabled) {
                        return;
                    }
                    event.preventDefault();
                    const card = event.currentTarget.closest('.activity-item');
                    abrirActividadDesdeEdicion(card);
                });
            });
        }

        function registerExamLinks() {
            document.querySelectorAll('.js-ver-examen').forEach((button) => {
                button.addEventListener('click', (event) => {
                    event.preventDefault();
                    event.stopPropagation();

                    if (PUEDE_MODIFICAR) {
                        const url = button.getAttribute('data-examen-url') || button.getAttribute('href');
                        if (url) window.location.href = url;
                        return;
                    }

                    const card = event.currentTarget.closest('.activity-item');
                    const aperturaIso = card ? card.getAttribute('data-actividad-apertura') : null;

                    if (!aperturaIso) {
                        const url = button.getAttribute('data-examen-url') || button.getAttribute('href');
                        if (url) window.location.href = url;
                        return;
                    }

                    const apertura = new Date(aperturaIso);
                    const ahora = new Date();

                    if (apertura > ahora) {
                        const textoApertura = card.getAttribute('data-actividad-apertura-text') || apertura.toLocaleString('es-AR');
                        mostrarToast(`El examen aún no está abierto. Intenta el ${textoApertura}.`, 'warning');
                        return;
                    }

                    // Si pasó todas las validaciones, navegar
                    const url = button.getAttribute('data-examen-url') || button.getAttribute('href');
                    if (url) window.location.href = url;
                });
            });
        }

        async function eliminarElemento(tipo, id, nombre) {
            try {
                const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

                let endpoint = '';
                let etiqueta = '';
                if (tipo === 'modulo') {
                    endpoint = '/modulo/' + id + '/eliminar';
                    etiqueta = 'módulo';
                } else if (tipo === 'clase') {
                    endpoint = '/clase/' + id + '/eliminar';
                    etiqueta = 'clase';
                } else if (tipo === 'actividad') {
                    endpoint = '/actividad/' + id + '/eliminar';
                    etiqueta = 'actividad';
                }

                const response = await fetch(endpoint, {
                    method: 'DELETE',
                    headers: {
                        [csrfHeader]: csrfToken
                    }
                });

                if (response.ok) {
                    mostrarNotificacionGlobal('Eliminado', `Se eliminó el ${etiqueta} "${nombre}".`, 'success', () => {
                        window.location.reload();
                    });
                } else {
                    const data = await response.json().catch(() => ({}));
                    mostrarNotificacionGlobal('Error', data.error || 'Error al eliminar. Por favor intenta nuevamente.', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacionGlobal('Error', 'Error al eliminar. Por favor intenta nuevamente.', 'error');
            }
        }

        function closeDeleteModal() {
            const modal = document.getElementById('deleteConfirmModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        function registerDeleteButtons() {
            document.querySelectorAll('[data-delete-type="modulo"]').forEach((button) => {
                button.addEventListener('click', (event) => {
                    if (!isEditModeEnabled) {
                        return;
                    }
                    event.preventDefault();
                    event.stopPropagation();
                    const moduloId = button.getAttribute('data-modulo-id');
                    const moduloNombre = button.getAttribute('data-modulo-nombre') || 'este módulo';
                    mostrarConfirmacionGlobal(
                        'Eliminar módulo',
                        `¿Estás seguro de eliminar el módulo "${moduloNombre}"? Esta acción no se puede deshacer.`,
                        () => eliminarElemento('modulo', moduloId, moduloNombre),
                        { confirmText: 'Eliminar', cancelText: 'Cancelar', type: 'warning' }
                    );
                });
            });

            document.querySelectorAll('[data-delete-type="clase"]').forEach((button) => {
                button.addEventListener('click', (event) => {
                    if (!isEditModeEnabled) {
                        return;
                    }
                    event.preventDefault();
                    event.stopPropagation();
                    const claseId = button.getAttribute('data-clase-id');
                    const claseNombre = button.getAttribute('data-clase-nombre') || 'esta clase';
                    mostrarConfirmacionGlobal(
                        'Eliminar clase',
                        `¿Estás seguro de eliminar la clase "${claseNombre}"? Esta acción no se puede deshacer.`,
                        () => eliminarElemento('clase', claseId, claseNombre),
                        { confirmText: 'Eliminar', cancelText: 'Cancelar', type: 'warning' }
                    );
                });
            });

            document.querySelectorAll('[data-delete-type="actividad"]').forEach((button) => {
                button.addEventListener('click', (event) => {
                    if (!isEditModeEnabled) {
                        return;
                    }
                    event.preventDefault();
                    event.stopPropagation();
                    const actividadId = button.getAttribute('data-actividad-id');
                    const actividadNombre = button.getAttribute('data-actividad-nombre') || 'esta actividad';
                    mostrarConfirmacionGlobal(
                        'Eliminar actividad',
                        `¿Estás seguro de eliminar la actividad "${actividadNombre}"? Esta acción no se puede deshacer.`,
                        () => eliminarElemento('actividad', actividadId, actividadNombre),
                        { confirmText: 'Eliminar', cancelText: 'Cancelar', type: 'warning' }
                    );
                });
            });
        }

        registerVisibilityToggleHandlers();
        registerEditButtons();
        registerDeleteButtons();
        registerExamLinks();
        window.closeEditModuleModal = closeEditModuleModal;
        window.closeDeleteModal = closeDeleteModal;

        const HTML_ESCAPE_MAP = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#39;',
            '`': '&#96;'
        };

        const ESCAPE_REGEX = /[&<>"'`]/g;

        function escapeHtml(texto) {
            if (!texto) {
                return '';
            }
            return texto.replace(ESCAPE_REGEX, (caracter) => HTML_ESCAPE_MAP[caracter] || caracter);
        }

        function escapeHtmlAtributo(texto) {
            return escapeHtml(texto || '');
        }

        function obtenerNombreModuloElemento(modulo) {
            if (!modulo) {
                return 'Módulo sin nombre';
            }

            const nombreAttr = modulo.getAttribute('data-modulo-nombre');
            if (nombreAttr && nombreAttr.trim().length > 0) {
                return nombreAttr.trim();
            }

            const heading = modulo.querySelector('h3');
            if (heading && heading.textContent && heading.textContent.trim().length > 0) {
                return heading.textContent.trim();
            }

            return 'Módulo sin nombre';
        }

        if (createClassButton) {
            createClassButton.addEventListener('click', () => {
                // Obtener todos los módulos (solo divs principales, no botones)
                const modulos = document.querySelectorAll('div.editable-block[data-modulo-id][data-modulo-nombre]');

                if (modulos.length > 0) {
                    // Si hay múltiples módulos, preguntar cuál usar
                    if (modulos.length === 1) {
                        // Solo hay un módulo, usar ese
                        const moduloId = modulos[0].getAttribute('data-modulo-id');
                        openClassModal(moduloId);
                    } else {
                        // Hay múltiples módulos, mostrar selector
                        mostrarSelectorModulos(modulos);
                    }
                } else {
                    alert('Primero debes crear un módulo');
                }
            });
        }

        // Función para mostrar selector de módulos
        function mostrarSelectorModulos(modulos) {
            const opcionesHTML = Array.from(modulos).map((modulo) => {
                const moduloId = modulo.getAttribute('data-modulo-id');
                if (!moduloId) {
                    return '';
                }
                const moduloNombre = escapeHtml(obtenerNombreModuloElemento(modulo));

                return `
                                    <button class="w-full text-left py-2 px-3 mb-2 rounded border hover:bg-gray-50 modulo-option"
                                            data-modulo-id="${moduloId}">
                                        <strong>${moduloNombre}</strong>
                                    </button>
                                `;
            }).join('');

            // Crear modal de selección
            const modalHTML = `
                    <div id="moduloSelectorModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white rounded-lg p-6 w-96">
                            <h3 class="text-lg font-semibold mb-4">
                                <i class="fas fa-folder me-2"></i>Seleccionar Módulo
                            </h3>
                            <p class="text-gray-600 mb-4">Selecciona en qué módulo quieres crear la clase:</p>
                            <div id="moduloList" class="max-h-60 overflow-y-auto mb-4">
                                ${opcionesHTML}
                            </div>
                            <div class="flex justify-end">
                                <button type="button" onclick="cerrarSelectorModulos()" class="px-4 py-2 text-gray-600 hover:text-gray-800">
                                    Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);

            // Agregar event listeners a los botones de módulo
            document.querySelectorAll('.modulo-option').forEach(button => {
                button.addEventListener('click', function () {
                    const moduloId = this.getAttribute('data-modulo-id');
                    cerrarSelectorModulos();
                    openClassModal(moduloId);
                });
            });
        }

        function cerrarSelectorModulos() {
            const modal = document.getElementById('moduloSelectorModal');
            if (modal) {
                modal.remove();
            }
        }

        function closeToolsSidebar() {
            if (!toolsSidebar || !toolsOverlay) {
                return;
            }

            toolsSidebar.classList.add('-translate-x-full');
            toolsSidebar.classList.remove('translate-x-0');
            toolsOverlay.classList.add('opacity-0');
            toolsOverlay.classList.remove('opacity-50');
            setTimeout(() => {
                toolsOverlay.classList.add('pointer-events-none');
            }, 300);
            document.body.classList.remove('no-scroll');
        }

        // Mostrar/ocultar panel de herramientas (CON LA MISMA ANIMACIÓN)
        if (modifyCourseButton) {
            modifyCourseButton.addEventListener('click', () => {
                if (isEditModeEnabled) {
                    setEditModeState(false);
                    closeToolsSidebar();
                    return;
                }

                if (!toolsSidebar || !toolsOverlay) {
                    return;
                }

                toolsSidebar.classList.remove('-translate-x-full');
                toolsSidebar.classList.add('translate-x-0');
                toolsOverlay.classList.remove('pointer-events-none', 'opacity-0');
                toolsOverlay.classList.add('opacity-50');
                document.body.classList.add('no-scroll');
            });
        }


        // Cerrar panel de herramientas (CON LA MISMA ANIMACIÓN)
        if (closeToolsButton) {
            closeToolsButton.addEventListener('click', () => {
                setEditModeState(false);
                closeToolsSidebar();
            });
        }

        // Cerrar panel de herramientas al hacer clic en el overlay
        if (toolsOverlay) {
            toolsOverlay.addEventListener('click', () => {
                if (isEditModeEnabled) {
                    return;
                }
                closeToolsSidebar();
            });
        }

        // Abrir modal para crear módulo
        if (createModuleButton) {
            createModuleButton.addEventListener('click', () => {
                moduleModal.classList.remove('hidden');
            });
        }

        // ========================================
        // CREAR ACTIVIDAD - Selector de Módulo y Tipo
        // ========================================
        const createActivityButton = document.getElementById('createActivityButton');

        if (createActivityButton) {
            createActivityButton.addEventListener('click', () => {
                // Obtener todos los módulos
                const modulos = document.querySelectorAll('div.editable-block[data-modulo-id][data-modulo-nombre]');

                if (modulos.length > 0) {
                    // Si hay múltiples módulos, preguntar cuál usar
                    if (modulos.length === 1) {
                        // Solo hay un módulo, ir directo a selección de tipo
                        const moduloId = modulos[0].getAttribute('data-modulo-id');
                        const moduloNombre = obtenerNombreModuloElemento(modulos[0]);
                        mostrarSelectorTipoActividad(moduloId, moduloNombre);
                    } else {
                        // Hay múltiples módulos, mostrar selector
                        mostrarSelectorModulosParaActividad(modulos);
                    }
                } else {
                    alert('Primero debes crear un módulo');
                }
            });
        }

        // Función para mostrar selector de módulos para actividad
        function mostrarSelectorModulosParaActividad(modulos) {
            const opcionesHTML = Array.from(modulos).map((modulo) => {
                const moduloId = modulo.getAttribute('data-modulo-id');
                if (!moduloId) {
                    return '';
                }
                const moduloNombre = obtenerNombreModuloElemento(modulo);

                return `
                                <button class="w-full text-left py-3 px-4 mb-2 rounded-lg border border-gray-200 hover:bg-green-50 hover:border-green-300 transition-colors duration-200 modulo-actividad-option"
                                        data-modulo-id="${moduloId}"
                                        data-modulo-nombre="${escapeHtmlAtributo(moduloNombre)}">
                                    <i class="fas fa-folder text-gray-400 me-2"></i>
                                    <strong>${escapeHtml(moduloNombre)}</strong>
                                </button>
                            `;
            }).join('');

            const modalHTML = `
                <div id="moduloActividadSelectorModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 w-96">
                        <h3 class="text-lg font-semibold mb-4">
                            <i class="fas fa-folder me-2 text-customGreen"></i>Seleccionar Módulo
                        </h3>
                        <p class="text-gray-600 mb-4">Selecciona en qué módulo quieres crear la actividad:</p>
                        <div id="moduloActividadList" class="max-h-60 overflow-y-auto mb-4">
                            ${opcionesHTML}
                        </div>
                        <div class="flex justify-end">
                            <button type="button" onclick="cerrarSelectorModulosActividad()" class="px-4 py-2 text-gray-600 hover:text-gray-800 border border-gray-300 rounded-md">
                                <i class="fas fa-times me-1"></i>Cancelar
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);

            // Agregar event listeners a los botones de módulo
            document.querySelectorAll('.modulo-actividad-option').forEach(button => {
                button.addEventListener('click', function () {
                    const moduloId = this.getAttribute('data-modulo-id');
                    const moduloNombre = this.getAttribute('data-modulo-nombre');
                    cerrarSelectorModulosActividad();
                    mostrarSelectorTipoActividad(moduloId, moduloNombre);
                });
            });
        }

        function cerrarSelectorModulosActividad() {
            const modal = document.getElementById('moduloActividadSelectorModal');
            if (modal) {
                modal.remove();
            }
        }

        // Función para mostrar selector de tipo de actividad
        function mostrarSelectorTipoActividad(moduloId, moduloNombre) {
            const moduloNombreSeguro = escapeHtml(moduloNombre);
            const modalHTML = `
                <div id="tipoActividadModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-5 w-full max-w-md">
                        <h3 class="text-lg font-semibold mb-1">
                            <i class="fas fa-tasks me-2 text-customGreen"></i>Crear Actividad
                        </h3>
                        <p class="text-sm text-gray-500 mb-4">
                            <i class="fas fa-folder text-gray-400 me-1"></i>${moduloNombreSeguro}
                        </p>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <!-- Opción 1: Crear Tarea -->
                            <button class="tipo-actividad-btn group p-4 border-2 border-gray-200 rounded-lg hover:border-blue-400 hover:bg-blue-50 transition-all duration-200"
                                    data-tipo="tarea" data-modulo-id="${moduloId}">
                                <div class="flex flex-col items-center text-center">
                                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mb-2 group-hover:bg-blue-200 transition-colors">
                                        <i class="fas fa-file-alt text-2xl text-blue-600"></i>
                                    </div>
                                    <h4 class="font-semibold text-sm text-gray-800">Tarea</h4>
                                </div>
                            </button>
                            
                            <!-- Opción 2: Crear Examen -->
                            <button class="tipo-actividad-btn group p-4 border-2 border-gray-200 rounded-lg hover:border-purple-400 hover:bg-purple-50 transition-all duration-200"
                                    data-tipo="examen" data-modulo-id="${moduloId}">
                                <div class="flex flex-col items-center text-center">
                                    <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mb-2 group-hover:bg-purple-200 transition-colors">
                                        <i class="fas fa-clipboard-check text-2xl text-purple-600"></i>
                                    </div>
                                    <h4 class="font-semibold text-sm text-gray-800">Examen</h4>
                                </div>
                            </button>
                            
                            <!-- Opción 3: Crear Recurso (Enlace) -->
                            <button class="tipo-actividad-btn group p-4 border-2 border-gray-200 rounded-lg hover:border-green-400 hover:bg-green-50 transition-all duration-200"
                                    data-tipo="enlace" data-modulo-id="${moduloId}">
                                <div class="flex flex-col items-center text-center">
                                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mb-2 group-hover:bg-green-200 transition-colors">
                                        <i class="fas fa-link text-2xl text-green-600"></i>
                                    </div>
                                    <h4 class="font-semibold text-sm text-gray-800">Enlace</h4>
                                </div>
                            </button>

                            <!-- Opción 4: Crear Sección Texto -->
                            <button class="tipo-actividad-btn group p-4 border-2 border-gray-200 rounded-lg hover:border-gray-400 hover:bg-gray-50 transition-all duration-200"
                                    data-tipo="texto" data-modulo-id="${moduloId}">
                                <div class="flex flex-col items-center text-center">
                                    <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mb-2 group-hover:bg-gray-200 transition-colors">
                                        <i class="fas fa-align-left text-2xl text-gray-600"></i>
                                    </div>
                                    <h4 class="font-semibold text-sm text-gray-800">Sección Texto</h4>
                                </div>
                            </button>

                            <!-- Opción 5: Crear Carpeta -->
                            <button class="tipo-actividad-btn group p-4 border-2 border-gray-200 rounded-lg hover:border-yellow-400 hover:bg-yellow-50 transition-all duration-200"
                                    data-tipo="carpeta" data-modulo-id="${moduloId}">
                                <div class="flex flex-col items-center text-center">
                                    <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center mb-2 group-hover:bg-yellow-200 transition-colors">
                                        <i class="fas fa-folder-open text-2xl text-yellow-600"></i>
                                    </div>
                                    <h4 class="font-semibold text-sm text-gray-800">Carpeta</h4>
                                </div>
                            </button>
                            
                            <!-- Opción 4: Subir Material -->
                            <button class="tipo-actividad-btn group p-4 border-2 border-gray-200 rounded-lg hover:border-green-400 hover:bg-green-50 transition-all duration-200"
                                    data-tipo="material" data-modulo-id="${moduloId}">
                                <div class="flex flex-col items-center text-center">
                                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mb-2 group-hover:bg-green-200 transition-colors">
                                        <i class="fas fa-upload text-2xl text-green-600"></i>
                                    </div>
                                    <h4 class="font-semibold text-sm text-gray-800">Material</h4>
                                </div>
                            </button>
                        </div>
                        
                        <div class="flex justify-end mt-4">
                            <button type="button" onclick="cerrarSelectorTipoActividad()" class="px-3 py-1.5 text-sm text-gray-600 hover:text-gray-800 border border-gray-300 rounded-md">
                                <i class="fas fa-times me-1"></i>Cancelar
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);

            // Agregar event listeners a los botones de tipo de actividad
            document.querySelectorAll('.tipo-actividad-btn').forEach(button => {
                button.addEventListener('click', function () {
                    const tipo = this.getAttribute('data-tipo');
                    const moduloId = this.getAttribute('data-modulo-id');
                    cerrarSelectorTipoActividad();
                    abrirFormularioActividad(tipo, moduloId, moduloNombre);
                });
            });
        }

        function cerrarSelectorTipoActividad() {
            const modal = document.getElementById('tipoActividadModal');
            if (modal) {
                modal.remove();
            }
        }

        // Función para abrir el formulario específico según el tipo de actividad
        function abrirFormularioActividad(tipo, moduloId, moduloNombre) {
            let formularioHTML = '';

            switch (tipo) {
                case 'tarea':
                    formularioHTML = crearFormularioTarea(moduloId, moduloNombre);
                    break;
                case 'examen':
                    formularioHTML = crearFormularioExamen(moduloId, moduloNombre);
                    break;
                case 'carpeta':
                    formularioHTML = crearFormularioCarpeta(moduloId, moduloNombre);
                    break;
                case 'material':
                    formularioHTML = crearFormularioMaterial(moduloId, moduloNombre);
                    break;
                case 'enlace':
                    formularioHTML = crearFormularioRecurso(moduloId, moduloNombre, 'ENLACE');
                    break;
                case 'texto':
                    formularioHTML = crearFormularioRecurso(moduloId, moduloNombre, 'TEXTO');
                    break;
            }

            document.body.insertAdjacentHTML('beforeend', formularioHTML);
}

        
        async function enviarFormularioCarpeta(form) {
            const moduloId = form.querySelector('input[name="moduloId"]')?.value;
            const titulo = form.querySelector('input[name="titulo"]')?.value?.trim() || '';
            const descripcion = form.querySelector('textarea[name="descripcion"]')?.value?.trim() || '';
            const materiales = [];

            const tituloMat = form.querySelector('input[name="materialTitulo"]')?.value?.trim() || '';
            const descripcionMat = form.querySelector('textarea[name="materialDescripcion"]')?.value?.trim() || '';
            const archivosInput = form.querySelector('input[type="file"][name="materialArchivos"]');
            const archivos = archivosInput ? Array.from(archivosInput.files || []) : [];

            const tieneDatosMaterial = tituloMat || descripcionMat || archivos.length > 0;
            if (tieneDatosMaterial) {
                let tituloFinal = tituloMat;
                if (!tituloFinal) {
                    if (archivos.length > 0) {
                        const nombre = archivos[0].name || 'Material';
                        const base = nombre.replace(/\.[^/.]+$/, '');
                        tituloFinal = base || 'Material';
                    } else {
                        tituloFinal = 'Material';
                    }
                }

                materiales.push({ titulo: tituloFinal, descripcion: descripcionMat, archivos });
            }

            const formData = new FormData();
            formData.append('titulo', titulo);
            if (descripcion) {
                formData.append('descripcion', descripcion);
            }
            formData.append('moduloId', moduloId);

            const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
            const btnCrear = form.querySelector('#btnCrearCarpeta');
            const btnCreando = form.querySelector('#btnCreandoCarpeta');

            try {
                if (btnCrear && btnCreando) {
                    btnCrear.style.display = 'none';
                    btnCreando.style.display = 'inline-flex';
                }

                const response = await fetch('/carpeta/crear', {
                    method: 'POST',
                    headers: {
                        [csrfHeader]: csrfToken
                    },
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    const carpetaId = data.carpetaId;
                    const materialesFallidos = [];

                    for (const material of materiales) {
                        const materialData = new FormData();
                        materialData.append('titulo', material.titulo);
                        if (material.descripcion) {
                            materialData.append('descripcion', material.descripcion);
                        }
                        material.archivos.forEach(file => materialData.append('archivos', file));

                        try {
                            const materialResponse = await fetch(`/carpeta/${carpetaId}/material`, {
                                method: 'POST',
                                headers: {
                                    [csrfHeader]: csrfToken
                                },
                                body: materialData
                            });

                            const materialResult = await materialResponse.json();
                            if (!materialResponse.ok || !materialResult.success) {
                                materialesFallidos.push(material.titulo || 'Material sin titulo');
                            }
                        } catch (materialError) {
                            console.error('Error creando material:', materialError);
                            materialesFallidos.push(material.titulo || 'Material sin titulo');
                        }
                    }

                    if (materialesFallidos.length > 0) {
                        alert(`Carpeta creada, pero algunos materiales fallaron: ${materialesFallidos.join(', ')}`);
                    } else {
                        alert('Carpeta creada exitosamente');
                    }

                    cerrarFormularioCarpeta();
                    window.location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al crear carpeta');
            } finally {
                if (btnCrear && btnCreando) {
                    btnCrear.style.display = 'inline-flex';
                    btnCreando.style.display = 'none';
                }
            }
        }


        // ========================================
        // FORMULARIO DE RECURSO (ENLACE / TEXTO)
        // ========================================
        function crearFormularioRecurso(moduloId, moduloNombre, tipo, opciones = {}) {
            const esEnlace = tipo === 'ENLACE';
            const esEdicion = opciones.modo === 'editar';
            const tituloModal = esEnlace
                ? (esEdicion ? 'Editar Enlace' : 'Agregar Enlace')
                : (esEdicion ? 'Editar Sección de Texto' : 'Agregar Sección de Texto');
            const iconModal = esEnlace ? 'fa-link' : 'fa-align-left';
            const tituloValor = opciones.titulo || '';
            const descripcionValor = opciones.descripcion || '';
            const urlValor = opciones.url || '';
            const contenidoValor = opciones.contenido || '';
            const formAction = esEdicion ? `/recurso/editar/${opciones.id}` : '/recurso/crear';

            return `
                <div id="recursoModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-lg shadow-xl w-full max-w-lg overflow-hidden animate-fade-in-up">
                        <div class="px-6 py-4 border-b flex justify-between items-center bg-gray-50">
                            <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                                <i class="fas ${iconModal} text-blue-600"></i> ${tituloModal}
                            </h3>
                            <button type="button" onclick="document.getElementById('recursoModal').remove()" class="text-gray-400 hover:text-gray-600 transition-colors">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        
                        <form id="recursoForm" action="${formAction}" method="post" class="p-6">
                            <input type="hidden" name="${csrfParameterName}" value="${csrfToken}" />
                            <input type="hidden" name="moduloId" value="${moduloId}" />
                            <input type="hidden" name="tipo" value="${tipo}" />
                            
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Título *</label>
                                <input type="text" name="titulo" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" placeholder="Título del recurso" value="${escapeHtmlAtributo(tituloValor)}">
                            </div>
                            
                            ${esEnlace ? `
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">URL (Enlace) *</label>
                                    <input type="url" name="url" required class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" placeholder="https://ejemplo.com" value="${escapeHtmlAtributo(urlValor)}">
                                </div>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
                                    <textarea name="descripcion" rows="2" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">${escapeHtml(descripcionValor)}</textarea>
                                </div>
                            ` : `
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Contenido *</label>
                                    <textarea name="contenido" rows="6" required class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" placeholder="Escribe aquí el contenido...">${escapeHtml(contenidoValor)}</textarea>
                                    <p class="text-xs text-gray-500 mt-1">Soporta HTML básico.</p>
                                </div>
                            `}
                            
                            <div class="flex justify-end gap-3 pt-4 border-t">
                                <button type="button" onclick="document.getElementById('recursoModal').remove()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                                    Cancelar
                                </button>
                                <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 shadow-sm">
                                    ${esEdicion ? 'Guardar cambios' : 'Guardar'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function abrirEditorRecursoDesdeCard(card) {
            if (!card) {
                return;
            }

            const actividadId = card.getAttribute('data-actividad-id');
            const tipo = (card.getAttribute('data-actividad-tipo') || '').toUpperCase();
            if (!actividadId || (tipo !== 'ENLACE' && tipo !== 'TEXTO')) {
                return;
            }

            const moduloCard = card.closest('.moodle-module');
            const moduloId = moduloCard ? moduloCard.getAttribute('data-modulo-id') : '';
            const moduloNombre = moduloCard ? moduloCard.getAttribute('data-modulo-nombre') : '';
            const titulo = card.getAttribute('data-actividad-titulo') || '';
            const descripcion = card.getAttribute('data-actividad-descripcion') || '';
            const url = card.getAttribute('data-actividad-url') || '';
            const contenido = card.getAttribute('data-actividad-contenido') || '';

            const modalHTML = crearFormularioRecurso(moduloId, moduloNombre, tipo, {
                modo: 'editar',
                id: actividadId,
                titulo,
                descripcion,
                url,
                contenido
            });

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        async function guardarRecurso(form) {
            const formData = new FormData(form);
            const btnSubmit = form.querySelector('button[type="submit"]');
            const originalText = btnSubmit.innerHTML;

            btnSubmit.disabled = true;
            btnSubmit.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

            try {
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    window.location.reload();
                } else {
                    alert('Error: ' + data.message);
                    btnSubmit.disabled = false;
                    btnSubmit.innerHTML = originalText;
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Ocurrió un error al guardar el recurso');
                btnSubmit.disabled = false;
                btnSubmit.innerHTML = originalText;
            }
        }

        // ========================================
        // FORMULARIO DE TAREA
        // ========================================
        function crearFormularioTarea(moduloId, moduloNombre) {
            const moduloNombreSeguro = escapeHtml(moduloNombre);
            return `
                <div id="formularioTareaModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[85vh] overflow-y-auto">
                        <h3 class="text-xl font-semibold mb-2 text-blue-600">
                            <i class="fas fa-file-alt me-2"></i>Crear Tarea
                        </h3>
                        <p class="text-sm text-gray-500 mb-4">
                            <i class="fas fa-folder text-gray-400 me-1"></i>${moduloNombreSeguro}
                        </p>
                        
                        <form id="formTarea" class="space-y-4">
                            <input type="hidden" name="moduloId" value="${moduloId}">
                            
                            <!-- Información Básica -->
                            <div class="border-b pb-4">
                                <h4 class="text-sm font-semibold text-gray-700 mb-3">
                                    <i class="fas fa-info-circle me-1"></i>Información Básica
                                </h4>
                                
                                <div class="mb-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        <i class="fas fa-heading me-1"></i>Nombre de la tarea *
                                    </label>
                                    <input type="text" name="titulo"
                                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500"
                                           placeholder="Ej: Trabajo Práctico N°1">
                                </div>
                                
                                <div class="mb-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        <i class="fas fa-align-left me-1"></i>Descripción / Instrucciones *
                                    </label>
                                    <textarea name="descripcion" rows="3" required
                                              class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500"
                                              placeholder="Describe las instrucciones y objetivos de la tarea..."></textarea>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            <i class="fas fa-calendar-alt me-1"></i>Fecha y hora límite de entrega *
                                        </label>
                                        <input type="datetime-local" name="limiteEntrega" required
                                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Tipo de Entrega -->
                            <div class="border-b pb-4">
                                <h4 class="text-sm font-semibold text-gray-700 mb-3">
                                    <i class="fas fa-upload me-1"></i>Tipo de Entrega Permitida *
                                </h4>
                                
                                <div class="space-y-2">
                                    <label class="flex items-center p-2 border border-gray-200 rounded hover:bg-gray-50 cursor-pointer">
                                        <input type="checkbox" name="tipoEntrega" value="TEXTO" class="tipo-entrega-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded">
                                        <span class="ml-2 text-sm text-gray-700">
                                            <i class="fas fa-keyboard me-1"></i>Respuesta de texto
                                        </span>
                                    </label>
                                    
                                    <label class="flex items-center p-2 border border-gray-200 rounded hover:bg-gray-50 cursor-pointer">
                                        <input type="checkbox" name="tipoEntrega" value="ARCHIVOS" class="tipo-entrega-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded">
                                        <span class="ml-2 text-sm text-gray-700">
                                            <i class="fas fa-file me-1"></i>Entrega de archivos
                                        </span>
                                    </label>
                                </div>
                                <p class="text-xs text-gray-500 mt-2">
                                    <i class="fas fa-info-circle me-1"></i>Selecciona al menos un tipo de entrega
                                </p>
                            </div>
                            
                            <!-- Configuración de Entregas -->
                            <div class="border-b pb-4">
                                <h4 class="text-sm font-semibold text-gray-700 mb-3">
                                    <i class="fas fa-cog me-1"></i>Configuración de Entregas
                                </h4>
                                
                                <div class="space-y-3">
                                    <label class="flex items-start">
                                        <input type="checkbox" name="entregasTardias" value="true"
                                               class="h-4 w-4 text-blue-600 border-gray-300 rounded mt-0.5">
                                        <span class="ml-2">
                                            <span class="block text-sm font-medium text-gray-700">Permitir entregas fuera de término</span>
                                            <span class="block text-xs text-gray-500">Los alumnos podrán enviar la tarea después de la fecha límite</span>
                                        </span>
                                    </label>
                                    
                                    <label class="flex items-start">
                                        <input type="checkbox" name="modificaciones" value="true"
                                               class="h-4 w-4 text-blue-600 border-gray-300 rounded mt-0.5">
                                        <span class="ml-2">
                                            <span class="block text-sm font-medium text-gray-700">Permitir modificar entregas</span>
                                            <span class="block text-xs text-gray-500">Los alumnos podrán editar su entrega después de enviarla</span>
                                        </span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Visibilidad -->
                            <div class="pb-4">
                                <h4 class="text-sm font-semibold text-gray-700 mb-3">
                                    <i class="fas fa-eye me-1"></i>Visibilidad
                                </h4>
                                
                                <label class="flex items-start">
                                    <input type="checkbox" name="visibilidad" value="true"
                                           class="h-4 w-4 text-blue-600 border-gray-300 rounded mt-0.5" checked>
                                    <span class="ml-2">
                                        <span class="block text-sm font-medium text-gray-700">Publicar la tarea inmediatamente</span>
                                        <span class="block text-xs text-gray-500">Si no se marca, la tarea quedará oculta para los alumnos</span>
                                    </span>
                                </label>
                            </div>
                            
                            <div class="flex justify-end space-x-2 pt-4 border-t">
                                <button type="button" onclick="cerrarFormularioTarea()" 
                                        class="px-4 py-2 text-gray-600 hover:text-gray-800 border border-gray-300 rounded-md">
                                    <i class="fas fa-times me-1"></i>Cancelar
                                </button>
                                <button type="submit" 
                                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                    <i class="fas fa-save me-1"></i>Crear Tarea
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function cerrarFormularioTarea() {
            document.getElementById('formularioTareaModal')?.remove();
        }

        // ========================================
        // FORMULARIO DE EXAMEN
        // ========================================
        function crearFormularioExamen(moduloId, moduloNombre) {
            const modulosRelacionadosHtml = construirOpcionesModulos(moduloId);
            return `
                <div id="formularioExamenModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[70vh] overflow-y-auto">
                        <h3 class="text-xl font-semibold mb-2 text-purple-600">
                            <i class="fas fa-file-alt me-2"></i>Crear Examen
                        </h3>
                        <p class="text-sm text-gray-500 mb-4">
                            <i class="fas fa-folder text-gray-400 me-1"></i>${moduloNombre}
                        </p>
                        
                        <form id="formExamen" class="space-y-4">
                            <input type="hidden" name="moduloId" value="${moduloId}">
                            <input type="hidden" id="poolsData" name="poolsData" value="[]">
                            <input type="hidden" id="permitirPreExamen" name="permitirPreExamen" value="true">
                            
                            <!-- Información Básica -->
                            <div class="border-b pb-3">
                                <h4 class="font-semibold text-gray-700 mb-3">
                                    <i class="fas fa-info-circle me-1"></i>Información Básica
                                </h4>
                                
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            <i class="fas fa-heading me-1"></i>Título del examen *
                                        </label>
                                        <input type="text" name="titulo"
                                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500"
                                               placeholder="Ej: Examen Parcial - Unidad 1">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            <i class="fas fa-align-left me-1"></i>Descripción
                                        </label>
                                        <textarea name="descripcion" rows="2"
                                                  class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500"
                                                  placeholder="Instrucciones y temas del examen..."></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Configuración de Fechas -->
                            <div class="border-b pb-3">
                                <h4 class="font-semibold text-gray-700 mb-3">
                                    <i class="fas fa-calendar-alt me-1"></i>Fechas y Tiempo
                                </h4>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            <i class="fas fa-door-open me-1"></i>Fecha de apertura *
                                        </label>
                                        <input type="datetime-local" name="fechaApertura" required
                                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            <i class="fas fa-door-closed me-1"></i>Fecha de cierre *
                                        </label>
                                        <input type="datetime-local" name="fechaCierre" required
                                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            <i class="fas fa-clock me-1"></i>Tiempo límite (minutos)
                                        </label>
                                        <input type="number" name="tiempoRealizacion" min="0" value="60"
                                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            <i class="fas fa-redo me-1"></i>Intentos permitidos
                                        </label>
                                        <input type="number" name="cantidadIntentos" min="1" value="1"
                                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Pools de Preguntas -->
                            <div class="border-b pb-3">
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="font-semibold text-gray-700">
                                        <i class="fas fa-layer-group me-1"></i>Pools de Preguntas *
                                    </h4>
                                    <div class="flex gap-2">
                                        <button type="button" onclick="verPoolsDisponibles()" 
                                                class="px-3 py-1.5 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700">
                                            <i class="fas fa-eye me-1"></i>Ver Pools
                                        </button>
                                        <button type="button" onclick="agregarPoolExamen()" 
                                                class="px-3 py-1.5 bg-purple-600 text-white text-sm rounded-md hover:bg-purple-700">
                                            <i class="fas fa-plus me-1"></i>Agregar Pool
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="poolsList" class="space-y-2 min-h-[50px]">
                                    <p class="text-sm text-gray-500 italic" id="noPoolsMessage">
                                        No hay pools agregados. Haz clic en "Agregar Pool" para comenzar.
                                    </p>
                                </div>
                                
                                <div class="mt-2 p-2 bg-purple-50 rounded text-sm">
                                    <strong>Total de preguntas:</strong> <span id="totalPreguntas">0</span>
                                </div>
                            </div>

                            <!-- Módulos relacionados para IA -->
                            <div class="border-b pb-3">
                                <h4 class="font-semibold text-gray-700 mb-3">
                                    <i class="fas fa-book-open me-1"></i>Módulos relacionados para la IA
                                </h4>
                                <div class="space-y-2">
                                    ${modulosRelacionadosHtml}
                                </div>
                                <p class="text-xs text-gray-500 mt-2">
                                    Estos módulos se usarán como contexto para la retroalimentación automática del examen.
                                </p>
                            </div>
                            
                            <!-- Opciones -->
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" name="calificacionAutomatica" value="true" checked
                                           class="h-4 w-4 text-purple-600 border-gray-300 rounded">
                                    <span class="ml-2 text-sm text-gray-700">
                                        <i class="fas fa-magic me-1"></i>Calificación automática
                                    </span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="publicarNota" value="true"
                                           class="h-4 w-4 text-purple-600 border-gray-300 rounded">
                                    <span class="ml-2 text-sm text-gray-700">
                                        <i class="fas fa-eye me-1"></i>Publicar nota automáticamente
                                    </span>
                                </label>
                            </div>
                            
                            <div class="flex justify-end space-x-2 pt-4 border-t">
                                <button type="button" onclick="cerrarFormularioExamen()" 
                                        class="px-4 py-2 text-gray-600 hover:text-gray-800 border border-gray-300 rounded-md">
                                    <i class="fas fa-times me-1"></i>Cancelar
                                </button>
                                <button type="submit" 
                                        class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">
                                    <i class="fas fa-save me-1"></i>Crear Examen
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function obtenerModulosDesdeDOM() {
            const cards = document.querySelectorAll('.moodle-module[data-modulo-id]');
            const modulos = [];
            const seen = new Set();
            cards.forEach(card => {
                const id = card.dataset.moduloId;
                if (!id || seen.has(id)) return;
                seen.add(id);
                const nombre = card.dataset.moduloNombre || card.querySelector('.module-title')?.textContent?.trim() || 'Módulo';
                modulos.push({ id, nombre });
            });
            return modulos;
        }

        function escapeHtml(text) {
            return (text || '').replace(/[&<>"']/g, function (ch) {
                switch (ch) {
                    case '&': return '&amp;';
                    case '<': return '&lt;';
                    case '>': return '&gt;';
                    case '"': return '&quot;';
                    case "'": return '&#39;';
                    default: return ch;
                }
            });
        }

        function construirOpcionesModulos(moduloIdActual) {
            const modulos = obtenerModulosDesdeDOM();
            if (modulos.length === 0) {
                return '<p class="text-sm text-gray-500 italic">No hay módulos disponibles.</p>';
            }
            return modulos.map(m => {
                const checked = m.id === moduloIdActual ? 'checked' : '';
                const badge = m.id === moduloIdActual ? '<span class="text-xs text-gray-500">(módulo principal)</span>' : '';
                return `
                    <label class="flex items-start gap-2 text-sm">
                        <input type="checkbox" name="modulosRelacionados" value="${m.id}" ${checked}
                               class="h-4 w-4 text-purple-600 border-gray-300 rounded">
                        <span class="text-gray-700"><strong>${escapeHtml(m.nombre)}</strong> ${badge}</span>
                    </label>
                `;
            }).join('');
        }

        // Variable global para almacenar los pools del examen actual
        let examenPools = [];

        // Variable global con el ID de la oferta académica (se interpola desde Thymeleaf)
        const OFERTA_ID = /*[[${curso.idOferta}]]*/ 0;
        const PUEDE_MODIFICAR = /*[[${puedeModificar}]]*/ false;

        console.log('🔍 OFERTA_ID cargado:', OFERTA_ID);

        function agregarPoolExamen() {
            // Mostrar modal para crear/seleccionar pool
            mostrarModalPool();
        }

        function mostrarModalPool() {
            console.log('📋 Cargando pools para oferta:', OFERTA_ID);

            // Primero cargamos los pools existentes de esta oferta
            fetch(`/pool/listar/${OFERTA_ID}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error al cargar pools: ' + response.status);
                    }
                    return response.json();
                })
                .then(poolsExistentes => {
                    console.log('=== POOLS EXISTENTES ===');
                    console.log('Cantidad:', poolsExistentes.length);
                    console.log('Pools:', poolsExistentes);
                    console.log('========================');

                    const modalHTML = `
                        <div id="modalPool" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[110]">
                            <div class="bg-white rounded-lg p-5 w-full max-w-xl max-h-[85vh] overflow-y-auto">
                                <h3 class="text-lg font-semibold mb-4 text-purple-600">
                                    <i class="fas fa-layer-group me-2"></i>Agregar Pool de Preguntas
                                </h3>
                                
                                <!-- Pestañas -->
                                <div class="mb-4 border-b border-gray-200">
                                    <nav class="flex space-x-4">
                                        <button onclick="cambiarTabPool('crear')" id="tabCrear"
                                                class="tab-pool px-4 py-2 border-b-2 border-purple-600 text-purple-600 font-medium">
                                            <i class="fas fa-plus me-1"></i>Crear Nuevo
                                        </button>
                                        <button onclick="cambiarTabPool('existente')" id="tabExistente"
                                                class="tab-pool px-4 py-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                                            <i class="fas fa-list me-1"></i>Usar Existente (${poolsExistentes.length})
                                        </button>
                                    </nav>
                                </div>
                                
                                <!-- Contenido Tab: Crear Nuevo -->
                                <div id="tabContenidoCrear" class="tab-content">
                                    
                                    <!-- Selector Modo Creación: Manual vs IA -->
                                    <div class="flex items-center space-x-4 mb-4 bg-gray-50 p-2 rounded-lg">
                                        <label class="flex justify-center flex-1 cursor-pointer">
                                            <input type="radio" name="modoCreacion" value="manual" checked class="hidden peer" onchange="toggleModoCreacion('manual')">
                                            <div class="px-4 py-1.5 rounded text-sm font-medium text-gray-600 peer-checked:bg-white peer-checked:text-purple-600 peer-checked:shadow w-full text-center transition">
                                                <i class="fas fa-edit me-1"></i>Manual
                                            </div>
                                        </label>
                                        <label class="flex justify-center flex-1 cursor-pointer">
                                            <input type="radio" name="modoCreacion" value="ia" class="hidden peer" onchange="toggleModoCreacion('ia')">
                                            <div class="px-4 py-1.5 rounded text-sm font-medium text-gray-600 peer-checked:bg-white peer-checked:text-purple-600 peer-checked:shadow w-full text-center transition">
                                                <i class="fas fa-magic me-1"></i>Con IA
                                            </div>
                                        </label>
                                    </div>

                                    <form id="formPool">
                                        <input type="hidden" name="esIA" id="inputEsIA" value="false">
                                        
                                        <div class="space-y-3">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                                    <i class="fas fa-heading me-1"></i>Nombre del pool *
                                                </label>
                                                <input type="text" name="nombrePool" required
                                                       class="w-full border border-gray-300 rounded-md px-3 py-2"
                                                       placeholder="Ej: Tema 1 - Introducción">
                                            </div>
                                            
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                                    <i class="fas fa-align-left me-1"></i>Descripción
                                                </label>
                                                <textarea name="descripcionPool" rows="2"
                                                          class="w-full border border-gray-300 rounded-md px-3 py-2"
                                                          placeholder="Describe el contenido del pool..."></textarea>
                                            </div>
                                            
                                            <!-- Inputs Específicos IA -->
                                            <div id="seccionIA" class="hidden space-y-3 border-t pt-3 border-purple-100 bg-purple-50 p-3 rounded">
                                                <div>
                                                    <label class="block text-sm font-medium text-purple-700 mb-1">
                                                        <i class="fas fa-robot me-1"></i>Temas / Conceptos
                                                    </label>
                                                    <input type="text" id="iaTemas" 
                                                           class="w-full border border-purple-300 rounded-md px-3 py-2 focus:ring-purple-500"
                                                           placeholder="Ej: Historia, Revolución Francesa, Fechas importantes">
                                                </div>
                                                
                                                <div>
                                                    <label class="block text-sm font-medium text-purple-700 mb-1">
                                                        <i class="fas fa-book me-1"></i>Materiales de Referencia
                                                    </label>
                                                    <div id="listaMaterialesContainer" class="max-h-32 overflow-y-auto border border-purple-200 rounded p-2 bg-white">
                                                        <p class="text-xs text-gray-400 text-center py-2" id="msgCargandoMateriales">Selecciona modo IA para cargar materiales...</p>
                                                    </div>
                                                    <small class="text-purple-600 text-xs text-right block mt-1">
                                                        Selecciona los archivos que la IA usará como contexto.
                                                    </small>
                                                </div>
                                            </div>
                                            
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                                    <i class="fas fa-list-ol me-1"></i>Cantidad de preguntas que se tomarán *
                                                </label>
                                                <input type="number" name="cantidadPreguntas" required min="1" value="1"
                                                       class="w-full border border-gray-300 rounded-md px-3 py-2">
                                                <small class="text-gray-500">
                                                    <span id="txtAyudaManual">De todas las preguntas agregadas, cuántas se mostrarán.</span>
                                                    <span id="txtAyudaIA" class="hidden text-purple-600">La IA generará al menos esta cantidad.</span>
                                                </small>
                                            </div>
                                        </div>
                                        
                                        <div class="flex justify-end space-x-2 mt-4 pt-4 border-t">
                                            <button type="button" onclick="cerrarModalPool()" 
                                                    class="px-3 py-2 text-gray-600 hover:text-gray-800 border border-gray-300 rounded-md">
                                                Cancelar
                                            </button>
                                            <button type="submit" id="btnCrearPool"
                                                    class="px-3 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 flex items-center">
                                                <i class="fas fa-plus me-1"></i><span id="txtBtnCrear">Crear Pool</span>
                                            </button>
                                        </div>
                                    </form>
                                </div>
                                
                                <!-- Contenido Tab: Usar Existente -->
                                <div id="tabContenidoExistente" class="tab-content hidden">
                                    ${poolsExistentes.length > 0 ? `
                                        <div class="space-y-2">
                                            <p class="text-sm text-gray-600 mb-3">
                                                <i class="fas fa-info-circle me-1"></i>
                                                Selecciona un pool creado previamente en esta oferta académica
                                            </p>
                                            ${poolsExistentes.map(pool => `
                                                <div class="border border-gray-200 rounded-lg p-3 hover:border-purple-500 transition flex items-start justify-between group">
                                                    <div class="flex-1 cursor-pointer" onclick="seleccionarPoolExistente('${pool.idPool}', '${pool.nombre}', '${pool.descripcion || ''}', ${pool.cantidadPreguntas}, ${pool.preguntasCount || 0})">
                                                        <h4 class="font-medium text-gray-900 group-hover:text-purple-700">${pool.nombre}</h4>
                                                        ${pool.descripcion ? `<p class="text-sm text-gray-600 mt-1">${pool.descripcion}</p>` : ''}
                                                        <div class="flex items-center gap-3 mt-2 text-xs text-gray-500">
                                                            <span><i class="fas fa-question-circle me-1"></i>${typeof pool.preguntasCount === 'number' ? pool.preguntasCount : 0} preguntas creadas</span>
                                                            <span><i class="fas fa-list-ol me-1"></i>Toma ${pool.cantidadPreguntas} al azar</span>
                                                        </div>
                                                    </div>
                                                    <div class="flex flex-col gap-2 ml-2">
                                                        <button type="button" onclick="editarPoolExistente('${pool.idPool}', '${pool.nombre}', '${pool.descripcion || ''}', ${pool.cantidadPreguntas})" 
                                                                class="text-blue-600 hover:text-blue-800 p-1 rounded hover:bg-blue-50" title="Editar configuración">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <i class="fas fa-chevron-right text-gray-400 p-1"></i>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                        <div class="flex justify-end mt-4 pt-4 border-t">
                                            <button type="button" onclick="cerrarModalPool()" 
                                                    class="px-3 py-2 text-gray-600 hover:text-gray-800 border border-gray-300 rounded-md">
                                                Cancelar
                                            </button>
                                        </div>
                                    ` : `
                                        <div class="text-center py-8 text-gray-500">
                                            <i class="fas fa-inbox fa-3x mb-3"></i>
                                            <p>No hay pools creados en esta oferta académica</p>
                                            <button onclick="cambiarTabPool('crear')" class="mt-3 text-purple-600 hover:underline">
                                                <i class="fas fa-plus me-1"></i>Crear el primero
                                            </button>
                                        </div>
                                    `}
                                </div>
                            </div>
                        </div>
                    `;

                    document.body.insertAdjacentHTML('beforeend', modalHTML);

                    // Event listener para el formulario de pool
                    document.getElementById('formPool').addEventListener('submit', function (e) {
                        e.preventDefault();
                        const formData = new FormData(e.target);
                        // Asociar el pool a la oferta actual
                        formData.append('ofertaId', OFERTA_ID);

                        const esIA = document.getElementById('inputEsIA').value === 'true';

                        if (esIA) {
                            const temas = document.getElementById('iaTemas').value;

                            // Obtener materiales seleccionados
                            const materialesSeleccionados = Array.from(document.querySelectorAll('input[name="materialesIA"]:checked')).map(cb => cb.value);

                            const iaParams = {
                                temas: temas,
                                materialesIds: materialesSeleccionados, // Nuevo campo
                                cantidad: formData.get('cantidadPreguntas'),
                                tipos: ["MULTIPLE_CHOICE"]
                            };
                            formData.append('iaParams', JSON.stringify(iaParams));
                        }

                        const ejecutarCreacionPool = () => {
                            fetch('/pool/crear', {
                                method: 'POST',
                                headers: {
                                    'X-XSRF-TOKEN': document.querySelector('meta[name="_csrf"]')?.getAttribute('content') || ''
                                },
                                body: formData
                            })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        const poolIdReal = data.idPool;

                                        const nuevoPool = {
                                            id: Date.now(), // ID temporal para el frontend
                                            idReal: poolIdReal, // ID real del backend
                                            nombre: formData.get('nombrePool'),
                                            descripcion: formData.get('descripcionPool'),
                                            cantidadPreguntas: parseInt(formData.get('cantidadPreguntas')),
                                            preguntas: [],
                                            esIA: esIA // Flag frontend
                                        };

                                        // Si es IA y status es PENDING, iniciamos polling
                                        if (esIA && data.iaStatus === 'PENDING') {
                                            nuevoPool.iaStatus = 'PENDING';
                                            iniciarPollingIA(nuevoPool);
                                        }

                                        examenPools.push(nuevoPool);
                                        actualizarListaPools();
                                        cerrarModalPool();

                                        if (esIA) {
                                            mostrarNotificacionGlobal('Pool en proceso', 'Generando preguntas con IA...', 'info');
                                        } else {
                                            mostrarNotificacionGlobal('Pool creado', 'Pool creado y guardado exitosamente.', 'success', () => {
                                                mostrarModalPreguntas(nuevoPool.id, poolIdReal);
                                            });
                                        }
                                    } else {
                                        alert('❌ Error: ' + data.message);
                                    }
                                })
                                .catch(error => {
                                    console.error('Error al crear pool:', error);
                                    alert('❌ Error al crear el pool. Por favor, intenta de nuevo.');
                                });
                        };

                        const mensajeConfirmacion = esIA
                            ? '¿Confirmas generar este pool con IA?'
                            : '¿Confirmas la creación de este pool?';
                        const textoConfirmar = esIA ? 'Generar' : 'Crear';

                        mostrarConfirmacionGlobal(
                            'Crear pool',
                            mensajeConfirmacion,
                            ejecutarCreacionPool,
                            { confirmText: textoConfirmar, cancelText: 'Cancelar', type: 'info' }
                        );
                    });
                })
                .catch(error => {
                    console.error('Error al cargar pools:', error);
                    alert('Error al cargar los pools existentes');
                });
        }

        function toggleModoCreacion(modo) {
            const esIA = modo === 'ia';
            document.getElementById('inputEsIA').value = esIA;

            const seccionIA = document.getElementById('seccionIA');
            const txtAyudaManual = document.getElementById('txtAyudaManual');
            const txtAyudaIA = document.getElementById('txtAyudaIA');
            const btnCrear = document.getElementById('txtBtnCrear');

            if (esIA) {
                seccionIA.classList.remove('hidden');
                txtAyudaManual.classList.add('hidden');
                txtAyudaIA.classList.remove('hidden');
                btnCrear.textContent = 'Generar con IA';
                cargarMaterialesIA(); // Cargar materiales al activar modo IA
            } else {
                seccionIA.classList.add('hidden');
                txtAyudaManual.classList.remove('hidden');
                txtAyudaIA.classList.add('hidden');
                btnCrear.textContent = 'Crear Pool';
            }
        }

        function iniciarPollingIA(pool) {
            const intervalId = setInterval(() => {
                fetch(`/pool/estado/${pool.idReal}`)
                    .then(r => r.json())
                    .then(data => {
                        console.log(`Polling IA pool ${pool.idReal}: ${data.status}`);
                        pool.iaStatus = data.status;

                        if (data.status === 'READY') {
                            clearInterval(intervalId);
                            // Cargar preguntas generadas
                            fetch(`/pool/detalle/${pool.idReal}`)
                                .then(r => r.json())
                                .then(d => {
                                    if (d.success && d.preguntas) {
                                        pool.preguntas = d.preguntas;
                                        pool.preguntasCount = d.preguntas.length;
                                        actualizarListaPools();
                                        mostrarNotificacionGlobal('Preguntas generadas', `Preguntas generadas para el pool "${pool.nombre}"`, 'success');
                                    }
                                });
                        } else if (data.status === 'FAILED') {
                            clearInterval(intervalId);
                            pool.iaErrorMessage = data.errorMessage;
                            actualizarListaPools();
                            alert(`❌ Error al generar preguntas para "${pool.nombre}": ${data.errorMessage}`);
                        }

                        actualizarListaPools(); // Actualizar UI (spinner, etc)
                    })
                    .catch(e => {
                        console.error('Error polling IA:', e);
                        clearInterval(intervalId);
                    });
            }, 3000); // Poll cada 3s
        }

        // Variable global para cachear materiales y evitar recargas
        let materialesCache = null;

        function cargarMaterialesCache() {
            if (materialesCache) {
                return Promise.resolve(materialesCache);
            }
            return fetch(`/pool/materiales/${OFERTA_ID}`)
                .then(r => r.json())
                .then(data => {
                    materialesCache = data;
                    return data;
                });
        }

        function cargarMaterialesIA() {
            const container = document.getElementById('listaMaterialesContainer');
            const msg = document.getElementById('msgCargandoMateriales');

            if (msg) msg.textContent = 'Cargando materiales...';

            cargarMaterialesCache()
                .then(data => {
                    renderizarMateriales(data);
                })
                .catch(e => {
                    console.error('Error cargando materiales:', e);
                    container.innerHTML = '<p class="text-xs text-red-500 text-center py-2">Error cargando materiales</p>';
                });
        }

        function renderizarMateriales(materiales) {
            const container = document.getElementById('listaMaterialesContainer');
            if (!materiales || materiales.length === 0) {
                container.innerHTML = '<p class="text-xs text-gray-400 text-center py-2">No hay materiales disponibles en este curso.</p>';
                return;
            }

            container.innerHTML = materiales.map(m => `
                <div class="flex items-center mb-2 last:mb-0">
                    <input type="checkbox" name="materialesIA" value="${m.id}" id="mat_${m.id}" 
                           class="h-4 w-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                    <label for="mat_${m.id}" class="ml-2 block text-sm text-gray-900 cursor-pointer truncate w-full" title="${m.titulo}">
                        <i class="fas fa-file-alt text-gray-400 me-1"></i>
                        ${m.titulo} 
                        <span class="text-gray-400 text-xs">(${m.moduloNombre})</span>
                    </label>
                </div>
            `).join('');
        }

        function obtenerNombreModuloPorId(moduloId) {
            const modulos = obtenerModulosDesdeDOM();
            const modulo = modulos.find(m => `${m.id}` === `${moduloId}`);
            return modulo ? modulo.nombre : 'Modulo';
        }

        function tieneMaterialEnModulo(moduloId) {
            if (!materialesCache || !moduloId) {
                return false;
            }
            return materialesCache.some(m => `${m.moduloId}` === `${moduloId}`);
        }

        function tieneMaterialEnModulos(moduloIds) {
            if (!materialesCache || !moduloIds || moduloIds.length === 0) {
                return false;
            }
            return moduloIds.some(id => materialesCache.some(m => `${m.moduloId}` === `${id}`));
        }

        function abrirFormularioMaterialParaModulo(moduloId) {
            const nombre = obtenerNombreModuloPorId(moduloId);
            const formularioHTML = crearFormularioMaterial(moduloId, nombre);
            document.body.insertAdjacentHTML('beforeend', formularioHTML);
        }

        function mostrarAdvertenciaMaterialExamen(moduloId, onContinuar) {
            const mensaje = 'No hay material en los modulos seleccionados. Si continuas, no se generara el PRE EXAMEN automaticamente.';
            mostrarConfirmacionGlobal(
                'Material faltante',
                mensaje,
                onContinuar,
                { confirmText: 'Continuar', cancelText: 'Anadir material', type: 'warning' }
            );

            const btnCancel = document.getElementById('btnCancelConfirm');
            if (btnCancel) {
                const newBtn = btnCancel.cloneNode(true);
                btnCancel.parentNode.replaceChild(newBtn, btnCancel);
                newBtn.textContent = 'Anadir material';
                newBtn.style.display = 'inline-flex';
                newBtn.addEventListener('click', () => {
                    if (window.ModalConfirmacion) {
                        ModalConfirmacion.close();
                    }
                    if (moduloId) {
                        abrirFormularioMaterialParaModulo(moduloId);
                    }
                });
            }
        }

        function editarPoolExistente(idPool, nombre, descripcion, cantidadPreguntas) {
            // Cambiar a la pestaña de crear (que usaremos para editar)
            cambiarTabPool('crear');

            // Llenar el formulario
            const form = document.getElementById('formPool');
            form.nombrePool.value = nombre;
            form.descripcionPool.value = descripcion;
            form.cantidadPreguntas.value = cantidadPreguntas;

            // Cambiar título y botón
            const tabCrearBtn = document.getElementById('tabCrear');
            tabCrearBtn.innerHTML = '<i class="fas fa-edit me-1"></i>Editar Pool';

            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.innerHTML = '<i class="fas fa-save me-1"></i>Guardar Cambios';
            submitBtn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
            submitBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');

            // Reemplazar el handler del submit
            // Clonamos el nodo para eliminar listeners anteriores
            const newForm = form.cloneNode(true);
            form.parentNode.replaceChild(newForm, form);

            // Reasignar valores porque cloneNode no copia valores de inputs modificados por JS
            newForm.nombrePool.value = nombre;
            newForm.descripcionPool.value = descripcion;
            newForm.cantidadPreguntas.value = cantidadPreguntas;

            newForm.addEventListener('submit', function (e) {
                e.preventDefault();
                const formData = new FormData(e.target);

                const ejecutarEdicionPool = () => {
                    fetch(`/pool/editar/${idPool}`, {
                        method: 'POST',
                        headers: {
                            'X-XSRF-TOKEN': document.querySelector('meta[name="_csrf"]')?.getAttribute('content') || ''
                        },
                        body: formData
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                cerrarModalPool();
                                mostrarNotificacionGlobal('Pool actualizado', 'Pool actualizado exitosamente.', 'success', () => {
                                    // Recargar modal para ver cambios
                                    setTimeout(mostrarModalPool, 300);
                                });
                            } else {
                                alert('❌ Error: ' + data.message);
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('Error al actualizar el pool');
                        });
                };

                mostrarConfirmacionGlobal(
                    'Actualizar pool',
                    '¿Confirmas guardar los cambios del pool?',
                    ejecutarEdicionPool,
                    { confirmText: 'Guardar', cancelText: 'Cancelar', type: 'info' }
                );
            });
        }

        function cambiarTabPool(tab) {
            // Actualizar clases de tabs
            document.getElementById('tabCrear').className = tab === 'crear'
                ? 'tab-pool px-4 py-2 border-b-2 border-purple-600 text-purple-600 font-medium'
                : 'tab-pool px-4 py-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700';
            document.getElementById('tabExistente').className = tab === 'existente'
                ? 'tab-pool px-4 py-2 border-b-2 border-purple-600 text-purple-600 font-medium'
                : 'tab-pool px-4 py-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700';

            // Mostrar/ocultar contenidos
            document.getElementById('tabContenidoCrear').classList.toggle('hidden', tab !== 'crear');
            document.getElementById('tabContenidoExistente').classList.toggle('hidden', tab !== 'existente');
        }

        function seleccionarPoolExistente(idPool, nombre, descripcion, cantidadPreguntas, preguntasCount) {
            // Validar que no se agregue el mismo pool dos veces
            const poolYaAgregado = examenPools.find(p => p.idReal === idPool);
            if (poolYaAgregado) {
                alert('⚠️ Este pool ya ha sido agregado al examen.');
                return;
            }

            const maxDisponible = typeof preguntasCount === 'number' ? preguntasCount : 0;
            let cantidadSeleccionada = parseInt(cantidadPreguntas, 10);
            if (isNaN(cantidadSeleccionada) || cantidadSeleccionada < 1) {
                cantidadSeleccionada = maxDisponible > 0 ? 1 : 0;
            }
            if (maxDisponible > 0 && cantidadSeleccionada > maxDisponible) {
                cantidadSeleccionada = maxDisponible;
            }

            const nuevoPool = {
                id: Date.now(),
                idReal: idPool,
                nombre: nombre,
                descripcion: descripcion,
                cantidadPreguntas: cantidadSeleccionada,
                preguntas: [], // Se cargarán del backend si hiciera falta
                preguntasCount: typeof preguntasCount === 'number' ? preguntasCount : 0,
                esExistente: true
            };

            examenPools.push(nuevoPool);
            actualizarListaPools();
            cerrarModalPool();
            mostrarNotificacionGlobal('Pool agregado', 'Pool agregado al examen.', 'success');
        }

        function cerrarModalPool() {
            document.getElementById('modalPool')?.remove();
        }

        function obtenerMaxPreguntas(pool) {
            const count = pool.esExistente
                ? (typeof pool.preguntasCount === 'number'
                    ? pool.preguntasCount
                    : (pool.preguntas ? pool.preguntas.length : 0))
                : (pool.preguntas ? pool.preguntas.length : 0);
            return typeof count === 'number' ? count : 0;
        }

        function normalizarCantidadPool(pool) {
            if (pool.iaStatus === 'GENERATING' || pool.iaStatus === 'PENDING') {
                return obtenerMaxPreguntas(pool);
            }

            const max = obtenerMaxPreguntas(pool);
            if (!max || max < 1) {
                pool.cantidadPreguntas = 0;
                return max;
            }

            let valor = parseInt(pool.cantidadPreguntas, 10);
            if (isNaN(valor) || valor < 1) valor = 1;
            if (valor > max) valor = max;
            pool.cantidadPreguntas = valor;
            return max;
        }

        function actualizarListaPools() {
            const poolsList = document.getElementById('poolsList');
            const noPoolsMsg = document.getElementById('noPoolsMessage');

            if (examenPools.length === 0) {
                noPoolsMsg?.classList.remove('hidden');
                if (poolsList) {
                    poolsList.innerHTML = '';
                }
                document.getElementById('totalPreguntas').textContent = '0';
                document.getElementById('poolsData').value = JSON.stringify([]);
                return;
            }

            noPoolsMsg?.classList.add('hidden');

            poolsList.innerHTML = examenPools.map((pool, index) => {
                let badgeStatus = '';
                let actionButtons = '';
                let preguntaCountText = '';
                let isGenerating = pool.iaStatus === 'GENERATING' || pool.iaStatus === 'PENDING';
                const maxPreguntas = normalizarCantidadPool(pool);
                const cantidadActual = typeof pool.cantidadPreguntas === 'number'
                    ? pool.cantidadPreguntas
                    : (parseInt(pool.cantidadPreguntas, 10) || 0);
                const minCantidad = maxPreguntas > 0 ? 1 : 0;
                const inputDisabled = isGenerating || maxPreguntas < 1;

                if (isGenerating) {
                    badgeStatus = `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800 ml-2">
                        <svg class="animate-spin -ml-1 mr-2 h-3 w-3 text-yellow-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Generando IA...
                    </span>`;
                    preguntaCountText = 'Procesando...';
                    actionButtons = `
                        <button type="button" disabled
                                class="px-2 py-1 text-xs bg-gray-300 text-white rounded cursor-not-allowed"
                                title="Generando preguntas...">
                            <i class="fas fa-spinner fa-spin"></i>
                        </button>
                        <button type="button" onclick="eliminarPool(${index})" 
                                class="px-2 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600"
                                title="Eliminar pool">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                } else if (pool.iaStatus === 'FAILED') {
                    badgeStatus = `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800 ml-2">
                        <i class="fas fa-exclamation-triangle mr-1"></i> Falló IA
                    </span>`;
                    preguntaCountText = `${typeof pool.preguntasCount === 'number' ? pool.preguntasCount : (pool.preguntas ? pool.preguntas.length : 0)} pregunta(s)`;
                    actionButtons = `
                        <button type="button" onclick="mostrarModalPreguntas(${pool.id}, '${pool.idReal || ''}')" 
                                class="px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600"
                                title="Gestionar preguntas">
                                <i class="fas fa-plus"></i>
                        </button>
                        <button type="button" onclick="eliminarPool(${index})" 
                                class="px-2 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600"
                                title="Eliminar pool">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                } else {
                    if (pool.generatedByIA) {
                        badgeStatus = `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800 ml-2">
                            <i class="fas fa-robot mr-1"></i> IA
                        </span>`;
                    }
                    preguntaCountText = `${typeof pool.preguntasCount === 'number' ? pool.preguntasCount : (pool.preguntas ? pool.preguntas.length : 0)} pregunta(s) creada(s)`;
                    actionButtons = `
                        <button type="button" onclick="mostrarModalPreguntas(${pool.id}, '${pool.idReal || ''}')" 
                                class="px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600"
                                title="Agregar preguntas">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button type="button" onclick="eliminarPool(${index})" 
                                class="px-2 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600"
                                title="Eliminar pool">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                }

                return `
                <div class="border border-purple-200 rounded-lg p-3 bg-purple-50 transition-all duration-300">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h5 class="font-semibold text-gray-800 flex items-center">
                                <i class="fas fa-layer-group text-purple-600 me-1"></i>${pool.nombre}
                                ${badgeStatus}
                            </h5>
                            <p class="text-sm text-gray-600 mt-1">${pool.descripcion || 'Sin descripción'}</p>
                            <div class="mt-2 flex items-center space-x-4 text-xs text-gray-500">
                                <span>
                                    <i class="fas fa-question-circle me-1"></i>
                                    ${preguntaCountText}
                                </span>
                                <label class="flex items-center gap-2">
                                    <i class="fas fa-random me-1"></i>
                                    Tomar
                                    <input type="number"
                                           min="${minCantidad}"
                                           max="${maxPreguntas}"
                                           value="${cantidadActual}"
                                           onchange="actualizarCantidadPool(${index}, this.value)"
                                           ${inputDisabled ? 'disabled' : ''}
                                           class="w-16 border border-gray-300 rounded px-1 py-0.5 text-xs text-center ${inputDisabled ? 'bg-gray-100 text-gray-400' : ''}">
                                    <span class="text-gray-400">/ ${maxPreguntas}</span>
                                </label>
                            </div>
                        </div>
                        <div class="flex space-x-1 ml-2">
                            ${actionButtons}
                        </div>
                    </div>
                </div>
            `}).join('');

            // Actualizar totales
            const totalPreguntas = examenPools.reduce((sum, pool) => sum + pool.cantidadPreguntas, 0);
            document.getElementById('totalPreguntas').textContent = totalPreguntas;
            // document.getElementById('calificacionInfo').textContent =
            //    totalPreguntas > 0 ? `${(100 / totalPreguntas).toFixed(2)} puntos por pregunta` : 'No configurada';

            // Actualizar campo hidden con datos JSON
            document.getElementById('poolsData').value = JSON.stringify(examenPools);
        }

        function actualizarCantidadPool(index, valor) {
            const pool = examenPools[index];
            if (!pool) return;

            const max = obtenerMaxPreguntas(pool);
            let nuevaCantidad = parseInt(valor, 10);
            if (isNaN(nuevaCantidad)) nuevaCantidad = 1;

            if (max < 1) {
                nuevaCantidad = 0;
            } else {
                if (nuevaCantidad < 1) nuevaCantidad = 1;
                if (nuevaCantidad > max) nuevaCantidad = max;
            }

            pool.cantidadPreguntas = nuevaCantidad;
            actualizarListaPools();
        }

        function actualizarCantidadPoolPorId(poolId, inputEl) {
            const index = examenPools.findIndex(p => p.id === poolId);
            if (index === -1) return;
            const valor = inputEl ? inputEl.value : undefined;
            actualizarCantidadPool(index, valor);
            if (inputEl) {
                inputEl.value = examenPools[index].cantidadPreguntas;
            }
        }

        function eliminarPool(index) {
            mostrarConfirmacionGlobal(
                'Eliminar pool',
                '¿Estás seguro de eliminar este pool?',
                () => {
                    examenPools.splice(index, 1);
                    actualizarListaPools();
                },
                { confirmText: 'Eliminar', cancelText: 'Cancelar', type: 'warning' }
            );
        }

        function mostrarModalPreguntas(poolId, poolIdReal = null) {
            const pool = examenPools.find(p => p.id === poolId);
            if (!pool) return;

            if (pool.esExistente && poolIdReal && !pool.preguntasLoaded) {
                if (pool.cargandoPreguntas) return;
                pool.cargandoPreguntas = true;

                fetch(`/pool/detalle/${poolIdReal}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && Array.isArray(data.preguntas)) {
                            pool.preguntas = data.preguntas.map(p => ({
                                enunciado: p.enunciado,
                                tipoPregunta: p.tipoPregunta,
                                puntaje: p.puntaje,
                                opciones: p.opciones || []
                            }));
                            pool.preguntasCount = pool.preguntas.length;
                        }
                        pool.preguntasLoaded = true;
                    })
                    .catch(error => {
                        console.error('Error al cargar preguntas del pool:', error);
                        pool.preguntasLoaded = true;
                    })
                    .finally(() => {
                        pool.cargandoPreguntas = false;
                        mostrarModalPreguntas(poolId, poolIdReal);
                    });

                return;
            }

            const maxPreguntas = normalizarCantidadPool(pool);
            const minCantidad = maxPreguntas > 0 ? 1 : 0;
            const cantidadActual = typeof pool.cantidadPreguntas === 'number'
                ? pool.cantidadPreguntas
                : (parseInt(pool.cantidadPreguntas, 10) || 0);
            const inputDisabled = maxPreguntas < 1;

            const modalHTML = `
                <div id="modalPreguntas" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70] overflow-y-auto">
                    <div class="bg-white rounded-lg p-6 w-full max-w-3xl my-8 max-h-[90vh] overflow-y-auto">
                        <h3 class="text-lg font-semibold mb-2 text-blue-600">
                            <i class="fas fa-question-circle me-2"></i>Preguntas del Pool: ${pool.nombre}
                        </h3>
                        <p class="text-sm text-gray-500 mb-4 flex items-center gap-2">
                            Se tomar?n
                            <input type="number" min="${minCantidad}" max="${maxPreguntas}" value="${cantidadActual}"
                                   onchange="actualizarCantidadPoolPorId(${poolId}, this)"
                                   ${inputDisabled ? 'disabled' : ''}
                                   class="w-16 border border-gray-300 rounded px-1 py-0.5 text-xs text-center ${inputDisabled ? 'bg-gray-100 text-gray-400' : ''}">
                            de ${maxPreguntas} pregunta(s) de este pool en el examen
                        </p>
                        
                        <div id="preguntasList" class="space-y-2 mb-4 max-h-60 overflow-y-auto">
                            ${pool.preguntas.length === 0 ?
                    '<p class="text-sm text-gray-500 italic">No hay preguntas agregadas</p>' :
                    pool.preguntas.map((p, i) => `
                                    <div class="border border-gray-200 rounded p-2 bg-gray-50">
                                        <div class="flex justify-between items-start">
                                            <div class="flex-1">
                                                <strong class="text-sm">${i + 1}. ${p.enunciado}</strong>
                                                <div class="text-xs text-gray-600 mt-1">
                                                    <span class="inline-block px-2 py-0.5 bg-blue-100 text-blue-800 rounded">
                                                        ${p.tipoPregunta}
                                                    </span>
                                                    <span class="ml-2">Puntaje: ${p.puntaje}</span>
                                                    ${p.opciones && p.opciones.length > 0 ? '<br><span class="text-xs">Opciones: ' + p.opciones.length + '</span>' : ''}
                                                </div>
                                            </div>
                                            <button type="button" onclick="eliminarPregunta(${poolId}, ${i})" 
                                                    class="ml-2 px-2 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                `).join('')
                }
                        </div>
                        
                        <form id="formPregunta" class="space-y-3 border-t pt-4">
                            <h4 class="font-semibold text-gray-700 text-sm">
                                <i class="fas fa-plus me-1"></i>Agregar Nueva Pregunta
                            </h4>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Tipo de Pregunta *
                                </label>
                                <select id="tipoPreguntaSelect" name="tipoPregunta" required
                                        onchange="cambiarFormularioPregunta()"
                                        class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                                    <option value="">-- Selecciona un tipo --</option>
                                    <option value="MULTIPLE_CHOICE">Opción múltiple</option>
                                    <option value="UNICA_RESPUESTA">Única respuesta</option>
                                    <option value="VERDADERO_FALSO">Verdadero/Falso</option>
                                    <option value="RESPUESTA_CORTA">Respuesta corta</option>
                                    <option value="DESCRIPCION_LARGA">Descripción larga</option>
                                    <option value="AUTOCOMPLETADO">Autocompletado</option>
                                </select>
                            </div>
                            
                            <div id="formularioDinamico">
                                <p class="text-sm text-gray-500 italic">Selecciona un tipo de pregunta para continuar</p>
                            </div>
                        </form>
                        
                        <div class="flex justify-end space-x-2 mt-4 pt-4 border-t">
                            <button type="button" onclick="finalizarModalPreguntas()" 
                                    class="px-3 py-2 text-gray-600 hover:text-gray-800 border border-gray-300 rounded-md">
                                <i class="fas fa-check me-1"></i>Finalizar
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);

            // Guardar el poolId en una variable global temporal
            window.currentPoolId = poolId;
            window.currentPoolIdReal = poolIdReal;
        }

        function cambiarFormularioPregunta() {
            const tipo = document.getElementById('tipoPreguntaSelect').value;
            const formularioDinamico = document.getElementById('formularioDinamico');

            if (!tipo) {
                formularioDinamico.innerHTML = '<p class="text-sm text-gray-500 italic">Selecciona un tipo de pregunta para continuar</p>';
                return;
            }

            let html = '';

            // Enunciado común para todos
            html += `
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Enunciado / Pregunta *
                    </label>
                    <textarea id="enunciadoPregunta" required rows="2"
                              class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm"
                              placeholder="Escribe la pregunta..."></textarea>
                </div>
                
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Puntaje *
                    </label>
                    <input type="number" id="puntajePregunta" required min="0" step="0.5" value="1"
                           class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                </div>
            `;

            // Sección específica según el tipo
            if (tipo === 'MULTIPLE_CHOICE' || tipo === 'UNICA_RESPUESTA') {
                html += `
                    <div class="border-t pt-3">
                        <h5 class="font-medium text-gray-700 mb-2">
                            <i class="fas fa-list-ul me-1"></i>Opciones de Respuesta
                        </h5>
                        <div id="opcionesContainer" class="space-y-2 mb-3">
                            <!-- Las opciones se agregarán aquí -->
                        </div>
                        <button type="button" onclick="agregarOpcion()" 
                                class="px-3 py-1.5 bg-gray-200 text-gray-700 text-sm rounded-md hover:bg-gray-300">
                            <i class="fas fa-plus me-1"></i>Agregar Opción
                        </button>
                    </div>
                `;
            } else if (tipo === 'VERDADERO_FALSO') {
                html += `
                    <div class="border-t pt-3">
                        <h5 class="font-medium text-gray-700 mb-2">
                            <i class="fas fa-check-circle me-1"></i>Respuesta Correcta *
                        </h5>
                        <div class="space-y-2">
                            <label class="flex items-center p-2 border rounded cursor-pointer hover:bg-gray-50">
                                <input type="radio" name="respuestaVF" value="Verdadero" required class="mr-2">
                                <span>Verdadero</span>
                            </label>
                            <label class="flex items-center p-2 border rounded cursor-pointer hover:bg-gray-50">
                                <input type="radio" name="respuestaVF" value="Falso" required class="mr-2">
                                <span>Falso</span>
                            </label>
                        </div>
                    </div>
                `;
            } else if (tipo === 'RESPUESTA_CORTA' || tipo === 'DESCRIPCION_LARGA') {
                html += `
                    <div class="border-t pt-3">
                        <p class="text-sm text-gray-600 italic">
                            <i class="fas fa-info-circle me-1"></i>
                            Este tipo de pregunta requiere corrección manual.
                        </p>
                    </div>
                `;
            } else if (tipo === 'AUTOCOMPLETADO') {
                html += `
                    <div class="border-t pt-3">
                        <p class="text-sm text-gray-600 mb-2">
                            <i class="fas fa-info-circle me-1"></i>
                            Usa [BLANK] en el enunciado donde quieras que aparezca un campo para completar.
                        </p>
                        <p class="text-xs text-gray-500">
                            Ejemplo: "La capital de Argentina es [BLANK] y se encuentra en [BLANK]."
                        </p>
                    </div>
                `;
            }

            html += `
                <button type="button" onclick="guardarPregunta()" 
                        class="w-full mt-4 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                    <i class="fas fa-save me-1"></i>Guardar Pregunta
                </button>
            `;

            formularioDinamico.innerHTML = html;

            // Si es múltiple choice o única respuesta, agregar la primera opción
            if (tipo === 'MULTIPLE_CHOICE' || tipo === 'UNICA_RESPUESTA') {
                agregarOpcion();
                agregarOpcion();
            }
        }

        let opcionCounter = 0;

        function agregarOpcion() {
            const tipo = document.getElementById('tipoPreguntaSelect').value;
            const container = document.getElementById('opcionesContainer');
            const opcionId = `opcion_${opcionCounter++}`;
            const esMultiple = tipo === 'MULTIPLE_CHOICE';

            const opcionHTML = `
                <div class="flex items-center space-x-2 p-2 border rounded bg-gray-50" id="${opcionId}_container">
                    <input type="text" id="${opcionId}" placeholder="Escribe la opción..." required
                           class="flex-1 border border-gray-300 rounded px-2 py-1 text-sm">
                    <label class="flex items-center text-xs whitespace-nowrap">
                        <input type="${esMultiple ? 'checkbox' : 'radio'}" 
                               name="opcionCorrecta" 
                               value="${opcionId}"
                               class="mr-1">
                        Correcta
                    </label>
                    <button type="button" onclick="eliminarOpcion('${opcionId}')" 
                            class="px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', opcionHTML);
        }

        function eliminarOpcion(opcionId) {
            document.getElementById(`${opcionId}_container`)?.remove();
        }

        function guardarPregunta() {
            const pool = examenPools.find(p => p.id === window.currentPoolId);
            if (!pool) return;

            const tipo = document.getElementById('tipoPreguntaSelect').value;
            const enunciado = document.getElementById('enunciadoPregunta').value;
            const puntaje = parseFloat(document.getElementById('puntajePregunta').value);

            if (!enunciado || !puntaje) {
                alert('Por favor completa todos los campos obligatorios');
                return;
            }

            const nuevaPregunta = {
                enunciado: enunciado,
                tipoPregunta: tipo,
                puntaje: puntaje,
                opciones: []
            };

            // Recopilar opciones según el tipo
            if (tipo === 'MULTIPLE_CHOICE' || tipo === 'UNICA_RESPUESTA') {
                const container = document.getElementById('opcionesContainer');
                const inputs = container.querySelectorAll('input[type="text"]');
                const correctas = container.querySelectorAll('input[name="opcionCorrecta"]:checked');

                if (inputs.length === 0) {
                    alert('Debes agregar al menos una opción');
                    return;
                }

                if (correctas.length === 0) {
                    alert('Debes marcar al menos una opción como correcta');
                    return;
                }

                const correctasSet = new Set(Array.from(correctas).map(c => c.value));

                inputs.forEach(input => {
                    if (input.value.trim()) {
                        nuevaPregunta.opciones.push({
                            descripcion: input.value.trim(),
                            esCorrecta: correctasSet.has(input.id)
                        });
                    }
                });
            } else if (tipo === 'VERDADERO_FALSO') {
                const respuestaSeleccionada = document.querySelector('input[name="respuestaVF"]:checked');
                if (!respuestaSeleccionada) {
                    alert('Debes seleccionar la respuesta correcta');
                    return;
                }

                nuevaPregunta.opciones = [
                    { descripcion: 'Verdadero', esCorrecta: respuestaSeleccionada.value === 'Verdadero' },
                    { descripcion: 'Falso', esCorrecta: respuestaSeleccionada.value === 'Falso' }
                ];
            }

            pool.preguntas.push(nuevaPregunta);
            if (pool.esExistente) {
                pool.preguntasCount = pool.preguntas.length;
            }

            // Persistir pregunta en el backend si el pool ya está guardado
            if (window.currentPoolIdReal) {
                guardarPreguntaEnBackend(window.currentPoolIdReal, nuevaPregunta);
            }

            // Recargar modal
            cerrarModalPreguntas();
            setTimeout(() => mostrarModalPreguntas(window.currentPoolId, window.currentPoolIdReal), 100);
        }

        function guardarPreguntaEnBackend(poolIdReal, pregunta) {
            console.log('=== DEBUG GUARDAR PREGUNTA ===');
            console.log('Pool ID:', poolIdReal);
            console.log('Pregunta:', pregunta);
            console.log('Opciones:', pregunta.opciones);
            console.log('Opciones JSON:', JSON.stringify(pregunta.opciones || []));

            const formData = new FormData();
            formData.append('enunciado', pregunta.enunciado);
            formData.append('tipoPregunta', pregunta.tipoPregunta);
            formData.append('puntaje', pregunta.puntaje);
            formData.append('opcionesData', JSON.stringify(pregunta.opciones || []));

            console.log('FormData opcionesData:', formData.get('opcionesData'));

            fetch(`/pool/agregarPregunta/${poolIdReal}`, {
                method: 'POST',
                headers: {
                    'X-XSRF-TOKEN': document.querySelector('meta[name="_csrf"]')?.getAttribute('content') || ''
                },
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    console.log('Respuesta del servidor:', data);
                    if (!data.success) {
                        console.error('Error al guardar pregunta:', data.message);
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        function finalizarModalPreguntas() {
            const pool = examenPools.find(p => p.id === window.currentPoolId);
            if (!pool) {
                cerrarModalPreguntas();
                return;
            }

            // Validar que el pool tenga al menos 1 pregunta
            const preguntasCount = pool.esExistente ?
                (typeof pool.preguntasCount === 'number' ? pool.preguntasCount : 0) :
                (pool.preguntas ? pool.preguntas.length : 0);

            if (preguntasCount === 0) {
                alert('⚠️ Debes agregar al menos 1 pregunta al pool antes de finalizar.');
                return;
            }

            cerrarModalPreguntas();
        }

        function cerrarModalPreguntas() {
            document.getElementById('modalPreguntas')?.remove();
            actualizarListaPools();
        }

        function eliminarPregunta(poolId, index) {
            const pool = examenPools.find(p => p.id === poolId);
            if (pool) {
                ModalConfirmacion.show(
                    'Eliminar Pregunta',
                    '¿Eliminar esta pregunta?',
                    () => {
                        pool.preguntas.splice(index, 1);
                        if (pool.esExistente) {
                            pool.preguntasCount = pool.preguntas.length;
                        }
                        cerrarModalPreguntas();
                        setTimeout(() => mostrarModalPreguntas(poolId), 100);
                    }
                );
            }
        }

        // Función para ver todos los pools disponibles con sus detalles
        function verPoolsDisponibles() {
            console.log('📋 Cargando pools disponibles para oferta:', OFERTA_ID);

            fetch(`/pool/listar/${OFERTA_ID}`)
                .then(response => response.json())
                .then(pools => {
                    mostrarModalPoolsDisponibles(pools);
                })
                .catch(error => {
                    console.error('Error al cargar pools:', error);
                    alert('Error al cargar los pools disponibles');
                });
        }

        function mostrarModalPoolsDisponibles(pools) {
            const modalHTML = `
                <div id="modalPoolsDisponibles" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] overflow-y-auto">
                    <div class="bg-white rounded-lg p-6 w-full max-w-4xl my-8 max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-blue-600">
                                <i class="fas fa-layer-group me-2"></i>Pools Disponibles
                            </h3>
                            <button type="button" onclick="cerrarModalPoolsDisponibles()" 
                                    class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times fa-lg"></i>
                            </button>
                        </div>
                        
                        ${pools.length > 0 ? `
                            <div class="space-y-4">
                                ${pools.map(pool => `
                                    <div class="border border-gray-200 rounded-lg p-4 hover:border-blue-400 transition">
                                        <div class="flex justify-between items-start mb-3">
                                            <div class="flex-1">
                                                <h4 class="text-lg font-semibold text-gray-800">
                                                    <i class="fas fa-layer-group text-blue-600 me-2"></i>${pool.nombre}
                                                </h4>
                                                ${pool.descripcion ? `<p class="text-sm text-gray-600 mt-1">${pool.descripcion}</p>` : ''}
                                                <div class="flex items-center gap-4 mt-2 text-sm text-gray-500">
                                                    <span><i class="fas fa-question-circle me-1"></i>${pool.preguntasCount} preguntas creadas</span>
                                                    <span><i class="fas fa-random me-1"></i>Toma ${pool.cantidadPreguntas} al azar</span>
                                                </div>
                                            </div>
                                            <button type="button" 
                                                    onclick="cargarDetallePool('${pool.idPool}')" 
                                                    class="ml-3 px-3 py-1.5 bg-blue-500 text-white text-sm rounded hover:bg-blue-600">
                                                <i class="fas fa-info-circle me-1"></i>Ver Detalles
                                            </button>
                                        </div>
                                        
                                        <div id="detallePool_${pool.idPool}" class="hidden border-t pt-3 mt-3">
                                            <div class="flex items-center justify-center py-2">
                                                <i class="fas fa-spinner fa-spin text-blue-600 me-2"></i>
                                                <span class="text-sm text-gray-600">Cargando preguntas...</span>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div class="text-center py-12 text-gray-500">
                                <i class="fas fa-inbox fa-4x mb-3"></i>
                                <p>No hay pools creados en esta oferta académica</p>
                            </div>
                        `}
                        
                        <div class="flex justify-end mt-6 pt-4 border-t">
                            <button type="button" onclick="cerrarModalPoolsDisponibles()" 
                                    class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">
                                <i class="fas fa-times me-1"></i>Cerrar
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function cargarDetallePool(poolId) {
            const detalleDiv = document.getElementById(`detallePool_${poolId}`);

            // Si ya está visible, ocultarlo
            if (!detalleDiv.classList.contains('hidden')) {
                detalleDiv.classList.add('hidden');
                return;
            }

            detalleDiv.classList.remove('hidden');

            // Cargar las preguntas del pool
            fetch(`/pool/detalle/${poolId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.preguntas) {
                        mostrarPreguntasPool(poolId, data.preguntas);
                    } else {
                        detalleDiv.innerHTML = '<p class="text-sm text-gray-500 italic py-2">No hay preguntas en este pool</p>';
                    }
                })
                .catch(error => {
                    console.error('Error al cargar preguntas:', error);
                    detalleDiv.innerHTML = '<p class="text-sm text-red-500 py-2">Error al cargar las preguntas</p>';
                });
        }

        function mostrarPreguntasPool(poolId, preguntas) {
            const detalleDiv = document.getElementById(`detallePool_${poolId}`);

            if (preguntas.length === 0) {
                detalleDiv.innerHTML = '<p class="text-sm text-gray-500 italic py-2">No hay preguntas en este pool</p>';
                return;
            }

            const preguntasHTML = preguntas.map((pregunta, index) => `
                <div class="bg-gray-50 rounded p-3 mb-2">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <p class="font-medium text-gray-800">
                                <span class="inline-block w-6 text-center bg-blue-600 text-white rounded-full text-xs mr-2">${index + 1}</span>
                                ${pregunta.enunciado}
                            </p>
                            <div class="flex items-center gap-3 mt-1 text-xs">
                                <span class="px-2 py-0.5 bg-blue-100 text-blue-800 rounded">
                                    ${pregunta.tipoPregunta}
                                </span>
                                <span class="text-gray-600">
                                    <i class="fas fa-star text-yellow-500 me-1"></i>${pregunta.puntaje} puntos
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    ${pregunta.opciones && pregunta.opciones.length > 0 ? `
                        <div class="ml-8 mt-2 space-y-1">
                            <p class="text-xs font-medium text-gray-600 mb-1">Opciones de respuesta:</p>
                            ${pregunta.opciones.map(opcion => `
                                <div class="flex items-start text-sm">
                                    <i class="fas ${opcion.esCorrecta ? 'fa-check-circle text-green-600' : 'fa-circle text-gray-400'} mt-0.5 me-2"></i>
                                    <span class="${opcion.esCorrecta ? 'font-medium text-green-700' : 'text-gray-700'}">
                                        ${opcion.descripcion}
                                        ${opcion.esCorrecta ? '<span class="ml-2 text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded">(Correcta)</span>' : ''}
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `).join('');

            detalleDiv.innerHTML = `
                <h5 class="font-semibold text-gray-700 mb-3">
                    <i class="fas fa-list-ul me-1"></i>Preguntas del Pool (${preguntas.length})
                </h5>
                <div class="max-h-96 overflow-y-auto">
                    ${preguntasHTML}
                </div>
            `;
        }

        function cerrarModalPoolsDisponibles() {
            document.getElementById('modalPoolsDisponibles')?.remove();
        }

        function cerrarFormularioExamen() {
            examenPools = []; // Limpiar pools
            document.getElementById('formularioExamenModal')?.remove();
        }

        // ========================================
        // FORMULARIO DE CARPETA
        // ========================================
        
        function crearItemMaterialCarpeta(index) {
            return `
                <div class="material-item border border-gray-200 rounded-md p-3 space-y-2" data-index="${index}">
                    <div class="flex items-center justify-between">
                        <span class="material-item-title text-xs font-semibold text-gray-700">Material ${index + 1}</span>
                        <button type="button" onclick="eliminarMaterialCarpeta(this)" class="text-xs text-red-600 hover:text-red-700">
                            <i class="fas fa-times me-1"></i>Quitar
                        </button>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Titulo *</label>
                        <input type="text" name="materialTitulo" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm" placeholder="Ej: Guia 1">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Descripcion</label>
                        <textarea name="materialDescripcion" rows="2" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm" placeholder="Describe el material..."></textarea>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Archivos (opcional)</label>
                        <input type="file" name="materialArchivos" multiple
                               accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.txt,.jpg,.jpeg,.png,.zip"
                               class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-xs file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
                    </div>
                </div>
            `;
        }

        function agregarMaterialCarpeta() {
            const container = document.getElementById('materialesCarpetaContainer');
            if (!container) return;
            const index = container.querySelectorAll('.material-item').length;
            container.insertAdjacentHTML('beforeend', crearItemMaterialCarpeta(index));
            renumerarMaterialesCarpeta(container);
        }

        function eliminarMaterialCarpeta(button) {
            const item = button.closest('.material-item');
            if (!item) return;
            const container = item.parentElement;
            item.remove();
            renumerarMaterialesCarpeta(container);
        }

        function renumerarMaterialesCarpeta(container) {
            const items = container.querySelectorAll('.material-item');
            items.forEach((item, index) => {
                item.dataset.index = index;
                const title = item.querySelector('.material-item-title');
                if (title) title.textContent = `Material ${index + 1}`;
            });
        }

        function crearFormularioCarpeta(moduloId, moduloNombre) {
            return `
                <div id="formularioCarpetaModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                        <h3 class="text-xl font-semibold mb-2 text-yellow-600">
                            <i class="fas fa-folder-open me-2"></i>Crear Carpeta
                        </h3>
                        <p class="text-sm text-gray-500 mb-4">
                            <i class="fas fa-folder text-gray-400 me-1"></i>${moduloNombre}
                        </p>
                        
                        <form id="formCarpeta" class="space-y-4" enctype="multipart/form-data">
                            <input type="hidden" name="moduloId" value="${moduloId}">
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    <i class="fas fa-heading me-1"></i>Nombre de la carpeta *
                                </label>
                                <input type="text" name="titulo"
                                       class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-yellow-500"
                                       placeholder="Ej: Materiales de Apoyo">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    <i class="fas fa-align-left me-1"></i>Descripcion
                                </label>
                                <textarea name="descripcion" rows="2"
                                          class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-yellow-500"
                                          placeholder="Describe el contenido de la carpeta..."></textarea>
                            </div>

                            <div class="pt-2 border-t space-y-2">
                                <label class="text-sm font-medium text-gray-700">
                                    <i class="fas fa-layer-group me-1"></i>Material inicial (opcional)
                                </label>
                                <p class="text-xs text-gray-500">Podes cargar uno o varios archivos en un solo material.</p>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Titulo (opcional)</label>
                                    <input type="text" name="materialTitulo" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm" placeholder="Ej: Guia 1">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Descripcion (opcional)</label>
                                    <textarea name="materialDescripcion" rows="2" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm" placeholder="Describe el material..."></textarea>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Archivos (opcional)</label>
                                    <input type="file" name="materialArchivos" multiple
                                           accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.txt,.jpg,.jpeg,.png,.zip"
                                           class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-xs file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-2 pt-4 border-t">
                                <button type="button" onclick="cerrarFormularioCarpeta()" 
                                        class="px-4 py-2 text-gray-600 hover:text-gray-800 border border-gray-300 rounded-md">
                                    <i class="fas fa-times me-1"></i>Cancelar
                                </button>
                                <button type="submit" id="btnCrearCarpeta"
                                        class="px-4 py-2 bg-yellow-500 text-white rounded-md hover:bg-yellow-600">
                                    <i class="fas fa-save me-1"></i>Crear Carpeta
                                </button>
                                <button type="button" id="btnCreandoCarpeta" style="display: none;"
                                        class="px-4 py-2 bg-yellow-500 text-white rounded-md cursor-not-allowed" disabled>
                                    <i class="fas fa-spinner fa-spin me-1"></i>Creando...
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }


        function cerrarFormularioCarpeta() {
            document.getElementById('formularioCarpetaModal')?.remove();
        }

        // ========================================
        // FORMULARIO DE MATERIAL
        // ========================================
        function crearFormularioMaterial(moduloId, moduloNombre) {
            return `
                <div id="formularioMaterialModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                        <h3 class="text-xl font-semibold mb-2 text-green-600">
                            <i class="fas fa-upload me-2"></i>Subir Material
                        </h3>
                        <p class="text-sm text-gray-500 mb-4">
                            <i class="fas fa-folder text-gray-400 me-1"></i>${moduloNombre}
                        </p>
                        
                        <form id="formMaterial" class="space-y-4" enctype="multipart/form-data">
                            <input type="hidden" name="moduloId" value="${moduloId}">
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    <i class="fas fa-heading me-1"></i>Titulo del material (opcional)
                                </label>
                                <input type="text" name="titulo"
                                       class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-green-500"
                                       placeholder="Ej: Presentacion - Introduccion al tema">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    <i class="fas fa-align-left me-1"></i>Descripcion (opcional)
                                </label>
                                <textarea name="descripcion" rows="2"
                                          class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-green-500"
                                          placeholder="Describe el material..."></textarea>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    <i class="fas fa-file-upload me-1"></i>Subir archivos (opcional)
                                </label>
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-green-400 transition-colors">
                                    <input type="file" name="archivos" multiple
                                           class="hidden" id="archivoMaterial"
                                           accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.txt,.jpg,.jpeg,.png,.zip"
                                           onchange="mostrarVistaPrevia(this)">
                                    <label for="archivoMaterial" class="cursor-pointer">
                                        <div id="previewArea">
                                            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
                                            <p class="text-sm text-gray-600">Click para seleccionar archivos</p>
                                            <p class="text-xs text-gray-500 mt-1">PDF, Word, Excel, PowerPoint, imagenes, ZIP</p>
                                        </div>
                                        <div id="filePreview" class="hidden flex flex-col items-center">
                                            <div id="filesList" class="w-full space-y-2 mb-2"></div>
                                            <button type="button" onclick="limpiarArchivo(event)" class="mt-2 text-xs text-red-600 hover:text-red-800">
                                                <i class="fas fa-times me-1"></i>Quitar todos
                                            </button>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-2 pt-4 border-t">
                                <button type="button" onclick="cerrarFormularioMaterial()" 
                                        class="px-4 py-2 text-gray-600 hover:text-gray-800 border border-gray-300 rounded-md">
                                    <i class="fas fa-times me-1"></i>Cancelar
                                </button>
                                <button type="submit" id="btnSubirMaterial"
                                        class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                                    <i class="fas fa-save me-1"></i>Subir Material
                                </button>
                                <button type="button" id="btnCargandoMaterial" style="display: none;"
                                        class="px-4 py-2 bg-green-600 text-white rounded-md cursor-not-allowed" disabled>
                                    <i class="fas fa-spinner fa-spin me-1"></i>Subiendo...
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function cerrarFormularioMaterial() {
            document.getElementById('formularioMaterialModal')?.remove();
        }

        // Cerrar modal
        function closeModuleModal() {
            const modal = document.getElementById('moduleModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        // Cerrar modal al hacer clic fuera
        // moduleModal ya está definido al inicio del script
        if (moduleModal) {
            moduleModal.addEventListener('click', (e) => {
                if (e.target === moduleModal) {
                    closeModuleModal();
                }
            });
        }

        // ========================================
        // EVENT LISTENERS PARA FORMULARIOS
        // ========================================

        // Event delegation para manejar los submit de los formularios dinámicos
        document.addEventListener('submit', async function (e) {
            if (e.target.id === 'recursoForm') {
                e.preventDefault();
                await guardarRecurso(e.target);
            }
            if (e.target.id === 'formTarea') {
                e.preventDefault();

                // Validar que al menos un tipo de entrega esté seleccionado
                const tiposEntregaCheckboxes = document.querySelectorAll('.tipo-entrega-checkbox:checked');
                if (tiposEntregaCheckboxes.length === 0) {
                    alert('⚠️ Debes seleccionar al menos un tipo de entrega (texto o archivos)');
                    return;
                }

                const formData = new FormData(e.target);
                const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

                const ejecutarCreacionTarea = () => {
                    fetch('/actividad/crearTarea', {
                        method: 'POST',
                        headers: {
                            [csrfHeader]: csrfToken
                        },
                        body: formData
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                mostrarNotificacionGlobal('Tarea creada', data.message || 'Tarea creada exitosamente.', 'success', () => {
                                    cerrarFormularioTarea();
                                    window.location.reload();
                                });
                            } else {
                                alert('❌ Error: ' + data.message);
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('❌ Error al crear la tarea. Por favor, intenta nuevamente.');
                        });
                };

                mostrarConfirmacionGlobal(
                    'Crear tarea',
                    '¿Confirmas la creación de esta tarea?',
                    ejecutarCreacionTarea,
                    { confirmText: 'Crear', cancelText: 'Cancelar', type: 'info' }
                );
            }

            if (e.target.id === 'formModificarEntrega') {
                e.preventDefault();
                const form = e.target;
                const submitBtn = form.querySelector('button[type="submit"]') || form.querySelector('button');

                const ejecutarModificacionEntrega = async () => {
                    if (submitBtn) submitBtn.disabled = true;
                    const fd = new FormData(form);
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');
                    const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
                    try {
                        const res = await fetch(form.action, {
                            method: 'POST',
                            headers: {
                                [csrfHeader]: csrfToken,
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: fd
                        });
                        const data = await res.json().catch(() => null);
                        if (res.ok && data && data.success) {
                            // Mensaje no bloqueante
                            console.info('✅ ' + (data.message || 'Modificación guardada'));

                            // cerrar modal
                            const tareaId = form.querySelector('input[name="idTarea"]')?.value;
                            document.getElementById('tareaModal')?.remove();

                            if (tareaId) {
                                // Actualizar todos los elementos que correspondan a esta tarea
                                const openers = Array.from(document.querySelectorAll(`[data-id="${tareaId}"]`));
                                openers.forEach(opener => {
                                    if (data.entregaId) opener.setAttribute('data-entrega-id', data.entregaId);
                                    if (data.entregaFecha) opener.setAttribute('data-entrega-fecha', data.entregaFecha);
                                    if (data.nombreArchivo !== undefined) opener.setAttribute('data-entrega-archivo', data.nombreArchivo || '');
                                    if (data.contenido !== undefined) opener.setAttribute('data-entrega-texto', data.contenido || '');
                                    if (data.calificacion !== undefined && data.calificacion !== null) opener.setAttribute('data-entrega-calif', data.calificacion);

                                    // Añadir badge si no existe
                                    if (!opener.querySelector('.entrega-badge')) {
                                        const badge = document.createElement('span');
                                        badge.className = 'entrega-badge ms-2 small text-success';
                                        badge.textContent = 'Enviado';
                                        opener.appendChild(badge);
                                    }

                                    // Actualizar o insertar info visible junto al opener (fecha y archivo)
                                    let info = opener.parentElement.querySelector(`.entrega-info[data-tarea-id="${tareaId}"]`);
                                    if (!info) {
                                        info = document.createElement('div');
                                        info.className = 'entrega-info text-muted small';
                                        info.setAttribute('data-tarea-id', tareaId);
                                        opener.parentElement.appendChild(info);
                                    }

                                    const parts = [];
                                    if (data.entregaFecha) parts.push('Fecha: ' + data.entregaFecha);
                                    if (data.nombreArchivo) parts.push('Archivo: ' + data.nombreArchivo);
                                    if (data.calificacion !== undefined && data.calificacion !== null) parts.push('Calificación: ' + data.calificacion);
                                    info.textContent = parts.join(' • ');
                                });
                            }

                            mostrarNotificacionGlobal('Modificación guardada', data.message || 'Modificación guardada.', 'success');
                        } else {
                            const msg = data?.message || await res.text();
                            alert('❌ Error: ' + (msg || 'Error desconocido'));
                        }
                    } catch (err) {
                        console.error(err);
                        alert('❌ Error de red. Intenta nuevamente.');
                    } finally {
                        if (submitBtn) submitBtn.disabled = false;
                    }
                };

                mostrarConfirmacionGlobal(
                    'Guardar cambios',
                    '¿Confirmas actualizar la entrega?',
                    ejecutarModificacionEntrega,
                    { confirmText: 'Guardar', cancelText: 'Cancelar', type: 'info' }
                );
            }

            if (e.target.id === 'formExamen') {
                e.preventDefault();
                const formData = new FormData(e.target);
                const moduloId = formData.get('moduloId');

                // Validar que haya al menos un pool
                if (examenPools.length === 0) {
                    alert('⚠️ Debes agregar al menos un pool de preguntas antes de crear el examen.');
                    return;
                }

                const modulosSeleccionados = formData.getAll('modulosRelacionados');
                if (!modulosSeleccionados || modulosSeleccionados.length === 0) {
                    alert('⚠️ Debes seleccionar al menos un módulo relacionado para el examen.');
                    return;
                }

                // Verificar que los pools tengan preguntas (usar conteo para existentes)
                const poolsSinPreguntas = examenPools.filter(p => {
                    const count = p.esExistente ? (typeof p.preguntasCount === 'number' ? p.preguntasCount : 0) : (p.preguntas ? p.preguntas.length : 0);
                    return count === 0;
                });
                if (poolsSinPreguntas.length > 0) {
                    alert('⚠️ Todos los pools deben tener al menos una pregunta.');
                    return;
                }

                console.log('📋 Enviando examen con pools:', examenPools);

                const ejecutarCreacionExamen = () => {
                    fetch('/actividad/crearExamen', {
                        method: 'POST',
                        headers: {
                            'X-XSRF-TOKEN': document.querySelector('meta[name="_csrf"]')?.getAttribute('content') || ''
                        },
                        body: formData
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                mostrarNotificacionGlobal('Examen creado', 'Examen creado exitosamente.', 'success', () => {
                                    cerrarFormularioExamen();
                                    location.reload();
                                });
                            } else {
                                alert('❌ Error: ' + data.message);
                            }
                        })
                        .catch(error => {
                            console.error('Error al crear examen:', error);
                            alert('❌ Error al crear el examen. Por favor, intenta de nuevo.');
                        });
                };

                try {
                    await cargarMaterialesCache();
                } catch (e) {
                    console.error('Error cargando materiales para validación:', e);
                }

                const inputPermitir = e.target.querySelector('input[name="permitirPreExamen"]');
                if (!tieneMaterialEnModulos(modulosSeleccionados)) {
                    const targetModulo = (modulosSeleccionados && modulosSeleccionados.length > 0)
                        ? modulosSeleccionados[0]
                        : moduloId;
                    if (inputPermitir) inputPermitir.value = 'false';
                    formData.set('permitirPreExamen', 'false');
                    mostrarAdvertenciaMaterialExamen(targetModulo, ejecutarCreacionExamen);
                    return;
                }

                if (inputPermitir) inputPermitir.value = 'true';
                formData.set('permitirPreExamen', 'true');

                mostrarConfirmacionGlobal(
                    'Crear examen',
                    '¿Confirmas la creación de este examen?',
                    ejecutarCreacionExamen,
                    { confirmText: 'Crear', cancelText: 'Cancelar', type: 'info' }
                );
            }

            if (e.target.id === 'formCarpeta') {
                e.preventDefault();
                await enviarFormularioCarpeta(e.target);
            }

            if (e.target.id === 'formMaterial') {
                e.preventDefault();

                const form = e.target;
                const btnSubir = document.getElementById('btnSubirMaterial');
                const btnCargando = document.getElementById('btnCargandoMaterial');

                const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

                const formData = new FormData(form);
                const moduloId = formData.get('moduloId');

                const archivosInput = form.querySelector('input[type="file"][name="archivos"]');
                const archivos = archivosInput ? Array.from(archivosInput.files || []) : [];
                let titulo = (formData.get('titulo') || '').toString().trim();

                if (!titulo) {
                    if (archivos.length > 0) {
                        const nombre = archivos[0].name || 'Material';
                        const base = nombre.replace(/\.[^/.]+$/, '');
                        titulo = base || 'Material';
                    } else {
                        alert('Agrega al menos un archivo o un titulo.');
                        return;
                    }
                }

                formData.set('titulo', titulo);

                if (btnSubir && btnCargando) {
                    btnSubir.style.display = 'none';
                    btnCargando.style.display = 'inline-flex';
                }

                // Determinar si es una carpeta (Long) o un modulo (UUID)
                const esCarpeta = /^\d+$/.test(moduloId); // Si son solo digitos, es carpeta
                const endpoint = esCarpeta
                    ? `/carpeta/${moduloId}/material`
                    : `/actividad/modulo/${moduloId}/material`;

                fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        [csrfHeader]: csrfToken
                    },
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Material creado exitosamente');
                            cerrarFormularioMaterial();
                            window.location.reload();
                        } else {
                            alert('Error: ' + data.message);
                            if (btnSubir && btnCargando) {
                                btnSubir.style.display = 'inline-flex';
                                btnCargando.style.display = 'none';
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error al crear material');
                        if (btnSubir && btnCargando) {
                            btnSubir.style.display = 'inline-flex';
                            btnCargando.style.display = 'none';
                        }
                    });
            }


        });

        // ========================================
        // GESTIÓN DE CARPETAS Y ARCHIVOS
        // ========================================
        window.toggleCarpetaInline = function (button) {
            const carpetaId = button.getAttribute('data-carpeta-id');
            const container = document.getElementById('carpeta-content-' + carpetaId);
            const icon = button.querySelector('i');

            if (container.classList.contains('hidden')) {
                // Abrir
                container.classList.remove('hidden');
                icon.classList.remove('fa-folder');
                icon.classList.add('fa-folder-open');

                // Cargar contenido si no se ha cargado (verificado por el spinner)
                if (container.querySelector('.fa-spinner')) {
                    cargarContenidoCarpetaInline(carpetaId, container);
                }
            } else {
                // Cerrar
                container.classList.add('hidden');
                icon.classList.remove('fa-folder-open');
                icon.classList.add('fa-folder');
            }
        };

        function cargarContenidoCarpetaInline(carpetaId, container) {
            fetch(`/carpeta/${carpetaId}/contenido`)
                .then(response => response.json())
                .then(data => {
                    let html = '<div class="space-y-3 py-3 pr-3">';

                    if (PUEDE_MODIFICAR) {
                        html += `
                            <div class="flex justify-end mb-2">
                                <button onclick="abrirFormularioMaterialEnCarpeta(${carpetaId}, 'Carpeta')" 
                                        class="text-xs bg-green-50 text-green-600 hover:bg-green-100 px-2 py-1 rounded border border-green-200">
                                    <i class="fas fa-plus me-1"></i>Agregar Material
                                </button>
                            </div>
                        `;
                    }

                    // 1. Mostrar Materiales (Texto enriquecido + Archivos)
                    if (data.materiales && data.materiales.length > 0) {
                        html += '<div class="space-y-3">';
                        data.materiales.forEach(mat => {
                            html += `
                                <div class="bg-white p-3 rounded shadow-sm border border-gray-100">
                                    <div class="flex justify-between items-start mb-1">
                                        <h5 class="font-bold text-gray-800 text-sm">
                                            <i class="fas fa-book-reader text-blue-500 me-2"></i>${escapeHtml(mat.titulo)}
                                        </h5>
                                        ${mat.archivos && mat.archivos.length > 0 ? `
                                            <button onclick="mostrarModalMaterial(${mat.id}, '${escapeHtmlAtributo(mat.titulo)}')"
                                                    class="text-xs bg-blue-50 text-blue-600 hover:bg-blue-100 px-2 py-1 rounded border border-blue-200">
                                                <i class="fas fa-eye me-1"></i>Ver archivos
                                            </button>
                                        ` : ''}
                                    </div>
                                    ${mat.descripcion ? `<p class="text-sm text-gray-600 mb-2">${escapeHtml(mat.descripcion)}</p>` : ''}
                                    
                                    ${mat.archivos && mat.archivos.length > 0 ? `
                                        <div class="mt-2 text-xs text-gray-500">
                                            <i class="fas fa-paperclip me-1"></i>
                                            ${mat.archivos.length} archivo${mat.archivos.length > 1 ? 's' : ''} adjunto${mat.archivos.length > 1 ? 's' : ''}
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        });
                        html += '</div>';
                    }

                    // 2. Mostrar Archivos Directos (Lista simple)
                    if (data.archivos && data.archivos.length > 0) {
                        // Separador si hay ambos
                        if (data.materiales && data.materiales.length > 0) {
                            html += '<hr class="my-3 border-gray-200">';
                        }

                        html += '<h6 class="text-xs font-bold text-gray-400 uppercase mb-2">Archivos Sueltos</h6>';
                        html += '<div class="grid grid-cols-1 gap-2">';
                        data.archivos.forEach(arch => {
                            html += `
                                <div class="flex items-center p-2 bg-white rounded border border-gray-200 hover:shadow-sm transition-shadow">
                                    <div class="w-8 h-8 rounded bg-gray-100 flex items-center justify-center text-gray-500 me-3">
                                        <i class="fas fa-file"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="text-sm font-medium text-gray-800 truncate" title="${escapeHtml(arch.nombre)}">${escapeHtml(arch.nombre)}</div>
                                        <div class="text-xs text-gray-400">${formatearTamano(arch.tamano)}</div>
                                    </div>
                                    <a href="/carpeta/archivo/${arch.id}/descargar" class="p-2 text-gray-400 hover:text-blue-600" title="Descargar" target="_blank">
                                        <i class="fas fa-download"></i>
                                    </a>
                                    ${PUEDE_MODIFICAR ? `
                                        <button onclick="eliminarArchivo(${arch.id}, ${carpetaId})" class="p-2 text-gray-400 hover:text-red-500" title="Eliminar">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            `;
                        });
                        html += '</div>';
                    }

                    if ((!data.materiales || data.materiales.length === 0) && (!data.archivos || data.archivos.length === 0)) {
                        html += `<div class="text-center text-gray-400 text-sm italic py-2">Carpeta vacía</div>`;
                    }

                    html += '</div>';
                    container.innerHTML = html;
                })
                .catch(err => {
                    console.error(err);
                    container.innerHTML = '<div class="text-red-500 text-sm text-center">Error al cargar contenido</div>';
                });
        }

        window.abrirCarpeta = function (button) {
            const carpetaId = button.getAttribute('data-carpeta-id');
            const carpetaNombre = button.getAttribute('data-carpeta-nombre');
            mostrarModalCarpeta(carpetaId, carpetaNombre);
        };

        function mostrarModalCarpeta(carpetaId, carpetaNombre) {
            const gridClass = PUEDE_MODIFICAR ? 'grid grid-cols-3 gap-4 mb-6' : 'grid grid-cols-1 gap-4 mb-6';
            const listaColClass = PUEDE_MODIFICAR ? 'col-span-2' : 'col-span-1';
            const listaTitulo = PUEDE_MODIFICAR ? 'Materiales en esta carpeta' : 'Contenido disponible';

            const accionesHTML = PUEDE_MODIFICAR ? `
                            <div class="col-span-1 border-r pr-4">
                                <h4 class="text-sm font-semibold text-gray-700 mb-3">
                                    <i class="fas fa-plus-circle mr-1"></i>Agregar contenido
                                </h4>
                                <div class="space-y-2">
                                    <button disabled
                                            class="w-full p-3 border-2 border-gray-200 rounded-lg bg-gray-100 text-gray-400 cursor-not-allowed opacity-60">
                                        <div class="flex items-center">
                                            <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center mr-3">
                                                <i class="fas fa-file-alt text-lg text-gray-400"></i>
                                            </div>
                                            <span class="font-medium text-sm">Tarea</span>
                                        </div>
                                    </button>
                                    <button disabled
                                            class="w-full p-3 border-2 border-gray-200 rounded-lg bg-gray-100 text-gray-400 cursor-not-allowed opacity-60">
                                        <div class="flex items-center">
                                            <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center mr-3">
                                                <i class="fas fa-clipboard-check text-lg text-gray-400"></i>
                                            </div>
                                            <span class="font-medium text-sm">Examen</span>
                                        </div>
                                    </button>
                                    <button onclick="abrirFormularioMaterialEnCarpeta(${carpetaId}, '${escapeHtmlAtributo(carpetaNombre)}')"
                                            class="w-full p-3 border-2 border-green-300 rounded-lg hover:bg-green-50 hover:border-green-400 transition-all">
                                        <div class="flex items-center">
                                            <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-3">
                                                <i class="fas fa-upload text-lg text-green-600"></i>
                                            </div>
                                            <span class="font-medium text-sm text-gray-800">Material</span>
                                        </div>
                                    </button>
                                    <button disabled
                                            class="w-full p-3 border-2 border-gray-200 rounded-lg bg-gray-100 text-gray-400 cursor-not-allowed opacity-60">
                                        <div class="flex items-center">
                                            <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center mr-3">
                                                <i class="fas fa-folder-open text-lg text-gray-400"></i>
                                            </div>
                                            <span class="font-medium text-sm">Carpeta</span>
                                        </div>
                                    </button>
                                </div>
                            </div>
            ` : '';

            const modalHTML = `
                <div id="carpetaModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 w-full max-w-4xl max-h-[90vh] flex flex-col">
                        <div class="flex justify-between items-center mb-4 border-b pb-3">
                            <h3 class="text-xl font-semibold text-yellow-600">
                                <i class="fas fa-folder-open mr-2"></i>${escapeHtml(carpetaNombre)}
                            </h3>
                            <button onclick="cerrarModalCarpeta()" class="text-gray-500 hover:text-gray-800">
                                <i class="fas fa-times text-2xl"></i>
                            </button>
                        </div>

                        <div class="${gridClass}">
                            ${accionesHTML}
                            <div class="${listaColClass}">
                                <h4 class="text-sm font-semibold text-gray-700 mb-3">
                                    <i class="fas fa-list mr-1"></i>${listaTitulo}
                                </h4>
                                <div id="listaArchivos" class="space-y-2 overflow-y-auto" style="max-height: 400px;">
                                    <div class="text-center text-gray-400 py-8">
                                        <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                                        <p>Cargando materiales...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
            cargarContenidoCarpeta(carpetaId);
        }

        function cargarContenidoCarpeta(carpetaId) {
            const listaArchivos = document.getElementById('listaArchivos');

            // Cargar archivos y materiales en paralelo
            Promise.all([
                fetch(`/carpeta/${carpetaId}/archivos`).then(r => r.json()),
                fetch(`/carpeta/${carpetaId}/materiales`).then(r => r.json())
            ])
                .then(([archivos, materiales]) => {
                    if (archivos.length === 0 && materiales.length === 0) {
                        listaArchivos.innerHTML = `
                        <div class="text-center text-gray-400 py-8">
                            <i class="fas fa-folder-open text-4xl mb-2"></i>
                            <p>No hay contenido en esta carpeta</p>
                        </div>
                    `;
                        return;
                    }

                    let html = '';

                    // Mostrar materiales
                    if (materiales.length > 0) {
                        html += materiales.map(material => `
                        <div class="p-3 border-l-4 border-green-500 bg-green-50 rounded-lg mb-2">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center mb-1">
                                        <i class="fas fa-file-alt text-green-600 text-lg mr-2"></i>
                                        <h5 class="font-semibold text-gray-800">${escapeHtml(material.titulo)}</h5>
                                    </div>
                                    ${material.descripcion ? `<p class="text-sm text-gray-600 mb-1">${escapeHtml(material.descripcion)}</p>` : ''}
                                    <p class="text-xs text-gray-500 mt-1">
                                        <i class="fas fa-clock mr-1"></i>${formatearFecha(material.fechaCreacion)}
                                    </p>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    }

                    // Mostrar archivos
                    if (archivos.length > 0) {
                        html += archivos.map(archivo => `
                        <div class="flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50">
                            <div class="flex items-center flex-1">
                                <i class="fas fa-file-pdf text-red-600 text-2xl mr-3"></i>
                                <div>
                                    <p class="font-medium text-gray-800">${escapeHtml(archivo.nombre)}</p>
                                    <p class="text-xs text-gray-500">
                                        ${formatearTamano(archivo.tamano)} • ${formatearFecha(archivo.fechaSubida)}
                                    </p>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <a href="/archivo/${archivo.id}/descargar" target="_blank"
                                   class="px-3 py-1.5 text-sm bg-blue-500 text-white rounded hover:bg-blue-600" title="Ver archivo">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="/archivo/${archivo.id}/descargar?download=true" target="_blank"
                                   class="px-3 py-1.5 text-sm bg-gray-500 text-white rounded hover:bg-gray-600" title="Descargar archivo">
                                    <i class="fas fa-download"></i>
                                </a>
                            </div>
                        </div>
                    `).join('');
                    }

                    listaArchivos.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error al cargar contenido:', error);
                    listaArchivos.innerHTML = `
                    <div class="text-center text-red-500 py-8">
                        <i class="fas fa-exclamation-triangle text-3xl mb-2"></i>
                        <p>Error al cargar contenido</p>
                    </div>
                `;
                });
        }

        window.subirArchivo = function (carpetaId) {
            const fileInput = document.getElementById('archivoInput');
            const file = fileInput.files[0];

            if (!file) {
                alert('Por favor selecciona un archivo PDF');
                return;
            }

            if (file.type !== 'application/pdf') {
                alert('Solo se permiten archivos PDF');
                return;
            }

            const formData = new FormData();
            formData.append('archivo', file);

            const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

            fetch(`/carpeta/${carpetaId}/subir`, {
                method: 'POST',
                headers: {
                    [csrfHeader]: csrfToken
                },
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        fileInput.value = '';
                        cargarArchivos(carpetaId);
                        alert('Archivo subido exitosamente');
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al subir archivo');
                });
        };

        window.eliminarArchivo = function (archivoId, carpetaId) {
            ModalConfirmacion.show(
                'Eliminar Archivo',
                '¿Estás seguro de eliminar este archivo?',
                () => {
                    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                    // ... rest of the logic or re-write it correctly below if the read missed specific lines
                    // Since I don't have the rest, I should probably read more to match better or rewrite the fetch too.
                    /* Re-implementing fetch to be safe since I need inside the callback */
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content') || 'X-CSRF-TOKEN';

                    fetch(`/aula/archivos/${archivoId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            [csrfHeader]: csrfToken
                        }
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                cargarArchivos(carpetaId);
                            } else {
                                alert('Error: ' + data.message);
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('Error al eliminar archivo');
                        });
                }
            );
        };

        function mostrarVistaPrevia(input) {
            const previewArea = document.getElementById('previewArea');
            const filePreview = document.getElementById('filePreview');
            const filesList = document.getElementById('filesList');

            if (input.files && input.files.length > 0) {
                // Ocultar área de carga y mostrar preview
                previewArea.classList.add('hidden');
                filePreview.classList.remove('hidden');

                filesList.innerHTML = '';
                Array.from(input.files).forEach(file => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'flex items-center justify-between bg-gray-50 p-2 rounded border border-gray-200';
                    fileItem.innerHTML = `
                        <div class="flex items-center overflow-hidden">
                            <i class="fas fa-file text-green-600 mr-2"></i>
                            <span class="text-sm font-medium text-gray-800 truncate">${file.name}</span>
                        </div>
                        <span class="text-xs text-gray-500 ml-2 whitespace-nowrap">${formatearTamano(file.size)}</span>
                    `;
                    filesList.appendChild(fileItem);
                });
            } else {
                // Si no hay archivo, mostrar área de carga
                previewArea.classList.remove('hidden');
                filePreview.classList.add('hidden');
            }
        }

        function limpiarArchivo(event) {
            event.preventDefault();
            event.stopPropagation();

            const input = document.getElementById('archivoMaterial');
            input.value = '';

            const previewArea = document.getElementById('previewArea');
            const filePreview = document.getElementById('filePreview');
            const filesList = document.getElementById('filesList');

            previewArea.classList.remove('hidden');
            filePreview.classList.add('hidden');
            filesList.innerHTML = '';
        }

        function cerrarModalCarpeta() {
            document.getElementById('carpetaModal')?.remove();
        }

        function cerrarModalMaterial() {
            document.getElementById('materialModal')?.remove();
        }

        window.descargarMaterial = function (button) {
            const materialId = button.getAttribute('data-material-id');
            const materialNombre = button.getAttribute('data-material-nombre');
            mostrarModalMaterial(materialId, materialNombre);
        };

        function mostrarModalMaterial(materialId, materialNombre) {
            const modalHTML = `
                <div id="materialModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[90vh] flex flex-col">
                        <div class="flex justify-between items-center mb-4 border-b pb-3">
                            <h3 class="text-xl font-semibold text-green-600">
                                <i class="fas fa-file-alt mr-2"></i>${escapeHtml(materialNombre)}
                            </h3>
                            <button onclick="cerrarModalMaterial()" class="text-gray-500 hover:text-gray-800">
                                <i class="fas fa-times text-2xl"></i>
                            </button>
                        </div>

                        <div>
                            <h4 class="text-sm font-semibold text-gray-700 mb-3">
                                <i class="fas fa-download mr-1"></i>Archivos disponibles
                            </h4>
                            <div id="listaArchivosMaterial" class="space-y-2 overflow-y-auto" style="max-height: 500px;">
                                <div class="text-center text-gray-400 py-8">
                                    <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                                    <p>Cargando archivos...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
            cargarArchivosMaterial(materialId);
        }

        function cargarArchivosMaterial(materialId) {
            const listaArchivos = document.getElementById('listaArchivosMaterial');

            fetch(`/actividad/material/${materialId}/archivos`)
                .then(response => response.json())
                .then(data => {
                    // Verificar si está bloqueado por mora
                    if (data.bloqueado === true) {
                        listaArchivos.innerHTML = `
                        <div class="bg-white rounded-lg p-8 text-center">
                            <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4" 
                                 style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                                <i class="fas fa-exclamation-triangle text-white text-4xl"></i>
                            </div>
                            <h4 class="text-2xl font-bold text-gray-900 mb-4">Material Bloqueado</h4>
                            
                            <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 mb-6 flex items-center gap-3">
                                <i class="fas fa-info-circle text-yellow-600 text-2xl"></i>
                                <p class="text-sm text-yellow-900 font-medium text-left">No puede acceder a este material debido a pagos pendientes. El resto del curso permanece accesible.</p>
                            </div>
                            
                            <div class="flex justify-center gap-8 mb-6 p-5 bg-yellow-50 rounded-xl border-2 border-yellow-300">
                                <div class="text-center">
                                    <div class="text-xs text-yellow-900 font-semibold uppercase tracking-wide mb-2">Días de Mora</div>
                                    <div class="text-4xl font-bold text-yellow-700">${data.diasMora || 0}</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-xs text-yellow-900 font-semibold uppercase tracking-wide mb-2">Límite Permitido</div>
                                    <div class="text-4xl font-bold text-green-600">${data.limiteMora || 0}</div>
                                </div>
                            </div>
                            
                            <a href="/alumno/mis-pagos" 
                               class="inline-block px-6 py-3 rounded-lg text-white font-semibold transition-all hover:shadow-lg"
                               style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                                <i class="fas fa-credit-card mr-2"></i>Regularizar mis Pagos
                            </a>
                            
                            <div class="mt-6 pt-6 border-t border-gray-200">
                                <p class="text-sm text-gray-600">
                                    <i class="fas fa-check-circle text-green-500 mr-1"></i>
                                    Una vez acreditado el pago, podrá acceder al material automáticamente.
                                </p>
                            </div>
                        </div>
                    `;
                        return;
                    }

                    // Si no está bloqueado, mostrar archivos normalmente
                    const archivos = data;
                    if (archivos.length === 0) {
                        listaArchivos.innerHTML = `
                        <div class="text-center text-gray-400 py-8">
                            <i class="fas fa-inbox text-3xl mb-2"></i>
                            <p>No hay archivos disponibles</p>
                        </div>
                    `;
                    } else {
                        const html = archivos.map(archivo => `
                        <div class="flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-file-pdf text-blue-600"></i>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-800">${escapeHtml(archivo.nombre)}</p>
                                    <p class="text-xs text-gray-500">
                                        ${formatearTamano(archivo.tamano)} • ${formatearFecha(archivo.fechaSubida)}
                                    </p>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <a href="/archivo/${archivo.id}/descargar" target="_blank"
                                   class="px-3 py-1.5 text-sm bg-blue-500 text-white rounded hover:bg-blue-600" title="Ver archivo">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="/archivo/${archivo.id}/descargar?download=true" target="_blank"
                                   class="px-3 py-1.5 text-sm bg-gray-500 text-white rounded hover:bg-gray-600" title="Descargar archivo">
                                    <i class="fas fa-download"></i>
                                </a>
                            </div>
                        </div>
                    `).join('');

                        listaArchivos.innerHTML = html;
                    }
                })
                .catch(error => {
                    console.error('Error al cargar archivos:', error);
                    listaArchivos.innerHTML = `
                    <div class="text-center text-red-500 py-8">
                        <i class="fas fa-exclamation-triangle text-3xl mb-2"></i>
                        <p>Error al cargar archivos</p>
                    </div>
                `;
                });
        }

        window.abrirFormularioMaterialEnCarpeta = function (carpetaId, carpetaNombre) {
            // Primero cerramos el modal de carpeta
            cerrarModalCarpeta();

            // Luego abrimos el formulario de material, pasando el ID de la carpeta como módulo
            const formularioHTML = crearFormularioMaterial(carpetaId, carpetaNombre);
            document.body.insertAdjacentHTML('beforeend', formularioHTML);
        };

        function formatearTamano(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function formatearFecha(fechaStr) {
            if (!fechaStr) return '';
            const fecha = new Date(fechaStr);
            return fecha.toLocaleDateString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function confirmarEliminarEntrega(idEntrega) {
            mostrarConfirmacionGlobal(
                'Eliminar entrega',
                '¿Estás seguro de que deseas eliminar tu entrega? Esta acción no se puede deshacer.',
                () => eliminarEntrega(idEntrega),
                { confirmText: 'Eliminar', cancelText: 'Cancelar', type: 'warning' }
            );
        }

        async function eliminarEntrega(idEntrega) {
            try {
                const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

                const response = await fetch('/entrega/eliminar/' + idEntrega, {
                    method: 'DELETE',
                    headers: {
                        [csrfHeader]: csrfToken
                    }
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    mostrarNotificacionGlobal('Entrega eliminada', data.message || 'Entrega eliminada correctamente.', 'success', () => {
                        window.location.reload();
                    });
                } else {
                    alert('Error: ' + (data.error || 'No se pudo eliminar la entrega'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al procesar la solicitud');
            }
        }

        async function abrirModalTarea(btn) {
            const id = btn.getAttribute('data-id');

            // Validar mora antes de abrir el modal (solo alumnos)
            if (!PUEDE_MODIFICAR) {
                try {
                    const response = await fetch(`/clase/validar-mora/${id}`);
                    const data = await response.json();

                    if (data.bloqueado === true) {
                        // Mostrar modal de bloqueo con el mismo estilo de examen
                        const modalBloqueado = `
                        <div id="tareaModalBloqueado" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100]">
                            <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-lg">
                                <div class="text-center">
                                    <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4" 
                                         style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                                        <i class="fas fa-exclamation-triangle text-white text-4xl"></i>
                                    </div>
                                    <h3 class="text-2xl font-bold text-gray-900 mb-4">Tarea Bloqueada</h3>
                                    
                                    <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 mb-6 flex items-center gap-3">
                                        <i class="fas fa-info-circle text-yellow-600 text-2xl"></i>
                                        <p class="text-sm text-yellow-900 font-medium text-left">No puede acceder a esta tarea debido a pagos pendientes. El resto del curso permanece accesible.</p>
                                    </div>
                                    
                                    <div class="flex justify-center gap-8 mb-6 p-5 bg-yellow-50 rounded-xl border-2 border-yellow-300">
                                        <div class="text-center">
                                            <div class="text-xs text-yellow-900 font-semibold uppercase tracking-wide mb-2">Días de Mora</div>
                                            <div class="text-4xl font-bold text-yellow-700">${data.diasMora || 0}</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-xs text-yellow-900 font-semibold uppercase tracking-wide mb-2">Límite Permitido</div>
                                            <div class="text-4xl font-bold text-green-600">${data.limiteMora || 0}</div>
                                        </div>
                                    </div>
                                    
                                    <div class="flex flex-col gap-3">
                                        <a href="/alumno/mis-pagos" 
                                           class="px-6 py-3 rounded-lg text-white font-semibold transition-all hover:shadow-lg"
                                           style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                                            <i class="fas fa-credit-card mr-2"></i>Regularizar mis Pagos
                                        </a>
                                        <button onclick="document.getElementById('tareaModalBloqueado').remove()" 
                                                class="bg-gray-100 text-gray-700 px-6 py-3 rounded-lg font-semibold hover:bg-gray-200 transition-all border-2 border-gray-300">
                                            Cerrar
                                        </button>
                                    </div>
                                    
                                    <div class="mt-6 pt-6 border-t border-gray-200">
                                        <p class="text-sm text-gray-600">
                                            <i class="fas fa-check-circle text-green-500 mr-1"></i>
                                            Una vez acreditado el pago, podrá acceder a la tarea automáticamente.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        `;
                        document.body.insertAdjacentHTML('beforeend', modalBloqueado);
                        return;
                    }
                } catch (error) {
                    console.error('Error al validar mora:', error);
                    // Continuar con el modal normal si falla la validación
                }
            }

            // Si no está bloqueado, continuar con el modal normal
            const titulo = btn.getAttribute('data-titulo');
            const descripcion = btn.getAttribute('data-descripcion');
            const limite = btn.getAttribute('data-limite');
            const tardias = btn.getAttribute('data-tardias') === 'true';
            const modificaciones = btn.getAttribute('data-modificaciones') === 'true';
            const entregaId = btn.getAttribute('data-entrega-id');
            const entregaFecha = btn.getAttribute('data-entrega-fecha');
            const calificacion = btn.getAttribute('data-entrega-calif');
            const entregaArchivo = btn.getAttribute('data-entrega-archivo');
            const entregaTexto = btn.getAttribute('data-entrega-texto');
            const tipoEntregaAttr = btn.getAttribute('data-tipo-entrega') || '';
            const tiposEntrega = tipoEntregaAttr.split(',').map(t => t.trim()).filter(Boolean);

            const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');

            let contenidoEntrega = '';

            if (entregaId) {
                // CU-11: Ya existe una entrega, verificar si se puede modificar
                const ahora = new Date();
                const fechaLimite = limite ? new Date(limite) : null;
                const fueraDePlazo = fechaLimite && ahora > fechaLimite;
                const puedeModificar = modificaciones && (!fueraDePlazo || (fueraDePlazo && tardias));

                contenidoEntrega = `
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200 mb-4">
                        <div class="flex items-center text-green-700 font-medium mb-2">
                            <i class="fas fa-check-circle mr-2"></i> Tarea enviada
                        </div>
                        <p class="text-sm text-gray-600">Fecha: ${formatearFecha(entregaFecha)}</p>
                        ${entregaTexto ? `<div class=\"mt-2 text-sm text-gray-700 bg-white border border-green-100 rounded p-3\"><strong>Texto enviado:</strong><br>${entregaTexto}</div>` : ''}
                        ${entregaArchivo ? `<div class=\"mt-2 text-sm\"><a href=\"/entrega/descargar/${entregaId}\" class=\"text-blue-600 hover:underline\"><i class=\"fas fa-paperclip mr-1\"></i>${entregaArchivo}</a></div>` : ''}
                        ${calificacion ? `<p class="text-sm font-bold text-gray-800 mt-2">Calificación: ${calificacion}</p>` : '<p class="text-xs text-gray-500 mt-1">Pendiente de calificación</p>'}
                    </div>
                    ${puedeModificar ? `
                        <div class="border-t pt-4 mt-4">
                            <h4 class="text-sm font-semibold text-gray-700 mb-3">
                                <i class="fas fa-edit mr-1"></i>Modificar Entrega
                            </h4>
                            <form id="formModificarEntrega" action="/entrega/modificar" method="post" enctype="multipart/form-data" class="space-y-4">
                                <input type="hidden" name="idEntrega" value="${entregaId}">
                                <input type="hidden" name="idTarea" value="${id}">
                                ${csrfToken ? `<input type="hidden" name="_csrf" value="${csrfToken}" />` : ''}
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Nuevo contenido (Texto)</label>
                                    <textarea name="texto" rows="4" class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="Ingresa el nuevo contenido..."></textarea>
                                </div>
                                 
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Reemplazar Archivo</label>
                                    <input type="file" name="archivo" class="w-full text-sm text-gray-500
                                        file:mr-4 file:py-2 file:px-4
                                        file:rounded-md file:border-0
                                        file:text-sm file:font-semibold
                                        file:bg-orange-50 file:text-orange-700
                                        hover:file:bg-orange-100">
                                </div>
                                
                                ${fueraDePlazo ? '<p class="text-xs text-orange-600"><i class="fas fa-exclamation-triangle mr-1"></i>Advertencia: La modificación será marcada como tardía</p>' : ''}
                                
                                <div class="flex justify-between pt-2">
                                    <button type="button" onclick="confirmarEliminarEntrega('${entregaId}')" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">
                                        <i class="fas fa-trash mr-1"></i>Eliminar
                                    </button>
                                    <div class="flex gap-2">
                                        <button type="button" onclick="document.getElementById('tareaModal').remove()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition">
                                            Cancelar
                                        </button>
                                        <button type="submit" class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition">
                                            <i class="fas fa-save mr-1"></i>Guardar Cambios
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    ` : (!modificaciones ? '<p class="text-xs text-gray-500 mt-2"><i class="fas fa-lock mr-1"></i>No se permiten modificaciones en esta tarea</p>' : '<p class="text-xs text-red-600 mt-2"><i class="fas fa-clock mr-1"></i>El plazo para modificar ha finalizado</p>')}
                `;
            } else {
                contenidoEntrega = `
                    <form action="/entrega/enviar" method="post" enctype="multipart/form-data" class="space-y-4">
                        <input type="hidden" name="idTarea" value="${id}">
                        ${csrfToken ? `<input type="hidden" name="_csrf" value="${csrfToken}" />` : ''}
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tu respuesta (Texto)</label>
                            <textarea name="texto" rows="4" class="w-full border border-gray-300 rounded-md px-3 py-2"></textarea>
                        </div>
                         
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Adjuntar Archivo</label>
                            <input type="file" name="archivo" class="w-full text-sm text-gray-500
                                file:mr-4 file:py-2 file:px-4
                                file:rounded-md file:border-0
                                file:text-sm file:font-semibold
                                file:bg-blue-50 file:text-blue-700
                                hover:file:bg-blue-100">
                        </div>
                        
                        <div class="flex justify-end pt-2">
                            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                                Enviar Tarea
                            </button>
                        </div>
                    </form>
                `;
            }

            const modalHTML = `
                <div id="tareaModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100]">
                    <div class="bg-white rounded-lg p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-start mb-4 border-b pb-3">
                            <h3 class="text-xl font-bold text-gray-800">${escapeHtml(titulo)}</h3>
                            <button onclick="document.getElementById('tareaModal').remove()" class="text-gray-500 hover:text-gray-800">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="mb-6">
                            <p class="text-gray-600 whitespace-pre-line">${escapeHtml(descripcion)}</p>
                            ${limite ? `<p class="mt-2 text-sm text-red-600"><i class="far fa-clock mr-1"></i>Vence: ${formatearFecha(limite)}</p>` : ''}
                        </div>
                        
                        ${contenidoEntrega}
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);

            const modalEl = document.getElementById('tareaModal');
            aplicarRestriccionesEntrega(modalEl, tiposEntrega);
        }

        function aplicarRestriccionesEntrega(modalEl, tiposEntrega) {
            if (!modalEl) return;
            const allowTexto = tiposEntrega.length === 0 || tiposEntrega.includes('TEXTO');
            const allowArchivo = tiposEntrega.length === 0 || tiposEntrega.includes('ARCHIVOS');

            const textoFields = modalEl.querySelectorAll('textarea[name="texto"]');
            const archivoFields = modalEl.querySelectorAll('input[type="file"][name="archivo"]');

            textoFields.forEach(field => {
                const wrapper = field.closest('div');
                if (allowTexto) {
                    field.disabled = false;
                    if (wrapper) wrapper.style.display = '';
                } else {
                    field.value = '';
                    field.disabled = true;
                    if (wrapper) wrapper.style.display = 'none';
                }
            });

            archivoFields.forEach(field => {
                const wrapper = field.closest('div');
                if (allowArchivo) {
                    field.disabled = false;
                    if (wrapper) wrapper.style.display = '';
                } else {
                    field.value = '';
                    field.disabled = true;
                    if (wrapper) wrapper.style.display = 'none';
                }
            });
        }

        function escapeHtml(text) {
            if (!text) return "";
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function mostrarModalAviso(titulo, mensaje, iconoClass = 'text-yellow-500 fas fa-exclamation-triangle') {
            const modalHTML = `
                <div id="avisoModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[120]">
                    <div class="bg-white rounded-lg p-6 w-96 shadow-xl transform transition-all scale-100">
                        <div class="text-center">
                            <i class="${iconoClass} text-5xl mb-4"></i>
                            <h3 class="text-xl font-semibold mb-2 text-gray-800">${escapeHtml(titulo)}</h3>
                            <p class="text-gray-600 mb-6">${escapeHtml(mensaje)}</p>
                            <button onclick="document.getElementById('avisoModal').remove()" 
                                    class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                Entendido
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        async function iniciarIngresoClase(claseId) {
            try {
                console.log('🔵 Iniciando proceso de ingreso a clase:', claseId);
                // Mostrar indicador de carga (opcional)
                document.body.style.cursor = 'wait';

                // 1. Primero validar mora
                console.log('🔍 Validando mora antes de entrar...');
                const moraResponse = await fetch('/clase/validar-mora-aula/' + claseId);
                const moraData = await moraResponse.json();

                console.log('📊 Respuesta de mora:', moraData);

                if (moraData.bloqueado === true) {
                    console.log('🚫 ACCESO BLOQUEADO POR MORA');
                    document.body.style.cursor = 'default';
                    // Mostrar modal de bloqueo con el mismo estilo de examen
                    const modalHtml = `
                        <div id="modalMoraBloqueoAula" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100]">
                            <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-lg mx-4">
                                <div class="text-center">
                                    <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4" 
                                         style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                                        <i class="fas fa-exclamation-triangle text-white text-4xl"></i>
                                    </div>
                                    <h3 class="text-2xl font-bold text-gray-900 mb-4">Clase en Vivo Bloqueada</h3>
                                    
                                    <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 mb-6 flex items-center gap-3">
                                        <i class="fas fa-info-circle text-yellow-600 text-2xl"></i>
                                        <p class="text-sm text-yellow-900 font-medium text-left">No puede acceder a esta clase en vivo debido a pagos pendientes. El resto del curso permanece accesible.</p>
                                    </div>
                                    
                                    <div class="flex justify-center gap-8 mb-6 p-5 bg-yellow-50 rounded-xl border-2 border-yellow-300">
                                        <div class="text-center">
                                            <div class="text-xs text-yellow-900 font-semibold uppercase tracking-wide mb-2">Días de Mora</div>
                                            <div class="text-4xl font-bold text-yellow-700">${moraData.diasMora}</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-xs text-yellow-900 font-semibold uppercase tracking-wide mb-2">Límite Permitido</div>
                                            <div class="text-4xl font-bold text-green-600">${moraData.limiteMora}</div>
                                        </div>
                                    </div>
                                    
                                    <div class="flex flex-col gap-3">
                                        <a href="/alumno/mis-pagos?oferta=${moraData.ofertaId}" 
                                           class="px-6 py-3 rounded-lg text-white font-semibold transition-all hover:shadow-lg"
                                           style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                                            <i class="fas fa-credit-card mr-2"></i>Regularizar mis Pagos
                                        </a>
                                        <button onclick="document.getElementById('modalMoraBloqueoAula').remove()" 
                                                class="bg-gray-100 text-gray-700 px-6 py-3 rounded-lg font-semibold hover:bg-gray-200 transition-all border-2 border-gray-300">
                                            Cerrar
                                        </button>
                                    </div>
                                    
                                    <div class="mt-6 pt-6 border-t border-gray-200">
                                        <p class="text-sm text-gray-600">
                                            <i class="fas fa-check-circle text-green-500 mr-1"></i>
                                            Una vez acreditado el pago, podrá unirse a las clases en vivo automáticamente.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.insertAdjacentHTML('beforeend', modalHtml);
                    return;
                }

                console.log('✅ Mora validada - Continuando con validación de horario...');

                // 2. Si no está bloqueado, validar estado de la clase
                const response = await fetch('/clase/estado/' + claseId);
                const estado = await response.json();

                if (!response.ok) {
                    throw new Error('Error al consultar estado');
                }

                document.body.style.cursor = 'default';

                if (estado.finalizada) {
                    mostrarModalAviso('Clase Finalizada', 'Esta clase ya realizó y ha finalizado.', 'text-red-500 fas fa-door-closed');
                    return;
                }

                if (!estado.esHoy) {
                    const fechaInicio = new Date(estado.inicio);
                    const opcionesFecha = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
                    // Capitalizar primera letra
                    let fechaStr = fechaInicio.toLocaleDateString('es-ES', opcionesFecha);
                    fechaStr = fechaStr.charAt(0).toUpperCase() + fechaStr.slice(1);

                    mostrarModalAviso('Fecha Incorrecta', `Esta clase está programada para el ${fechaStr}.`, 'text-blue-500 fas fa-calendar-alt');
                    return;
                }

                if (!estado.iniciada) {
                    const fechaInicio = new Date(estado.inicio);
                    const horaStr = fechaInicio.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                    mostrarModalAviso('Aún no es la hora', `La clase inicia a las ${horaStr}. Podrás ingresar 5 minutos antes.`, 'text-yellow-500 fas fa-clock');
                    return;
                }

                // Si cumple condiciones (es hoy y ya inició o falta poco), redirigir
                console.log('🚀 Redirigiendo a la videoconferencia...');
                window.location.href = '/clase/unirse/' + claseId;

            } catch (error) {
                document.body.style.cursor = 'default';
                console.error('❌ Error en validación:', error);
                // Fallback: intentar entrar de todos modos si falla la validación previa, 
                // el servidor detendrá si es crítico.
                console.log('⚠️ Fallback: intentando redirigir de todos modos...');
                window.location.href = '/clase/unirse/' + claseId;
            }
        }

        function validarIngreso(event) {
            // Deprecated
        }
        /*]]>*/
    </script>

    <script th:if="${success != null}" th:inline="javascript">
        /*<![CDATA[*/
        document.addEventListener('DOMContentLoaded', () => {
            const successMsg = /*[[${success}]]*/ '';
            if (!successMsg) return;

            if (successMsg === 'ANÁLISIS_COMPLETADO') {
                console.log("Auto-opening AI chat for analysis result...");
                setTimeout(() => {
                    // Abrir el chat
                    if (window.aiChat && typeof window.aiChat.openChat === 'function') {
                        window.aiChat.openChat();
                        // Forzar chequeo inmediato de notificaciones para traer el mensaje desde el servidor
                        if (typeof window.aiChat.checkNotifications === 'function') {
                            window.aiChat.checkNotifications();
                        }
                    } else if (window.simpleChatInstance && typeof window.simpleChatInstance.openChat === 'function') {
                        window.simpleChatInstance.openChat();
                        if (typeof window.simpleChatInstance.checkNotifications === 'function') {
                            window.simpleChatInstance.checkNotifications();
                        }
                    } else {
                        const btn = document.getElementById('chat-button-simple');
                        if (btn) btn.click();
                    }
                    // NOTA: Ya no inyectamos manualmente el mensaje aquí para evitar duplicados, 
                    // puesto que el backend ya generó la notificación correspondiente.
                }, 1000);
            } else {
                if (typeof mostrarNotificacionGlobal === 'function') {
                    mostrarNotificacionGlobal('Éxito', successMsg, 'success');
                } else if (typeof mostrarToast === 'function') {
                    mostrarToast(successMsg, 'success');
                } else {
                    alert(successMsg);
                }
            }
        });
        /*]]>*/
    </script>

    <script th:if="${moduloError != null}" th:inline="javascript">
        /*<![CDATA[*/
        document.addEventListener('DOMContentLoaded', () => {
            const mensaje = /*[[${moduloError}]]*/ '';
            if (!mensaje) return;
            if (window.ModalConfirmacion && typeof ModalConfirmacion.show === 'function') {
                ModalConfirmacion.show(
                    'Error de validación',
                    mensaje,
                    null,
                    { type: 'error', confirmText: 'Aceptar', showCancel: false }
                );
            } else {
                alert(mensaje);
            }
        });
        /*]]>*/
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const errorMsg = params.get('error');
            if (!errorMsg) return;

            const mensaje = errorMsg.replace(/\+/g, ' ');
            if (typeof mostrarNotificacionGlobal === 'function') {
                mostrarNotificacionGlobal('Error', mensaje, 'error');
            } else if (typeof mostrarToast === 'function') {
                mostrarToast(mensaje, 'error');
            } else {
                alert(mensaje);
            }
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const createForm = document.getElementById('createModuleForm');
            const editForm = document.getElementById('editModuleForm');

            const confirmarAccion = (titulo, mensaje, onConfirm) => {
                if (typeof mostrarConfirmacionGlobal === 'function') {
                    mostrarConfirmacionGlobal(titulo, mensaje, onConfirm, { confirmText: 'Confirmar', cancelText: 'Cancelar', type: 'info' });
                    return;
                }
                if (window.ModalConfirmacion && typeof ModalConfirmacion.show === 'function') {
                    ModalConfirmacion.show(titulo, mensaje, onConfirm, { confirmText: 'Confirmar', cancelText: 'Cancelar', type: 'info' });
                    return;
                }
                if (confirm(mensaje)) onConfirm();
            };

            const mostrarError = (mensaje) => {
                if (window.ModalConfirmacion && typeof ModalConfirmacion.show === 'function') {
                    ModalConfirmacion.show('Error de validación', mensaje, null, { type: 'error', confirmText: 'Aceptar', showCancel: false });
                    return;
                }
                alert(mensaje);
            };

            const parseDate = (value) => {
                if (!value) return null;
                const d = new Date(value + 'T00:00:00');
                return Number.isNaN(d.getTime()) ? null : d;
            };

            const formatDate = (value) => {
                if (!value) return '-';
                const parts = value.split('-');
                if (parts.length !== 3) return value;
                return `${parts[2]}/${parts[1]}/${parts[0]}`;
            };

            const validarFechasModulo = (form) => {
                const nombre = (form.querySelector('[name="nombre"]')?.value || '').trim();
                const inicioVal = (form.querySelector('[name="fechaInicio"]')?.value || '').trim();
                const finVal = (form.querySelector('[name="fechaFin"]')?.value || '').trim();
                const inicio = parseDate(inicioVal);
                const fin = parseDate(finVal);

                if (inicio && fin && fin < inicio) {
                    return { ok: false, message: 'La fecha de fin no puede ser anterior a la fecha de inicio.' };
                }

                const cursoInicioVal = form.getAttribute('data-curso-inicio') || '';
                const cursoFinVal = form.getAttribute('data-curso-fin') || '';
                const cursoInicio = parseDate(cursoInicioVal);
                const cursoFin = parseDate(cursoFinVal);

                if (inicio && cursoInicio && inicio < cursoInicio) {
                    return { ok: false, message: 'La fecha de inicio del módulo debe estar dentro de las fechas de dictado de la oferta.' };
                }
                if (inicio && cursoFin && inicio > cursoFin) {
                    return { ok: false, message: 'La fecha de inicio del módulo debe estar dentro de las fechas de dictado de la oferta.' };
                }
                if (fin && cursoInicio && fin < cursoInicio) {
                    return { ok: false, message: 'La fecha de fin del módulo debe estar dentro de las fechas de dictado de la oferta.' };
                }
                if (fin && cursoFin && fin > cursoFin) {
                    return { ok: false, message: 'La fecha de fin del módulo debe estar dentro de las fechas de dictado de la oferta.' };
                }

                if (inicio && fin) {
                    const moduloIdActual = form.querySelector('[name="moduloId"]')?.value || '';
                    const modulos = document.querySelectorAll('div.editable-block[data-modulo-id][data-modulo-inicio][data-modulo-fin]');
                    for (const modulo of modulos) {
                        const id = modulo.getAttribute('data-modulo-id') || '';
                        if (moduloIdActual && id === moduloIdActual) continue;
                        const inicioExistenteVal = modulo.getAttribute('data-modulo-inicio') || '';
                        const finExistenteVal = modulo.getAttribute('data-modulo-fin') || '';
                        const inicioExistente = parseDate(inicioExistenteVal);
                        const finExistente = parseDate(finExistenteVal);
                        if (!inicioExistente || !finExistente) continue;

                        const seSuperpone = inicio <= finExistente && fin >= inicioExistente;
                        if (seSuperpone) {
                            const nombreExistente = modulo.getAttribute('data-modulo-nombre') || 'otro módulo';
                            const rangoExistente = `${formatDate(inicioExistenteVal)} - ${formatDate(finExistenteVal)}`;
                            return {
                                ok: false,
                                message: `Las fechas del módulo se superponen con "${nombreExistente}" (${rangoExistente}). Ajusta las fechas para que los módulos no se solapen.`
                            };
                        }
                    }
                }

                return { ok: true, nombre, inicioVal, finVal };
            };

            const attachHandler = (form, tituloConfirmacion) => {
                if (!form) return;
                form.addEventListener('submit', (event) => {
                    event.preventDefault();
                    const resultado = validarFechasModulo(form);
                    if (!resultado.ok) {
                        mostrarError(resultado.message);
                        return;
                    }

                    const nombre = resultado.nombre || 'Nuevo módulo';
                    const inicioTxt = resultado.inicioVal ? formatDate(resultado.inicioVal) : 'Sin fecha';
                    const finTxt = resultado.finVal ? formatDate(resultado.finVal) : 'Sin fecha';
                    const mensaje = `Vas a ${tituloConfirmacion.toLowerCase()} "${nombre}".\nFechas: ${inicioTxt} - ${finTxt}.\n¿Deseas continuar?`;

                    confirmarAccion(
                        tituloConfirmacion,
                        mensaje,
                        () => form.submit()
                    );
                });
            };

            attachHandler(createForm, 'Crear módulo');
            attachHandler(editForm, 'Guardar cambios del módulo');
        });
    </script>"},{
    <!-- Incluir modal de crear clase -->

</body>

</html>
