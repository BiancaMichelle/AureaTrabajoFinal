<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">

<head>
    <title th:text="${instituto?.nombreInstituto ?: 'Instituto Aurea'}">Instituto Aurea</title>
</head>

    <div layout:fragment="content">
        
        <!-- Hero Section con Carrusel Bootstrap -->
        <section class="hero-section">
            
            <div id="heroCarousel" class="carousel slide" data-bs-ride="carousel" th:if="${imagenesCarrusel != null and not #lists.isEmpty(imagenesCarrusel)}">
                <div class="carousel-indicators">
                    <button th:each="imagen, iterStat : ${imagenesCarrusel}" 
                            type="button" 
                            data-bs-target="#heroCarousel" 
                            th:data-bs-slide-to="${iterStat.index}"
                            th:class="${iterStat.index == 0} ? 'active' : ''"
                            th:aria-current="${iterStat.index == 0} ? 'true' : 'false'"
                            th:aria-label="'Slide ' + ${iterStat.index + 1}"></button>
                </div>
                <div class="carousel-inner">
                    <div th:each="imagen, iterStat : ${imagenesCarrusel}" 
                         th:class="'carousel-item' + (${iterStat.index == 0} ? ' active' : '')">
                        <img th:src="@{'/api/carrusel/imagen/' + ${imagen.id}}" 
                             th:alt="${imagen.altText ?: 'Imagen del instituto'}"
                             class="d-block w-100" style="height: 500px; object-fit: cover;">
                        <div class="carousel-caption d-none d-md-block">
                            <div class="container">
                                <h1 class="display-4 fw-bold" th:text="${instituto?.nombreInstituto}">Instituto Aurea</h1>
                                <p class="lead" th:text="${instituto?.descripcion}">Tu futuro profesional comienza aquí</p>
                                <a href="#ofertas" class="btn btn-primary btn-lg">Ver Ofertas Académicas</a>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#heroCarousel" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#heroCarousel" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            </div>
            
            <!-- Fallback Hero si no hay imágenes -->
            <div th:if="${imagenesCarrusel == null or #lists.isEmpty(imagenesCarrusel)}" class="hero-fallback bg-dark text-white py-5">
                <div class="container text-center">
                    <h1 class="display-4 fw-bold" th:text="${instituto?.nombreInstituto}">Instituto Aurea</h1>
                    <p class="lead" th:text="${instituto?.descripcion}">Tu futuro profesional comienza aquí</p>
                    <a href="#ofertas" class="btn btn-light btn-lg">Ver Ofertas Académicas</a>
                </div>
            </div>
        </section>

        <!-- Sección Misión y Visión -->
        <section class="py-5 bg-light" id="mision-vision">
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-lg-8 text-center mb-5">
                        <h2 class="display-5 fw-bold text-primary">Nuestra Institución</h2>
                        <p class="lead text-muted">Conoce más sobre nuestros valores y objetivos</p>
                    </div>
                </div>
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-body text-center p-4">
                                <div class="mb-3">
                                    <i class="fas fa-bullseye fa-3x text-primary"></i>
                                </div>
                                <h3 class="card-title h4 text-primary">Nuestra Misión</h3>
                                <p class="card-text" th:text="${instituto?.mision}">
                                    Brindar educación de calidad y formar profesionales competentes para el mercado laboral actual, 
                                    desarrollando habilidades técnicas y humanas que contribuyan al crecimiento personal y profesional.
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-body text-center p-4">
                                <div class="mb-3">
                                    <i class="fas fa-eye fa-3x text-primary"></i>
                                </div>
                                <h3 class="card-title h4 text-primary">Nuestra Visión</h3>
                                <p class="card-text" th:text="${instituto?.vision}">
                                    Ser referentes en educación profesional a nivel nacional, reconocidos por la excelencia académica 
                                    y la innovación en metodologías de enseñanza.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Sección Ofertas Académicas -->
        <section class="py-5" id="ofertas">
            <div class="container">

                <div class="row justify-content-center">
                    <div class="col-lg-8 text-center mb-5">
                        <h2 class="display-5 fw-bold text-primary">Nuestras Ofertas Académicas</h2>
                        <p class="lead text-muted">Descubre nuestros programas educativos diseñados para tu crecimiento profesional</p>
                    </div>
                </div>

                <!-- Filtros de Búsqueda -->
                <div class="card border-0 shadow-sm mb-5 bg-light" th:if="${not #lists.isEmpty(ofertas)}">
                    <div class="card-body p-4">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label for="filtroNombre" class="form-label fw-bold text-muted small text-uppercase">Buscar</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                                    <input type="text" class="form-control border-start-0 ps-0" id="filtroNombre" placeholder="Nombre de la oferta...">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <label for="filtroTipo" class="form-label fw-bold text-muted small text-uppercase">Tipo</label>
                                <select class="form-select" id="filtroTipo">
                                    <option value="">Todos</option>
                                    <option value="CURSO">Curso</option>
                                    <option value="FORMACION">Formación</option>
                                    <option value="SEMINARIO">Seminario</option>
                                    <option value="CHARLA">Charla</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="filtroCategoria" class="form-label fw-bold text-muted small text-uppercase">Categoría</label>
                                <select class="form-select" id="filtroCategoria">
                                    <option value="">Todas</option>
                                    <option th:each="cat : ${categorias}" 
                                            th:value="${cat.idCategoria}" 
                                            th:text="${cat.nombre}">Categoría</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="filtroModalidad" class="form-label fw-bold text-muted small text-uppercase">Modalidad</label>
                                <select class="form-select" id="filtroModalidad">
                                    <option value="">Todas</option>
                                    <option value="PRESENCIAL">Presencial</option>
                                    <option value="VIRTUAL">Virtual</option>
                                    <option value="HIBRIDA">Híbrida</option>
                                </select>
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button class="btn btn-outline-secondary w-100" id="btnLimpiarFiltros">
                                    <i class="fas fa-eraser me-1"></i> Limpiar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row g-4" th:if="${not #lists.isEmpty(ofertas)}">
                    <div th:each="oferta : ${ofertas}" class="col-lg-4 col-md-6 oferta-item"
                         th:data-nombre="${oferta.nombre != null ? oferta.nombre.toLowerCase() : ''}"
                         th:data-tipo="${oferta.tipoOferta}"
                         th:data-modalidad="${oferta.modalidad}"
                         th:data-categoria="${oferta.categorias != null and not #lists.isEmpty(oferta.categorias) ? oferta.categorias[0].idCategoria : ''}">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-header text-white" style="background-color: var(--dark-blue);">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="badge bg-light me-2" style="color: var(--dark-blue);"
                                          th:text="${oferta.categorias != null and not #lists.isEmpty(oferta.categorias)} ? ${oferta.categorias[0].nombre} : 'General'">Categoría</span>
                                    <span class="badge bg-warning text-dark" th:text="${oferta.tipoOferta}">TIPO</span>
                                </div>
                                <h5 class="card-title mb-0 mt-2">
                                    <a th:href="@{/publico/oferta/{id}(id=${oferta.idOferta})}" class="text-white text-decoration-none" th:text="${oferta.nombre}">Título de la Oferta</a>
                                </h5>
                            </div>
                            <div class="card-body">
                                <p class="card-text" th:text="${oferta.descripcion}">
                                    Descripción de la oferta académica que proporciona información detallada sobre el contenido y objetivos del programa.
                                </p>
                                <div class="row g-2 mb-3">
                                    <div class="col-6">
                                        <small class="text-muted">
                                            <i class="fas fa-calendar me-1"></i>
                                            <span th:text="${oferta.modalidad}">Modalidad</span>
                                        </small>
                                    </div>
                                    <div class="col-6" th:if="${oferta.duracion}">
                                        <small class="text-muted">
                                            <i class="fas fa-clock me-1"></i>
                                            <span th:text="${oferta.duracion}">Duración</span>
                                        </small>
                                    </div>
                                    <div class="col-6" th:if="${oferta.certificado}">
                                        <small class="text-success">
                                            <i class="fas fa-certificate me-1"></i>
                                            Con Certificado
                                        </small>
                                    </div>
                                    <div class="col-6" th:if="${oferta.cuposDisponibles != null}">
                                        <small class="text-info">
                                            <i class="fas fa-users me-1"></i>
                                            <span th:text="${oferta.cantidadAlumnosActivos} + ' de ' + ${oferta.cupos} + ' cupos'">x de xx cupos</span>
                                        </small>
                                    </div>
                                    <div class="col-6" th:if="${oferta.cuposDisponibles == null}">
                                        <small class="text-info">
                                            <i class="fas fa-users me-1"></i>
                                            Sin límite
                                        </small>
                                    </div>
                                    <!-- Costo mensual para Curso (usa costoCuota) -->
                                    <div class="col-12" th:if="${oferta.tipoOferta == 'CURSO' and oferta.costoCuota != null and oferta.costoCuota > 0}">
                                        <small class="text-primary fw-bold">
                                            <i class="fas fa-calendar-alt me-1"></i>
                                            Costo mensual: $<span th:text="${#numbers.formatDecimal(oferta.costoCuota, 0, 'COMMA', 2, 'POINT')}">0</span>
                                        </small>
                                    </div>
                                    <!-- Costo mensual para Formación (usa costoCuota si existe) -->
                                    <div class="col-12" th:if="${oferta.tipoOferta == 'FORMACION' and oferta.costoCuota != null and oferta.costoCuota > 0}">
                                        <small class="text-primary fw-bold">
                                            <i class="fas fa-calendar-alt me-1"></i>
                                            Costo mensual: $<span th:text="${#numbers.formatDecimal(oferta.costoCuota, 0, 'COMMA', 2, 'POINT')}">0</span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer bg-transparent">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="h5 text-primary mb-0" th:if="${oferta.costoInscripcion != null and oferta.costoInscripcion > 0}">
                                        $<span th:text="${#numbers.formatDecimal(oferta.costoInscripcion, 0, 'COMMA', 2, 'POINT')}">0</span>
                                    </span>
                                    <span class="h5 text-success mb-0" th:if="${oferta.costoInscripcion == null or oferta.costoInscripcion == 0}">
                                        Gratuito
                                    </span>
                                    
                                    <!-- Botones de Acción -->
                                    <div>
                                        <!-- Botón Ver Detalle (para todos) -->
                                        <a th:href="@{/publico/oferta/{id}(id=${oferta.idOferta})}" class="btn btn-outline-secondary btn-sm me-1" style="color: var(--dark-blue); border-color: var(--dark-blue);">
                                            <i class="fas fa-eye"></i>
                                        </a>

                                        <span th:if="${#authorization.expression('isAuthenticated()')}" th:remove="tag">
                                        
                                        <!-- Caso: Ya es Docente del curso -->
                                        <a th:if="${idsDocente != null and #sets.contains(idsDocente, oferta.idOferta)}"
                                           th:href="@{/docente/aula/{id}(id=${oferta.idOferta})}"
                                           class="btn btn-success btn-sm me-1">
                                            <i class="fas fa-chalkboard-teacher me-1"></i> Aula Docente
                                        </a>
                                        
                                        <!-- Caso: Ya está inscrito (Alumno) -->
                                        <a th:if="${idsInscritos != null and #sets.contains(idsInscritos, oferta.idOferta)}"
                                           th:href="@{/alumno/aula/{id}(id=${oferta.idOferta})}"
                                           class="btn btn-info btn-sm text-white me-1">
                                            <i class="fas fa-door-open me-1"></i> Ir al Aula
                                        </a>

                                        <!-- Caso: No inscrito y No docente (Mostrar Inscripción) -->
                                        <th:block th:if="${(idsInscritos == null or !#sets.contains(idsInscritos, oferta.idOferta)) and (idsDocente == null or !#sets.contains(idsDocente, oferta.idOferta))}">
                                            <form th:action="@{/alumno/inscribirse/{id}(id=${oferta.idOferta})}" 
                                                  method="post" class="d-inline" target="_blank">
                                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                                <button type="submit" class="btn btn-primary btn-sm">
                                                    <i class="fas fa-user-plus me-1"></i>
                                                    Inscribirse
                                                </button>
                                            </form>
                                        </th:block>
                                    </span>
                                    <span th:unless="${#authorization.expression('isAuthenticated()')}" th:remove="tag">
                                        <a th:href="@{/login}" class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-sign-in-alt me-1"></i>
                                            Iniciar sesión
                                        </a>
                                    </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Mensaje cuando no hay resultados por filtro -->
                <div id="mensajeNoResultados" class="text-center py-5" style="display: none;">
                    <div class="mb-3">
                        <i class="fas fa-search fa-3x text-muted opacity-50"></i>
                    </div>
                    <h4 class="text-muted">No se encontraron resultados</h4>
                    <p class="text-muted">Intenta ajustar los filtros de búsqueda</p>
                </div>

                <!-- Mensaje cuando no hay ofertas -->
                <div th:if="${#lists.isEmpty(ofertas)}" class="text-center py-5">
                    <div class="mb-4">
                        <i class="fas fa-graduation-cap fa-4x text-muted"></i>
                    </div>
                    <h3 class="text-muted">Próximamente</h3>
                    <p class="lead text-muted">Estamos preparando nuevas ofertas académicas. ¡Mantente atento!</p>
                </div>
            </div>
        </section>

        <!-- Modal Cupos Agotados y Recomendaciones IA -->
        <div class="modal fade" id="modalCuposAgotados" tabindex="-1" aria-hidden="true" th:if="${errorCupo}">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content border-0 shadow">
                    <div class="modal-header bg-warning bg-opacity-10">
                        <h5 class="modal-title text-warning fw-bold">
                            <i class="fas fa-exclamation-triangle me-2"></i> Cupos Agotados
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body p-4">
                        <div class="text-center mb-4">
                            <i class="fas fa-store-slash fa-4x text-muted mb-3 opacity-50"></i>
                            <h4 class="fw-bold" th:text="'Lo sentimos, ' + ${ofertaLlena.nombre} + ' ya no tiene cupos.'">Oferta Llena</h4>
                            <p class="text-muted">La capacidad máxima para esta oferta académica ha sido alcanzada.</p>
                        </div>

                        <hr class="my-4">

                        <h5 class="mb-3 text-primary"><i class="fas fa-robot me-2"></i>Recomendaciones Inteligentes</h5>
                        <p class="text-muted small mb-3">Nuestra IA ha seleccionado estas alternativas basándose en tus intereses:</p>

                        <div class="row g-3" th:if="${not #lists.isEmpty(recomendaciones)}">
                            <div th:each="rec : ${recomendaciones}" class="col-md-4">
                                <div class="card h-100 border-0 shadow-sm bg-light">
                                    <div class="card-body p-3">
                                        <div class="badge bg-info mb-2" th:text="${rec.tipoOferta}">TIPO</div>
                                        <h6 class="card-title fw-bold text-dark mb-1" th:text="${rec.nombre}">Nombre</h6>
                                        <p class="card-text small text-muted text-truncate" th:text="${rec.descripcion}">Desc</p>
                                    </div>
                                    <div class="card-footer bg-transparent border-0 p-3 pt-0">
                                        <form th:action="@{/inscribirse/{id}(id=${rec.idOferta})}" method="post" target="_blank">
                                            <button type="submit" class="btn btn-outline-primary btn-sm w-100">Ver e Inscribirse</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div th:if="${#lists.isEmpty(recomendaciones)}" class="text-center py-3">
                             <p class="text-muted fst-italic">No encontramos recomendaciones similares en este momento.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Scripts específicos de la página -->
    <th:block layout:fragment="scripts">
        <script>
            // Activar modal de cupos si existe el error
            document.addEventListener('DOMContentLoaded', function() {
                var modalCupos = document.getElementById('modalCuposAgotados');
                if (modalCupos) {
                    var myModal = new bootstrap.Modal(modalCupos);
                    myModal.show();
                }
            });
            // Lógica de filtrado de ofertas
            document.addEventListener('DOMContentLoaded', function() {
                const filtroNombre = document.getElementById('filtroNombre');
                const filtroTipo = document.getElementById('filtroTipo');
                const filtroModalidad = document.getElementById('filtroModalidad');
                const filtroCategoria = document.getElementById('filtroCategoria');
                const btnLimpiar = document.getElementById('btnLimpiarFiltros');
                const ofertas = document.querySelectorAll('.oferta-item');
                const mensajeNoResultados = document.getElementById('mensajeNoResultados');

                if (filtroNombre && ofertas.length > 0) {
                    function filtrarOfertas() {
                        const nombre = filtroNombre.value.toLowerCase().trim();
                        const tipo = filtroTipo.value;
                        const modalidad = filtroModalidad.value;
                        const categoria = filtroCategoria ? filtroCategoria.value : '';
                        let visibles = 0;

                        ofertas.forEach(oferta => {
                            const dataNombre = oferta.getAttribute('data-nombre') || '';
                            const dataTipo = oferta.getAttribute('data-tipo') || '';
                            const dataModalidad = oferta.getAttribute('data-modalidad') || '';
                            const dataCategoria = oferta.getAttribute('data-categoria') || '';

                            // Normalizar para ignorar mayúsculas/minúsculas y acentos
                            const normalize = (str) => str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase();
                            
                            const coincideNombre = dataNombre.includes(nombre);
                            const coincideTipo = tipo === '' || normalize(dataTipo) === tipo;
                            const coincideModalidad = modalidad === '' || dataModalidad === modalidad;
                            const coincideCategoria = categoria === '' || dataCategoria === categoria;

                            if (coincideNombre && coincideTipo && coincideModalidad && coincideCategoria) {
                                oferta.style.display = ''; // Restaurar display original
                                visibles++;
                            } else {
                                oferta.style.display = 'none';
                            }
                        });
                        
                        if (mensajeNoResultados) {
                            mensajeNoResultados.style.display = visibles === 0 ? 'block' : 'none';
                        }
                    }

                    filtroNombre.addEventListener('input', filtrarOfertas);
                    filtroTipo.addEventListener('change', filtrarOfertas);
                    filtroModalidad.addEventListener('change', filtrarOfertas);
                    if (filtroCategoria) filtroCategoria.addEventListener('change', filtrarOfertas);

                    if (btnLimpiar) {
                        btnLimpiar.addEventListener('click', function() {
                            filtroNombre.value = '';
                            filtroTipo.value = '';
                            filtroModalidad.value = '';
                            if (filtroCategoria) filtroCategoria.value = '';
                            filtrarOfertas();
                        });
                    }
                }
            });

            // Inicializar carrusel si existe
            document.addEventListener('DOMContentLoaded', function() {
                var myCarousel = document.querySelector('#heroCarousel')
                if (myCarousel) {
                    var carousel = new bootstrap.Carousel(myCarousel, {
                        interval: 5000,
                        wrap: true
                    })
                }
            });
        </script>
    </th:block>

</html>