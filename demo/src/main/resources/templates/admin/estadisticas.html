<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/adminBase :: layout(~{::title}, ~{::content})}" lang="es">
<head>
    <title>Estadísticas Académicas - Aurea</title>
</head>
<body>
<div th:fragment="content" class="main-content">
    
    <style>
        /* Modern Dashboard Styles */
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --warning-gradient: linear-gradient(135deg, #fce38a 0%, #f38181 100%);
            --danger-gradient: linear-gradient(135deg, #ff9966 0%, #ff5e62 100%);
            --card-shadow: 0 4px 6px rgba(50, 50, 93, 0.11), 0 1px 3px rgba(0, 0, 0, 0.08);
            --hover-shadow: 0 7px 14px rgba(50, 50, 93, 0.1), 0 3px 6px rgba(0, 0, 0, 0.08);
        }

        .dashboard-header {
            background: white;
            padding: 1.5rem 2rem;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dashboard-header h1 {
            font-size: 1.8rem;
            color: #2d3748;
            margin: 0;
            font-weight: 700;
        }

        .dashboard-header p {
            color: #718096;
            margin-top: 0.5rem;
        }

        /* Stats Cards */
        .stats-card {
            border: none;
            border-radius: 12px;
            transition: all 0.3s ease;
            overflow: hidden;
            box-shadow: var(--card-shadow);
            color: white;
        }

        .kpi-row .stats-card {
            aspect-ratio: 1 / 1;
            max-width: 210px;
            margin: 0 auto;
        }

        .kpi-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 1rem;
        }

        .kpi-row > [class*='col-'] {
            flex: 0 1 210px;
            width: auto;
            padding: 0;
        }

        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--hover-shadow);
        }

        .stats-card .card-body {
            padding: 1.5rem;
            position: relative;
            z-index: 1;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .stats-card .icon-bg {
            position: absolute;
            right: -10px;
            bottom: -10px;
            font-size: 5rem;
            opacity: 0.1;
            transform: rotate(-15deg);
            z-index: 0;
            color: white;
        }

        .bg-gradient-primary { background: var(--primary-gradient); }
        .bg-gradient-success { background: var(--success-gradient); }
        .bg-gradient-info { background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%); }
        .bg-gradient-warning { background: var(--warning-gradient); }

        .stats-value {
            font-size: 2.2rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            display: block;
        }

        .stats-label {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.9;
        }

        /* Chart Cards */
        .metric-card {
            background: white;
            border: none;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
            height: 100%;
        }

        .metric-card .card-header {
            background: transparent;
            border-bottom: 1px solid #e2e8f0;
            padding: 1.2rem 1.5rem;
            font-weight: 600;
            color: #2d3748;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            padding: 1rem;
        }

        /* Tabs Styling */
        .nav-tabs {
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 1.5rem;
        }
        
        .nav-tabs .nav-link {
            border: none;
            color: #718096;
            font-weight: 600;
            padding: 1rem 1.5rem;
            transition: all 0.2s;
        }
        
        .nav-tabs .nav-link:hover {
            color: #4a5568;
            border: none; 
            border-bottom: 2px solid #cbd5e0;
        }
        
        .nav-tabs .nav-link.active {
            color: #667eea;
            border: none;
            border-bottom: 2px solid #667eea;
            background: transparent;
        }

        /* Table Styling */
        .custom-table thead th {
            background-color: #f8fafc;
            color: #4a5568;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            border-top: none;
        }
        
        .custom-table tbody td {
            vertical-align: middle;
            color: #2d3748;
        }

        .badge-demanda {
            padding: 0.4em 0.8em;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        /* Action Buttons */
        .action-btn {
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }
        
        .btn-generate-report {
            background: var(--success-gradient);
            color: white;
            box-shadow: 0 4px 6px rgba(17, 153, 142, 0.3);
            text-decoration: none;
        }
        
        .btn-generate-report:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(17, 153, 142, 0.4);
            color: white;
        }

        .btn-refresh {
            background: #fff;
            color: #4a5568;
            border: 1px solid #e2e8f0;
        }
        
        .btn-refresh:hover {
            background: #f7fafc;
            color: #2d3748;
        }

        /* Report Modal custom styles */
        .modal-report-header {
            background: var(--primary-gradient);
            color: white;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            padding: 1.5rem;
        }
        
        .form-section-label {
            font-size: 0.85rem;
            text-transform: uppercase;
            color: #a0aec0;
            font-weight: 700;
            margin-bottom: 0.5rem;
            display: block;
        }

        .time-filters-card {
            background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 14px;
            box-shadow: var(--card-shadow);
            padding: 1.1rem 1.25rem;
            margin-bottom: 1.1rem;
            border: 1px solid #dbe4f0;
        }

        .time-filters-title {
            font-size: 0.78rem;
            color: #64748b;
            font-weight: 800;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            margin-bottom: 0.75rem;
        }

        .time-filters-grid {
            display: grid;
            grid-template-columns: repeat(12, minmax(0, 1fr));
            gap: 0.85rem;
            align-items: end;
        }

        .tf-col-3 { grid-column: span 3; }
        .tf-col-2 { grid-column: span 2; }
        .tf-col-4 { grid-column: span 4; }
        .tf-col-12 { grid-column: span 12; }

        .tf-field {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 0.65rem 0.75rem;
        }

        .tf-field label {
            display: block;
            font-size: 0.72rem;
            font-weight: 800;
            color: #475569;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            margin-bottom: 0.45rem;
        }

        .tf-field .form-control,
        .tf-field .form-select {
            border: 1px solid #dbe4f0;
            border-radius: 8px;
            box-shadow: none;
            font-weight: 600;
        }

        .tf-field .form-control:focus,
        .tf-field .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        }

        .time-range-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 0.45rem;
            margin-top: 0.6rem;
        }

        .time-range-pill {
            border: 1px solid #cbd5e1;
            background: #fff;
            color: #334155;
            padding: 0.35rem 0.6rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            line-height: 1;
        }

        .time-range-pill:hover {
            border-color: #94a3b8;
            background: #f8fafc;
        }

        .time-range-pill.active {
            border-color: #4f46e5;
            background: #eef2ff;
            color: #312e81;
            box-shadow: inset 0 0 0 1px rgba(79, 70, 229, 0.25);
        }

        .time-range-help {
            margin-top: 0.45rem;
            font-size: 0.72rem;
            color: #64748b;
            font-weight: 600;
        }

        .filter-chip-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.45rem;
        }

        .filter-chip-input {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }

        .filter-chip {
            display: inline-flex;
            align-items: center;
            border: 1px solid #cbd5e1;
            background: #ffffff;
            color: #334155;
            padding: 0.42rem 0.7rem;
            border-radius: 999px;
            font-size: 0.78rem;
            font-weight: 700;
            cursor: pointer;
            user-select: none;
            transition: all 0.18s ease;
        }

        .filter-chip:hover {
            border-color: #94a3b8;
            background: #f8fafc;
        }

        .filter-chip-input:checked + .filter-chip {
            border-color: #667eea;
            background: #eef2ff;
            color: #3730a3;
            box-shadow: inset 0 0 0 1px rgba(102, 126, 234, 0.25);
        }

        .filter-toast {
            position: fixed;
            top: 92px;
            right: 20px;
            z-index: 1080;
            background: #ffffff;
            border-left: 4px solid #10b981;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(15, 23, 42, 0.15);
            padding: 0.85rem 0.95rem;
            min-width: 260px;
            max-width: 360px;
            opacity: 0;
            transform: translateX(24px);
            pointer-events: none;
            transition: all 0.28s ease;
        }

        .filter-toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .filter-toast-title {
            font-size: 0.82rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            font-weight: 800;
            color: #047857;
            margin-bottom: 0.2rem;
        }

        .filter-toast-msg {
            color: #0f172a;
            font-size: 0.9rem;
            font-weight: 600;
        }


        @media (max-width: 992px) {
            .tf-col-3, .tf-col-2, .tf-col-4 { grid-column: span 6; }
        }

        @media (max-width: 768px) {
            .tf-col-3, .tf-col-2, .tf-col-4 { grid-column: span 12; }
            .kpi-row .stats-card {
                max-width: 240px;
            }
            .kpi-row > [class*='col-'] {
                flex-basis: min(100%, 240px);
            }
        }

        .summary-chip {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 0.85rem 1rem;
            height: 100%;
        }

        .summary-chip .k {
            color: #64748b;
            font-size: 0.78rem;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 0.4px;
        }

        .summary-chip .v {
            color: #0f172a;
            font-size: 1.4rem;
            font-weight: 800;
            line-height: 1.1;
            margin-top: 0.25rem;
        }
    </style>

    <!-- Header / Actions -->
    <div class="container-fluid py-4">
        <div class="dashboard-header">
            <div>
                <h1><i class="fas fa-chart-line text-primary me-2"></i>Estadísticas</h1>
                <p class="mb-0">Visión general del rendimiento y métricas clave del sistema</p>
            </div>
            <div class="d-flex gap-3">
                <button id="btnRefreshCharts" class="action-btn btn-refresh">
                    <i class="fas fa-sync-alt"></i> Actualizar
                </button>
                <button id="btnOpenReportModal" class="action-btn btn-generate-report">
                    <i class="fas fa-file-download"></i> Exportar Reportes
                </button>
            </div>
        </div>

        <div id="filterToast" class="filter-toast" aria-live="polite">
            <div class="filter-toast-title">Filtros aplicados</div>
            <div id="filterToastMsg" class="filter-toast-msg">Se actualizaron las estadisticas.</div>
        </div>
        
        <!-- Alerts -->
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i> <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        
        <!-- KPI Cards Row -->
        <div class="row mb-4 g-4 kpi-row">
            <!-- Usuarios -->
            <div class="col-xl-3 col-md-6">
                <div class="stats-card bg-gradient-info h-100">
                    <div class="card-body">
                        <i class="fas fa-users icon-bg"></i>
                        <span class="stats-value" th:text="${metricas != null ? metricas['totalUsuarios'] : 0}">0</span>
                        <span class="stats-label">Usuarios Registrados</span>
                    </div>
                </div>
            </div>
            <!-- Ofertas -->
            <div class="col-xl-3 col-md-6">
                <div class="stats-card bg-gradient-primary h-100">
                    <div class="card-body">
                        <i class="fas fa-book-open icon-bg"></i>
                        <span class="stats-value" th:text="${metricas != null ? metricas['totalOfertas'] : 0}">0</span>
                        <span class="stats-label">Ofertas Activas</span>
                    </div>
                </div>
            </div>
            <!-- Inscripciones -->
            <div class="col-xl-3 col-md-6">
                <div class="stats-card bg-gradient-success h-100">
                    <div class="card-body">
                        <i class="fas fa-user-graduate icon-bg"></i>
                        <span class="stats-value" th:text="${metricas != null ? metricas['totalInscripciones'] : 0}">0</span>
                        <span class="stats-label">Inscripciones Totales</span>
                    </div>
                </div>
            </div>
            <!-- Ingresos -->
            <div class="col-xl-3 col-md-6">
                <div class="stats-card bg-gradient-warning h-100">
                    <div class="card-body">
                        <i class="fas fa-coins icon-bg"></i>
                        <span class="stats-value" th:text="${metricas != null ? ('$' + metricas['ingresosTotales']) : '$0.00'}">$0.00</span>
                        <span class="stats-label">Ingresos Generados</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="time-filters-card">
            <div class="time-filters-title">Filtros Temporales</div>
            <div class="time-filters-grid">
                <div class="tf-col-3">
                    <div class="tf-field">
                        <label for="fltFechaInicio">Periodo: desde</label>
                        <input id="fltFechaInicio" type="date" class="form-control"
                               th:value="${#temporals.format(fechaInicioDefault, 'yyyy-MM-dd')}"
                               th:attr="max=${#temporals.format(maxFechaHoy, 'yyyy-MM-dd')}">
                    </div>
                </div>
                <div class="tf-col-3">
                    <div class="tf-field">
                        <label for="fltFechaFin">Periodo: hasta</label>
                        <input id="fltFechaFin" type="date" class="form-control"
                               th:value="${#temporals.format(fechaFinDefault, 'yyyy-MM-dd')}"
                               th:attr="max=${#temporals.format(maxFechaHoy, 'yyyy-MM-dd')}">
                    </div>
                </div>
                <div class="tf-col-2">
                    <div class="tf-field">
                        <label for="fltAgrupacion">Agrupacion</label>
                        <select id="fltAgrupacion" class="form-select">
                            <option value="dia">Dia</option>
                            <option value="semana">Semana</option>
                            <option value="mes">Mes</option>
                        </select>
                    </div>
                </div>
                <div class="tf-col-4">
                    <div class="tf-field">
                        <label>Tipo de oferta</label>
                        <div class="filter-chip-group">
                            <input class="filter-chip-input fltTipoCheck" type="checkbox" id="tipoCurso" value="curso" checked>
                            <label class="filter-chip" for="tipoCurso">Curso</label>

                            <input class="filter-chip-input fltTipoCheck" type="checkbox" id="tipoCharla" value="charla" checked>
                            <label class="filter-chip" for="tipoCharla">Charla</label>

                            <input class="filter-chip-input fltTipoCheck" type="checkbox" id="tipoSeminario" value="seminario" checked>
                            <label class="filter-chip" for="tipoSeminario">Seminario</label>

                            <input class="filter-chip-input fltTipoCheck" type="checkbox" id="tipoFormacion" value="formacion" checked>
                            <label class="filter-chip" for="tipoFormacion">Formacion</label>
                        </div>
                    </div>
                </div>
                <div class="tf-col-12">
                    <div class="tf-field">
                        <label>Atajos de periodo</label>
                        <div class="time-range-pills">
                            <button type="button" class="time-range-pill" data-days="7">7 dias</button>
                            <button type="button" class="time-range-pill" data-days="30">30 dias</button>
                            <button type="button" class="time-range-pill" data-days="90">90 dias</button>
                            <button type="button" class="time-range-pill" data-days="180">6 meses</button>
                        </div>
                        <div class="time-range-help">Selecciona un atajo para completar fechas. Se aplica al hacer click en "Aplicar filtros".</div>
                    </div>
                </div>
                <div class="tf-col-4">
                    <div class="tf-field">
                        <label>Modalidad</label>
                        <div class="filter-chip-group">
                            <input class="filter-chip-input fltModalidadCheck" type="checkbox" id="modVirtual" value="virtual" checked>
                            <label class="filter-chip" for="modVirtual">Virtual</label>

                            <input class="filter-chip-input fltModalidadCheck" type="checkbox" id="modPresencial" value="presencial" checked>
                            <label class="filter-chip" for="modPresencial">Presencial</label>

                            <input class="filter-chip-input fltModalidadCheck" type="checkbox" id="modHibrida" value="hibrida" checked>
                            <label class="filter-chip" for="modHibrida">Hibrida</label>
                        </div>
                    </div>
                </div>
                <div class="tf-col-4 text-end">
                    <button id="btnAplicarTemporal" class="action-btn btn-refresh">
                        <i class="fas fa-filter"></i> Aplicar filtros
                    </button>
                </div>
            </div>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-lg-3 col-md-6">
                <div class="summary-chip">
                    <div class="k">Total inscripciones</div>
                    <div id="sumTotalInscripciones" class="v">0</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="summary-chip">
                    <div class="k">Pico del periodo</div>
                    <div id="sumPico" class="v">-</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="summary-chip">
                    <div class="k">Comparativa periodo</div>
                    <div id="sumComparativa" class="v">0%</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="summary-chip">
                    <div class="k">Ultima inscripcion</div>
                    <div id="sumUltima" class="v">sin registros</div>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-lg-7">
                <div class="metric-card">
                    <div class="card-header">
                        <span>Tendencia por modalidad</span>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="chartTemporalModalidad"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-5">
                <div class="metric-card">
                    <div class="card-header">
                        <span>Tipo de oferta por modalidad (apilado)</span>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="chartTemporalTipoModalidad"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-content" id="statsTabsContent">
            
            <!-- TAB: OFERTA ACADÉMICA -->
            <div class="tab-pane fade show active" id="oferta" role="tabpanel">
                <div class="row mb-4">
                    <div class="col-lg-6 mb-4">
                        <div class="metric-card">
                            <div class="card-header">
                                <span>Estado de Ofertas</span>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="chartOfertasEstado"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 mb-4">
                        <div class="metric-card">
                            <div class="card-header">
                                <span>Ofertas por Tipo</span>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="chartOfertasTipo"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                         <div class="metric-card">
                            <div class="card-header">
                                <span><i class="fas fa-fire me-2 text-primary"></i>Demanda y Ocupación</span>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table custom-table table-hover mb-0">
                                        <thead>
                                            <tr>
                                                <th class="ps-4">Oferta Académica</th>
                                                <th class="text-center">Inscriptos</th>
                                                <th class="text-center">Tasa Ocupación</th>
                                                <th class="text-center">Demanda</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr th:if="${demandaOfertas == null or #lists.isEmpty(demandaOfertas)}">
                                                <td colspan="4" class="text-center py-4 text-muted">No hay datos disponibles</td>
                                            </tr>
                                            <tr th:each="oferta : ${demandaOfertas}">
                                                <td class="ps-4 fw-bold" th:text="${oferta['tituloOferta']}">Nombre</td>
                                                <td class="text-center" th:text="${oferta['cantidadInscritos']}">0</td>
                                                <td class="text-center">
                                                    <div class="d-flex align-items-center justify-content-center">
                                                        <div class="progress w-50 me-2" style="height: 6px;">
                                                            <div class="progress-bar" 
                                                                 th:style="'width: ' + ${oferta['tasaOcupacion'] * 100} + '%'"
                                                                 th:classappend="${oferta['tasaOcupacion'] > 0.8 ? 'bg-danger' : (oferta['tasaOcupacion'] > 0.5 ? 'bg-info' : 'bg-success')}">
                                                            </div>
                                                        </div>
                                                        <span class="small" th:text="${#numbers.formatPercent(oferta['tasaOcupacion'], 1, 0)}">0%</span>
                                                    </div>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge" 
                                                        th:classappend="${oferta['nivelDemanda'] == 'ALTA' ? 'bg-success' : 'bg-secondary'}"
                                                        th:text="${oferta['nivelDemanda']}">MEDIA</span>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- INSCRIPCIONES (migrado a Oferta Académica) -->
                <div id="inscripciones-section" class="row mb-4">
                    <div class="col-lg-8">
                        <div class="metric-card">
                            <div class="card-header">
                                <span>Evolución Mensual de Inscripciones</span>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="chartInscripcionesEvol"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                         <div class="metric-card">
                            <div class="card-header">
                                <span>Ratios Clave</span>
                            </div>
                            <div class="card-body">
                                <div class="mb-4 text-center">
                                    <h6 class="text-muted text-uppercase mb-2">Tasa de Abandono</h6>
                                    <h2 class="text-danger fw-bold" th:if="${statsInscripciones != null}" th:text="${#numbers.formatPercent(statsInscripciones['tasaAbandonoGlobal'], 1, 1)}">0%</h2>
                                </div>
                                <hr>
                                <div class="mb-4 text-center">
                                    <h6 class="text-muted text-uppercase mb-2">Nuevos vs Recurrentes</h6>
                                    <div class="d-flex justify-content-center gap-4">
                                        <div>
                                            <span class="d-block text-success fw-bold h4" th:if="${statsInscripciones != null}" th:text="${statsInscripciones['alumnosNuevos']}">0</span>
                                            <small class="text-muted">Nuevos</small>
                                        </div>
                                        <div>
                                            <span class="d-block text-primary fw-bold h4" th:if="${statsInscripciones != null}" th:text="${statsInscripciones['alumnosRecurrentes']}">0</span>
                                            <small class="text-muted">Recurrentes</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ECONÓMICO (migrado a Oferta Académica) -->
                <div id="economico-section" class="row mb-4">
                    <div class="col-lg-6">
                        <div class="metric-card">
                            <div class="card-header">
                                <span>Ingresos por Oferta Académica</span>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="chartIngresosOferta"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                     <div class="col-lg-6">
                        <div class="metric-card">
                            <div class="card-header">
                                <span>Estado de Pagos</span>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="chartEstadoPagos"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div> <!-- End Tab Content -->

    </div>

    <!-- Report Modal -->
    <div id="statsReportModal" class="modal" tabindex="-1" style="display: none; background: rgba(0,0,0,0.5); position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1050;">
        <div class="modal-dialog modal-dialog-centered" style="margin: 1.75rem auto; max-width: 500px;">
            <div class="modal-content shadow-lg border-0" style="background-color: #fff; border-radius: 0.5rem;">
                <div class="modal-header modal-report-header">
                    <h5 class="modal-title fw-bold" style="color: white;"><i class="fas fa-file-invoice me-2"></i>Generar Reporte</h5>
                    <button type="button" class="btn-close btn-close-white close-modal-trigger" style="filter: invert(1); background: transparent; border: 0; font-size: 1.5rem; line-height: 1;">&times;</button>
                </div>
                <div class="modal-body p-4">
                    <form id="statsReportForm" action="/admin/reportes/ofertas/descargar" method="get">
                        <input type="hidden" name="tipoReporte" value="estadistico">
                        <input type="hidden" name="fechaInicio" id="reportFechaInicio">
                        <input type="hidden" name="fechaFin" id="reportFechaFin">
                        <input type="hidden" name="agrupacion" id="reportAgrupacion">
                        <div id="reportTiposContainer"></div>
                        <div id="reportModalidadesContainer"></div>
                        <!-- Form fields preserved -->
                        <div class="mb-4">
                            <label class="form-section-label">Formato de Salida</label>
                            <div class="d-flex gap-2">
                                <div class="w-50">
                                    <input type="radio" class="btn-check visually-hidden" name="formato" id="fmtPdf" value="pdf" checked>
                                    <label class="btn btn-outline-danger w-100 py-3" for="fmtPdf" style="display: block; text-align: center; border: 1px solid #dc3545; border-radius: 0.375rem; color: #dc3545; cursor: pointer;">
                                        <i class="fas fa-file-pdf fa-2x mb-2"></i><br>PDF
                                    </label>
                                </div>
                                <div class="w-50" style="display: none;"></div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold text-muted small text-uppercase">Resumen de filtros aplicados</label>
                            <div class="p-3 rounded border bg-light">
                                <div class="small text-muted mb-1">Periodo</div>
                                <div id="reportResumenPeriodo" class="fw-semibold mb-2">-</div>
                                <div class="small text-muted mb-1">Agrupacion</div>
                                <div id="reportResumenAgrupacion" class="fw-semibold mb-2">-</div>
                                <div class="small text-muted mb-1">Tipos</div>
                                <div id="reportResumenTipos" class="fw-semibold mb-2">-</div>
                                <div class="small text-muted mb-1">Modalidades</div>
                                <div id="reportResumenModalidades" class="fw-semibold">-</div>
                            </div>
                        </div>

                         <div class="d-grid mt-4">
                            <button type="submit" class="btn btn-primary btn-lg btn-reporte-unificado" style="width: 100%; padding: 0.5rem 1rem;">
                                <i class="fas fa-download me-2"></i>Descargar Reporte
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            initGlobalCharts();
            loadOfertaCharts();
            loadInscripcionCharts();
            loadEconomicoCharts();
            loadTemporalInscripciones();
            
            // Modal Logic
            const modal = document.getElementById('statsReportModal');
            const openBtn = document.getElementById('btnOpenReportModal');
            const closeBtns = document.querySelectorAll('.close-modal-trigger');
            
            if(openBtn) {
                openBtn.onclick = () => {
                    hydrateReportFiltersFromApplied();
                    modal.style.display = 'block';
                    modal.classList.add('show');
                };
            }
            
            closeBtns.forEach(btn => {
                btn.onclick = () => modal.style.display = 'none';
            });
            
            window.onclick = (e) => {
                if(e.target == modal) modal.style.display = 'none';
            };

            document.getElementById('btnRefreshCharts').onclick = () => window.location.reload();
            const btnAplicar = document.getElementById('btnAplicarTemporal');
            if (btnAplicar) btnAplicar.onclick = () => loadTemporalInscripciones(true);
            document.querySelectorAll('.time-range-pill').forEach(btn => {
                btn.addEventListener('click', () => {
                    const days = Number(btn.dataset.days || 30);
                    const end = new Date();
                    const start = new Date();
                    start.setDate(end.getDate() - days);
                    const toIso = d => d.toISOString().slice(0, 10);
                    const iniInput = document.getElementById('fltFechaInicio');
                    const finInput = document.getElementById('fltFechaFin');
                    if (iniInput) iniInput.value = toIso(start);
                    if (finInput) finInput.value = toIso(end);
                    syncTimeRangePills(btn);
                });
            });
            const iniInput = document.getElementById('fltFechaInicio');
            const finInput = document.getElementById('fltFechaFin');
            if (iniInput) iniInput.addEventListener('change', () => syncTimeRangePills());
            if (finInput) finInput.addEventListener('change', () => syncTimeRangePills());
            syncTimeRangePills();

            const reportForm = document.getElementById('statsReportForm');
            if (reportForm) {
                reportForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    hydrateReportFiltersFromApplied();
                    const rPeriodo = document.getElementById('reportResumenPeriodo')?.innerText || '-';
                    const rTipos = document.getElementById('reportResumenTipos')?.innerText || '-';
                    const rModalidades = document.getElementById('reportResumenModalidades')?.innerText || '-';
                    openReportConfirm(rPeriodo, rTipos, rModalidades, () => reportForm.submit());
                });
            }
        });

        Chart.register(ChartDataLabels);

        const colors = {
            palette: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40']
        };

        const formatEntero = (value) => {
            if (value === null || value === undefined || value === '') return '';
            const numero = Number(value);
            if (!Number.isFinite(numero)) return value;
            return Math.round(numero).toLocaleString('es-AR');
        };

        const formatMoneda = (value) => {
            if (value === null || value === undefined || value === '') return '';
            const numero = Number(value);
            if (!Number.isFinite(numero)) return value;
            return numero.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };

        const dataLabelCommon = {
            color: '#ffffff',
            backgroundColor: 'rgba(15, 23, 42, 0.85)',
            borderRadius: 6,
            padding: { top: 4, right: 6, bottom: 4, left: 6 },
            font: { weight: '700', size: 13 },
            formatter: formatEntero
        };

        function initGlobalCharts() {
            // Placeholder for global summary charts if any
        }
        
        let charts = {};
        let lastAppliedTemporalFilters = null;

        function destroyChart(id) {
            if (charts[id]) {
                charts[id].destroy();
                delete charts[id];
            }
        }

        function loadOfertaCharts() {
            fetch('/admin/estadisticas/api/ofertas-detalladas')
            .then(r => r.json())
            .then(data => {
                // Estado
                const porEstado = data.porEstado || {};
                destroyChart('chartOfertasEstado');
                charts['chartOfertasEstado'] = new Chart(document.getElementById('chartOfertasEstado'), {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(porEstado),
                        datasets: [{
                            data: Object.values(porEstado),
                            backgroundColor: colors.palette
                        }]
                    },
                    options: {
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: (context) => `${context.label}: ${formatEntero(context.raw)}`
                                }
                            },
                            datalabels: {
                                ...dataLabelCommon,
                                color: '#ffffff'
                            }
                        }
                    }
                });
                
                // Tipo (using same endpoint structure if added)
                 const porTipo = data.porTipo || {}; // Assuming we added it back to the map in service
                 // Fetch simple offers graph as fallback
                 fetch('/admin/estadisticas/api/grafico-ofertas')
                    .then(r => r.json())
                    .then(d => {
                        destroyChart('chartOfertasTipo');
                         charts['chartOfertasTipo'] = new Chart(document.getElementById('chartOfertasTipo'), {
                            type: 'bar',
                            data: {
                                labels: d.labels,
                                datasets: [{
                                    label: 'Cantidad',
                                    data: d.data,
                                    backgroundColor: '#667eea'
                                }]
                            },
                            options: {
                                plugins: {
                                    tooltip: {
                                        callbacks: {
                                            label: (context) => `${context.dataset.label}: ${formatEntero(context.raw)}`
                                        }
                                    },
                                    datalabels: {
                                        ...dataLabelCommon,
                                        anchor: 'end',
                                        align: 'top'
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: { stepSize: 1, callback: (value) => formatEntero(value) }
                                    }
                                }
                            }
                        });
                    });
            });
        }

   function last12MonthsLabels() {
    const labels = [];
    const now = new Date();
    for (let i = 11; i >= 0; i--) {
        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
        labels.push(d.toISOString().slice(0,7)); // yyyy-MM
    }
    return labels;
}
function showStatsError(msg) {
    const container = document.querySelector('#inscripciones-section .metric-card .card-body');
    if (!container || container.querySelector('.stats-error')) return;
    const alert = document.createElement('div');
    alert.className = 'alert alert-warning stats-error';
    alert.style.marginTop = '0.5rem';
    alert.textContent = msg;
    container.prepend(alert);
}
function loadInscripcionCharts() {
            fetch('/admin/estadisticas/api/inscripciones-detalladas')
            .then(r => {
                if (!r.ok) throw new Error('HTTP status ' + r.status);
                const ct = r.headers.get('content-type') || '';
                if (!ct.includes('application/json')) throw new Error('Unexpected content-type: ' + ct);
                return r.json();
            })
            .then(data => {
                console.log('Datos recibidos:', data);
                const evol = data && data.evolucionMensual ? data.evolucionMensual : {};
                
                let labels = Object.keys(evol);
                let values = labels.map(k => evol[k]);

                if (labels.length === 0) {
                    showStatsError('No hay datos de inscripciones disponibles.');
                    labels = last12MonthsLabels();
                    values = labels.map(() => 0);
                }

                const labelsFormateados = formatTemporalLabels(labels, 'mes');

                destroyChart('chartInscripcionesEvol');
                
                const ctx = document.getElementById('chartInscripcionesEvol');
                if (!ctx) {
                     console.error('Canvas chartInscripcionesEvol no encontrado');
                     return;
                }

                charts['chartInscripcionesEvol'] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labelsFormateados,
                        datasets: [{
                            label: 'Inscripciones Mensuales',
                            data: values,
                            borderColor: '#38ef7d',
                            backgroundColor: 'rgba(56, 239, 125, 0.15)',
                            borderWidth: 2,
                            pointRadius: 4,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#38ef7d',
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'top' },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: (context) => `${context.dataset.label}: ${formatEntero(context.raw)}`
                                }
                            },
                            datalabels: {
                                ...dataLabelCommon,
                                anchor: 'end',
                                align: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 1, callback: (value) => formatEntero(value) }
                            }
                        }
                    }
                });
            })
            .catch(err => {
                console.error('Error cargando inscripciones:', err);
                showStatsError('Error visualizando grafico.');
            });
        }

        function loadEconomicoCharts() {
            console.log('Cargando charts económicos...');
            fetch('/admin/estadisticas/api/economia-detallada')
            .then(r => {
                if (!r.ok) throw new Error('HTTP ' + r.status);
                const ct = r.headers.get('content-type');
                if (!ct || !ct.includes('application/json')) throw new Error('Respuesta no es JSON');
                return r.json();
            })
            .then(data => {
                console.log('Datos económicos:', data);
                
                // 1. Ingresos por Oferta
                const ing = data.ingresosPorOferta || {};
                const labelsIng = Object.keys(ing);
                const valuesIng = Object.values(ing);
                
                destroyChart('chartIngresosOferta');
                const ctxIng = document.getElementById('chartIngresosOferta');
                if (ctxIng) {
                    charts['chartIngresosOferta'] = new Chart(ctxIng, {
                        type: 'bar',
                        data: {
                            labels: labelsIng.length ? labelsIng : ['Sin datos'],
                            datasets: [{
                                label: 'Ingresos ($)',
                                data: valuesIng.length ? valuesIng : [0],
                                backgroundColor: '#f38181',
                                borderRadius: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { 
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: (context) => `${context.dataset.label}: ${formatMoneda(context.raw)}`
                                    }
                                },
                                datalabels: {
                                    ...dataLabelCommon,
                                    formatter: formatMoneda,
                                    anchor: 'end',
                                    align: 'top'
                                }
                            },
                            scales: { 
                                y: { 
                                    beginAtZero: true,
                                    ticks: { callback: (value) => formatMoneda(value) }
                                } 
                            }
                        }
                    });
                }

                // 2. Estado de Pagos
                const estado = data.estadoPagos || {};
                const labelsEst = Object.keys(estado);
                const valuesEst = Object.values(estado);
                
                destroyChart('chartEstadoPagos');
                const ctxEst = document.getElementById('chartEstadoPagos');
                if (ctxEst) {
                    charts['chartEstadoPagos'] = new Chart(ctxEst, {
                        type: 'doughnut',
                        data: {
                            labels: labelsEst.length ? labelsEst : ['Sin datos'],
                            datasets: [{
                                data: valuesEst.length ? valuesEst : [0],
                                backgroundColor: ['#fce38a', '#11998e', '#ff5e62', '#e2e8f0']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { 
                                legend: { position: 'right' },
                                tooltip: {
                                    callbacks: {
                                        label: (context) => `${context.label}: ${formatEntero(context.raw)}`
                                    }
                                },
                                datalabels: {
                                    ...dataLabelCommon,
                                    color: '#ffffff'
                                }
                            }
                        }
                    });
                }
            })
            .catch(e => console.error('Error economía:', e));
        }
    
        function getSelectedModalidades() {
            const checked = Array.from(document.querySelectorAll('.fltModalidadCheck:checked'));
            return checked.map(i => i.value);
        }

        function getSelectedTipos() {
            const checked = Array.from(document.querySelectorAll('.fltTipoCheck:checked'));
            return checked.map(i => i.value);
        }

        function loadTemporalInscripciones(showToast = false) {
            const fechaInicio = document.getElementById('fltFechaInicio')?.value || '';
            const fechaFin = document.getElementById('fltFechaFin')?.value || '';
            const agrupacion = document.getElementById('fltAgrupacion')?.value || 'dia';
            const tipos = getSelectedTipos();
            const modalidades = getSelectedModalidades();

            const qs = new URLSearchParams();
            if (fechaInicio) qs.append('fechaInicio', fechaInicio);
            if (fechaFin) qs.append('fechaFin', fechaFin);
            if (agrupacion) qs.append('agrupacion', agrupacion);
            tipos.forEach(t => qs.append('tiposOferta', t));
            modalidades.forEach(m => qs.append('modalidades', m));

            fetch('/admin/estadisticas/api/inscripciones-temporal?' + qs.toString())
                .then(r => r.json())
                .then(data => {
                    const resumen = data.resumen || {};
                    document.getElementById('sumTotalInscripciones').innerText = formatEntero(resumen.totalInscripciones || 0);
                    const picoFechaFormateada = resumen.picoFecha
                        ? (formatTemporalLabels([resumen.picoFecha], 'dia')[0] || resumen.picoFecha)
                        : null;
                    document.getElementById('sumPico').innerText = picoFechaFormateada ? `${picoFechaFormateada} (${formatEntero(resumen.picoCantidad || 0)})` : '-';
                    const pct = Number(resumen.variacionPeriodoPct || 0);
                    document.getElementById('sumComparativa').innerText = `${pct >= 0 ? '+' : ''}${pct.toFixed(1)}%`;
                    document.getElementById('sumUltima').innerText = resumen.ultimaInscripcion || 'sin registros';

                    renderTemporalLine(data.lineasModalidad || {});
                    renderTemporalStacked(data.barrasTipoModalidad || {});
                    lastAppliedTemporalFilters = {
                        fechaInicio,
                        fechaFin,
                        agrupacion,
                        tipos: [...tipos],
                        modalidades: [...modalidades]
                    };
                    if (showToast) {
                        showFilterToast(resumen.totalInscripciones || 0, resumen.periodo || '');
                    }
                })
                .catch(err => console.error('Error temporal inscripciones:', err));
        }

        function showFilterToast(total, periodo) {
            const toast = document.getElementById('filterToast');
            const msg = document.getElementById('filterToastMsg');
            if (!toast || !msg) return;
            msg.innerText = `Resultados actualizados: ${formatEntero(total)} inscripciones (${periodo || 'periodo seleccionado'})`;
            toast.classList.add('show');
            window.clearTimeout(window.__filterToastTimer);
            window.__filterToastTimer = window.setTimeout(() => {
                toast.classList.remove('show');
            }, 2600);
        }

        function openReportConfirm(periodo, tipos, modalidades, onConfirm) {
            if (typeof ModalConfirmacion === 'undefined' || typeof ModalConfirmacion.show !== 'function') {
                if (typeof onConfirm === 'function') onConfirm();
                return;
            }
            const detalle = [
                `Periodo: ${periodo || '-'}`,
                `Tipos: ${tipos || '-'}`,
                `Modalidades: ${modalidades || '-'}`
            ].join('\n');
            ModalConfirmacion.show('Confirmar descarga de reporte', detalle, onConfirm, {
                type: 'confirm',
                confirmText: 'Descargar',
                cancelText: 'Cancelar',
                showCancel: true
            });
        }

        function hydrateReportFiltersFromApplied() {
            const base = lastAppliedTemporalFilters || {
                fechaInicio: document.getElementById('fltFechaInicio')?.value || '',
                fechaFin: document.getElementById('fltFechaFin')?.value || '',
                agrupacion: document.getElementById('fltAgrupacion')?.value || 'dia',
                tipos: getSelectedTipos(),
                modalidades: getSelectedModalidades()
            };

            const reportFechaInicio = document.getElementById('reportFechaInicio');
            const reportFechaFin = document.getElementById('reportFechaFin');
            const reportAgrupacion = document.getElementById('reportAgrupacion');
            if (reportFechaInicio) reportFechaInicio.value = base.fechaInicio || '';
            if (reportFechaFin) reportFechaFin.value = base.fechaFin || '';
            if (reportAgrupacion) reportAgrupacion.value = base.agrupacion || 'dia';

            const tiposContainer = document.getElementById('reportTiposContainer');
            if (tiposContainer) {
                tiposContainer.innerHTML = '';
                (base.tipos || []).forEach(t => {
                    const i = document.createElement('input');
                    i.type = 'hidden';
                    i.name = 'tipos';
                    i.value = t;
                    tiposContainer.appendChild(i);
                });
            }

            const modalidadesContainer = document.getElementById('reportModalidadesContainer');
            if (modalidadesContainer) {
                modalidadesContainer.innerHTML = '';
                (base.modalidades || []).forEach(m => {
                    const i = document.createElement('input');
                    i.type = 'hidden';
                    i.name = 'modalidades';
                    i.value = m;
                    modalidadesContainer.appendChild(i);
                });
            }

            const periodo = (base.fechaInicio && base.fechaFin)
                ? `${formatTemporalLabels([base.fechaInicio], 'dia')[0]} al ${formatTemporalLabels([base.fechaFin], 'dia')[0]}`
                : (base.fechaInicio || base.fechaFin || 'Sin periodo');
            const agrupacion = (base.agrupacion || 'dia').toUpperCase();
            const tipos = (base.tipos && base.tipos.length) ? base.tipos.join(', ') : 'Todos';
            const modalidades = (base.modalidades && base.modalidades.length) ? base.modalidades.join(', ') : 'Todas';

            const repPeriodo = document.getElementById('reportResumenPeriodo');
            const repAgrupacion = document.getElementById('reportResumenAgrupacion');
            const repTipos = document.getElementById('reportResumenTipos');
            const repModalidades = document.getElementById('reportResumenModalidades');
            if (repPeriodo) repPeriodo.innerText = periodo;
            if (repAgrupacion) repAgrupacion.innerText = agrupacion;
            if (repTipos) repTipos.innerText = tipos;
            if (repModalidades) repModalidades.innerText = modalidades;
        }

        function syncTimeRangePills(forceActiveBtn = null) {
            const pills = Array.from(document.querySelectorAll('.time-range-pill'));
            pills.forEach(p => p.classList.remove('active'));
            if (forceActiveBtn) {
                forceActiveBtn.classList.add('active');
                return;
            }

            const ini = document.getElementById('fltFechaInicio')?.value;
            const fin = document.getElementById('fltFechaFin')?.value;
            if (!ini || !fin) return;

            const dIni = new Date(ini + 'T00:00:00');
            const dFin = new Date(fin + 'T00:00:00');
            if (Number.isNaN(dIni.getTime()) || Number.isNaN(dFin.getTime())) return;
            const diffDays = Math.round((dFin - dIni) / 86400000);

            const match = pills.find(p => Number(p.dataset.days || 0) === diffDays);
            if (match) match.classList.add('active');
        }

        function formatDateDMY(dateObj) {
            const dd = `${dateObj.getDate()}`.padStart(2, '0');
            const mm = `${dateObj.getMonth() + 1}`.padStart(2, '0');
            const yyyy = dateObj.getFullYear();
            return `${dd}/${mm}/${yyyy}`;
        }

        function formatTemporalLabels(labels, agrupacion) {
            return (labels || []).map(raw => {
                if (!raw) return raw;

                // dia: yyyy-MM-dd -> dd/MM/yyyy
                if (agrupacion === 'dia' && /^\d{4}-\d{2}-\d{2}$/.test(raw)) {
                    const d = new Date(`${raw}T00:00:00`);
                    if (!Number.isNaN(d.getTime())) return formatDateDMY(d);
                }

                // mes: yyyy-MM -> 01/MM/yyyy (inicio de mes)
                if (agrupacion === 'mes' && /^\d{4}-\d{2}$/.test(raw)) {
                    const d = new Date(`${raw}-01T00:00:00`);
                    if (!Number.isNaN(d.getTime())) return formatDateDMY(d);
                }

                // semana: yyyy-Www -> fecha inicio de semana (lunes)
                if (agrupacion === 'semana' && /^\d{4}-W\d{2}$/.test(raw)) {
                    const [yearStr, weekStr] = raw.split('-W');
                    const year = Number(yearStr);
                    const week = Number(weekStr);
                    if (Number.isFinite(year) && Number.isFinite(week)) {
                        const jan4 = new Date(year, 0, 4);
                        const jan4Day = jan4.getDay() || 7; // 1=lunes ... 7=domingo
                        const mondayWeek1 = new Date(jan4);
                        mondayWeek1.setDate(jan4.getDate() - (jan4Day - 1));
                        const monday = new Date(mondayWeek1);
                        monday.setDate(mondayWeek1.getDate() + (week - 1) * 7);
                        return formatDateDMY(monday);
                    }
                }

                return raw;
            });
        }

        function renderTemporalLine(payload) {
            const agrupacion = document.getElementById('fltAgrupacion')?.value || 'dia';
            const labels = formatTemporalLabels(payload.labels || [], agrupacion);
            const virtual = payload.virtual || [];
            const presencial = payload.presencial || [];
            const hibrida = payload.hibrida || [];

            destroyChart('chartTemporalModalidad');
            charts['chartTemporalModalidad'] = new Chart(document.getElementById('chartTemporalModalidad'), {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        { label: 'Virtual', data: virtual, borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.12)', tension: 0.2, fill: true, borderWidth: 3, pointRadius: 4, pointHoverRadius: 6 },
                        { label: 'Presencial', data: presencial, borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.12)', tension: 0.2, fill: true, borderWidth: 3, pointRadius: 4, pointHoverRadius: 6 },
                        { label: 'Hibrida', data: hibrida, borderColor: '#f59e0b', backgroundColor: 'rgba(245,158,11,0.12)', tension: 0.2, fill: true, borderWidth: 3, pointRadius: 4, pointHoverRadius: 6 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        datalabels: {
                            color: '#111827',
                            backgroundColor: 'rgba(255,255,255,0.98)',
                            borderColor: 'rgba(148,163,184,0.35)',
                            borderWidth: 1,
                            borderRadius: 8,
                            padding: { top: 3, right: 7, bottom: 3, left: 7 },
                            font: { weight: '800', size: 12 },
                            align: 'top',
                            anchor: 'end',
                            formatter: (v) => v > 0 ? formatEntero(v) : ''
                        }
                    },
                    scales: {
                        x: { ticks: { maxRotation: 0, autoSkip: true } },
                        y: {
                            beginAtZero: true,
                            ticks: { precision: 0, callback: (v) => formatEntero(v) },
                            grid: { color: 'rgba(148,163,184,0.25)' }
                        }
                    }
                }
            });
        }

        function renderTemporalStacked(payload) {
            const labels = payload.labels || [];
            const virtual = payload.virtual || [];
            const presencial = payload.presencial || [];
            const hibrida = payload.hibrida || [];

            destroyChart('chartTemporalTipoModalidad');
            charts['chartTemporalTipoModalidad'] = new Chart(document.getElementById('chartTemporalTipoModalidad'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        { label: 'Virtual', data: virtual, backgroundColor: '#3b82f6' },
                        { label: 'Presencial', data: presencial, backgroundColor: '#10b981' },
                        { label: 'Hibrida', data: hibrida, backgroundColor: '#f59e0b' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        datalabels: {
                            color: '#ffffff',
                            backgroundColor: 'rgba(15,23,42,0.85)',
                            borderRadius: 7,
                            padding: { top: 3, right: 7, bottom: 3, left: 7 },
                            font: { weight: '900', size: 12 },
                            formatter: (v) => v > 0 ? formatEntero(v) : '',
                            anchor: 'center',
                            align: 'center',
                            clamp: true
                        }
                    },
                    scales: {
                        x: { stacked: true, ticks: { autoSkip: false } },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: { precision: 0, callback: (v) => formatEntero(v) },
                            grid: { color: 'rgba(148,163,184,0.25)' }
                        }
                    }
                }
            });
        }
    </script>
</div>
</body>
</html>

