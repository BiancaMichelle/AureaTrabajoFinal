<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/adminBase :: layout(~{::title}, ~{::content})}"
      lang="es">
<head>
    <title>Estadísticas Académicas - Panel de Administración</title>
</head>
<body>
<div th:fragment="content" class="main-content">
    <!-- Contenido principal del dashboard -->
    <div class="container-fluid py-4">
        <!-- Header del Dashboard -->
        <div class="dashboard-header">
            <h1><i class="fas fa-chart-line"></i> Dashboard de Estadísticas</h1>
            <p class="mb-0">Análisis y métricas del sistema educativo</p>
        </div>
        
        <!-- Alertas y notificaciones -->
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle"></i> <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        
        <!-- Cards de métricas principales -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stats-card h-100 text-center">
                    <div class="card-body">
                        <i class="fas fa-users fa-3x mb-3"></i>
                        <h3 class="card-title" th:text="${metricas != null ? (metricas['totalUsuarios'] != null ? metricas['totalUsuarios'] : 0) : 0}">0</h3>
                        <p class="card-text">Total Usuarios</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stats-card h-100 text-center">
                    <div class="card-body">
                        <i class="fas fa-graduation-cap fa-3x mb-3"></i>
                        <h3 class="card-title" th:text="${metricas != null ? (metricas['totalOfertas'] != null ? metricas['totalOfertas'] : 0) : 0}">0</h3>
                        <p class="card-text">Ofertas Académicas</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stats-card h-100 text-center">
                    <div class="card-body">
                        <i class="fas fa-user-check fa-3x mb-3"></i>
                        <h3 class="card-title" th:text="${metricas != null ? (metricas['totalInscripciones'] != null ? metricas['totalInscripciones'] : 0) : 0}">0</h3>
                        <p class="card-text">Total Inscripciones</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stats-card h-100 text-center">
                    <div class="card-body">
                        <i class="fas fa-dollar-sign fa-3x mb-3"></i>
                        <h3 class="card-title" th:text="${metricas != null ? (metricas['ingresosTotales'] != null ? metricas['ingresosTotales'] : '0.00') : '0.00'}">0.00</h3>
                        <p class="card-text">Ingresos Totales</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Gráficos de estadísticas -->
        <div class="row mb-4">
            <div class="col-xl-6 col-lg-12 mb-4">
                <div class="card metric-card h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Ofertas por Tipo</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="chartOfertas"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-6 col-lg-12 mb-4">
                <div class="card metric-card h-100">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-users-cog"></i> Usuarios por Rol</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="chartUsuarios"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Análisis de demanda -->
        <div class="row mb-4" th:if="${demandaOfertas != null and !#lists.isEmpty(demandaOfertas)}">
            <div class="col-12">
                <div class="card metric-card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="fas fa-search"></i> Análisis de Demanda de Ofertas</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive" style="max-height: 350px;">
                            <table class="table table-striped table-hover mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Oferta</th>
                                        <th>Inscritos</th>
                                        <th>Nivel de Demanda</th>
                                        <th>Tasa Ocupación</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="oferta : ${demandaOfertas}">
                                        <td th:text="${oferta.tituloOferta}"></td>
                                        <td th:text="${oferta.cantidadInscritos}"></td>
                                        <td>
                                            <span class="badge"
                                                  th:classappend="${oferta.nivelDemanda == 'ALTA' ? 'bg-success' : 
                                                                   oferta.nivelDemanda == 'MEDIA' ? 'bg-warning' : 'bg-danger'}"
                                                  th:text="${oferta.nivelDemanda}">
                                            </span>
                                        </td>
                                        <td>
                                            <span th:text="${oferta.tasaOcupacion != null ? #numbers.formatPercent(oferta.tasaOcupacion, 1, 1) : '0%'}"></span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Análisis de deserción -->
        <div class="row mb-4" th:if="${analisisDesercion != null}">
            <div class="col-lg-6 mb-4">
                <div class="card metric-card h-100">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0"><i class="fas fa-user-times"></i> Análisis de Deserción</h5>
                    </div>
                    <div class="card-body analysis-card">
                        <h2 class="display-4 text-danger" th:text="${analisisDesercion.tasaDesercion != null ? #numbers.formatPercent(analisisDesercion.tasaDesercion, 1, 1) : '0%'}">0%</h2>
                        <p class="text-muted">Tasa de Deserción</p>
                        <div class="metrics-row">
                            <div class="row">
                                <div class="col-4">
                                    <strong th:text="${analisisDesercion != null ? (analisisDesercion.estudiantesActivos != null ? analisisDesercion.estudiantesActivos : 0) : 0}">0</strong>
                                    <small>Activos</small>
                                </div>
                                <div class="col-4">
                                    <strong th:text="${analisisDesercion != null ? (analisisDesercion.estudiantesInactivos != null ? analisisDesercion.estudiantesInactivos : 0) : 0}">0</strong>
                                    <small>Inactivos</small>
                                </div>
                                <div class="col-4">
                                    <strong th:text="${analisisDesercion != null ? (analisisDesercion.totalEstudiantes != null ? analisisDesercion.totalEstudiantes : 0) : 0}">0</strong>
                                    <small>Total</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="card metric-card h-100">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0"><i class="fas fa-chart-area"></i> Proyección de Crecimiento</h5>
                    </div>
                    <div class="card-body analysis-card" th:if="${proyeccionCrecimiento != null}">
                        <h3 class="text-primary">
                            <span th:text="${proyeccionCrecimiento['tasaCrecimiento'] != null ? proyeccionCrecimiento['tasaCrecimiento'] : 0}">0</span>%
                        </h3>
                        <p class="text-muted">Tasa de Crecimiento Mensual</p>
                        <div class="metrics-row">
                            <div class="row">
                                <div class="col-6">
                                    <strong th:text="${proyeccionCrecimiento != null ? (proyeccionCrecimiento['proyeccionProximoMes'] != null ? proyeccionCrecimiento['proyeccionProximoMes'] : 0) : 0}">0</strong>
                                    <small>Próximo Mes</small>
                                </div>
                                <div class="col-6">
                                    <strong th:text="${proyeccionCrecimiento != null ? (proyeccionCrecimiento['proyeccionTrimestre'] != null ? proyeccionCrecimiento['proyeccionTrimestre'] : 0) : 0}">0</strong>
                                    <small>Trimestre</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Botones de acciones -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card metric-card">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0"><i class="fas fa-cogs"></i> Acciones del Sistema</h5>
                    </div>
                    <div class="card-body text-center">
                        <div class="d-flex flex-wrap justify-content-center gap-3">
                            <button id="btnAccionesAutomaticas" class="btn btn-primary btn-lg">
                                <i class="fas fa-robot"></i> Ejecutar Acciones Automáticas
                            </button>
                            <button id="btnGenerarReporte" class="btn btn-success btn-lg">
                                <i class="fas fa-file-alt"></i> Generar Reporte
                            </button>
                            <button id="btnRefreshCharts" class="btn btn-info btn-lg">
                                <i class="fas fa-sync-alt"></i> Actualizar Datos
                            </button>
                        </div>
                        
                        <!-- Spinner de carga -->
                        <div id="loadingSpinner" class="mt-3" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="mt-2 text-muted">Procesando...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <!-- Chart.js para gráficos de estadísticas -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Variables globales
        let chartOfertas, chartUsuarios;
        
        // Colores para los gráficos
        const colors = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
            '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
        ];
        
        // Inicializar dashboard al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            setupEventListeners();
        });
        
        // Configurar event listeners
        function setupEventListeners() {
            const btnRefresh = document.getElementById('btnRefreshCharts');
            const btnAcciones = document.getElementById('btnAccionesAutomaticas');
            const btnReporte = document.getElementById('btnGenerarReporte');
            
            if (btnRefresh) btnRefresh.addEventListener('click', refreshAllCharts);
            if (btnAcciones) btnAcciones.addEventListener('click', ejecutarAccionesAutomaticas);
            if (btnReporte) btnReporte.addEventListener('click', generarReporte);
        }
        
        // Inicializar todos los gráficos
        function initializeCharts() {
            initChartOfertas();
            initChartUsuarios();
        }
        
        // Gráfico de ofertas por tipo
        function initChartOfertas() {
            fetch('/admin/estadisticas/api/grafico-ofertas')
                .then(response => response.json())
                .then(data => {
                    const ctx = document.getElementById('chartOfertas').getContext('2d');
                    chartOfertas = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: data.labels || ['Sin datos'],
                            datasets: [{
                                data: data.data || [1],
                                backgroundColor: colors,
                                borderWidth: 2,
                                borderColor: '#fff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                })
                .catch(error => {
                    console.error('Error cargando gráfico de ofertas:', error);
                    // Mostrar gráfico con datos vacíos
                    const ctx = document.getElementById('chartOfertas').getContext('2d');
                    chartOfertas = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Sin datos'],
                            datasets: [{
                                data: [1],
                                backgroundColor: ['#cccccc']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false
                        }
                    });
                });
        }
        
        // Gráfico de usuarios por rol
        function initChartUsuarios() {
            fetch('/admin/estadisticas/api/grafico-usuarios')
                .then(response => response.json())
                .then(data => {
                    const ctx = document.getElementById('chartUsuarios').getContext('2d');
                    chartUsuarios = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: data.labels || ['Sin datos'],
                            datasets: [{
                                label: 'Cantidad de Usuarios',
                                data: data.data || [0],
                                backgroundColor: colors,
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    }
                                }
                            }
                        }
                    });
                })
                .catch(error => {
                    console.error('Error cargando gráfico de usuarios:', error);
                    // Mostrar gráfico con datos vacíos
                    const ctx = document.getElementById('chartUsuarios').getContext('2d');
                    chartUsuarios = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['Sin datos'],
                            datasets: [{
                                data: [0],
                                backgroundColor: ['#cccccc']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false
                        }
                    });
                });
        }
        
        // Actualizar todos los gráficos
        function refreshAllCharts() {
            showLoading();
            window.location.reload(); // Recarga la página para obtener datos frescos
        }
        
        // Ejecutar acciones automáticas
        function ejecutarAccionesAutomaticas() {
            if (!confirm('¿Estás seguro de ejecutar las acciones automáticas? Esto puede modificar el estado de las ofertas.')) {
                return;
            }
            
            showLoading();
            fetch('/admin/estadisticas/api/acciones-automaticas', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.success) {
                    alert(`Acciones ejecutadas exitosamente: ${data.totalAcciones} acciones realizadas`);
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    alert(data.error || 'Error ejecutando acciones');
                }
            })
            .catch(error => {
                hideLoading();
                alert('Error de conexión al ejecutar acciones automáticas');
                console.error('Error:', error);
            });
        }
        
        // Generar reporte
        function generarReporte() {
            showLoading();
            fetch('/admin/estadisticas/api/generar-reporte?tipoReporte=general')
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    alert('Reporte generado exitosamente');
                })
                .catch(error => {
                    hideLoading();
                    alert('Error generando reporte');
                    console.error('Error:', error);
                });
        }
        
        // Mostrar loading
        function showLoading() {
            const spinner = document.getElementById('loadingSpinner');
            if (spinner) spinner.style.display = 'block';
        }
        
        // Ocultar loading
        function hideLoading() {
            const spinner = document.getElementById('loadingSpinner');
            if (spinner) spinner.style.display = 'none';
        }
    </script>
</div>
</body>
</html>