<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/adminBase :: layout(~{::title}, ~{::content})}" lang="es">
<head>
    <title>Estadísticas Académicas - Aurea</title>
</head>
<body>
<div th:fragment="content" class="main-content">
    
    <style>
        /* Modern Dashboard Styles */
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --warning-gradient: linear-gradient(135deg, #fce38a 0%, #f38181 100%);
            --danger-gradient: linear-gradient(135deg, #ff9966 0%, #ff5e62 100%);
            --card-shadow: 0 4px 6px rgba(50, 50, 93, 0.11), 0 1px 3px rgba(0, 0, 0, 0.08);
            --hover-shadow: 0 7px 14px rgba(50, 50, 93, 0.1), 0 3px 6px rgba(0, 0, 0, 0.08);
        }

        .dashboard-header {
            background: white;
            padding: 1.5rem 2rem;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dashboard-header h1 {
            font-size: 1.8rem;
            color: #2d3748;
            margin: 0;
            font-weight: 700;
        }

        .dashboard-header p {
            color: #718096;
            margin-top: 0.5rem;
        }

        /* Stats Cards */
        .stats-card {
            border: none;
            border-radius: 12px;
            transition: all 0.3s ease;
            overflow: hidden;
            box-shadow: var(--card-shadow);
            color: white;
        }

        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--hover-shadow);
        }

        .stats-card .card-body {
            padding: 1.5rem;
            position: relative;
            z-index: 1;
        }

        .stats-card .icon-bg {
            position: absolute;
            right: -10px;
            bottom: -10px;
            font-size: 5rem;
            opacity: 0.1;
            transform: rotate(-15deg);
            z-index: 0;
            color: white;
        }

        .bg-gradient-primary { background: var(--primary-gradient); }
        .bg-gradient-success { background: var(--success-gradient); }
        .bg-gradient-info { background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%); }
        .bg-gradient-warning { background: var(--warning-gradient); }

        .stats-value {
            font-size: 2.2rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            display: block;
        }

        .stats-label {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.9;
        }

        /* Chart Cards */
        .metric-card {
            background: white;
            border: none;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
            height: 100%;
        }

        .metric-card .card-header {
            background: transparent;
            border-bottom: 1px solid #e2e8f0;
            padding: 1.2rem 1.5rem;
            font-weight: 600;
            color: #2d3748;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            padding: 1rem;
        }

        /* Tabs Styling */
        .nav-tabs {
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 1.5rem;
        }
        
        .nav-tabs .nav-link {
            border: none;
            color: #718096;
            font-weight: 600;
            padding: 1rem 1.5rem;
            transition: all 0.2s;
        }
        
        .nav-tabs .nav-link:hover {
            color: #4a5568;
            border: none; 
            border-bottom: 2px solid #cbd5e0;
        }
        
        .nav-tabs .nav-link.active {
            color: #667eea;
            border: none;
            border-bottom: 2px solid #667eea;
            background: transparent;
        }

        /* Table Styling */
        .custom-table thead th {
            background-color: #f8fafc;
            color: #4a5568;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            border-top: none;
        }
        
        .custom-table tbody td {
            vertical-align: middle;
            color: #2d3748;
        }

        .badge-demanda {
            padding: 0.4em 0.8em;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        /* Action Buttons */
        .action-btn {
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }
        
        .btn-generate-report {
            background: var(--success-gradient);
            color: white;
            box-shadow: 0 4px 6px rgba(17, 153, 142, 0.3);
            text-decoration: none;
        }
        
        .btn-generate-report:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(17, 153, 142, 0.4);
            color: white;
        }

        .btn-refresh {
            background: #fff;
            color: #4a5568;
            border: 1px solid #e2e8f0;
        }
        
        .btn-refresh:hover {
            background: #f7fafc;
            color: #2d3748;
        }

        .btn-apply {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 4px 6px rgba(102, 126, 234, 0.25);
        }

        .btn-apply:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(102, 126, 234, 0.35);
            color: white;
        }

        .stats-filter-card {
            margin-bottom: 1.25rem;
        }

        .stats-filter-card .card-header {
            padding: 0.75rem 1rem;
            font-size: 0.95rem;
        }

        .stats-filter-card .card-body {
            padding: 0.75rem 1rem;
        }

        .stats-filter-card .form-control {
            padding: 0.35rem 0.6rem;
            font-size: 0.85rem;
            height: 36px;
        }

        .stats-filter-card label {
            margin-bottom: 0.25rem;
        }

        .stats-filter-card .action-btn {
            padding: 0.55rem 1rem;
            font-size: 0.85rem;
        }

        .stats-filter-actions {
            display: flex;
            gap: 0.6rem;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        /* Report Modal custom styles */
        .modal-report-header {
            background: var(--primary-gradient);
            color: white;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            padding: 1.5rem;
        }
        
        .form-section-label {
            font-size: 0.85rem;
            text-transform: uppercase;
            color: #a0aec0;
            font-weight: 700;
            margin-bottom: 0.5rem;
            display: block;
        }
    </style>

    <!-- Header / Actions -->
    <div class="container-fluid py-4">
        <div class="dashboard-header">
            <div>
                <h1><i class="fas fa-chart-line text-primary me-2"></i>Estadísticas</h1>
                <p class="mb-0">Visión general del rendimiento y métricas clave del sistema</p>
            </div>
            <div class="d-flex gap-3">
                <button id="btnRefreshCharts" class="action-btn btn-refresh">
                    <i class="fas fa-sync-alt"></i> Actualizar
                </button>
                <button id="btnOpenReportModal" class="action-btn btn-generate-report">
                    <i class="fas fa-file-download"></i> Exportar Reportes
                </button>
            </div>
        </div>

        <!-- Filtro de periodo -->
        <div class="metric-card stats-filter-card">
            <div class="card-header">
                <span><i class="fas fa-calendar-alt me-2 text-primary"></i>Filtrar por periodo</span>
                <small class="text-muted">Aplica a gráficos y ratios</small>
            </div>
            <div class="card-body">
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label class="small text-muted">Desde</label>
                        <input type="date" id="statsFechaInicio" class="form-control"
                               th:value="${fechaInicioSeleccionada != null ? #temporals.format(fechaInicioSeleccionada, 'yyyy-MM-dd') : ''}"
                               th:attr="max=${#temporals.format(maxFechaHoy, 'yyyy-MM-dd')}">
                    </div>
                    <div class="col-md-3">
                        <label class="small text-muted">Hasta</label>
                        <input type="date" id="statsFechaFin" class="form-control"
                               th:value="${fechaFinSeleccionada != null ? #temporals.format(fechaFinSeleccionada, 'yyyy-MM-dd') : ''}"
                               th:attr="max=${#temporals.format(maxFechaHoy, 'yyyy-MM-dd')}">
                    </div>
                    <div class="col-md-6 stats-filter-actions">
                        <button id="btnApplyStatsRange" class="action-btn btn-apply">
                            <i class="fas fa-filter"></i> Aplicar
                        </button>
                        <button id="btnClearStatsRange" class="action-btn btn-refresh">
                            <i class="fas fa-undo"></i> Limpiar
                        </button>
                    </div>
                </div>
                <div id="statsRangeAlert" class="alert alert-warning mt-3 d-none" role="alert"></div>
                <div id="statsRangeHint" class="small text-muted mt-2">Mostrando el histórico completo.</div>
            </div>
        </div>
        
        <!-- Alerts -->
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i> <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        
        <!-- KPI Cards Row -->
        <div class="row mb-4 g-4">
            <!-- Usuarios -->
            <div class="col-xl-3 col-md-6">
                <div class="stats-card bg-gradient-info h-100">
                    <div class="card-body">
                        <i class="fas fa-users icon-bg"></i>
                        <span class="stats-value" th:text="${metricas != null ? metricas['totalUsuarios'] : 0}">0</span>
                        <span class="stats-label">Usuarios Registrados</span>
                    </div>
                </div>
            </div>
            <!-- Ofertas -->
            <div class="col-xl-3 col-md-6">
                <div class="stats-card bg-gradient-primary h-100">
                    <div class="card-body">
                        <i class="fas fa-book-open icon-bg"></i>
                        <span class="stats-value" th:text="${metricas != null ? metricas['totalOfertas'] : 0}">0</span>
                        <span class="stats-label">Ofertas Activas</span>
                    </div>
                </div>
            </div>
            <!-- Inscripciones -->
            <div class="col-xl-3 col-md-6">
                <div class="stats-card bg-gradient-success h-100">
                    <div class="card-body">
                        <i class="fas fa-user-graduate icon-bg"></i>
                        <span class="stats-value" th:text="${metricas != null ? metricas['totalInscripciones'] : 0}">0</span>
                        <span class="stats-label">Inscripciones Totales</span>
                    </div>
                </div>
            </div>
            <!-- Ingresos -->
            <div class="col-xl-3 col-md-6">
                <div class="stats-card bg-gradient-warning h-100">
                    <div class="card-body">
                        <i class="fas fa-coins icon-bg"></i>
                        <span class="stats-value" th:text="${metricas != null ? ('$' + metricas['ingresosTotales']) : '$0.00'}">$0.00</span>
                        <span class="stats-label">Ingresos Generados</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-content" id="statsTabsContent">
            
            <!-- TAB: OFERTA ACADÉMICA -->
            <div class="tab-pane fade show active" id="oferta" role="tabpanel">
                <div class="row mb-4">
                    <div class="col-lg-6 mb-4">
                        <div class="metric-card">
                            <div class="card-header">
                                <span>Estado de Ofertas</span>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="chartOfertasEstado"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 mb-4">
                        <div class="metric-card">
                            <div class="card-header">
                                <span>Ofertas por Tipo</span>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="chartOfertasTipo"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                         <div class="metric-card">
                            <div class="card-header">
                                <span><i class="fas fa-fire me-2 text-primary"></i>Demanda y Ocupación</span>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table custom-table table-hover mb-0">
                                        <thead>
                                            <tr>
                                                <th class="ps-4">Oferta Académica</th>
                                                <th class="text-center">Inscritos</th>
                                                <th class="text-center">Tasa Ocupación</th>
                                                <th class="text-center">Demanda</th>
                                            </tr>
                                        </thead>
                                        <tbody id="demandaOfertasBody">
                                            <tr th:if="${demandaOfertas == null or #lists.isEmpty(demandaOfertas)}">
                                                <td colspan="4" class="text-center py-4 text-muted">No hay datos disponibles</td>
                                            </tr>
                                            <tr th:each="oferta : ${demandaOfertas}">
                                                <td class="ps-4 fw-bold" th:text="${oferta['tituloOferta']}">Nombre</td>
                                                <td class="text-center" th:text="${oferta['cantidadInscritos']}">0</td>
                                                <td class="text-center">
                                                    <div class="d-flex align-items-center justify-content-center">
                                                        <div class="progress w-50 me-2" style="height: 6px;">
                                                            <div class="progress-bar" 
                                                                 th:style="'width: ' + ${oferta['tasaOcupacion'] * 100} + '%'"
                                                                 th:classappend="${oferta['tasaOcupacion'] > 0.8 ? 'bg-danger' : (oferta['tasaOcupacion'] > 0.5 ? 'bg-info' : 'bg-success')}">
                                                            </div>
                                                        </div>
                                                        <span class="small" th:text="${#numbers.formatPercent(oferta['tasaOcupacion'], 1, 0)}">0%</span>
                                                    </div>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge" 
                                                        th:classappend="${oferta['nivelDemanda'] == 'ALTA' ? 'bg-success' : 'bg-secondary'}"
                                                        th:text="${oferta['nivelDemanda']}">MEDIA</span>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- INSCRIPCIONES (migrado a Oferta Académica) -->
                <div id="inscripciones-section" class="row mb-4">
                    <div class="col-lg-8">
                        <div class="metric-card">
                            <div class="card-header">
                                <span>Evolución Mensual de Inscripciones</span>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="chartInscripcionesEvol"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                         <div class="metric-card">
                            <div class="card-header">
                                <span>Ratios Clave</span>
                            </div>
                            <div class="card-body">
                                <div class="mb-4 text-center">
                                    <h6 class="text-muted text-uppercase mb-2">Tasa de Abandono</h6>
                                    <h2 id="statsTasaAbandono" class="text-danger fw-bold" th:if="${statsInscripciones != null}" th:text="${#numbers.formatPercent(statsInscripciones['tasaAbandonoGlobal'], 1, 1)}">0%</h2>
                                </div>
                                <hr>
                                <div class="mb-4 text-center">
                                    <h6 class="text-muted text-uppercase mb-2">Nuevos vs Recurrentes</h6>
                                    <div class="d-flex justify-content-center gap-4">
                                        <div>
                                            <span id="statsAlumnosNuevos" class="d-block text-success fw-bold h4" th:if="${statsInscripciones != null}" th:text="${statsInscripciones['alumnosNuevos']}">0</span>
                                            <small class="text-muted">Nuevos</small>
                                        </div>
                                        <div>
                                            <span id="statsAlumnosRecurrentes" class="d-block text-primary fw-bold h4" th:if="${statsInscripciones != null}" th:text="${statsInscripciones['alumnosRecurrentes']}">0</span>
                                            <small class="text-muted">Recurrentes</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ECONÓMICO (migrado a Oferta Académica) -->
                <div id="economico-section" class="row mb-4">
                    <div class="col-lg-6">
                        <div class="metric-card">
                            <div class="card-header">
                                <span>Ingresos por Oferta Académica</span>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="chartIngresosOferta"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                     <div class="col-lg-6">
                        <div class="metric-card">
                            <div class="card-header">
                                <span>Estado de Pagos</span>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="chartEstadoPagos"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div> <!-- End Tab Content -->

    </div>

    <!-- Report Modal -->
    <div id="statsReportModal" class="modal" tabindex="-1" style="display: none; background: rgba(0,0,0,0.5); position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1050;">
        <div class="modal-dialog modal-dialog-centered" style="margin: 1.75rem auto; max-width: 500px;">
            <div class="modal-content shadow-lg border-0" style="background-color: #fff; border-radius: 0.5rem;">
                <div class="modal-header modal-report-header">
                    <h5 class="modal-title fw-bold" style="color: white;"><i class="fas fa-file-invoice me-2"></i>Generar Reporte</h5>
                    <button type="button" class="btn-close btn-close-white close-modal-trigger" style="filter: invert(1); background: transparent; border: 0; font-size: 1.5rem; line-height: 1;">&times;</button>
                </div>
                <div class="modal-body p-4">
                    <form id="statsReportForm" action="/admin/reportes/ofertas/descargar" method="get">
                        <input type="hidden" name="tipoReporte" value="estadistico">
                        <!-- Form fields preserved -->
                        <div class="mb-4">
                            <label class="form-section-label">Formato de Salida</label>
                            <div class="d-flex gap-2">
                                <div class="w-50">
                                    <input type="radio" class="btn-check visually-hidden" name="formato" id="fmtPdf" value="pdf" checked>
                                    <label class="btn btn-outline-danger w-100 py-3" for="fmtPdf" style="display: block; text-align: center; border: 1px solid #dc3545; border-radius: 0.375rem; color: #dc3545; cursor: pointer;">
                                        <i class="fas fa-file-pdf fa-2x mb-2"></i><br>PDF
                                    </label>
                                </div>
                                <div class="w-50" style="display: none;"></div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold text-muted small text-uppercase">Filtros Opcionales</label>
                            <input type="text" name="nombre" class="form-control mb-2" placeholder="Buscar por palabra clave..." style="display: block; width: 100%; padding: 0.375rem 0.75rem;">
                            <select name="estado" class="form-select mb-2" style="display: block; width: 100%; padding: 0.375rem 2.25rem 0.375rem 0.75rem;">
                                <option value="">Todos los estados</option>
                                <option value="PUBLICADO">Publicado</option>
                                <option value="BORRADOR">Borrador</option>
                                <option value="DE_BAJA">De Baja</option>
                            </select>
                            
                            <div class="row g-2" style="display: flex; gap: 0.5rem;">
                                <div class="col-6" style="flex: 1;">
                                    <label class="small text-muted">Desde</label>
                                    <input type="date" name="fechaInicio" class="form-control" style="width: 100%;"
                                           th:attr="max=${#temporals.format(maxFechaHoy, 'yyyy-MM-dd')}">
                                </div>
                                <div class="col-6" style="flex: 1;">
                                    <label class="small text-muted">Hasta</label>
                                     <input type="date" name="fechaFin" class="form-control" style="width: 100%;"
                                         th:attr="max=${#temporals.format(maxFechaHoy, 'yyyy-MM-dd')}">
                                </div>
                            </div>
                        </div>

                         <div class="d-grid mt-4">
                            <button type="submit" class="btn btn-primary btn-lg" style="width: 100%; padding: 0.5rem 1rem;">
                                <i class="fas fa-download me-2"></i>Descargar Reporte
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            initGlobalCharts();
            initStatsFilters();
            
            // Modal Logic
            const modal = document.getElementById('statsReportModal');
            const openBtn = document.getElementById('btnOpenReportModal');
            const closeBtns = document.querySelectorAll('.close-modal-trigger');
            
            if(openBtn) {
                openBtn.onclick = () => {
                    modal.style.display = 'block';
                    modal.classList.add('show');
                };
            }
            
            closeBtns.forEach(btn => {
                btn.onclick = () => modal.style.display = 'none';
            });
            
            window.onclick = (e) => {
                if(e.target == modal) modal.style.display = 'none';
            };

            const refreshBtn = document.getElementById('btnRefreshCharts');
            if (refreshBtn) {
                refreshBtn.onclick = () => applyStatsRange({ pushState: false });
            }
        });

        Chart.register(ChartDataLabels);

        const colors = {
            palette: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40']
        };

        const formatEntero = (value) => {
            if (value === null || value === undefined || value === '') return '';
            const numero = Number(value);
            if (!Number.isFinite(numero)) return value;
            return Math.round(numero).toLocaleString('es-AR');
        };

        const formatMoneda = (value) => {
            if (value === null || value === undefined || value === '') return '';
            const numero = Number(value);
            if (!Number.isFinite(numero)) return value;
            return numero.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };

        const dataLabelCommon = {
            color: '#ffffff',
            backgroundColor: 'rgba(15, 23, 42, 0.85)',
            borderRadius: 6,
            padding: { top: 4, right: 6, bottom: 4, left: 6 },
            font: { weight: '700', size: 13 },
            formatter: formatEntero
        };

        const formatPercent = (value) => {
            if (value === null || value === undefined || value === '') return '';
            const numero = Number(value);
            if (!Number.isFinite(numero)) return value;
            return (numero * 100).toLocaleString('es-AR', { minimumFractionDigits: 0, maximumFractionDigits: 1 }) + '%';
        };

        function getStatsRangeValues() {
            const inicioInput = document.getElementById('statsFechaInicio');
            const finInput = document.getElementById('statsFechaFin');
            return {
                inicio: inicioInput ? inicioInput.value : '',
                fin: finInput ? finInput.value : ''
            };
        }

        function buildStatsQuery(range) {
            const params = new URLSearchParams();
            if (range && range.inicio) params.set('fechaInicio', range.inicio);
            if (range && range.fin) params.set('fechaFin', range.fin);
            const qs = params.toString();
            return qs ? `?${qs}` : '';
        }

        function showStatsRangeAlert(msg) {
            const alert = document.getElementById('statsRangeAlert');
            if (!alert) return;
            alert.textContent = msg;
            alert.classList.remove('d-none');
        }

        function hideStatsRangeAlert() {
            const alert = document.getElementById('statsRangeAlert');
            if (!alert) return;
            alert.textContent = '';
            alert.classList.add('d-none');
        }

        function updateStatsRangeHint(range) {
            const hint = document.getElementById('statsRangeHint');
            if (!hint) return;
            if (!range.inicio && !range.fin) {
                hint.textContent = 'Mostrando el histórico completo.';
                return;
            }
            const desde = range.inicio ? range.inicio : 'Inicio';
            const hasta = range.fin ? range.fin : 'Hoy';
            hint.textContent = `Mostrando del ${desde} al ${hasta}.`;
        }

        function validateStatsRange(range) {
            const today = new Date().toISOString().slice(0, 10);
            if (range.inicio && range.fin && range.inicio > range.fin) {
                return 'La fecha desde no puede ser posterior a la fecha hasta.';
            }
            if (range.inicio && range.inicio > today) {
                return 'La fecha desde no puede ser futura.';
            }
            if (range.fin && range.fin > today) {
                return 'La fecha hasta no puede ser futura.';
            }
            return '';
        }

        function updateStatsUrl(range) {
            const params = new URLSearchParams(window.location.search);
            if (range.inicio) params.set('fechaInicio', range.inicio);
            else params.delete('fechaInicio');
            if (range.fin) params.set('fechaFin', range.fin);
            else params.delete('fechaFin');
            const qs = params.toString();
            const newUrl = `${window.location.pathname}${qs ? '?' + qs : ''}`;
            window.history.replaceState(null, '', newUrl);
        }

        function initStatsFilters() {
            const inicioInput = document.getElementById('statsFechaInicio');
            const finInput = document.getElementById('statsFechaFin');
            const params = new URLSearchParams(window.location.search);
            if (inicioInput && params.get('fechaInicio')) inicioInput.value = params.get('fechaInicio');
            if (finInput && params.get('fechaFin')) finInput.value = params.get('fechaFin');
            if (inicioInput && finInput && inicioInput.value) {
                finInput.setAttribute('min', inicioInput.value);
            }

            if (inicioInput && finInput) {
                inicioInput.addEventListener('change', () => {
                    if (inicioInput.value) {
                        finInput.setAttribute('min', inicioInput.value);
                    } else {
                        finInput.removeAttribute('min');
                    }
                });
            }

            const applyBtn = document.getElementById('btnApplyStatsRange');
            if (applyBtn) {
                applyBtn.addEventListener('click', () => applyStatsRange({ pushState: true }));
            }
            const clearBtn = document.getElementById('btnClearStatsRange');
            if (clearBtn) {
                clearBtn.addEventListener('click', () => clearStatsRange());
            }

            applyStatsRange({ pushState: false });
        }

        function applyStatsRange({ pushState }) {
            const range = getStatsRangeValues();
            const error = validateStatsRange(range);
            if (error) {
                showStatsRangeAlert(error);
                return;
            }
            hideStatsRangeAlert();
            updateStatsRangeHint(range);
            if (pushState) updateStatsUrl(range);
            loadOfertaCharts(range);
            loadInscripcionCharts(range);
            loadEconomicoCharts(range);
            loadDemandaTable(range);
        }

        function clearStatsRange() {
            const inicioInput = document.getElementById('statsFechaInicio');
            const finInput = document.getElementById('statsFechaFin');
            if (inicioInput) inicioInput.value = '';
            if (finInput) {
                finInput.value = '';
                finInput.removeAttribute('min');
            }
            const range = getStatsRangeValues();
            updateStatsUrl(range);
            applyStatsRange({ pushState: false });
        }

        function buildRangeLabels(range) {
            if (!range || (!range.inicio && !range.fin)) {
                return last12MonthsLabels();
            }
            const endDate = range.fin ? new Date(range.fin + 'T00:00:00') : new Date();
            const startDate = range.inicio ? new Date(range.inicio + 'T00:00:00') : new Date(endDate.getFullYear(), endDate.getMonth() - 11, 1);
            const labels = [];
            let cursor = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
            const endMonth = new Date(endDate.getFullYear(), endDate.getMonth(), 1);
            while (cursor <= endMonth) {
                labels.push(cursor.toISOString().slice(0, 7));
                cursor.setMonth(cursor.getMonth() + 1);
            }
            return labels;
        }

        function updateInscripcionStats(data) {
            if (!data) return;
            const tasaEl = document.getElementById('statsTasaAbandono');
            if (tasaEl && data.tasaAbandonoGlobal !== undefined) {
                tasaEl.textContent = formatPercent(data.tasaAbandonoGlobal);
            }
            const nuevosEl = document.getElementById('statsAlumnosNuevos');
            if (nuevosEl && data.alumnosNuevos !== undefined) {
                nuevosEl.textContent = formatEntero(data.alumnosNuevos);
            }
            const recurrentesEl = document.getElementById('statsAlumnosRecurrentes');
            if (recurrentesEl && data.alumnosRecurrentes !== undefined) {
                recurrentesEl.textContent = formatEntero(data.alumnosRecurrentes);
            }
        }

        function loadDemandaTable(range) {
            const qs = buildStatsQuery(range);
            fetch(`/admin/estadisticas/api/demanda${qs}`)
            .then(r => r.json())
            .then(data => {
                const tbody = document.getElementById('demandaOfertasBody');
                if (!tbody) return;
                const rows = Array.isArray(data) ? data : [];
                if (rows.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-muted">No hay datos disponibles</td></tr>';
                    return;
                }
                tbody.innerHTML = rows.map(oferta => {
                    const inscritos = oferta.cantidadInscritos || 0;
                    const tasa = Number(oferta.tasaOcupacion || 0);
                    const nivel = oferta.nivelDemanda || '';
                    const porcentaje = Math.max(0, Math.min(100, tasa * 100));
                    const barraClase = tasa > 0.8 ? 'bg-danger' : (tasa > 0.5 ? 'bg-info' : 'bg-success');
                    const badgeClase = nivel === 'ALTA' ? 'bg-success' : 'bg-secondary';
                    return `
                        <tr>
                            <td class="ps-4 fw-bold">${oferta.tituloOferta || 'Sin nombre'}</td>
                            <td class="text-center">${formatEntero(inscritos)}</td>
                            <td class="text-center">
                                <div class="d-flex align-items-center justify-content-center">
                                    <div class="progress w-50 me-2" style="height: 6px;">
                                        <div class="progress-bar ${barraClase}" style="width: ${porcentaje}%;"></div>
                                    </div>
                                    <span class="small">${formatPercent(tasa)}</span>
                                </div>
                            </td>
                            <td class="text-center">
                                <span class="badge ${badgeClase}">${nivel}</span>
                            </td>
                        </tr>
                    `;
                }).join('');
            })
            .catch(() => {
                const tbody = document.getElementById('demandaOfertasBody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-muted">No hay datos disponibles</td></tr>';
                }
            });
        }


        function initGlobalCharts() {
            // Placeholder for global summary charts if any
        }
        
        let charts = {};

        function destroyChart(id) {
            if (charts[id]) {
                charts[id].destroy();
                delete charts[id];
            }
        }

        function loadOfertaCharts(range) {
            const qs = buildStatsQuery(range);
            fetch('/admin/estadisticas/api/ofertas-detalladas' + qs)
            .then(r => r.json())
            .then(data => {
                // Estado
                const porEstado = data.porEstado || {};
                destroyChart('chartOfertasEstado');
                charts['chartOfertasEstado'] = new Chart(document.getElementById('chartOfertasEstado'), {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(porEstado),
                        datasets: [{
                            data: Object.values(porEstado),
                            backgroundColor: colors.palette
                        }]
                    },
                    options: {
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: (context) => `${context.label}: ${formatEntero(context.raw)}`
                                }
                            },
                            datalabels: {
                                ...dataLabelCommon,
                                color: '#ffffff'
                            }
                        }
                    }
                });
                
                // Tipo (using same endpoint structure if added)
                 const porTipo = data.porTipo || {}; // Assuming we added it back to the map in service
                 // Fetch simple offers graph as fallback
                 fetch('/admin/estadisticas/api/grafico-ofertas' + qs)
                    .then(r => r.json())
                    .then(d => {
                        destroyChart('chartOfertasTipo');
                         charts['chartOfertasTipo'] = new Chart(document.getElementById('chartOfertasTipo'), {
                            type: 'bar',
                            data: {
                                labels: d.labels,
                                datasets: [{
                                    label: 'Cantidad',
                                    data: d.data,
                                    backgroundColor: '#667eea'
                                }]
                            },
                            options: {
                                plugins: {
                                    tooltip: {
                                        callbacks: {
                                            label: (context) => `${context.dataset.label}: ${formatEntero(context.raw)}`
                                        }
                                    },
                                    datalabels: {
                                        ...dataLabelCommon,
                                        anchor: 'end',
                                        align: 'top'
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: { stepSize: 1, callback: (value) => formatEntero(value) }
                                    }
                                }
                            }
                        });
                    });
            });
        }

   function last12MonthsLabels() {
    const labels = [];
    const now = new Date();
    for (let i = 11; i >= 0; i--) {
        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
        labels.push(d.toISOString().slice(0,7)); // yyyy-MM
    }
    return labels;
}
function showStatsError(msg) {
    const container = document.querySelector('#inscripciones-section .metric-card .card-body');
    if (!container || container.querySelector('.stats-error')) return;
    const alert = document.createElement('div');
    alert.className = 'alert alert-warning stats-error';
    alert.style.marginTop = '0.5rem';
    alert.textContent = msg;
    container.prepend(alert);
}
function loadInscripcionCharts(range) {
            const qs = buildStatsQuery(range);
            fetch('/admin/estadisticas/api/inscripciones-detalladas' + qs)
            .then(r => {
                if (!r.ok) throw new Error('HTTP status ' + r.status);
                const ct = r.headers.get('content-type') || '';
                if (!ct.includes('application/json')) throw new Error('Unexpected content-type: ' + ct);
                return r.json();
            })
            .then(data => {
                console.log('Datos recibidos:', data);
                const evol = data && data.evolucionMensual ? data.evolucionMensual : {};
                updateInscripcionStats(data);
                
                let labels = Object.keys(evol);
                let values = labels.map(k => evol[k]);

                if (labels.length === 0) {
                    showStatsError('No hay datos de inscripciones disponibles.');
                    labels = buildRangeLabels(range);
                    values = labels.map(() => 0);
                }

                destroyChart('chartInscripcionesEvol');
                
                const ctx = document.getElementById('chartInscripcionesEvol');
                if (!ctx) {
                     console.error('Canvas chartInscripcionesEvol no encontrado');
                     return;
                }

                charts['chartInscripcionesEvol'] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Inscripciones Mensuales',
                            data: values,
                            borderColor: '#38ef7d',
                            backgroundColor: 'rgba(56, 239, 125, 0.15)',
                            borderWidth: 2,
                            pointRadius: 4,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#38ef7d',
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'top' },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: (context) => `${context.dataset.label}: ${formatEntero(context.raw)}`
                                }
                            },
                            datalabels: {
                                ...dataLabelCommon,
                                anchor: 'end',
                                align: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 1, callback: (value) => formatEntero(value) }
                            }
                        }
                    }
                });
            })
            .catch(err => {
                console.error('Error cargando inscripciones:', err);
                showStatsError('Error visualizando grafico.');
            });
        }

        function loadEconomicoCharts(range) {
            console.log('Cargando charts económicos...');
            const qs = buildStatsQuery(range);
            fetch('/admin/estadisticas/api/economia-detallada' + qs)
            .then(r => {
                if (!r.ok) throw new Error('HTTP ' + r.status);
                const ct = r.headers.get('content-type');
                if (!ct || !ct.includes('application/json')) throw new Error('Respuesta no es JSON');
                return r.json();
            })
            .then(data => {
                console.log('Datos económicos:', data);
                
                // 1. Ingresos por Oferta
                const ing = data.ingresosPorOferta || {};
                const labelsIng = Object.keys(ing);
                const valuesIng = Object.values(ing);
                
                destroyChart('chartIngresosOferta');
                const ctxIng = document.getElementById('chartIngresosOferta');
                if (ctxIng) {
                    charts['chartIngresosOferta'] = new Chart(ctxIng, {
                        type: 'bar',
                        data: {
                            labels: labelsIng.length ? labelsIng : ['Sin datos'],
                            datasets: [{
                                label: 'Ingresos ($)',
                                data: valuesIng.length ? valuesIng : [0],
                                backgroundColor: '#f38181',
                                borderRadius: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { 
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: (context) => `${context.dataset.label}: ${formatMoneda(context.raw)}`
                                    }
                                },
                                datalabels: {
                                    ...dataLabelCommon,
                                    formatter: formatMoneda,
                                    anchor: 'end',
                                    align: 'top'
                                }
                            },
                            scales: { 
                                y: { 
                                    beginAtZero: true,
                                    ticks: { callback: (value) => formatMoneda(value) }
                                } 
                            }
                        }
                    });
                }

                // 2. Estado de Pagos
                const estado = data.estadoPagos || {};
                const labelsEst = Object.keys(estado);
                const valuesEst = Object.values(estado);
                
                destroyChart('chartEstadoPagos');
                const ctxEst = document.getElementById('chartEstadoPagos');
                if (ctxEst) {
                    charts['chartEstadoPagos'] = new Chart(ctxEst, {
                        type: 'doughnut',
                        data: {
                            labels: labelsEst.length ? labelsEst : ['Sin datos'],
                            datasets: [{
                                data: valuesEst.length ? valuesEst : [0],
                                backgroundColor: ['#fce38a', '#11998e', '#ff5e62', '#e2e8f0']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { 
                                legend: { position: 'right' },
                                tooltip: {
                                    callbacks: {
                                        label: (context) => `${context.label}: ${formatEntero(context.raw)}`
                                    }
                                },
                                datalabels: {
                                    ...dataLabelCommon,
                                    color: '#ffffff'
                                }
                            }
                        }
                    });
                }
            })
            .catch(e => console.error('Error economía:', e));
        }
    </script>
</div>
</body>
</html>
