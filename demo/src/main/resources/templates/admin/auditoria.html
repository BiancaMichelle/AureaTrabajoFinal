<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/adminBase :: layout(~{::title}, ~{::main})}">
<head>
    <title>Auditoría del Sistema - Instituto Aurea</title>
</head>
<body>
<main class="main-content" th:fragment="main">
    <header class="main-header">
        <h1><i class="fas fa-shield-alt"></i> Auditoría del Sistema</h1>
        <p>Monitoreo completo de actividades y acciones en el sistema</p>
    </header>

    <!-- Filtros de Auditoría -->
    <section class="audit-filters">
        <div class="filters-grid">
            <div class="filter-group">
                <label for="filter-usuario">Usuario</label>
                <input type="text" id="filter-usuario" class="filter-input" placeholder="DNI o nombre del usuario">
            </div>

            <div class="filter-group">
                <label for="filter-accion">Acción</label>
                <select id="filter-accion" class="filter-input">
                    <option value="">Todas las acciones</option>
                    <option value="INICIO_SESION">Inicios de Sesión</option>
                    <option value="CIERRE_SESION">Cierres de Sesión</option>
                    <option value="ALTA_USUARIO">Crear Usuario</option>
                    <option value="MODIFICACION_USUARIO">Actualizar Usuario</option>
                    <option value="BAJA_USUARIO">Dar de Baja Usuario</option>
                    <option value="REACTIVAR_USUARIO">Reactivar Usuario</option>
                    <option value="CREAR_OFERTA">Crear Oferta</option>
                    <option value="MODIFICAR_OFERTA">Modificar Oferta</option>
                    <option value="ELIMINAR_OFERTA">Eliminar Oferta</option>
                    <option value="CAMBIAR_ESTADO_OFERTA">Cambiar Estado Oferta</option>
                    <option value="MODIFICAR_CONFIGURACION">Modificar Configuración</option>
                    <option value="EXPORTAR_REPORTE">Exportar Reporte</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="filter-estado">Estado</label>
                <select id="filter-estado" class="filter-input">
                    <option value="">Todos</option>
                    <option value="true">Exitoso</option>
                    <option value="false">Fallido</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="filter-entidad">Entidad Afectada</label>
                <select id="filter-entidad" class="filter-input">
                    <option value="">Todas las entidades</option>
                    <option value="Usuario">Usuario</option>
                    <option value="OfertaAcademica">Oferta Académica</option>
                    <option value="Sesion">Sesión</option>
                    <option value="Rol">Rol</option>
                    <option value="Configuracion">Configuración</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="filter-fecha-desde">Desde</label>
                <input type="date" id="filter-fecha-desde" class="filter-input">
            </div>

            <div class="filter-group">
                <label for="filter-fecha-hasta">Hasta</label>
                <input type="date" id="filter-fecha-hasta" class="filter-input">
            </div>
        </div>

        <div class="filter-actions">
            <button type="button" class="btn-filter secondary" onclick="limpiarFiltros()">
                <i class="fas fa-times"></i>
                Limpiar Filtros
            </button>
            <button type="button" class="btn-filter secondary" onclick="exportarCSV()">
                <i class="fas fa-file-csv"></i>
                Exportar CSV
            </button>
            <button type="button" class="btn-filter primary" onclick="aplicarFiltros()">
                <i class="fas fa-search"></i>
                Aplicar Filtros
            </button>
        </div>
    </section>

    <!-- Tabla de Auditoría usando estilos de admin.css -->
    <section class="table-container">
        <div class="table-header">
            <h2><i class="fas fa-list-ul"></i> Registro de Actividades</h2>
            <div class="audit-stats">
                <span><i class="fas fa-database"></i> <span id="total-registros">0</span> registros</span>
                <span><i class="fas fa-check-circle"></i> <span id="exitosos-count">0</span> exitosos</span>
                <span><i class="fas fa-times-circle"></i> <span id="fallidos-count">0</span> fallidos</span>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loading-overlay" style="display: none;">
            <div class="loading-spinner"></div>
        </div>

        <table class="data-table" id="audit-table">
            <thead>
                <tr>
                    <th style="width: 20%;"><i class="fas fa-user"></i> Usuario</th>
                    <th style="width: 15%;"><i class="fas fa-cogs"></i> Acción</th>
                    <th style="width: 12%;"><i class="fas fa-calendar"></i> Fecha</th>
                    <th style="width: 10%;"><i class="fas fa-clock"></i> Hora</th>
                    <th style="width: 35%;"><i class="fas fa-info-circle"></i> Detalle</th>
                    <th style="width: 8%;"><i class="fas fa-check"></i> Estado</th>
                </tr>
            </thead>
            <tbody id="audit-table-body">
                <!-- Los datos se cargarán dinámicamente aquí -->
            </tbody>
        </table>

        <!-- Empty State -->
        <div class="empty-state" id="empty-state" style="display: none;">
            <i class="fas fa-search"></i>
            <h3>No se encontraron registros</h3>
            <p>No hay datos de auditoría que coincidan con los filtros aplicados.</p>
        </div>
    </section>

    <!-- Paginación -->
    <div class="pagination-container" id="pagination-container">
        <div class="pagination-info">
            Mostrando <span id="showing-from">0</span> - <span id="showing-to">0</span> de <span id="total-records">0</span> registros
        </div>
        <div class="pagination-controls" id="pagination-controls">
            <!-- Los controles de paginación se generarán dinámicamente -->
        </div>
    </div>

    <!-- Modal detalle de auditoría -->
    <div id="audit-detail-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h3><i class="fas fa-info-circle"></i> Detalle de Auditoría</h3>
                <button type="button" class="btn-close" aria-label="Cerrar" onclick="cerrarModalAuditoria()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="oferta-info-grid">
                    <div class="info-item">
                        <label>Usuario:</label>
                        <span id="audit-modal-usuario">-</span>
                    </div>
                    <div class="info-item">
                        <label>DNI:</label>
                        <span id="audit-modal-dni">-</span>
                    </div>
                    <div class="info-item">
                        <label>Rol:</label>
                        <span id="audit-modal-rol">-</span>
                    </div>
                    <div class="info-item">
                        <label>Acción:</label>
                        <span id="audit-modal-accion">-</span>
                    </div>
                    <div class="info-item">
                        <label>Fecha:</label>
                        <span id="audit-modal-fecha">-</span>
                    </div>
                    <div class="info-item">
                        <label>Hora:</label>
                        <span id="audit-modal-hora">-</span>
                    </div>
                    <div class="info-item">
                        <label>Estado:</label>
                        <span id="audit-modal-estado">-</span>
                    </div>
                    <div class="info-item full-width">
                        <label>Detalle:</label>
                        <div id="audit-modal-detalle" class="audit-detail-text" style="white-space: pre-wrap;">-</div>
                        <div id="audit-user-detail" class="audit-user-detail audit-change-grid" style="display: none;"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="cerrarModalAuditoria()">
                    <i class="fas fa-times"></i> Cerrar
                </button>
            </div>
        </div>
    </div>
    
    <script th:inline="javascript">
    /*<![CDATA[*/
    (function() {
        'use strict';
        
        console.log('=== SCRIPT DE AUDITORÍA INICIADO ===');
    
    // === VARIABLES GLOBALES ===
    let currentPage = 0;
    let pageSize = 20;
    let totalRecords = 0;
    let currentFilters = {};
    let auditDataCache = [];

    // === FUNCIÓN PRINCIPAL DE CARGA ===
    async function cargarDatosAuditoria() {
        console.log('=== CARGANDO DATOS DE AUDITORÍA ===');
        console.log('Página:', currentPage, 'Tamaño:', pageSize);
        
        const loading = document.getElementById('loading-overlay');
        if (loading) loading.style.display = 'flex';
        
        try {
            const params = new URLSearchParams({
                page: currentPage.toString(),
                size: pageSize.toString()
            });
            
            if (currentFilters.usuario) params.append('usuario', currentFilters.usuario);
            if (currentFilters.accion) params.append('accion', currentFilters.accion);
            if (currentFilters.entidad) params.append('entidad', currentFilters.entidad);
            if (currentFilters.fechaDesde) params.append('fechaDesde', currentFilters.fechaDesde);
            if (currentFilters.fechaHasta) params.append('fechaHasta', currentFilters.fechaHasta);
            if (currentFilters.estado !== null && currentFilters.estado !== undefined) params.append('exito', currentFilters.estado);
            
            const url = `/auditoria/api/logs?${params.toString()}`;
            console.log('Fetch URL:', url);
            
            const response = await fetch(url);
            console.log('Response status:', response.status);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const datos = await response.json();
            console.log('Datos recibidos:', datos);
            console.log('Total elementos:', datos.totalElements);
            console.log('Contenido:', datos.content ? datos.content.length : 0);
            
            if (!datos.content || datos.content.length === 0) {
                mostrarEstadoVacio();
                return;
            }
            
            actualizarTabla(datos.content);
            actualizarPaginacion(datos);
            actualizarEstadisticas(datos);
            
        } catch (error) {
            console.error('Error:', error);
            mostrarEstadoVacio();
        } finally {
            if (loading) loading.style.display = 'none';
        }
    }

    // === ACTUALIZAR TABLA ===
    function actualizarTabla(datos) {
        console.log('Actualizando tabla con', datos.length, 'registros');
        
        const tbody = document.getElementById('audit-table-body');
        const emptyState = document.getElementById('empty-state');
        
        if (!tbody) {
            console.error('No se encontró tbody');
            return;
        }
        
        if (emptyState) emptyState.style.display = 'none';
        
        auditDataCache = Array.isArray(datos) ? datos : [];
        
        tbody.innerHTML = auditDataCache.map((item, index) => {
            const usuario = item.usuarioNombre || 'N/A';
            const dni = item.usuarioDni || 'N/A';
            const accion = formatearAccion(item.accion || '');
            const fecha = formatearFecha(item.fecha);
            const hora = formatearHora(item.hora);
            const detalles = truncarTexto(formatearDetalleAuditoria(item.detalles, item.afecta), 80);
            const exito = item.exito;
            
            return `
                <tr data-audit-index="${index}">
                    <td>
                        <strong>${usuario}</strong><br>
                        <small style="color: #64748b;">DNI: ${dni}</small>
                    </td>
                    <td><span class="action-badge">${accion}</span></td>
                    <td>${fecha}</td>
                    <td><strong>${hora}</strong></td>
                    <td title="${formatearDetalleAuditoria(item.detalles, item.afecta)}">${detalles}</td>
                    <td>
                        <span class="status-badge ${exito ? 'success' : 'error'}">
                            <i class="fas fa-${exito ? 'check' : 'times'}"></i>
                            ${exito ? 'Exitoso' : 'Fallido'}
                        </span>
                    </td>
                </tr>
            `;
        }).join('');

        // Hacer filas clicables
        Array.from(tbody.querySelectorAll('tr[data-audit-index]')).forEach(row => {
            row.style.cursor = 'pointer';
            row.addEventListener('click', () => {
                const idx = Number(row.getAttribute('data-audit-index'));
                const item = auditDataCache[idx];
                if (item) abrirModalAuditoria(item);
            });
        });
        
        console.log('Tabla actualizada');
    }

    // === MOSTRAR ESTADO VACÍO ===
    function mostrarEstadoVacio() {
        const tbody = document.getElementById('audit-table-body');
        const emptyState = document.getElementById('empty-state');
        if (tbody) tbody.innerHTML = '';
        if (emptyState) emptyState.style.display = 'block';
    }

    // === ACTUALIZAR PAGINACIÓN ===
    function actualizarPaginacion(datos) {
        const showingFrom = document.getElementById('showing-from');
        const showingTo = document.getElementById('showing-to');
        const totalRecordsSpan = document.getElementById('total-records');
        const paginationControls = document.getElementById('pagination-controls');
        const paginationContainer = document.getElementById('pagination-container');
        
        totalRecords = datos.totalElements || 0;
        const from = totalRecords > 0 ? (datos.number * datos.size) + 1 : 0;
        const to = Math.min((datos.number + 1) * datos.size, totalRecords);
        
        if (showingFrom) showingFrom.textContent = from;
        if (showingTo) showingTo.textContent = to;
        if (totalRecordsSpan) totalRecordsSpan.textContent = totalRecords;
        
        if (paginationControls && datos.totalPages > 1) {
            let html = '';
            
            // Botón anterior
            html += `<button class="pagination-btn ${datos.number === 0 ? 'disabled' : ''}" 
                onclick="cambiarPagina(${datos.number - 1})" ${datos.number === 0 ? 'disabled' : ''}>
                <i class="fas fa-chevron-left"></i></button>`;
            
            // Números de página
            const startPage = Math.max(0, datos.number - 2);
            const endPage = Math.min(datos.totalPages - 1, datos.number + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="pagination-btn ${i === datos.number ? 'active' : ''}" 
                    onclick="cambiarPagina(${i})">${i + 1}</button>`;
            }
            
            // Botón siguiente
            html += `<button class="pagination-btn ${datos.number >= datos.totalPages - 1 ? 'disabled' : ''}" 
                onclick="cambiarPagina(${datos.number + 1})" 
                ${datos.number >= datos.totalPages - 1 ? 'disabled' : ''}>
                <i class="fas fa-chevron-right"></i></button>`;
            
            paginationControls.innerHTML = html;
        }
        
        if (paginationContainer) {
            paginationContainer.style.display = totalRecords > 0 ? 'flex' : 'none';
        }
    }

    // === ACTUALIZAR ESTADÍSTICAS ===
    function actualizarEstadisticas(datos) {
        if (!datos.estadisticas) return;
        
        const stats = datos.estadisticas;
        const totalReg = document.getElementById('total-registros');
        const exitosos = document.getElementById('exitosos-count');
        const fallidos = document.getElementById('fallidos-count');
        
        if (totalReg && stats.totalLogs !== undefined) totalReg.textContent = stats.totalLogs;
        if (exitosos && stats.logsExitosos !== undefined) exitosos.textContent = stats.logsExitosos;
        if (fallidos && stats.logsFallidos !== undefined) fallidos.textContent = stats.logsFallidos;
    }

    // === FUNCIONES DE FORMATEO ===
    function formatearFecha(fecha) {
        if (!fecha) return 'N/A';
        try {
            const parsed = parseLocalDate(fecha);
            if (!parsed) return String(fecha);
            return parsed.toLocaleDateString('es-ES');
        } catch (e) {
            return String(fecha);
        }
    }

    function parseLocalDate(value) {
        if (!value) return null;
        if (value instanceof Date) {
            return Number.isNaN(value.getTime()) ? null : value;
        }
        if (typeof value === 'string') {
            const match = value.match(/^(\d{4})-(\d{2})-(\d{2})/);
            if (match) {
                const year = Number(match[1]);
                const month = Number(match[2]) - 1;
                const day = Number(match[3]);
                return new Date(year, month, day);
            }
        }
        const date = new Date(value);
        return Number.isNaN(date.getTime()) ? null : date;
    }

    function formatearHora(hora) {
        if (!hora) return 'N/A';
        try {
            return typeof hora === 'string' ? hora.substring(0, 5) : hora.toString().substring(0, 5);
        } catch (e) {
            return String(hora);
        }
    }

    function formatearAccion(accion) {
        if (!accion) return 'N/A';
        return accion.replace(/_/g, ' ').toLowerCase().replace(/\b\w/g, l => l.toUpperCase());
    }

    function truncarTexto(texto, limite) {
        if (!texto) return 'N/A';
        return texto.length > limite ? texto.substring(0, limite) + '...' : texto;
    }

    // === MODAL DETALLE ===
    window.abrirModalAuditoria = function(item) {
        const modal = document.getElementById('audit-detail-modal');
        if (!modal) return;

        const setText = (id, value) => {
            const el = document.getElementById(id);
            if (el) el.textContent = value ?? '-';
        };

        setText('audit-modal-usuario', item.usuarioNombre || 'N/A');
        setText('audit-modal-dni', item.usuarioDni || 'N/A');
        setText('audit-modal-rol', item.rolNombre || 'N/A');
        setText('audit-modal-accion', formatearAccion(item.accion || ''));
        setText('audit-modal-fecha', formatearFecha(item.fecha));
        setText('audit-modal-hora', formatearHora(item.hora));

        const estadoEl = document.getElementById('audit-modal-estado');
        if (estadoEl) {
            const exito = !!item.exito;
            estadoEl.innerHTML = `<span class="status-badge ${exito ? 'success' : 'error'}">
                <i class="fas fa-${exito ? 'check' : 'times'}"></i> ${exito ? 'Exitoso' : 'Fallido'}
            </span>`;
        }

        const detalleEl = document.getElementById('audit-modal-detalle');
        const userDetailEl = document.getElementById('audit-user-detail');
        if (userDetailEl) {
            userDetailEl.style.display = 'none';
            userDetailEl.innerHTML = '';
        }
        if (detalleEl) {
            detalleEl.style.display = 'block';
            detalleEl.textContent = formatearDetalleAuditoria(item.detalles, item.afecta);
        }

        if (item.accion === 'MODIFICACION_USUARIO' || item.accion === 'ACTUALIZAR_USUARIO') {
            renderAuditUserDetail(item);
        } else if (item.accion === 'MODIFICAR_OFERTA' || item.accion === 'MODIFICACION_OFERTA') {
            renderAuditOfertaDetail(item);
        } else if (item.accion === 'MODIFICAR_CONFIGURACION') {
            renderAuditConfigDetail(item);
        }

        modal.style.display = 'flex';
    };

    window.cerrarModalAuditoria = function() {
        const modal = document.getElementById('audit-detail-modal');
        if (modal) modal.style.display = 'none';
    };

    function formatearDetalleAuditoria(detalles, afecta) {
        const texto = detalles || 'N/A';
        if (!texto) return 'N/A';

        const lower = texto.toLowerCase();
        if (lower.includes('exportación') || lower.includes('exportacion')) {
            const tipo = afecta ? ` (${afecta})` : '';
            let periodo = '';
            const marker = 'Periodo: ';
            const idx = texto.indexOf(marker);
            if (idx !== -1) {
                const after = texto.substring(idx + marker.length);
                const dot = after.indexOf('.');
                periodo = dot !== -1 ? after.substring(0, dot).trim() : after.trim();
            }
            return `Reporte generado${tipo}: ${periodo || 'Histórico completo'}`;
        }

        return texto;
    }

    function normalizeChangeKey(value) {
        if (!value) return '';
        return String(value)
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '')
            .toLowerCase()
            .replace(/[\s_-]+/g, '');
    }

    function parseAuditChanges(detalles) {
        const cambios = {};
        if (!detalles) return cambios;

        const raw = String(detalles);
        let changeText = raw;
        const pipeIdx = raw.indexOf('|');
        if (pipeIdx !== -1) {
            changeText = raw.slice(pipeIdx + 1);
        }

        if (/sin\s+cambios/i.test(changeText)) {
            return cambios;
        }

        const stripQuotes = (value) => String(value || '').trim().replace(/^[\"'`]+|[\"'`]+$/g, '');
        const segments = changeText.split(';');
        segments.forEach((segment) => {
            const seg = segment.trim();
            if (!seg) return;
            const colonIdx = seg.indexOf(':');
            const arrowIdx = seg.indexOf('->');
            if (colonIdx === -1 || arrowIdx === -1 || arrowIdx < colonIdx) return;
            const keyRaw = seg.slice(0, colonIdx).trim();
            let before = seg.slice(colonIdx + 1, arrowIdx).trim();
            let after = seg.slice(arrowIdx + 2).trim();
            before = stripQuotes(before);
            after = stripQuotes(after);
            const normalized = normalizeChangeKey(keyRaw);
            if (!normalized) return;
            cambios[normalized] = { antes: before, despues: after, keyRaw };
        });

        if (Object.keys(cambios).length === 0) {
            const regex = /([A-Za-z0-9ÁÉÍÓÚÜÑáéíóúüñ _-]+)\s*:\s*'([^']*)'\s*->\s*'([^']*)'/g;
            let match;
            while ((match = regex.exec(raw)) !== null) {
                const keyRaw = match[1]?.trim() || '';
                const normalized = normalizeChangeKey(keyRaw);
                if (!normalized) continue;
                cambios[normalized] = {
                    antes: match[2],
                    despues: match[3],
                    keyRaw
                };
            }
        }

        return cambios;
    }

    function formatDateValue(valor) {
        if (!valor) return '-';
        const local = parseLocalDate(valor);
        if (local) {
            return local.toLocaleDateString('es-ES');
        }
        const parsed = new Date(valor);
        if (!Number.isNaN(parsed.getTime())) {
            return parsed.toLocaleDateString('es-ES');
        }
        return String(valor);
    }

    function formatFieldValue(key, valor) {
        if (valor === null || valor === undefined || valor === '') return '-';
        const dateKeys = new Set([
            'fechaNacimiento',
            'fechaRegistro',
            'fechaInicio',
            'fechaFin',
            'fechaInicioInscripcion',
            'fechaFinInscripcion',
            'inicioActividad'
        ]);
        const boolKeys = new Set([
            'documentacionEntregada',
            'certificado',
            'visibilidad',
            'cuposDisponibles',
            'permisoBajaAutomatica',
            'habilitarIA',
            'reportesAutomaticos'
        ]);
        if (dateKeys.has(key)) {
            return formatDateValue(valor);
        }
        if (key === 'horaInicio' && typeof valor === 'string') {
            return valor.length >= 5 ? valor.substring(0, 5) : valor;
        }
        if (boolKeys.has(key)) {
            if (valor === true || valor === 'true') return 'Si';
            if (valor === false || valor === 'false') return 'No';
        }
        return String(valor);
    }

    function buildAuditUserDetailHtml(data, cambios, item) {
        const rolActual = data?.rolPrincipal
            || (Array.isArray(data?.rolesRaw) ? data.rolesRaw[0] : null)
            || (Array.isArray(data?.roles) ? data.roles[0] : data?.roles)
            || '-';
        const campos = [
            { key: 'dni', label: 'DNI', value: data?.dni || item?.usuarioDni || '-' },
            { key: 'nombre', label: 'Nombre', value: data?.nombre || '-' },
            { key: 'apellido', label: 'Apellido', value: data?.apellido || '-' },
            { key: 'correo', label: 'Correo', value: data?.correo || '-' },
            { key: 'telefono', label: 'Teléfono', value: data?.telefono || '-' },
            { key: 'fechaNacimiento', label: 'Fecha Nacimiento', value: data?.fechaNacimiento || '-' },
            { key: 'estado', label: 'Estado', value: data?.estado || '-' },
            { key: 'fechaRegistro', label: 'Fecha Registro', value: data?.fechaRegistro || '-' },
            { key: 'rol', label: 'Rol', value: rolActual },
            { key: 'pais', label: 'País', value: data?.pais?.nombre || '-' },
            { key: 'provincia', label: 'Provincia', value: data?.provincia?.nombre || '-' },
            { key: 'ciudad', label: 'Ciudad', value: data?.ciudad?.nombre || '-' },
            { key: 'colegioEgreso', label: 'Colegio Egreso', value: data?.colegioEgreso || '-' },
            { key: 'añoEgreso', label: 'Año Egreso', value: data?.añoEgreso || '-' },
            { key: 'ultimosEstudios', label: 'Últimos Estudios', value: data?.ultimosEstudios || '-' },
            { key: 'documentacionEntregada', label: 'Documentación Entregada', value: data?.documentacionEntregada },
            { key: 'matricula', label: 'Matrícula', value: data?.matricula || '-' },
            { key: 'experiencia', label: 'Experiencia', value: data?.experiencia || '-' }
        ];

        const labelMap = {};
        const orderedKeys = [];
        campos.forEach((campo) => {
            const normalized = normalizeChangeKey(campo.key);
            if (!normalized) return;
            labelMap[normalized] = { label: campo.label, key: campo.key };
            orderedKeys.push(normalized);
        });

        const seen = new Set();
        const orderedEntries = [];
        orderedKeys.forEach((key) => {
            if (cambios[key]) {
                orderedEntries.push([key, cambios[key]]);
                seen.add(key);
            }
        });
        Object.keys(cambios || {}).forEach((key) => {
            if (!seen.has(key)) {
                orderedEntries.push([key, cambios[key]]);
            }
        });

        if (orderedEntries.length === 0) {
            return '<div class="audit-user-loading">Sin cambios detectados.</div>';
        }

        const rows = orderedEntries.map(([key, cambio]) => {
            const meta = labelMap[key] || {};
            const label = meta.label || cambio.keyRaw || key;
            const fieldKey = meta.key || key;
            const antes = formatFieldValue(fieldKey, cambio.antes);
            const despues = formatFieldValue(fieldKey, cambio.despues);
            return `
                <div class="audit-change-row">
                    <div class="audit-change-label">${label}</div>
                    <div class="audit-change-cell audit-old">${antes}</div>
                    <div class="audit-change-cell audit-new">${despues}</div>
                </div>
            `;
        }).join('');

        return `
            <div class="audit-change-table">
                <div class="audit-change-head">
                    <div class="audit-change-head-cell audit-old">Antes</div>
                    <div class="audit-change-head-cell audit-new">Despues</div>
                </div>
                ${rows}
            </div>
        `;
    }

    function renderAuditUserDetail(item) {
        const container = document.getElementById('audit-user-detail');
        const detalleEl = document.getElementById('audit-modal-detalle');
        if (!container) return;

        const cambios = parseAuditChanges(item?.detalles || '');

        container.innerHTML = '<div class="audit-user-loading">Cargando detalle de usuario...</div>';
        container.style.display = 'block';
        const dni = item?.usuarioDni || cambios?.dni?.despues || cambios?.dni?.antes || null;
        if (!dni) {
            container.innerHTML = buildAuditUserDetailHtml({}, cambios, item);
            return;
        }

        fetch(`/admin/usuarios/${encodeURIComponent(dni)}`)
            .then(resp => resp.json())
            .then(payload => {
                const data = payload?.data || {};
                container.innerHTML = buildAuditUserDetailHtml(data, cambios, item);
            })
            .catch(() => {
                container.innerHTML = buildAuditUserDetailHtml({}, cambios, item);
            });
    }

    function buildAuditOfertaDetailHtml(cambios) {
        const campos = [
            { key: 'nombre', label: 'Nombre' },
            { key: 'descripcion', label: 'Descripcion' },
            { key: 'tipo', label: 'Tipo' },
            { key: 'modalidad', label: 'Modalidad' },
            { key: 'estado', label: 'Estado' },
            { key: 'fechaInicio', label: 'Fecha Inicio' },
            { key: 'fechaFin', label: 'Fecha Fin' },
            { key: 'fechaInicioInscripcion', label: 'Inicio Inscripcion' },
            { key: 'fechaFinInscripcion', label: 'Fin Inscripcion' },
            { key: 'cupos', label: 'Cupos' },
            { key: 'costo', label: 'Costo Inscripcion' },
            { key: 'costoInscripcion', label: 'Costo Inscripcion' },
            { key: 'certificado', label: 'Certificado' },
            { key: 'visibilidad', label: 'Visibilidad' },
            { key: 'lugar', label: 'Lugar' },
            { key: 'enlace', label: 'Enlace' },
            { key: 'imagen', label: 'Imagen' },
            { key: 'categorias', label: 'Categorias' },
            { key: 'temario', label: 'Temario' },
            { key: 'plan', label: 'Plan' },
            { key: 'docentes', label: 'Docentes' },
            { key: 'costoCuota', label: 'Costo Cuota' },
            { key: 'costoMora', label: 'Costo Mora' },
            { key: 'nrCuotas', label: 'Nro Cuotas' },
            { key: 'diaVencimiento', label: 'Dia Vencimiento' },
            { key: 'duracionEstimada', label: 'Duracion Estimada' },
            { key: 'duracionMinutos', label: 'Duracion Minutos' },
            { key: 'numeroEncuentros', label: 'Numero Encuentros' },
            { key: 'publicoObjetivo', label: 'Publico Objetivo' },
            { key: 'disertantes', label: 'Disertantes' },
            { key: 'horaInicio', label: 'Hora Inicio' }
        ];

        const labelMap = {};
        const orderedKeys = [];
        campos.forEach((campo) => {
            const normalized = normalizeChangeKey(campo.key);
            if (!normalized) return;
            labelMap[normalized] = { label: campo.label, key: campo.key };
            orderedKeys.push(normalized);
        });

        const seen = new Set();
        const orderedEntries = [];
        orderedKeys.forEach((key) => {
            if (cambios[key]) {
                orderedEntries.push([key, cambios[key]]);
                seen.add(key);
            }
        });
        Object.keys(cambios || {}).forEach((key) => {
            if (!seen.has(key)) {
                orderedEntries.push([key, cambios[key]]);
            }
        });

        if (orderedEntries.length === 0) {
            return '<div class="audit-user-loading">Sin cambios detectados.</div>';
        }

        const rows = orderedEntries.map(([key, cambio]) => {
            const meta = labelMap[key] || {};
            const label = meta.label || cambio.keyRaw || key;
            const fieldKey = meta.key || key;
            const antes = formatFieldValue(fieldKey, cambio.antes);
            const despues = formatFieldValue(fieldKey, cambio.despues);
            return `
                <div class="audit-change-row">
                    <div class="audit-change-label">${label}</div>
                    <div class="audit-change-cell audit-old">${antes}</div>
                    <div class="audit-change-cell audit-new">${despues}</div>
                </div>
            `;
        }).join('');

        return `
            <div class="audit-change-table">
                <div class="audit-change-head">
                    <div class="audit-change-head-cell audit-old">Antes</div>
                    <div class="audit-change-head-cell audit-new">Despues</div>
                </div>
                ${rows}
            </div>
        `;
    }

    function renderAuditOfertaDetail(item) {
        const container = document.getElementById('audit-user-detail');
        if (!container) return;

        const cambios = parseAuditChanges(item?.detalles || '');
        container.innerHTML = '<div class="audit-user-loading">Cargando detalle de oferta...</div>';
        container.style.display = 'block';
        container.innerHTML = buildAuditOfertaDetailHtml(cambios);
    }

    function buildAuditConfigDetailHtml(cambios) {
        const campos = [
            { key: 'nombreInstituto', label: 'Nombre Instituto' },
            { key: 'descripcion', label: 'Descripcion' },
            { key: 'mision', label: 'Mision' },
            { key: 'vision', label: 'Vision' },
            { key: 'sobreNosotros', label: 'Sobre Nosotros' },
            { key: 'direccion', label: 'Direccion' },
            { key: 'telefono', label: 'Telefono' },
            { key: 'email', label: 'Email' },
            { key: 'facebook', label: 'Facebook' },
            { key: 'instagram', label: 'Instagram' },
            { key: 'x', label: 'X (Twitter)' },
            { key: 'moneda', label: 'Moneda' },
            { key: 'cuentaBancaria', label: 'Cuenta Bancaria' },
            { key: 'politicaPagos', label: 'Politica de Pagos' },
            { key: 'razonSocial', label: 'Razon Social' },
            { key: 'cuil', label: 'CUIL' },
            { key: 'inicioActividad', label: 'Inicio Actividad' },
            { key: 'permisoBajaAutomatica', label: 'Permiso Baja Automatica' },
            { key: 'minimoAlumnoBaja', label: 'Minimo Alumno Baja' },
            { key: 'inactividadBaja', label: 'Inactividad Baja' },
            { key: 'diasMoraBloqueoExamen', label: 'Dias Mora Bloqueo Examen' },
            { key: 'diasMoraBloqueoMaterial', label: 'Dias Mora Bloqueo Material' },
            { key: 'diasMoraBloqueoActividad', label: 'Dias Mora Bloqueo Actividad' },
            { key: 'diasMoraBloqueoAula', label: 'Dias Mora Bloqueo Aula' },
            { key: 'habilitarIA', label: 'Habilitar IA' },
            { key: 'reportesAutomaticos', label: 'Reportes Automaticos' },
            { key: 'colorPrimario', label: 'Color Primario' },
            { key: 'colorSecundario', label: 'Color Secundario' },
            { key: 'colorTexto', label: 'Color Texto' },
            { key: 'logo', label: 'Logo' }
        ];

        const labelMap = {};
        const orderedKeys = [];
        campos.forEach((campo) => {
            const normalized = normalizeChangeKey(campo.key);
            if (!normalized) return;
            labelMap[normalized] = { label: campo.label, key: campo.key };
            orderedKeys.push(normalized);
        });

        const seen = new Set();
        const orderedEntries = [];
        orderedKeys.forEach((key) => {
            if (cambios[key]) {
                orderedEntries.push([key, cambios[key]]);
                seen.add(key);
            }
        });
        Object.keys(cambios || {}).forEach((key) => {
            if (!seen.has(key)) {
                orderedEntries.push([key, cambios[key]]);
            }
        });

        if (orderedEntries.length === 0) {
            return '<div class="audit-user-loading">Sin cambios detectados.</div>';
        }

        const rows = orderedEntries.map(([key, cambio]) => {
            const meta = labelMap[key] || {};
            const label = meta.label || cambio.keyRaw || key;
            const fieldKey = meta.key || key;
            const antes = formatFieldValue(fieldKey, cambio.antes);
            const despues = formatFieldValue(fieldKey, cambio.despues);
            return `
                <div class="audit-change-row">
                    <div class="audit-change-label">${label}</div>
                    <div class="audit-change-cell audit-old">${antes}</div>
                    <div class="audit-change-cell audit-new">${despues}</div>
                </div>
            `;
        }).join('');

        return `
            <div class="audit-change-table">
                <div class="audit-change-head">
                    <div class="audit-change-head-cell audit-old">Antes</div>
                    <div class="audit-change-head-cell audit-new">Despues</div>
                </div>
                ${rows}
            </div>
        `;
    }

    function renderAuditConfigDetail(item) {
        const container = document.getElementById('audit-user-detail');
        if (!container) return;

        const cambios = parseAuditChanges(item?.detalles || '');
        container.innerHTML = '<div class="audit-user-loading">Cargando detalle de configuracion...</div>';
        container.style.display = 'block';
        container.innerHTML = buildAuditConfigDetailHtml(cambios);
    }


    // === CAMBIAR PÁGINA ===
    window.cambiarPagina = function(nuevaPagina) {
        console.log('Cambiando a página:', nuevaPagina);
        currentPage = nuevaPagina;
        cargarDatosAuditoria();
    };

    // === APLICAR FILTROS ===
    window.aplicarFiltros = function() {
        console.log('Aplicando filtros');
        currentPage = 0;
        
        const filterUsuario = document.getElementById('filter-usuario');
        const filterAccion = document.getElementById('filter-accion');
        const filterEntidad = document.getElementById('filter-entidad');
        const filterDesde = document.getElementById('filter-fecha-desde');
        const filterHasta = document.getElementById('filter-fecha-hasta');
        const filterEstado = document.getElementById('filter-estado');
        
        currentFilters = {
            usuario: filterUsuario ? filterUsuario.value.trim() || null : null,
            accion: filterAccion ? filterAccion.value || null : null,
            entidad: filterEntidad ? filterEntidad.value || null : null,
            fechaDesde: filterDesde ? filterDesde.value || null : null,
            fechaHasta: filterHasta ? filterHasta.value || null : null,
            estado: filterEstado && filterEstado.value !== '' ? filterEstado.value : null
        };
        
        console.log('Filtros:', currentFilters);
        cargarDatosAuditoria();
    };

    // === LIMPIAR FILTROS ===
    window.limpiarFiltros = function() {
        console.log('Limpiando filtros');
        
        const filterUsuario = document.getElementById('filter-usuario');
        const filterAccion = document.getElementById('filter-accion');
        const filterEntidad = document.getElementById('filter-entidad');
        const filterDesde = document.getElementById('filter-fecha-desde');
        const filterHasta = document.getElementById('filter-fecha-hasta');
        const filterEstado = document.getElementById('filter-estado');
        
        if (filterUsuario) filterUsuario.value = '';
        if (filterAccion) filterAccion.value = '';
        if (filterEntidad) filterEntidad.value = '';
        if (filterDesde) filterDesde.value = '';
        if (filterHasta) filterHasta.value = '';
        if (filterEstado) filterEstado.value = '';
        
        currentFilters = {};
        currentPage = 0;
        cargarDatosAuditoria();
    };

    // === EXPORTAR CSV ===
    window.exportarCSV = async function() {
        try {
            console.log('Exportando CSV');
            const params = new URLSearchParams(currentFilters);
            const response = await fetch(`/auditoria/export/csv?${params.toString()}`);
            
            if (!response.ok) throw new Error('Error al generar CSV');
            
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `auditoria-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            console.log('CSV descargado');
        } catch (error) {
            console.error('Error al exportar CSV:', error);
        }
    };

    // === CARGAR ESTADÍSTICAS GENERALES ===
    async function cargarEstadisticasGenerales() {
        try {
            const response = await fetch('/auditoria/api/estadisticas');
            if (response.ok) {
                const stats = await response.json();
                const totalReg = document.getElementById('total-registros');
                const exitosos = document.getElementById('exitosos-count');
                const fallidos = document.getElementById('fallidos-count');
                
                if (totalReg) totalReg.textContent = stats.totalLogs || 0;
                if (exitosos) exitosos.textContent = stats.logsExitosos || 0;
                if (fallidos) fallidos.textContent = stats.logsFallidos || 0;
            }
        } catch (error) {
            console.warn('No se pudieron cargar estadísticas:', error);
        }
    }

    // === INICIALIZACIÓN ===
    function inicializar() {
        console.log('=== INICIALIZANDO AUDITORÍA ===');
        
        // Configurar eventos de filtros
        const filterUsuario = document.getElementById('filter-usuario');
        if (filterUsuario) {
            filterUsuario.addEventListener('input', function() {
                clearTimeout(this._timeout);
                this._timeout = setTimeout(() => window.aplicarFiltros(), 500);
            });
        }
        
        const filterAccion = document.getElementById('filter-accion');
        if (filterAccion) filterAccion.addEventListener('change', window.aplicarFiltros);
        
        const filterEntidad = document.getElementById('filter-entidad');
        if (filterEntidad) filterEntidad.addEventListener('change', window.aplicarFiltros);
        
        const filterDesde = document.getElementById('filter-fecha-desde');
        if (filterDesde) filterDesde.addEventListener('change', window.aplicarFiltros);
        
        const filterHasta = document.getElementById('filter-fecha-hasta');
        if (filterHasta) filterHasta.addEventListener('change', window.aplicarFiltros);
        
        // Cargar datos iniciales
        cargarDatosAuditoria();
        cargarEstadisticasGenerales();

        // Cerrar modal al hacer click fuera
        const modal = document.getElementById('audit-detail-modal');
        if (modal) {
            modal.addEventListener('click', (event) => {
                if (event.target === modal) {
                    window.cerrarModalAuditoria();
                }
            });
        }
    }

    // Ejecutar cuando el DOM esté listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', inicializar);
    } else {
        inicializar();
    }
})();
/*]]>*/
</script>
</main>
</body>
</html>




