<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/adminBase :: layout(~{::title}, ~{::main})}">
<head>
    <title>Auditoría del Sistema - Instituto Aurea</title>
</head>
<body>
<main class="main-content" th:fragment="main">
    <header class="main-header">
        <h1><i class="fas fa-shield-alt"></i> Auditoría del Sistema</h1>
        <p>Monitoreo completo de actividades y acciones en el sistema</p>
    </header>

    <!-- Filtros de Auditoría -->
    <section class="audit-filters">
        <div class="filters-grid">
            <div class="filter-group">
                <label for="filter-usuario">Usuario</label>
                <input type="text" id="filter-usuario" class="filter-input" placeholder="DNI o nombre del usuario">
            </div>

            <div class="filter-group">
                <label for="filter-accion">Acción</label>
                <select id="filter-accion" class="filter-input">
                    <option value="">Todas las acciones</option>
                    <option value="LOGIN">Inicios de Sesión</option>
                    <option value="LOGOUT">Cierres de Sesión</option>
                    <option value="CREAR_USUARIO">Crear Usuario</option>
                    <option value="ACTUALIZAR_USUARIO">Actualizar Usuario</option>
                    <option value="ELIMINAR_USUARIO">Eliminar Usuario</option>
                    <option value="CAMBIAR_ROL">Cambiar Rol</option>
                    <option value="CREAR_OFERTA">Crear Oferta</option>
                    <option value="MODIFICAR_OFERTA">Modificar Oferta</option>
                    <option value="ELIMINAR_OFERTA">Eliminar Oferta</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="filter-entidad">Entidad Afectada</label>
                <select id="filter-entidad" class="filter-input">
                    <option value="">Todas las entidades</option>
                    <option value="Usuario">Usuario</option>
                    <option value="OfertaAcademica">Oferta Académica</option>
                    <option value="Sesion">Sesión</option>
                    <option value="Rol">Rol</option>
                    <option value="Configuracion">Configuración</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="filter-fecha-desde">Desde</label>
                <input type="date" id="filter-fecha-desde" class="filter-input">
            </div>

            <div class="filter-group">
                <label for="filter-fecha-hasta">Hasta</label>
                <input type="date" id="filter-fecha-hasta" class="filter-input">
            </div>
        </div>

        <div class="filter-actions">
            <button type="button" class="btn-filter secondary" onclick="limpiarFiltros()">
                <i class="fas fa-times"></i>
                Limpiar Filtros
            </button>
            <button type="button" class="btn-filter secondary" onclick="exportarCSV()">
                <i class="fas fa-file-csv"></i>
                Exportar CSV
            </button>
            <button type="button" class="btn-filter primary" onclick="aplicarFiltros()">
                <i class="fas fa-search"></i>
                Aplicar Filtros
            </button>
        </div>
    </section>

    <!-- Tabla de Auditoría usando estilos de admin.css -->
    <section class="table-container">
        <div class="table-header">
            <h2><i class="fas fa-list-ul"></i> Registro de Actividades</h2>
            <div class="audit-stats">
                <span><i class="fas fa-database"></i> <span id="total-registros">0</span> registros</span>
                <span><i class="fas fa-check-circle"></i> <span id="exitosos-count">0</span> exitosos</span>
                <span><i class="fas fa-times-circle"></i> <span id="fallidos-count">0</span> fallidos</span>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loading-overlay" style="display: none;">
            <div class="loading-spinner"></div>
        </div>

        <table class="data-table" id="audit-table">
            <thead>
                <tr>
                    <th style="width: 20%;"><i class="fas fa-user"></i> Usuario</th>
                    <th style="width: 15%;"><i class="fas fa-cogs"></i> Acción</th>
                    <th style="width: 12%;"><i class="fas fa-calendar"></i> Fecha</th>
                    <th style="width: 10%;"><i class="fas fa-clock"></i> Hora</th>
                    <th style="width: 35%;"><i class="fas fa-info-circle"></i> Detalle</th>
                    <th style="width: 8%;"><i class="fas fa-check"></i> Estado</th>
                </tr>
            </thead>
            <tbody id="audit-table-body">
                <!-- Los datos se cargarán dinámicamente aquí -->
            </tbody>
        </table>

        <!-- Empty State -->
        <div class="empty-state" id="empty-state" style="display: none;">
            <i class="fas fa-search"></i>
            <h3>No se encontraron registros</h3>
            <p>No hay datos de auditoría que coincidan con los filtros aplicados.</p>
        </div>
    </section>

    <!-- Paginación -->
    <div class="pagination-container" id="pagination-container">
        <div class="pagination-info">
            Mostrando <span id="showing-from">0</span> - <span id="showing-to">0</span> de <span id="total-records">0</span> registros
        </div>
        <div class="pagination-controls" id="pagination-controls">
            <!-- Los controles de paginación se generarán dinámicamente -->
        </div>
    </div>

    <!-- Modal detalle de auditoría -->
    <div id="audit-detail-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h3><i class="fas fa-info-circle"></i> Detalle de Auditoría</h3>
                <button type="button" class="btn-close" aria-label="Cerrar" onclick="cerrarModalAuditoria()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="oferta-info-grid">
                    <div class="info-item">
                        <label>Usuario:</label>
                        <span id="audit-modal-usuario">-</span>
                    </div>
                    <div class="info-item">
                        <label>DNI:</label>
                        <span id="audit-modal-dni">-</span>
                    </div>
                    <div class="info-item">
                        <label>Rol:</label>
                        <span id="audit-modal-rol">-</span>
                    </div>
                    <div class="info-item">
                        <label>Acción:</label>
                        <span id="audit-modal-accion">-</span>
                    </div>
                    <div class="info-item">
                        <label>Fecha:</label>
                        <span id="audit-modal-fecha">-</span>
                    </div>
                    <div class="info-item">
                        <label>Hora:</label>
                        <span id="audit-modal-hora">-</span>
                    </div>
                    <div class="info-item">
                        <label>IP:</label>
                        <span id="audit-modal-ip">-</span>
                    </div>
                    <div class="info-item">
                        <label>Estado:</label>
                        <span id="audit-modal-estado">-</span>
                    </div>
                    <div class="info-item full-width">
                        <label>Detalle:</label>
                        <div id="audit-modal-detalle" style="white-space: pre-wrap;">-</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="cerrarModalAuditoria()">
                    <i class="fas fa-times"></i> Cerrar
                </button>
            </div>
        </div>
    </div>
    
    <script th:inline="javascript">
    /*<![CDATA[*/
    (function() {
        'use strict';
        
        console.log('=== SCRIPT DE AUDITORÍA INICIADO ===');
    
    // === VARIABLES GLOBALES ===
    let currentPage = 0;
    let pageSize = 20;
    let totalRecords = 0;
    let currentFilters = {};
    let auditDataCache = [];

    // === FUNCIÓN PRINCIPAL DE CARGA ===
    async function cargarDatosAuditoria() {
        console.log('=== CARGANDO DATOS DE AUDITORÍA ===');
        console.log('Página:', currentPage, 'Tamaño:', pageSize);
        
        const loading = document.getElementById('loading-overlay');
        if (loading) loading.style.display = 'flex';
        
        try {
            const params = new URLSearchParams({
                page: currentPage.toString(),
                size: pageSize.toString()
            });
            
            if (currentFilters.usuario) params.append('usuario', currentFilters.usuario);
            if (currentFilters.accion) params.append('accion', currentFilters.accion);
            if (currentFilters.entidad) params.append('entidad', currentFilters.entidad);
            if (currentFilters.fechaDesde) params.append('fechaDesde', currentFilters.fechaDesde);
            if (currentFilters.fechaHasta) params.append('fechaHasta', currentFilters.fechaHasta);
            
            const url = `/auditoria/api/logs?${params.toString()}`;
            console.log('Fetch URL:', url);
            
            const response = await fetch(url);
            console.log('Response status:', response.status);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const datos = await response.json();
            console.log('Datos recibidos:', datos);
            console.log('Total elementos:', datos.totalElements);
            console.log('Contenido:', datos.content ? datos.content.length : 0);
            
            if (!datos.content || datos.content.length === 0) {
                mostrarEstadoVacio();
                return;
            }
            
            actualizarTabla(datos.content);
            actualizarPaginacion(datos);
            actualizarEstadisticas(datos);
            
        } catch (error) {
            console.error('Error:', error);
            mostrarEstadoVacio();
        } finally {
            if (loading) loading.style.display = 'none';
        }
    }

    // === ACTUALIZAR TABLA ===
    function actualizarTabla(datos) {
        console.log('Actualizando tabla con', datos.length, 'registros');
        
        const tbody = document.getElementById('audit-table-body');
        const emptyState = document.getElementById('empty-state');
        
        if (!tbody) {
            console.error('No se encontró tbody');
            return;
        }
        
        if (emptyState) emptyState.style.display = 'none';
        
        auditDataCache = Array.isArray(datos) ? datos : [];
        
        tbody.innerHTML = auditDataCache.map((item, index) => {
            const usuario = item.usuarioNombre || 'N/A';
            const dni = item.usuarioDni || 'N/A';
            const accion = formatearAccion(item.accion || '');
            const fecha = formatearFecha(item.fecha);
            const hora = formatearHora(item.hora);
            const detalles = truncarTexto(item.detalles || '', 80);
            const exito = item.exito;
            
            return `
                <tr data-audit-index="${index}">
                    <td>
                        <strong>${usuario}</strong><br>
                        <small style="color: #64748b;">DNI: ${dni}</small>
                    </td>
                    <td><span class="action-badge">${accion}</span></td>
                    <td>${fecha}</td>
                    <td><strong>${hora}</strong></td>
                    <td title="${item.detalles || ''}">${detalles}</td>
                    <td>
                        <span class="status-badge ${exito ? 'success' : 'error'}">
                            <i class="fas fa-${exito ? 'check' : 'times'}"></i>
                            ${exito ? 'Exitoso' : 'Fallido'}
                        </span>
                    </td>
                </tr>
            `;
        }).join('');

        // Hacer filas clicables
        Array.from(tbody.querySelectorAll('tr[data-audit-index]')).forEach(row => {
            row.style.cursor = 'pointer';
            row.addEventListener('click', () => {
                const idx = Number(row.getAttribute('data-audit-index'));
                const item = auditDataCache[idx];
                if (item) abrirModalAuditoria(item);
            });
        });
        
        console.log('Tabla actualizada');
    }

    // === MOSTRAR ESTADO VACÍO ===
    function mostrarEstadoVacio() {
        const tbody = document.getElementById('audit-table-body');
        const emptyState = document.getElementById('empty-state');
        if (tbody) tbody.innerHTML = '';
        if (emptyState) emptyState.style.display = 'block';
    }

    // === ACTUALIZAR PAGINACIÓN ===
    function actualizarPaginacion(datos) {
        const showingFrom = document.getElementById('showing-from');
        const showingTo = document.getElementById('showing-to');
        const totalRecordsSpan = document.getElementById('total-records');
        const paginationControls = document.getElementById('pagination-controls');
        const paginationContainer = document.getElementById('pagination-container');
        
        totalRecords = datos.totalElements || 0;
        const from = totalRecords > 0 ? (datos.number * datos.size) + 1 : 0;
        const to = Math.min((datos.number + 1) * datos.size, totalRecords);
        
        if (showingFrom) showingFrom.textContent = from;
        if (showingTo) showingTo.textContent = to;
        if (totalRecordsSpan) totalRecordsSpan.textContent = totalRecords;
        
        if (paginationControls && datos.totalPages > 1) {
            let html = '';
            
            // Botón anterior
            html += `<button class="pagination-btn ${datos.number === 0 ? 'disabled' : ''}" 
                onclick="cambiarPagina(${datos.number - 1})" ${datos.number === 0 ? 'disabled' : ''}>
                <i class="fas fa-chevron-left"></i></button>`;
            
            // Números de página
            const startPage = Math.max(0, datos.number - 2);
            const endPage = Math.min(datos.totalPages - 1, datos.number + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="pagination-btn ${i === datos.number ? 'active' : ''}" 
                    onclick="cambiarPagina(${i})">${i + 1}</button>`;
            }
            
            // Botón siguiente
            html += `<button class="pagination-btn ${datos.number >= datos.totalPages - 1 ? 'disabled' : ''}" 
                onclick="cambiarPagina(${datos.number + 1})" 
                ${datos.number >= datos.totalPages - 1 ? 'disabled' : ''}>
                <i class="fas fa-chevron-right"></i></button>`;
            
            paginationControls.innerHTML = html;
        }
        
        if (paginationContainer) {
            paginationContainer.style.display = totalRecords > 0 ? 'flex' : 'none';
        }
    }

    // === ACTUALIZAR ESTADÍSTICAS ===
    function actualizarEstadisticas(datos) {
        if (!datos.estadisticas) return;
        
        const stats = datos.estadisticas;
        const totalReg = document.getElementById('total-registros');
        const exitosos = document.getElementById('exitosos-count');
        const fallidos = document.getElementById('fallidos-count');
        
        if (totalReg && stats.totalLogs !== undefined) totalReg.textContent = stats.totalLogs;
        if (exitosos && stats.logsExitosos !== undefined) exitosos.textContent = stats.logsExitosos;
        if (fallidos && stats.logsFallidos !== undefined) fallidos.textContent = stats.logsFallidos;
    }

    // === FUNCIONES DE FORMATEO ===
    function formatearFecha(fecha) {
        if (!fecha) return 'N/A';
        try {
            return new Date(fecha).toLocaleDateString('es-ES');
        } catch (e) {
            return String(fecha);
        }
    }

    function formatearHora(hora) {
        if (!hora) return 'N/A';
        try {
            return typeof hora === 'string' ? hora.substring(0, 5) : hora.toString().substring(0, 5);
        } catch (e) {
            return String(hora);
        }
    }

    function formatearAccion(accion) {
        if (!accion) return 'N/A';
        return accion.replace(/_/g, ' ').toLowerCase().replace(/\b\w/g, l => l.toUpperCase());
    }

    function truncarTexto(texto, limite) {
        if (!texto) return 'N/A';
        return texto.length > limite ? texto.substring(0, limite) + '...' : texto;
    }

    // === MODAL DETALLE ===
    window.abrirModalAuditoria = function(item) {
        const modal = document.getElementById('audit-detail-modal');
        if (!modal) return;

        const setText = (id, value) => {
            const el = document.getElementById(id);
            if (el) el.textContent = value ?? '-';
        };

        setText('audit-modal-usuario', item.usuarioNombre || 'N/A');
        setText('audit-modal-dni', item.usuarioDni || 'N/A');
        setText('audit-modal-rol', item.rolNombre || 'N/A');
        setText('audit-modal-accion', formatearAccion(item.accion || ''));
        setText('audit-modal-fecha', formatearFecha(item.fecha));
        setText('audit-modal-hora', formatearHora(item.hora));
        setText('audit-modal-ip', item.ip || 'N/A');

        const estadoEl = document.getElementById('audit-modal-estado');
        if (estadoEl) {
            const exito = !!item.exito;
            estadoEl.innerHTML = `<span class="status-badge ${exito ? 'success' : 'error'}">
                <i class="fas fa-${exito ? 'check' : 'times'}"></i> ${exito ? 'Exitoso' : 'Fallido'}
            </span>`;
        }

        const detalleEl = document.getElementById('audit-modal-detalle');
        if (detalleEl) detalleEl.textContent = item.detalles || 'N/A';

        modal.style.display = 'flex';
    };

    window.cerrarModalAuditoria = function() {
        const modal = document.getElementById('audit-detail-modal');
        if (modal) modal.style.display = 'none';
    };

    // === CAMBIAR PÁGINA ===
    window.cambiarPagina = function(nuevaPagina) {
        console.log('Cambiando a página:', nuevaPagina);
        currentPage = nuevaPagina;
        cargarDatosAuditoria();
    };

    // === APLICAR FILTROS ===
    window.aplicarFiltros = function() {
        console.log('Aplicando filtros');
        currentPage = 0;
        
        const filterUsuario = document.getElementById('filter-usuario');
        const filterAccion = document.getElementById('filter-accion');
        const filterEntidad = document.getElementById('filter-entidad');
        const filterDesde = document.getElementById('filter-fecha-desde');
        const filterHasta = document.getElementById('filter-fecha-hasta');
        
        currentFilters = {
            usuario: filterUsuario ? filterUsuario.value.trim() || null : null,
            accion: filterAccion ? filterAccion.value || null : null,
            entidad: filterEntidad ? filterEntidad.value || null : null,
            fechaDesde: filterDesde ? filterDesde.value || null : null,
            fechaHasta: filterHasta ? filterHasta.value || null : null
        };
        
        console.log('Filtros:', currentFilters);
        cargarDatosAuditoria();
    };

    // === LIMPIAR FILTROS ===
    window.limpiarFiltros = function() {
        console.log('Limpiando filtros');
        
        const filterUsuario = document.getElementById('filter-usuario');
        const filterAccion = document.getElementById('filter-accion');
        const filterEntidad = document.getElementById('filter-entidad');
        const filterDesde = document.getElementById('filter-fecha-desde');
        const filterHasta = document.getElementById('filter-fecha-hasta');
        
        if (filterUsuario) filterUsuario.value = '';
        if (filterAccion) filterAccion.value = '';
        if (filterEntidad) filterEntidad.value = '';
        if (filterDesde) filterDesde.value = '';
        if (filterHasta) filterHasta.value = '';
        
        currentFilters = {};
        currentPage = 0;
        cargarDatosAuditoria();
    };

    // === EXPORTAR CSV ===
    window.exportarCSV = async function() {
        try {
            console.log('Exportando CSV');
            const params = new URLSearchParams(currentFilters);
            const response = await fetch(`/auditoria/export/csv?${params.toString()}`);
            
            if (!response.ok) throw new Error('Error al generar CSV');
            
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `auditoria-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            console.log('CSV descargado');
        } catch (error) {
            console.error('Error al exportar CSV:', error);
        }
    };

    // === CARGAR ESTADÍSTICAS GENERALES ===
    async function cargarEstadisticasGenerales() {
        try {
            const response = await fetch('/auditoria/api/estadisticas');
            if (response.ok) {
                const stats = await response.json();
                const totalReg = document.getElementById('total-registros');
                const exitosos = document.getElementById('exitosos-count');
                const fallidos = document.getElementById('fallidos-count');
                
                if (totalReg) totalReg.textContent = stats.totalLogs || 0;
                if (exitosos) exitosos.textContent = stats.logsExitosos || 0;
                if (fallidos) fallidos.textContent = stats.logsFallidos || 0;
            }
        } catch (error) {
            console.warn('No se pudieron cargar estadísticas:', error);
        }
    }

    // === INICIALIZACIÓN ===
    function inicializar() {
        console.log('=== INICIALIZANDO AUDITORÍA ===');
        
        // Configurar eventos de filtros
        const filterUsuario = document.getElementById('filter-usuario');
        if (filterUsuario) {
            filterUsuario.addEventListener('input', function() {
                clearTimeout(this._timeout);
                this._timeout = setTimeout(() => window.aplicarFiltros(), 500);
            });
        }
        
        const filterAccion = document.getElementById('filter-accion');
        if (filterAccion) filterAccion.addEventListener('change', window.aplicarFiltros);
        
        const filterEntidad = document.getElementById('filter-entidad');
        if (filterEntidad) filterEntidad.addEventListener('change', window.aplicarFiltros);
        
        const filterDesde = document.getElementById('filter-fecha-desde');
        if (filterDesde) filterDesde.addEventListener('change', window.aplicarFiltros);
        
        const filterHasta = document.getElementById('filter-fecha-hasta');
        if (filterHasta) filterHasta.addEventListener('change', window.aplicarFiltros);
        
        // Cargar datos iniciales
        cargarDatosAuditoria();
        cargarEstadisticasGenerales();

        // Cerrar modal al hacer click fuera
        const modal = document.getElementById('audit-detail-modal');
        if (modal) {
            modal.addEventListener('click', (event) => {
                if (event.target === modal) {
                    window.cerrarModalAuditoria();
                }
            });
        }
    }

    // Ejecutar cuando el DOM esté listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', inicializar);
    } else {
        inicializar();
    }
})();
/*]]>*/
</script>
</main>
</body>
</html>
