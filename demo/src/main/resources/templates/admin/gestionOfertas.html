<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/adminBase :: layout(~{::title}, ~{::main})}">

<head>
    <title>Gestión de Ofertas Académicas</title>
    <style>

.horario-chip-editable.pinned {
    border: 2px solid #f59e0b !important;
    background: #fff7ed !important;
    box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.25);
}
    .horario-chip-editable.pinned .pin-check {
        accent-color: #f59e0b;
    }

        /* Estilos para el modal de error */
        .error-content {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .error-icon {
            font-size: 2rem;
            color: #ffc107;
            margin-top: 0.2rem;
        }

        .error-message h4 {
            color: #dc3545;
            margin: 0 0 0.5rem 0;
            font-size: 1.2rem;
        }

        .error-message p {
            margin: 0 0 1rem 0;
            line-height: 1.5;
            color: #333;
        }

        .error-suggestions {
            background: #f8f9fa;
            border-left: 4px solid #ffc107;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-top: 1rem;
        }

        .error-suggestions h5 {
            color: #856404;
            margin: 0 0 0.5rem 0;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .error-suggestions ul {
            margin: 0;
            padding-left: 1rem;
        }

        .error-suggestions li {
            margin-bottom: 0.5rem;
            color: #495057;
        }

        .error-suggestions li i {
            color: #6c757d;
            margin-right: 0.5rem;
        }

        .modal-md {
            max-width: 500px;
        }

        .text-warning {
            color: #ffc107 !important;
        }

        .text-danger {
            color: #dc3545 !important;
        }

        /* =========================================
   1. ESTILOS DEL SWITCH (MODO MANUAL/AUTO)
   ========================================= */
        .switch-wrapper {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
            padding: 18px 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #eef2f7 100%);
            border-radius: 14px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 6px 18px rgba(15, 23, 42, 0.06);
        }


        /* El contenedor del toggle */
        .switch-toggle {
            position: relative;
            display: inline-block;
            width: 74px;
            height: 40px;
            flex-shrink: 0;
        }

        /* Ocultar el checkbox default */
        .switch-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        /* El deslizador (la parte visual) */
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #e5e7eb;
            transition: all 0.25s ease;
            border-radius: 999px;
            border: 1px solid #d1d5db;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.06);
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 30px;
            width: 30px;
            left: 4px;
            bottom: 4px;
            background: #ffffff;
            transition: all 0.25s ease;
            border-radius: 50%;
            box-shadow: 0 6px 14px rgba(15, 23, 42, 0.18);
        }

        /* Estado Activo (Automático) */
        input:checked+.slider {
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
            border-color: #16a34a;
        }

        input:checked+.slider:before {
            transform: translateX(34px);
        }

        /* Etiqueta dentro del toggle */
        .slider:after {
            content: "MAN";
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 10px;
            font-weight: 700;
            letter-spacing: .5px;
            color: #6b7280;
        }

        input:checked+.slider:after {
            content: "AUTO";
            left: 10px;
            right: auto;
            color: #ffffff;
        }

        /* Focus */
        .switch-toggle input:focus+.slider {
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.2);
        }

        /* Textos del Switch */
        .switch-labels {
            display: flex;
            flex-direction: column;
        }

        .switch-title {
            font-weight: 700;
            color: #2c3e50;
            font-size: 1.05rem;
        }

        .switch-desc {
            font-size: 0.9rem;
            color: #6c757d;
        }

        /* =========================================
   2. BARRA DE CONTROL (INPUTS)
   ========================================= */
        .control-panel {
            display: flex;
            align-items: flex-end;
            gap: 15px;
            background: white;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            border: 1px solid #f1f3f5;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .input-group-modern {
            flex: 1;
            min-width: 250px;
        }

        .input-group-modern label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #495057;
            font-size: 0.95rem;
        }

        .input-modern {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background-color: #fff;
        }

        .input-modern:focus {
            border-color: #764ba2;
            outline: none;
            box-shadow: 0 0 0 4px rgba(118, 75, 162, 0.1);
        }

        .btn-generate {
            padding: 12px 28px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            height: 50px;
            /* Altura para igualar al input */
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(118, 75, 162, 0.2);
        }

        .btn-generate:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(118, 75, 162, 0.3);
        }

.btn-generate:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
}

/* =========================================
   2.1 HORARIOS AUTOMATICOS RESPONSIVE
   ========================================= */
.auto-horarios-shell {
    width: 100%;
    max-width: 100%;
    overflow: hidden;
}

.auto-horarios-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
}

.auto-horarios-controls .auto-input {
    flex: 1;
    min-width: 200px;
}

#propuestas-container {
    width: 100%;
    max-width: 100%;
    overflow: hidden;
}

        /* =========================================
   3. TARJETAS DE PROPUESTAS (GRID)
   ========================================= */
.propuestas-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 25px;
    margin-top: 20px;
    width: 100%;
    min-width: 0;
    align-items: start;
    padding: 12px;
    background: #f8fafc;
    border: 1px solid #e5e7eb;
    border-radius: 16px;
}

.propuesta-card {
    background: #ffffff;
    border-radius: 16px;
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.01);
    border: 2px solid #cbd5e1;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
    position: relative;
    min-width: 0;
    max-width: 100%;
    box-sizing: border-box;
    padding: 16px;
}

.propuesta-horarios {
    width: 100%;
}

.propuesta-horarios > div {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
}

.propuesta-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}

        .propuesta-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

/* Estado Seleccionado */
.propuesta-card.card-selected {
    border-color: #10b981 !important; /* Verde esmeralda */
    background-color: #ecfdf5 !important;
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.45), 0 18px 30px rgba(16, 185, 129, 0.22);
}

        .propuesta-card.card-selected .card-body {
            background-color: #ecfdf5;
        }

.propuesta-card.card-selected::before {
    content: "✓ SELECCIONADO";
    position: absolute;
    top: 0;
    right: 0;
    background: #10b981;
    color: white;
    font-size: 0.7rem;
    font-weight: 800;
    padding: 6px 12px;
    border-bottom-left-radius: 12px;
    z-index: 10;
}

.propuesta-card.card-selected::after {
    content: "";
    position: absolute;
    inset: 0;
    border-radius: 16px;
    box-shadow: inset 0 0 0 2px rgba(16, 185, 129, 0.6);
    pointer-events: none;
}

.propuesta-card.card-selected .propuesta-header {
    background: linear-gradient(135deg, rgba(16,185,129,0.18), rgba(16,185,129,0.06));
    border-bottom: 1px solid rgba(16, 185, 129, 0.25);
    padding: 12px 16px;
    margin: -16px -16px 16px -16px;
    border-radius: 14px 14px 10px 10px;
}

.propuesta-card.card-selected {
    border-left-width: 6px !important;
    border-left-color: #10b981 !important;
}

.propuesta-card.card-selected .propuesta-title {
    color: #047857;
}

        .card-body {
            padding: 24px;
            flex: 1;
        }

        .propuesta-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .propuesta-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
            margin: 0 0 4px 0;
        }

        .propuesta-subtitle {
            color: #6b7280;
            font-size: 0.875rem;
        }

        .score-badge {
            padding: 6px 12px;
            border-radius: 20px;
            color: white;
            font-weight: 700;
            font-size: 0.85rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: #f3f4f6;
            padding: 10px 12px;
            border-radius: 10px;
            font-size: 0.85rem;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .stat-item i {
            color: #667eea;
        }

        .horarios-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .horario-chip {
            font-size: 0.75rem;
            padding: 6px 12px;
            background: white;
            color: #4f46e5;
            border-radius: 20px;
            border: 1px solid #e0e7ff;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

.propuesta-card.card-selected .score-badge {
    box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.25);
}

.propuesta-card.card-selected .horario-chip {
    background: #ffffff;
    border-color: #10b981;
    color: #0f766e;
}

.propuesta-card.card-selected .horario-chip-editable {
    border-color: #10b981 !important;
    background: #ecfdf5 !important;
}

.propuesta-card.card-selected .horario-chip-editable.pinned {
    border-color: #f59e0b !important;
    background: #fff7ed !important;
    box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.25);
}

@media (max-width: 768px) {
    .propuestas-grid {
        grid-template-columns: 1fr;
    }
}

        /* Área del botón dentro de la carta */
        .btn-select-area {
            padding: 16px 24px;
            background: #f9fafb;
            border-top: 1px solid #f3f4f6;
        }

        .btn-seleccionar-propuesta {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #1e3a8a, #2563eb);
            color: #ffffff;
            border: 1px solid #1e40af;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }

.btn-seleccionar-propuesta:hover {
    transform: translateY(-1px);
    box-shadow: 0 10px 18px rgba(37, 99, 235, 0.25);
}
        .btn-seleccionar-propuesta:hover {
            background: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }

/* Estilo botón cuando está seleccionado */
.propuesta-card.card-selected .btn-seleccionar-propuesta {
    background: linear-gradient(135deg, #059669, #10b981);
    border-color: #059669;
    color: white;
    pointer-events: none;
    opacity: 1;
    box-shadow: 0 10px 18px rgba(16, 185, 129, 0.25);
}
        /* Estilo botón cuando está seleccionado */
        .propuesta-card.card-selected .btn-seleccionar-propuesta {
            background: #10b981;
            border-color: #10b981;
            color: white;
            pointer-events: none;
            opacity: 1;
        }

        /* Estilos para el input-group de videoconferencia */
        .input-group {
            display: flex;
            align-items: center;
        }

        .input-group .form-control {
            flex: 1;
        }

        .input-group .btn {
            white-space: nowrap;
        }
    </style>

    <!-- Script para validaciones de fecha -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Obtener la fecha actual en formato YYYY-MM-DD
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];

            // Calcular la fecha de mañana
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];

            // Configurar fecha mínima para inicio de inscripción (desde hoy)
            const fechaInicioInscripcion = document.getElementById('fechaInicioInscripcion');
            if (fechaInicioInscripcion) {
                fechaInicioInscripcion.setAttribute('min', todayStr);
            }

            // Configurar fecha mínima para fin de inscripción (desde mañana)
            const fechaFinInscripcion = document.getElementById('fechaFinInscripcion');
            if (fechaFinInscripcion) {
                fechaFinInscripcion.setAttribute('min', tomorrowStr);
            }
        });
    </script>
</head>

<body>
    <main class="main-content">
        <header class="main-header">
            <h1><i class="fas fa-graduation-cap"></i> Gestión de Ofertas Académicas</h1>
            <div class="header-actions">
                <button id="btn-show-report-modal" class="btn-secondary"
                    style="background-color: #28a745; color: white; margin-right: 10px;">
                    <i class="fas fa-file-alt"></i> Generar Informes
                </button>
                <button id="btn-show-form" class="btn-primary">
                    <i class="fas fa-plus-circle"></i> Nueva Oferta
                </button>
            </div>
        </header>



        <!-- Formulario de Registro (colapsable) -->
        <div id="form-container" class="form-container" style="display: none;">
            <div class="form-card">
                <div class="form-header">
                    <h3><i class="fas fa-plus-circle"></i> Registrar Nueva Oferta Académica</h3>
                    <button type="button" id="btn-close-form" class="btn-close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <form th:action="@{/admin/ofertas/registrar}" method="post" id="oferta-form"
                    enctype="multipart/form-data" th:object="${ofertaEditar}">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <div class="form-content">
                        <!-- Columna Izquierda: Campos principales -->
                        <div class="form-left-column">
                            <!-- Datos Básicos -->
                            <div class="form-section">
                                <h4><i class="fas fa-info-circle"></i> Información Básica</h4>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="tipoOferta">Tipo de Oferta *</label>
                                        <select id="tipoOferta" name="tipoOferta" required class="form-control">
                                            <option value="">Seleccione un tipo</option>
                                            <option value="CURSO">Curso</option>
                                            <option value="FORMACION">Formación Profesional</option>
                                            <option value="SEMINARIO">Seminario</option>
                                            <option value="CHARLA">Charla</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="nombre">Nombre de la Oferta *</label>
                                        <input type="text" id="nombre" name="nombre" required class="form-control"
                                            placeholder="Ej: Curso de Programación Java">
                                    </div>
                                    <div class="form-group">
                                        <label for="modalidad">Modalidad *</label>
                                        <select id="modalidad" name="modalidad" required class="form-control">
                                            <option value="">Seleccione modalidad</option>
                                            <option value="PRESENCIAL">Presencial</option>
                                            <option value="VIRTUAL">Virtual</option>
                                            <option value="HIBRIDA">Híbrida</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="cupos">Cantidad de Cupos</label>
                                        <input type="number" id="cupos" name="cupos" class="form-control" min="1"
                                            placeholder="Número máximo de estudiantes">
                                    </div>
                                    <div class="form-group" id="grupo-fecha-inicio">
                                        <label for="fechaInicio">Fecha de Inicio *</label>
                                        <input type="date" id="fechaInicio" name="fechaInicio" class="form-control"
                                            required>
                                        <small class="form-text text-muted">
                                            <i class="fas fa-info-circle"></i> La fecha debe ser desde hoy en adelante
                                        </small>
                                    </div>
                                    <div class="form-group" id="grupo-fecha-fin">
                                        <label for="fechaFin">Fecha de Fin *</label>
                                        <input type="date" id="fechaFin" name="fechaFin" class="form-control" required
                                            disabled>
                                        <small class="form-text text-muted">
                                            <i class="fas fa-info-circle"></i> Debe ser posterior a la fecha de inicio
                                        </small>
                                    </div>
                                    <div class="form-group">
                                        <label for="fechaInicioInscripcion">Inicio de Inscripciones *</label>
                                        <input type="date" id="fechaInicioInscripcion" name="fechaInicioInscripcion"
                                            class="form-control" required>
                                        <small class="form-text text-muted">
                                            <i class="fas fa-info-circle"></i> No puede ser anterior a la fecha actual
                                        </small>
                                    </div>
                                    <div class="form-group">
                                        <label for="fechaFinInscripcion">Fin de Inscripciones *</label>
                                        <input type="date" id="fechaFinInscripcion" name="fechaFinInscripcion"
                                            class="form-control" required>
                                        <small class="form-text text-muted">
                                            <i class="fas fa-info-circle"></i> Debe ser posterior a la fecha actual
                                            (mínimo mañana)
                                        </small>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="descripcion">Descripción *</label>
                                    <textarea id="descripcion" name="descripcion" rows="3" required class="form-control"
                                        placeholder="Descripción detallada de la oferta académica"></textarea>
                                </div>
                            </div>

                            <!-- Ubicación -->
                            <div class="form-section" id="seccion-ubicacion" style="display: none;">
                                <h4><i class="fas fa-map-marker-alt"></i> Ubicación</h4>
                                <div class="form-group" id="grupo-lugar" style="display: none;">
                                    <label for="lugar">Ubicación *</label>
                                    <input type="text" id="lugar" name="lugar" class="form-control"
                                        placeholder="Dirección física o aula">
                                    <small class="form-text text-muted">
                                        <i class="fas fa-map-marker-alt"></i> Lugar donde se realizará la actividad
                                        presencial
                                    </small>
                                </div>
                                <div class="form-group" id="grupo-enlace" style="display: none;">
                                    <label for="enlace">Enlace de Videoconferencia</label>
                                    <div style="display: flex; gap: 15px; align-items: flex-start;">
                                        <input type="url" id="enlace" name="enlace" class="form-control"
                                            placeholder="Haz clic en el botón para generar el enlace" readonly
                                            style="flex: 1;">
                                        <button type="button" class="btn btn-primary"
                                            onclick="generarVideoconferencia()"
                                            style="flex-shrink: 0; white-space: nowrap;">
                                            <i class="fas fa-video"></i> Programar Videoconferencia
                                        </button>
                                    </div>
                                    <small class="form-text text-muted">
                                        <i class="fas fa-info-circle"></i> El moderador será el primer disertante
                                        ingresado
                                    </small>
                                </div>
                            </div>

                            <!-- Costos -->
                            <div class="form-section">
                                <h4><i class="fas fa-dollar-sign"></i> Información de Costos</h4>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="costoInscripcion">Costo de Inscripción</label>
                                        <input type="number" step="0.01" id="costoInscripcion" name="costoInscripcion"
                                            class="form-control" placeholder="0.00">
                                    </div>
                                    <div class="form-group" id="grupo-costo-cuota" style="display: none;">
                                        <label for="costoCuota">Costo por Cuota</label>
                                        <input type="number" step="0.01" id="costoCuota" name="costoCuota"
                                            class="form-control" placeholder="0.00">
                                    </div>
                                    <div class="form-group" id="grupo-dia-vencimiento" style="display: none;">
                                        <label for="diaVencimiento">Día de Vencimiento *</label>
                                        <input type="number" id="diaVencimiento" name="diaVencimiento"
                                            class="form-control" min="1" max="28" placeholder="Día del mes (1-28)">
                                        <small class="form-text text-muted">
                                            <i class="fas fa-calendar-check"></i>
                                            Día del mes para vencimiento de cada cuota
                                        </small>
                                    </div>
                                    <div class="form-group" id="grupo-nro-cuotas" style="display: none;">
                                        <label for="nrCuotas">Número de Cuotas</label>
                                        <input type="number" id="nrCuotas" name="nrCuotas" class="form-control" min="1"
                                            readonly>
                                        <small class="form-text text-muted">
                                            <i class="fas fa-calculator"></i>
                                            Se calcula automáticamente según duración y día de vencimiento
                                        </small>
                                    </div>
                                </div>
                            </div>



                        <!-- Categorías -->
                        <div class="form-section">
                            <div class="categoria-header">
                                <h4><i class="fas fa-tags"></i> Categorías</h4>
                                <button type="button" id="btn-gestionar-categorias" class="btn-secondary btn-xs">
                                    <i class="fas fa-cog"></i> Gestionar
                                </button>
                            </div>
                            <div class="form-group">
                                <label for="categoria-select">Seleccionar Categorías</label>
                                <p class="field-description">Seleccione una o más categorías que describan esta oferta académica</p>
                                <div class="categoria-input-group">
                                    <input type="text" id="categoria-search" class="form-control" placeholder="Buscar categoria..." style="margin-bottom: 6px; margin-top: 14px; max-width: 260px; height: 32px; padding: 4px 8px; font-size: 0.9rem;">
                                    <select id="categoria-select" class="form-control categoria-select" size="6" style="min-height: 160px;">
                                        <option value="">-- Seleccione una categoría --</option>
                                        <!-- Las categorías se cargarán dinámicamente desde la base de datos -->
                                    </select>
                                    <button type="button" id="btn-add-categoria" class="btn-add-categoria">
                                        <i class="fas fa-plus"></i> Añadir
                                    </button>
                                </div>
                                
                                <!-- Categorías seleccionadas como chips -->
                                <div class="selected-categories" id="selected-categories" style="display: none;">
                                    <span class="selected-label">Categorías seleccionadas:</span>
                                    <div class="selected-chips" id="selected-chips">
                                        <!-- Las categorías seleccionadas aparecerán aquí como chips -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                        <!-- Columna Derecha: Imagen y campos específicos -->
                        <div class="form-right-column">
                            <!-- Imagen de presentación -->
                            <div class="form-section">
                                <h4><i class="fas fa-image"></i> Imagen de Presentación</h4>
                                <div class="image-upload-container">
                                    <input type="file" id="imagen" name="imagen" accept="image/*" class="image-input">
                                    <label for="imagen" class="image-upload-area">
                                        <div class="upload-placeholder">
                                            <i class="fas fa-cloud-upload-alt"></i>
                                            <p>Subir imagen</p>
                                            <span>JPG, PNG, GIF hasta 5MB</span>
                                        </div>
                                        <img id="image-preview" style="display: none;" alt="Vista previa">
                                    </label>
                                </div>
                                <button type="button" id="btn-clear-image"
                                    class="btn-clear-image mt-2">
                                    <i class="fas fa-trash-alt"></i>
                                    Borrar imagen
                                </button>
                            </div>

                            <!-- Certificación -->
                            <div class="form-section">
                                <h4><i class="fas fa-certificate"></i> Certificación</h4>
                                <div class="checkbox-container">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="otorgaCertificado" class="form-checkbox">
                                        <span class="checkmark"></span>
                                        Otorga Certificado
                                    </label>
                                </div>

                                <div id="certificado-fields" style="display: none;">
                                    <div class="form-group">
                                        <label for="tituloCertificado">Título del Certificado</label>
                                        <input type="text" id="tituloCertificado" name="tituloCertificado"
                                            class="form-control" placeholder="Ej: Certificado de Finalización en...">
                                    </div>
                                    <div class="form-group">
                                        <label for="descripcionCertificado">Descripción del Certificado</label>
                                        <textarea id="descripcionCertificado" name="descripcionCertificado" rows="2"
                                            class="form-control"
                                            placeholder="Descripción que aparecerá en el certificado"></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Campos específicos por tipo de oferta -->

                            <!-- Campos para CURSO -->
                            <div id="fields-curso" class="form-section tipo-specific" style="display: none;">
                                <h4><i class="fas fa-book"></i> Información del Curso</h4>
                                <div class="form-group">
                                    <label for="temario">Temario</label>
                                    <textarea id="temario" name="temario" rows="4" class="form-control"
                                        placeholder="Temario detallado del curso"></textarea>
                                </div>

                                <!-- Docentes a cargo -->
                                <div class="docentes-section">
                                    <h5>Docentes a Cargo</h5>
                                    <div class="docente-search-container">
                                        <input type="text" id="docente-search" placeholder="Buscar docente..."
                                            class="form-control">
                                        <div id="docente-results" class="search-results"></div>
                                    </div>
                                    <div class="docentes-list">
                                        <table id="docentes-table" class="mini-table">
                                            <thead>
                                                <tr>
                                                    <th>Docente</th>
                                                    <th>Acción</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Docentes asignados -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- Campos para FORMACIÓN PROFESIONAL -->
                            <div id="fields-formacion" class="form-section tipo-specific" style="display: none;">
                                <h4><i class="fas fa-graduation-cap"></i> Formación Profesional</h4>
                                <div class="form-group">
                                    <label for="planFormacion">Plan de Formación</label>
                                    <textarea id="planFormacion" name="planFormacion" rows="4" class="form-control"
                                        placeholder="Plan detallado de la formación profesional"></textarea>
                                </div>

                                <!-- Docentes para formación también -->
                                <div class="docentes-section">
                                    <h5>Docentes a Cargo</h5>
                                    <div class="docente-search-container">
                                        <input type="text" id="docente-search-formacion" placeholder="Buscar docente..."
                                            class="form-control">
                                        <div id="docente-results-formacion" class="search-results"></div>
                                    </div>
                                    <div class="docentes-list">
                                        <table id="docentes-table-formacion" class="mini-table">
                                            <thead>
                                                <tr>
                                                    <th>Docente</th>
                                                    <th>Acción</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Docentes asignados -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- Campos para CHARLA -->
                            <div id="fields-charla" class="form-section tipo-specific" style="display: none;">
                                <h4><i class="fas fa-microphone"></i> Información de la Charla</h4>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="fechaCharla">Fecha de la Charla *</label>
                                        <input type="date" id="fechaCharla" name="fechaCharla" class="form-control">
                                    </div>
                                    <div class="form-group">
                                        <label for="horaCharla">Hora de Inicio *</label>
                                        <input type="time" id="horaCharla" name="horaCharla" class="form-control">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="publicoObjetivo">Público Objetivo</label>
                                    <input type="text" id="publicoObjetivo" name="publicoObjetivo" class="form-control"
                                        placeholder="A quién está dirigida la charla">
                                </div>
                                <div class="form-group">
                                    <label for="disertantesCharla">Disertantes</label>
                                    <div class="input-with-button">
                                        <input type="text" id="disertantesCharlaInput" class="form-control"
                                            placeholder="Nombre del disertante">
                                        <button type="button" class="btn-add-item"
                                            onclick="agregarDisertante('charla')">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <div id="disertantes-charla-list" class="chips-container"></div>
                                    <input type="hidden" id="disertantesCharlaHidden" name="disertantesCharla" value="">
                                </div>
                            </div>

                            <!-- Campos para SEMINARIO -->
                            <div id="fields-seminario" class="form-section tipo-specific" style="display: none;">
                                <h4><i class="fas fa-users"></i> Información del Seminario</h4>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="numeroEncuentros">Número de encuentros *</label>
                                        <input type="number" id="numeroEncuentros" name="numeroEncuentros"
                                            class="form-control" min="1" step="1" placeholder="Ej: 4">
                                        <small id="help-encuentros" class="form-text text-muted">
                                            Debe ser menor o igual a los días entre fecha inicio y fecha fin.
                                        </small>
                                    </div>
                                    <div class="form-group">
                                        <label for="horaSeminario">Hora de Inicio *</label>
                                        <input type="time" id="horaSeminario" name="horaSeminario" class="form-control">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Fechas de encuentros</label>
                                    <div id="encuentros-preview" class="form-text text-muted">
                                        Completa fecha inicio, fecha fin y número de encuentros para generar las fechas.
                                    </div>
                                    <div id="encuentros-fechas-list" class="form-grid" style="margin-top: 10px;"></div>
                                </div>
                                <div class="form-group">
                                    <label for="publicoObjetivoSeminario">Público Objetivo</label>
                                    <input type="text" id="publicoObjetivoSeminario" name="publicoObjetivoSeminario"
                                        class="form-control" placeholder="A quién está dirigido el seminario">
                                </div>
                                <div class="form-group">
                                    <label for="disertantesSeminario">Disertantes</label>
                                    <div class="input-with-button">
                                        <input type="text" id="disertantesSeminarioInput" class="form-control"
                                            placeholder="Nombre del disertante">
                                        <button type="button" class="btn-add-item"
                                            onclick="agregarDisertante('seminario')">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <div id="disertantes-seminario-list" class="chips-container"></div>
                                    <input type="hidden" id="disertantesSeminarioHidden" name="disertantesSeminario"
                                        value="">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="seccion-horarios" class="form-section" style="display: none;">
                        <h4><i class="fas fa-clock"></i> Gestión de Horarios</h4>

                        <!-- SWITCH DE MODO (Reemplazado para usar CSS puro, no Bootstrap) -->
                        <div class="switch-wrapper">
                            <label class="switch-toggle">
                                <!-- Input checkbox oculto con evento onchange -->
                                <input type="checkbox" id="modo-horario-switch"
                                    onchange="window.toggleModoHorario && window.toggleModoHorario()">
                                <span class="slider"></span>
                            </label>
                            <div class="switch-labels">
                                <span class="switch-title" id="modo-label">Modo Manual</span>
                                <span class="switch-desc" id="modo-descripcion">Selecciona días y horarios
                                    manualmente</span>
                            </div>
                        </div>

                        <!-- CONTENEDOR MODO MANUAL (Sin cambios estructurales mayores, solo limpieza) -->
                        <div id="horarios-manual-container" class="horarios-container" style="display: block;">
                            <div class="horario-form">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="dia-horario">Día de la semana</label>
                                        <select id="dia-horario" class="form-control">
                                            <option value="">Seleccionar día</option>
                                            <option value="LUNES">Lunes</option>
                                            <option value="MARTES">Martes</option>
                                            <option value="MIERCOLES">Miércoles</option>
                                            <option value="JUEVES">Jueves</option>
                                            <option value="VIERNES">Viernes</option>
                                            <option value="SABADO">Sábado</option>
                                            <option value="DOMINGO">Domingo</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="hora-inicio">Hora de inicio</label>
                                        <input type="time" id="hora-inicio" class="form-control">
                                    </div>
                                    <div class="form-group">
                                        <label for="hora-fin">Hora de fin</label>
                                        <input type="time" id="hora-fin" class="form-control">
                                    </div>
                                    <div class="form-group" style="align-self: flex-end;">
                                        <button type="button" class="btn-add-horario" onclick="agregarHorario()">
                                            <i class="fas fa-plus"></i> Agregar
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="horarios-list-container" style="margin-top: 15px;">
                                <h6 style="color: #666; font-size: 0.9rem; margin-bottom: 10px;">Horarios programados:
                                </h6>
                                <div id="lista-horarios" class="horarios-chips">
                                    <p class="no-horarios text-muted">No hay horarios programados</p>
                                </div>
                            </div>
                        </div>

                        <!-- CONTENEDOR MODO AUTOMÁTICO (Rediseñado) -->
                        <div id="horarios-automatico-container" style="display: none;">
                            <div class="auto-horarios-shell">
                                <div class="auto-horarios-header">
                                    <div class="auto-horarios-title">
                                        <i class="fas fa-robot"></i>
                                        <span>Generador Inteligente de Horarios</span>
                                    </div>
                                </div>

                                <!-- Barra de Control (Inputs) -->
                                <div class="auto-horarios-controls">
                                    <div class="auto-input">
                                        <label for="horas-semanales">Horas semanales requeridas</label>
                                        <input type="number" id="horas-semanales" placeholder="Ej: 6" min="1"
                                            step="0.5">
                                    </div>

                                    <div class="auto-input">
                                        <label for="max-horas-diarias">Máx horas por día</label>
                                        <input type="number" id="max-horas-diarias" placeholder="Ej: 4" min="1" max="12"
                                            value="4">
                                    </div>

                                    <button type="button" class="btn-generate" onclick="generarPropuestasAutomaticas()">
                                        <i class="fas fa-magic"></i> Generar Propuestas
                                    </button>
                                </div>

                                <!-- Información del/los docentes -->
                                <div id="info-docente-carga" class="auto-docentes-panel" style="display: none;">
                                    <div style="display:flex; align-items:center; gap:10px;">
                                        <i class="fas fa-user-tie" style="color:#93c5fd;"></i>
                                        <strong>Resumen de docentes</strong>
                                    </div>
                                    <div id="docentes-info-grid" class="auto-docentes-grid"></div>
                                </div>
                            </div>

        <!-- Grid de Propuestas -->
        <div id="propuestas-container" style="display: none;">
            <div class="propuestas-header">
                <i class="fas fa-lightbulb" style="color: #f59e0b; font-size: 1.2rem;"></i>
                <h5 style="margin: 0;">Propuestas Disponibles</h5>
            </div>
            
            <div id="preview-horarios-automaticos" style="display:none; margin-bottom:18px;">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <i class="fas fa-eye" style="color:#2563eb"></i>
                        <strong style="color:#374151">Vista previa de la propuesta</strong>
                        <small style="color:#6b7280;">(puedes editar y luego aplicar)</small>
                    </div>
                    
                </div>
                <div id="preview-horarios-chips" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
            </div>

                                <div id="lista-propuestas" class="propuestas-grid">
                                    <!-- Aquí se inyectan las cartas vía JS -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Campos ocultos para datos del formulario -->
                    <input type="hidden" id="categorias" name="categorias" value="">
                    <input type="hidden" id="docentesCurso" name="docentesCurso" value="">
                    <input type="hidden" id="docentesFormacion" name="docentesFormacion" value="">
                    <input type="hidden" id="horarios" name="horarios" value="">
                    <input type="hidden" id="otorgaCertificadoHidden" name="otorgaCertificado" value="false">
                    <input type="hidden" id="idOfertaModificar" name="idOferta" value="">

                    <div class="form-actions">
                        <button type="submit" id="btn-submit-form" class="btn-submit">
                            <i class="fas fa-save"></i> <span id="btn-submit-text">Registrar Oferta</span>
                        </button>
                        <button type="button" id="btn-cancel-form" class="btn-cancel">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Sección de Filtros y Tabla -->
        <div class="ofertas-table-section">
            <div class="filters-section">
                <div class="filters-header">
                    <h3><i class="fas fa-filter"></i> Filtros y Búsqueda</h3>
                </div>
                <div class="filters-content">
                    <div class="search-container">
                        <div class="search-input-container">
                            <input type="text" id="search-input" placeholder="Buscar por nombre de oferta..."
                                class="search-input">
                            <i class="fas fa-search search-icon"></i>
                        </div>
                    </div>
                    <div class="filters-grid">
                        <select id="filtro-tipo" class="filter-select">
                            <option value="">Todos los tipos</option>
                            <option value="CURSO">Curso</option>
                            <option value="FORMACION">Formación</option>
                            <option value="SEMINARIO">Seminario</option>
                            <option value="CHARLA">Charla</option>
                        </select>
                        <select id="filtro-modalidad" class="filter-select">
                            <option value="">Todas las modalidades</option>
                            <option value="PRESENCIAL">Presencial</option>
                            <option value="VIRTUAL">Virtual</option>
                            <option value="HIBRIDA">Híbrida</option>
                        </select>
                        <select id="filtro-estado" class="filter-select">
                            <option value="">Todos los estados</option>
                            <option value="ENCURSO">En Curso</option>
                            <option value="ACTIVA">Activo</option>
                            <option value="FINALIZADA">Finalizado</option>
                            <option value="DE_BAJA">De Baja</option>
                        </select>
                        <select id="filtro-certificado" class="filter-select">
                            <option value="">Certificado</option>
                            <option value="SI">Con certificado</option>
                            <option value="NO">Sin certificado</option>
                        </select>
                    </div>
                    <div class="filters-actions">
                        <button id="btn-apply-filters" class="btn-secondary">
                            <i class="fas fa-search"></i> Aplicar Filtros
                        </button>
                        <button id="btn-clear-filters" class="btn-outline">
                            <i class="fas fa-times"></i> Limpiar
                        </button>
                    </div>
                </div>
            </div>

            <div class="table-section">
                <div class="table-header">
                    <h3><i class="fas fa-list"></i> Lista de Ofertas Académicas</h3>
                    <div class="table-stats">
                        <span class="stats-text">Total: <strong id="total-ofertas"
                                th:text="${#lists.size(ofertas ?: {})}">0</strong> ofertas</span>
                    </div>
                </div>

                <div class="table-container">
                    <table id="ofertas-table" class="ofertas-table">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Tipo</th>
                                <th>Modalidad</th>
                                <th>Cupos</th>
                                <th>Fecha Inicio</th>
                                <th>Fecha Fin</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="oferta : ${ofertas}" th:if="${ofertas != null and !ofertas.isEmpty()}">
                                <td th:text="${oferta.nombre}">Nombre de la oferta</td>
                                <td th:text="${oferta.tipoOferta}">CURSO</td>
                                <td th:text="${oferta.modalidad}">PRESENCIAL</td>
                                <td class="cupos-cell">
                                    <span th:if="${oferta.cupos != null}"
                                        th:class="${oferta.tieneCuposDisponibles() ? 'cupos-disponibles' : 'cupos-agotados'}"
                                        th:text="${oferta.cupos}">30</span>
                                    <span th:if="${oferta.cupos == null}" class="cupos-ilimitados">∞</span>
                                </td>
                                <td th:text="${#temporals.format(oferta.fechaInicio, 'dd/MM/yyyy')}">01/01/2024</td>
                                <td th:text="${#temporals.format(oferta.fechaFin, 'dd/MM/yyyy')}">31/12/2024</td>
                                <td>
                                    <span class="estado-badge" th:text="${oferta.estado}">ACTIVA</span>
                                </td>
                                <td class="acciones-cell">
                                    <button class="btn-accion btn-ver" title="Ver información"
                                        th:data-id="${oferta.idOferta}"
                                        onclick="verDetalleOferta(this.getAttribute('data-id'))">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn-accion btn-modificar" title="Modificar"
                                        th:data-id="${oferta.idOferta}" th:data-nombre="${oferta.nombre}"
                                        onclick="modificarOferta(this.getAttribute('data-id'), this.getAttribute('data-nombre'))">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </td>
                            </tr>
                            <!-- Mensaje cuando no hay ofertas -->
                            <tr th:if="${ofertas == null or ofertas.isEmpty()}">
                                <td colspan="8" class="text-center text-muted py-4">
                                    <i class="fas fa-inbox fa-2x mb-2"></i><br>
                                    No hay ofertas académicas registradas
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="table-pagination">
                    <div class="pagination-info" id="pagination-info">
                        Mostrando 0-0 de 0 ofertas
                    </div>
                    <div class="pagination-controls">
                        <button class="btn-pagination" id="btn-prev" onclick="cambiarPagina(-1)">
                            <i class="fas fa-chevron-left"></i> Anterior
                        </button>
                        <span class="pagination-pages" id="pagination-pages">
                            <button class="btn-page active">1</button>
                        </span>
                        <button class="btn-pagination" id="btn-next" onclick="cambiarPagina(1)">
                            Siguiente <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de Gestión de Categorías -->
        <div id="categoriaModal" class="modal-overlay" style="display: none;">
            <div class="modal-content modal-lg">
                <div class="modal-header">
                    <h3 id="categoriaModalLabel">Gestión de Categorías</h3>
                    <button type="button" class="btn-close" aria-label="Cerrar" onclick="categoriaModal.hide()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="modal-body">
                    <!-- Alertas -->
                    <div id="categoriaAlert"></div>

                    <!-- Sección para agregar nueva categoría -->
                    <div class="categoria-form-section">
                        <h4><i class="fas fa-plus"></i> Nueva Categoría</h4>
                        <form id="categoriaForm">
                            <input type="hidden" id="categoriaId" name="categoriaId">

                            <div class="form-group">
                                <label for="categoriaNombre">
                                    <i class="fas fa-tag"></i> Nombre de la Categoría *
                                </label>
                                <input type="text" id="categoriaNombre" name="categoriaNombre" class="form-control"
                                    placeholder="Ej: Tecnología, Idiomas, Arte..." maxlength="100" required>
                                <small class="form-text text-muted">Entre 2 y 100 caracteres</small>
                            </div>

                            <div class="form-group">
                                <label for="categoriaDescripcion">
                                    <i class="fas fa-align-left"></i> Descripción *
                                </label>
                                <textarea id="categoriaDescripcion" name="categoriaDescripcion" class="form-control"
                                    rows="3" placeholder="Descripción detallada de la categoría..." maxlength="500"
                                    required></textarea>
                                <small class="form-text text-muted">Entre 5 y 500 caracteres</small>
                            </div>

                            <div class="form-actions">
                                <button type="button" class="btn btn-primary"
                                    onclick="categoriaController.guardarCategoria()">
                                    <i class="fas fa-save"></i> <span id="btnGuardarText">Crear Categoría</span>
                                </button>
                                <button type="button" class="btn btn-secondary"
                                    onclick="categoriaController.cancelarEdicion()">
                                    <i class="fas fa-times"></i> Cancelar
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Separador -->
                    <hr class="modal-separator">

                    <!-- Sección de categorías existentes -->
                    <div class="categorias-table-section">
                        <div class="table-header">
                            <h4><i class="fas fa-list"></i> Categorías Existentes</h4>
                            <div class="table-stats">
                                <span id="contadorCategorias">Total: 0 categorías</span>
                            </div>
                        </div>

                        <div class="categoria-filtros"
                            style="display: flex; gap: 10px; align-items: flex-end; margin: 10px 0 15px;">
                            <div class="form-group" style="flex: 1; margin-bottom: 0;">
                                <label for="categorias-filter-input"><i class="fas fa-search"></i> Filtro</label>
                                <input type="text" id="categorias-filter-input" class="form-control"
                                    placeholder="Filtrar por nombre o descripcion">
                            </div>
                            <button type="button" id="categorias-filter-clear" class="btn btn-outline"
                                style="height: 38px;">
                                <i class="fas fa-times"></i> Limpiar
                            </button>
                        </div>

                        <!-- Loading y error messages -->
                        <div id="categoriasLoading" class="text-center">
                            <i class="fas fa-spinner fa-spin"></i> Cargando categorías...
                        </div>
                        <div id="categoriasError" class="alert alert-danger" style="display: none;"></div>

                        <!-- Tabla de categorías -->
                        <div class="table-responsive">
                            <table id="categoriasTable" class="table table-striped" style="display: none;">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Descripción</th>
                                        <th width="100" class="text-center">Acciones</th> <!-- Ancho fijo y centrado -->
                                    </tr>
                                </thead>
                                <tbody id="categoriasTableBody">
                                    <!-- Las categorías se cargan dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Ver Oferta Completa -->
        <div id="modal-ver-oferta" class="modal-overlay" style="display: none;">
            <div class="modal-content modal-large">
                <div class="modal-header">
                    <h3><i class="fas fa-eye"></i> Detalles de la Oferta Académica</h3>
                    <button type="button" class="btn-close" onclick="cerrarModalVerOferta()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="modal-body">
                    <div class="oferta-details-container">
                        <!-- Información Principal -->
                        <div class="detail-section">
                            <h4><i class="fas fa-info-circle"></i> Información General</h4>
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <label>Nombre:</label>
                                    <span id="modal-nombre">-</span>
                                </div>
                                <div class="detail-item">
                                    <label>Tipo:</label>
                                    <span id="modal-tipo">-</span>
                                </div>
                                <div class="detail-item">
                                    <label>Modalidad:</label>
                                    <span id="modal-modalidad">-</span>
                                </div>
                                <div class="detail-item">
                                    <label>Estado:</label>
                                    <span id="modal-estado" class="estado-badge">-</span>
                                </div>
                            </div>

                            <div class="detail-item full-width">
                                <label>Descripción:</label>
                                <p id="modal-descripcion">-</p>
                            </div>
                        </div>

                        <!-- Fechas y Duración -->
                        <div class="detail-section">
                            <h4><i class="fas fa-calendar"></i> Fechas y Duración</h4>
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <label>Fecha de Inicio:</label>
                                    <span id="modal-fecha-inicio">-</span>
                                </div>
                                <div class="detail-item">
                                    <label>Fecha de Fin:</label>
                                    <span id="modal-fecha-fin">-</span>
                                </div>
                                <div class="detail-item">
                                    <label>Duración:</label>
                                    <span id="modal-duracion">-</span>
                                </div>
                                <div class="detail-item">
                                    <label>Certificado:</label>
                                    <span id="modal-certificado">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- Cupos y Costos -->
                        <div class="detail-section">
                            <h4><i class="fas fa-users"></i> Cupos y Costos</h4>
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <label>Cupos Totales:</label>
                                    <span id="modal-cupos">-</span>
                                </div>
                                <div class="detail-item">
                                    <label>Inscriptos:</label>
                                    <span id="modal-inscriptos">-</span>
                                </div>
                                <div class="detail-item">
                                    <label>Costo de Inscripción:</label>
                                    <span id="modal-costo">-</span>
                                </div>
                                <div class="detail-item">
                                    <label>Disponibles:</label>
                                    <span id="modal-disponibles">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- Horarios -->
                        <div class="detail-section">
                            <h4><i class="fas fa-clock"></i> Horarios</h4>
                            <div id="modal-horarios" class="horarios-list">
                                <p class="no-data">No hay horarios definidos</p>
                            </div>
                        </div>

                        <!-- Categorías -->
                        <div class="detail-section">
                            <h4><i class="fas fa-tags"></i> Categorías</h4>
                            <div id="modal-categorias" class="categorias-list">
                                <p class="no-data">No hay categorías asignadas</p>
                            </div>
                        </div>

                        <!-- Docentes/Disertantes -->
                        <div class="detail-section">
                            <h4><i class="fas fa-chalkboard-teacher"></i> Docentes/Disertantes</h4>
                            <div id="modal-docentes" class="docentes-list">
                                <p class="no-data">No hay docentes asignados</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalVerOferta()">
                        <i class="fas fa-times"></i> Cerrar
                    </button>
                    <button type="button" class="btn btn-danger" onclick="eliminarOfertaDesdeModal()">
                        <i class="fas fa-trash"></i> Eliminar Oferta
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal de Confirmación para Eliminar -->
        <div id="confirmDeleteModal" class="modal-overlay" style="display: none;">
            <div class="modal-content modal-sm">
                <div class="modal-header">
                    <h3><i class="fas fa-exclamation-triangle text-danger"></i> Confirmar Eliminación</h3>
                    <button type="button" class="btn-close" aria-label="Cerrar" onclick="cerrarModalConfirmacion()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="modal-body">
                    <p>¿Estás seguro de que deseas eliminar la oferta académica <strong
                            id="nombre-oferta-eliminar">-</strong>?</p>
                    <p class="text-muted">Esta acción no se puede deshacer.</p>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalConfirmacion()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button id="btn-confirmar-eliminar" type="button" class="btn btn-danger"
                        onclick="ejecutarEliminacion()">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal de Detalle Completo de Oferta -->
        <div id="modalDetalleOferta" class="modal-overlay" style="display: none;">
            <div class="modal-content modal-xl">
                <div class="modal-header">
                    <h3><i class="fas fa-graduation-cap"></i> Detalle de Oferta Académica</h3>
                    <button type="button" class="btn-close" onclick="cerrarModalDetalle()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="modal-body">
                    <!-- Información General -->
                    <div class="oferta-detalle-section">
                        <div class="section-header">
                            <h4><i class="fas fa-info-circle"></i> Información General</h4>
                        </div>
                        <div class="oferta-info-grid">
                            <div class="info-item">
                                <label>Nombre:</label>
                                <span id="detalle-nombre">-</span>
                            </div>
                            <div class="info-item">
                                <label>Tipo:</label>
                                <span id="detalle-tipo" class="badge">-</span>
                            </div>
                            <div class="info-item">
                                <label>Modalidad:</label>
                                <span id="detalle-modalidad" class="badge">-</span>
                            </div>
                            <div class="info-item">
                                <label>Estado:</label>
                                <span id="detalle-estado" class="badge">-</span>
                            </div>
                            <div class="info-item">
                                <label>Categorías:</label>
                                <div id="detalle-categorias" class="categorias-list">-</div>
                            </div>
                            <div class="info-item">
                                <label>Costo:</label>
                                <span id="detalle-costo" class="precio">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Imagen y Descripción -->
                    <div class="oferta-detalle-section">
                        <div class="section-header">
                            <h4><i class="fas fa-image"></i> Imagen y Descripción</h4>
                        </div>
                        <div class="imagen-descripcion-container">
                            <div class="imagen-container">
                                <img id="detalle-imagen" src="" alt="Imagen de la oferta" style="display: none;">
                                <div id="detalle-sin-imagen" class="sin-imagen-placeholder">
                                    <i class="fas fa-image"></i>
                                    <span>Sin imagen</span>
                                </div>
                            </div>
                            <div class="descripcion-container">
                                <label>Descripción:</label>
                                <div id="detalle-descripcion" class="descripcion-content">-</div>
                            </div>
                        </div>
                    </div>

                    <!-- Fechas -->
                    <div class="oferta-detalle-section">
                        <div class="section-header">
                            <h4><i class="fas fa-calendar"></i> Fechas</h4>
                        </div>
                        <div class="oferta-info-grid">
                            <div class="info-item">
                                <label>Fecha de Inicio:</label>
                                <span id="detalle-fecha-inicio">-</span>
                            </div>
                            <div class="info-item">
                                <label>Fecha de Fin:</label>
                                <span id="detalle-fecha-fin">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Cupos -->
                    <div class="oferta-detalle-section">
                        <div class="section-header">
                            <h4><i class="fas fa-users"></i> Cupos</h4>
                        </div>
                        <div class="oferta-info-grid">
                            <div class="info-item">
                                <label>Cupos Disponibles:</label>
                                <span id="detalle-capacidad-max">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Horarios -->
                    <div class="oferta-detalle-section">
                        <div class="section-header">
                            <h4><i class="fas fa-clock"></i> Horarios</h4>
                        </div>
                        <div class="oferta-info-grid">
                            <div class="info-item full-width">
                                <div id="detalle-horarios-container" class="horarios-list"
                                    style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
                                    <span class="text-muted">Sin horarios definidos</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Certificación -->
                    <div id="seccion-certificacion" class="oferta-detalle-section" style="display: none;">
                        <div class="section-header">
                            <h4><i class="fas fa-certificate"></i> Certificación</h4>
                        </div>
                        <div class="oferta-info-grid">
                            <div class="info-item">
                                <label>Otorga Certificado:</label>
                                <span id="detalle-otorga-certificado">Sí</span>
                            </div>
                        </div>
                    </div>

                    <!-- Datos Específicos por Tipo -->
                    <!-- Datos para CURSO -->
                    <div id="datos-curso" class="oferta-detalle-section tipo-especifico" style="display: none;">
                        <div class="section-header">
                            <h4><i class="fas fa-book"></i> Información del Curso</h4>
                        </div>
                        <div class="oferta-info-grid">
                            <div class="info-item full-width">
                                <label>Temario:</label>
                                <div id="detalle-curso-temario" style="white-space: pre-wrap;">-</div>
                            </div>
                            <div class="info-item full-width">
                                <label>Docentes a Cargo:</label>
                                <div id="detalle-curso-docentes" class="docentes-list">-</div>
                            </div>
                        </div>
                    </div>

                    <!-- Datos para FORMACIÓN -->
                    <div id="datos-formacion" class="oferta-detalle-section tipo-especifico" style="display: none;">
                        <div class="section-header">
                            <h4><i class="fas fa-graduation-cap"></i> Formación Profesional</h4>
                        </div>
                        <div class="oferta-info-grid">
                            <div class="info-item full-width">
                                <label>Plan de Formación:</label>
                                <div id="detalle-formacion-plan" style="white-space: pre-wrap;">-</div>
                            </div>
                            <div class="info-item full-width">
                                <label>Docentes a Cargo:</label>
                                <div id="detalle-formacion-docentes" class="docentes-list">-</div>
                            </div>
                        </div>
                    </div>

                    <!-- Datos para CHARLA -->
                    <div id="datos-charla" class="oferta-detalle-section tipo-especifico" style="display: none;">
                        <div class="section-header">
                            <h4><i class="fas fa-microphone"></i> Información de la Charla</h4>
                        </div>
                        <div class="oferta-info-grid">
                            <div class="info-item">
                                <label>Lugar:</label>
                                <span id="detalle-charla-lugar">-</span>
                            </div>
                            <div class="info-item">
                                <label>Enlace:</label>
                                <span id="detalle-charla-enlace">-</span>
                            </div>
                            <div class="info-item full-width">
                                <label>Público Objetivo:</label>
                                <div id="detalle-charla-publico" style="white-space: pre-wrap;">-</div>
                            </div>
                            <div class="info-item full-width">
                                <label>Disertantes:</label>
                                <div id="detalle-charla-disertantes" class="disertantes-list">-</div>
                            </div>
                        </div>
                    </div>

                    <!-- Datos para SEMINARIO -->
                    <div id="datos-seminario" class="oferta-detalle-section tipo-especifico" style="display: none;">
                        <div class="section-header">
                            <h4><i class="fas fa-chalkboard-teacher"></i> Información del Seminario</h4>
                        </div>
                        <div class="oferta-info-grid">
                            <div class="info-item">
                                <label>Lugar:</label>
                                <span id="detalle-seminario-lugar">-</span>
                            </div>
                            <div class="info-item">
                                <label>Enlace:</label>
                                <span id="detalle-seminario-enlace">-</span>
                            </div>
                            <div class="info-item full-width">
                                <label>Público Objetivo:</label>
                                <div id="detalle-seminario-publico" style="white-space: pre-wrap;">-</div>
                            </div>
                            <div class="info-item full-width">
                                <label>Disertantes:</label>
                                <div id="detalle-seminario-disertantes" class="disertantes-list">-</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <div class="action-buttons">
                        <button type="button" class="btn-primary" onclick="cerrarModalDetalle()">
                            <i class="fas fa-times"></i>
                            Cerrar
                        </button>
                        <button type="button" id="btn-cambiar-estado" class="btn-secondary"
                            onclick="cambiarEstadoOferta()">
                            <i id="icon-estado" class="fas fa-toggle-on"></i>
                            <span id="text-estado">Dar de Baja</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de Error para Cambio de Estado -->
        <div id="modalErrorEstado" class="modal-overlay" style="display: none;">
            <div class="modal-content modal-md">
                <div class="modal-header">
                    <h3><i class="fas fa-exclamation-triangle text-warning"></i> No se puede cambiar el estado</h3>
                    <button type="button" class="btn-close" onclick="cerrarModalError()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="modal-body">
                    <div class="error-content">
                        <div class="error-icon">
                            <i id="error-icon" class="fas fa-exclamation-circle"></i>
                        </div>
                        <div class="error-message">
                            <h4 id="error-title">Error al cambiar estado</h4>
                            <p id="error-description">Descripción del error</p>
                            <div id="error-suggestions" class="error-suggestions" style="display: none;">
                                <h5><i class="fas fa-lightbulb"></i> Sugerencias:</h5>
                                <ul id="error-suggestions-list">
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="cerrarModalError()">
                    <i class="fas fa-check"></i> Entendido
                </button>
            </div>
        </div>
    </div>
    
    <!-- SCRIPT COMPLETO INLINE - SIN ARCHIVOS EXTERNOS -->
    <script>
        console.log('🔥 SCRIPT INLINE CARGADO');
        
        document.addEventListener('DOMContentLoaded', function() {
            // Imagen: preview inmediato al seleccionar archivo
            const imagenInput = document.getElementById('imagen');
            const imagePreview = document.getElementById('image-preview');
            const uploadPlaceholder = document.querySelector('.upload-placeholder');
            if (imagenInput && imagePreview && uploadPlaceholder) {
                imagenInput.addEventListener('change', function(event) {
                    const file = event.target.files && event.target.files[0];
                    if (!file) return;
                    if (file.size > 5 * 1024 * 1024) {
                        if (typeof mostrarNotificacion === 'function') {
                            mostrarNotificacion('La imagen supera 5MB', 'warning');
                        } else {
                            alert('La imagen supera 5MB');
                        }
                        imagenInput.value = '';
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        imagePreview.src = e.target.result;
                        imagePreview.style.display = 'block';
                        uploadPlaceholder.style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                });
            }
            const btnClearImage = document.getElementById('btn-clear-image');
            if (btnClearImage && imagenInput && imagePreview && uploadPlaceholder) {
                btnClearImage.addEventListener('click', function() {
                    imagenInput.value = '';
                    imagePreview.src = '';
                    imagePreview.style.display = 'none';
                    uploadPlaceholder.style.display = 'flex';
                });
            }
            console.log('✅ DOM CARGADO');
            
            // Test: Verificar que los botones de ver detalle estén presentes
            setTimeout(function() {
                const botonesVer = document.querySelectorAll('.btn-ver');
                console.log('🔍 Botones de ver encontrados:', botonesVer.length);
                botonesVer.forEach((btn, index) => {
                    console.log(`- Botón ${index + 1}:`, btn.getAttribute('data-id'));
                });
            }, 1000);
            
            // Referencias a elementos
            const btnShowForm = document.getElementById('btn-show-form');
            const formContainer = document.getElementById('form-container');
            const btnCloseForm = document.getElementById('btn-close-form');
            const btnCancelForm = document.getElementById('btn-cancel-form');
            const btnGestionarCategorias = document.getElementById('btn-gestionar-categorias');
            const categoriasFilterInput = document.getElementById('categorias-filter-input');
            const categoriasFilterClear = document.getElementById('categorias-filter-clear');
            const categoriaSearchInput = document.getElementById('categoria-search');
            
            console.log('Elementos encontrados:', {
                btnShowForm: !!btnShowForm,
                formContainer: !!formContainer,
                btnCloseForm: !!btnCloseForm,
                btnCancelForm: !!btnCancelForm,
                btnGestionarCategorias: !!btnGestionarCategorias
            });

            if (categoriasFilterInput) {
                categoriasFilterInput.addEventListener('input', aplicarFiltroCategorias);
            }
            
            if (categoriaSearchInput) {
                categoriaSearchInput.addEventListener('input', filtrarCategoriasSelect);
            }

            if (categoriasFilterClear) {
                categoriasFilterClear.addEventListener('click', function() {
                    if (categoriasFilterInput) {
                        categoriasFilterInput.value = '';
                        aplicarFiltroCategorias();
                        categoriasFilterInput.focus();
                    }
                });
            }
            
            // Manejador del botón mostrar formulario
            if (btnShowForm && formContainer) {
                btnShowForm.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('👆 CLICK EN NUEVA OFERTA');
                    
                    // Limpiar formulario para asegurar estado inicial
                    if (typeof limpiarFormularioCompleto === 'function') {
                        limpiarFormularioCompleto();
                    }
                    
                     // Establecer fecha mínima en los inputs de fecha (hoy)
                    const hoy = new Date().toISOString().split('T')[0];
                    const fechaInicioInput = document.getElementById('fechaInicio');
                    const fechaFinInput = document.getElementById('fechaFin');
                    
                    if (fechaInicioInput) fechaInicioInput.setAttribute('min', hoy);
                    if (fechaFinInput) fechaFinInput.setAttribute('min', hoy);
                    
                    // Mostrar formulario con animación
                    formContainer.style.display = 'block';
                    
                    setTimeout(() => {
                        formContainer.classList.add('show');
                        console.log('📝 FORMULARIO MOSTRADO');
                    }, 10);
                });
            }
            
            function confirmarCancelacionFormulario() {
                const estaEnEdicion = typeof modoEdicion !== 'undefined' && modoEdicion;
                const titulo = estaEnEdicion ? 'Cancelar Modificación' : 'Cancelar Registro';
                const mensaje = estaEnEdicion
                    ? '¿Estás seguro que deseas cancelar la modificación? Los cambios no guardados se perderán.'
                    : '¿Estás seguro que deseas cancelar el registro? Los datos ingresados se perderán.';

                ModalConfirmacion.show(titulo, mensaje, () => {
                    if (estaEnEdicion && typeof resetearModoEdicion === 'function') {
                        resetearModoEdicion();
                    }
                    if (typeof limpiarFormularioCompleto === 'function') {
                        limpiarFormularioCompleto();
                    }
                    console.log('❌ CERRANDO FORMULARIO');
                    formContainer.classList.remove('show');
                    setTimeout(() => {
                        formContainer.style.display = 'none';
                    }, 500);
                });
            }

            // Manejador del botón cerrar formulario
            if (btnCloseForm && formContainer) {
                btnCloseForm.addEventListener('click', function(e) {
                    e.preventDefault();
                    confirmarCancelacionFormulario();
                });
            }

            // Manejador del botón cancelar formulario (botón inferior)
            if (btnCancelForm && formContainer) {
                btnCancelForm.addEventListener('click', function(e) {
                    e.preventDefault();
                    confirmarCancelacionFormulario();
                });
            }
            
            // Manejador del botón gestionar categorías
            if (btnGestionarCategorias) {
                btnGestionarCategorias.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('📋 ABRIENDO GESTIÓN DE CATEGORÍAS');
                    
                    const modal = document.getElementById('categoriaModal');
                    if (modal) {
                        modal.style.display = 'flex';
                        if (categoriasFilterInput) {
                            categoriasFilterInput.value = '';
                        }
                        cargarCategorias();
                    }
                });
            }
            
            // Manejador del botón añadir categoría
            const btnAddCategoria = document.getElementById('btn-add-categoria');
            if (btnAddCategoria) {
                btnAddCategoria.addEventListener('click', function(e) {
                    e.preventDefault();
                    añadirCategoriaSeleccionada();
                });
            }
            
            // Manejador para mostrar campos específicos según tipo de oferta
            const tipoOfertaSelect = document.getElementById('tipoOferta');
            if (tipoOfertaSelect) {
                tipoOfertaSelect.addEventListener('change', function() {
                    mostrarCamposEspecificos(this.value);
                });
            }
            
            // Manejador para mostrar/ocultar campos según modalidad
            const modalidadSelect = document.getElementById('modalidad');
            if (modalidadSelect) {
                modalidadSelect.addEventListener('change', function() {
                    actualizarCamposModalidad(this.value);
                });
            }
            
            // Listeners para cálculo automático de cuotas
            const fechaInicio = document.getElementById('fechaInicio');
            const fechaFin = document.getElementById('fechaFin');
            const diaVencimiento = document.getElementById('diaVencimiento');
            
            if (fechaInicio) {
                fechaInicio.addEventListener('change', function() {
                    // Aplicar lógica si es CURSO, FORMACION o SEMINARIO
                    const tipoOferta = document.getElementById('tipoOferta')?.value;
                    if (tipoOferta === 'CURSO' || tipoOferta === 'FORMACION' || tipoOferta === 'SEMINARIO') {
                        // Habilitar fechaFin cuando se selecciona fechaInicio
                        if (fechaFin && this.value) {
                            fechaFin.disabled = false;
                            fechaFin.setAttribute('min', this.value);
                        }
                        if (tipoOferta === 'CURSO' || tipoOferta === 'FORMACION') {
                            calcularNumeroCuotas();
                        }
                    }
                });
            }
            if (fechaFin) {
                fechaFin.addEventListener('change', calcularNumeroCuotas);
            }
            if (diaVencimiento) {
                diaVencimiento.addEventListener('change', calcularNumeroCuotas);
            }
            
            // Event listeners para disertantes (Enter key)
            const disertantesCharlaInput = document.getElementById('disertantesCharlaInput');
            if (disertantesCharlaInput) {
                disertantesCharlaInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        agregarDisertante('charla');
                    }
                });
            }
            
            const disertantesSeminarioInput = document.getElementById('disertantesSeminarioInput');
            if (disertantesSeminarioInput) {
                disertantesSeminarioInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        agregarDisertante('seminario');
                    }
                });
            }
            
            // Cargar categorías al iniciar
            cargarCategoriasSelect();
            
            // Event listener para cerrar notificación
            const notificationClose = document.getElementById('notification-close');
            if (notificationClose) {
                notificationClose.addEventListener('click', ocultarNotificacion);
            }
            
            // Manejador de filtros
            const btnApplyFilters = document.getElementById('btn-apply-filters');
            const btnClearFilters = document.getElementById('btn-clear-filters');
            
            if (btnApplyFilters) {
                btnApplyFilters.addEventListener('click', function() {
                    aplicarFiltros();
                });
            }
            
            if (btnClearFilters) {
                btnClearFilters.addEventListener('click', function() {
                    limpiarFiltros();
                });
            }

            console.log('🎉 GESTIÓN DE OFERTAS INICIALIZADA');
            
            // Cargar ofertas iniciales para paginación
            actualizarTablaOfertas();
        });
        
        // Función para mostrar campos específicos según tipo de oferta
        function mostrarCamposEspecificos(tipoOferta) {
            console.log('🔄 Cambiando tipo de oferta a:', tipoOferta);
            
            // Limpiar datos anteriores
            limpiarDatosFormulario();
            
            // Ocultar todas las secciones específicas
            const seccionesEspecificas = document.querySelectorAll('.tipo-specific');
            seccionesEspecificas.forEach(seccion => {
                seccion.style.display = 'none';
            });
            
            // Ocultar sección de horarios por defecto
            const seccionHorarios = document.getElementById('seccion-horarios');
            seccionHorarios.style.display = 'none';
            
            // Controlar campos de cuotas en la sección principal de costos
            const grupoCostoCuota = document.getElementById('grupo-costo-cuota');
            const grupoNroCuotas = document.getElementById('grupo-nro-cuotas');
            const grupoDiaVencimiento = document.getElementById('grupo-dia-vencimiento');
            
            // Mostrar campos de cuotas solo para CURSO y FORMACION
            const mostrarCamposCuotas = tipoOferta === 'CURSO' || tipoOferta === 'FORMACION';
            
            if (grupoCostoCuota) grupoCostoCuota.style.display = mostrarCamposCuotas ? 'block' : 'none';
            if (grupoNroCuotas) grupoNroCuotas.style.display = mostrarCamposCuotas ? 'block' : 'none';
            if (grupoDiaVencimiento) grupoDiaVencimiento.style.display = mostrarCamposCuotas ? 'block' : 'none';
            
            // Ocultar fechaInicio y fechaFin solo para CHARLA (usa fecha específica)
            const grupoFechaInicio = document.getElementById('grupo-fecha-inicio');
            const grupoFechaFin = document.getElementById('grupo-fecha-fin');
            const mostrarFechasGenerales = tipoOferta === 'CURSO' || tipoOferta === 'FORMACION' || tipoOferta === 'SEMINARIO';
            
            if (grupoFechaInicio) {
                grupoFechaInicio.style.display = mostrarFechasGenerales ? 'block' : 'none';
                const inputFechaInicio = document.getElementById('fechaInicio');
                if (inputFechaInicio) {
                    inputFechaInicio.required = mostrarFechasGenerales;
                }
            }
            
            if (grupoFechaFin) {
                grupoFechaFin.style.display = mostrarFechasGenerales ? 'block' : 'none';
                const inputFechaFin = document.getElementById('fechaFin');
                if (inputFechaFin) {
                    inputFechaFin.required = mostrarFechasGenerales;
                }
            }
            
            // Mostrar la sección correspondiente al tipo seleccionado
            let seccionMostrar = null;
            switch(tipoOferta) {
                case 'CURSO':
                    seccionMostrar = document.getElementById('fields-curso');
                    // Mostrar horarios para curso
                    seccionHorarios.style.display = 'block';
                    // Inicializar búsqueda de docentes para curso
                    console.log('🔍 Inicializando búsqueda para CURSO');
                    inicializarBusquedaDocentes('docente-search', 'docente-results', 'docentes-table');
                    break;
                    
                case 'FORMACION':
                    seccionMostrar = document.getElementById('fields-formacion');
                    // Mostrar horarios para formación
                    seccionHorarios.style.display = 'block';
                    // Inicializar búsqueda de docentes para formación
                    console.log('🔍 Inicializando búsqueda para FORMACION');
                    inicializarBusquedaDocentes('docente-search-formacion', 'docente-results-formacion', 'docentes-table-formacion');
                    break;
                    
                case 'CHARLA':
                    seccionMostrar = document.getElementById('fields-charla');
                    break;
                    
                case 'SEMINARIO':
                    seccionMostrar = document.getElementById('fields-seminario');
                    break;
                    
                default:
                    console.log('⚠️ Tipo de oferta no reconocido:', tipoOferta);
                    return;
            }
            
            if (seccionMostrar) {
                seccionMostrar.style.display = 'block';
                console.log('✅ Mostrando campos específicos para:', tipoOferta);
            }
            
            // Actualizar campos según el tipo y modalidad
            actualizarCamposModalidad();
        }
        
        // Función para limpiar datos del formulario cuando se cambia tipo
        function limpiarDatosFormulario() {
            // Limpiar docentes seleccionados
            docentesSeleccionados.curso = [];
            docentesSeleccionados.formacion = [];
            
            // Limpiar horarios
            horariosSeleccionados = [];
            
            // Limpiar disertantes
            disertantesCharla = [];
            disertantesSeminario = [];
            
            // Limpiar tablas de docentes
            const tablaCurso = document.getElementById('docentes-table');
            const tablaFormacion = document.getElementById('docentes-table-formacion');
            
            if (tablaCurso) {
                const tbody = tablaCurso.querySelector('tbody');
                if (tbody) tbody.innerHTML = '';
            }
            
            if (tablaFormacion) {
                const tbody = tablaFormacion.querySelector('tbody');
                if (tbody) tbody.innerHTML = '';
            }
            
            // Limpiar visualizaciones
            actualizarHorariosChips();
            actualizarDisertantesChips('charla');
            actualizarDisertantesChips('seminario');
            
            // Actualizar campos hidden
            actualizarDocentesHidden('curso');
            actualizarDocentesHidden('formacion');
            
            console.log('🧹 Datos del formulario limpiados');
        }
        
        // Función para actualizar campos según modalidad seleccionada
        function actualizarCamposModalidad() {
            const modalidadSelect = document.getElementById('modalidad');
            const tipoOfertaSelect = document.getElementById('tipoOferta');
            
            if (!modalidadSelect || !tipoOfertaSelect) return;
            
            const modalidad = modalidadSelect.value;
            const tipoOferta = tipoOfertaSelect.value;
            
            const seccionUbicacion = document.getElementById('seccion-ubicacion');
            const grupoLugar = document.getElementById('grupo-lugar');
            const grupoEnlace = document.getElementById('grupo-enlace');
            
            if (!seccionUbicacion || !grupoLugar || !grupoEnlace) return;
            
            // Si no hay tipo de oferta o modalidad seleccionada, ocultar todo
            if (!tipoOferta || !modalidad) {
                seccionUbicacion.style.display = 'none';
                grupoLugar.style.display = 'none';
                grupoEnlace.style.display = 'none';
                return;
            }
            
            // Para CURSO y FORMACIÓN
            if (tipoOferta === 'CURSO' || tipoOferta === 'FORMACION') {
                grupoEnlace.style.display = 'none';
                
                // Mostrar ubicación solo para PRESENCIAL o HÍBRIDA
                if (modalidad === 'PRESENCIAL' || modalidad === 'HIBRIDA') {
                    seccionUbicacion.style.display = 'block';
                    grupoLugar.style.display = 'block';
                } else {
                    seccionUbicacion.style.display = 'none';
                    grupoLugar.style.display = 'none';
                }
                return;
            }
            
            // Para CHARLA
            if (tipoOferta === 'CHARLA') {
                if (modalidad === 'PRESENCIAL') {
                    // Solo ubicación, sin enlace
                    seccionUbicacion.style.display = 'block';
                    grupoLugar.style.display = 'block';
                    grupoEnlace.style.display = 'none';
                } else if (modalidad === 'VIRTUAL') {
                    // Solo enlace, sin ubicación
                    seccionUbicacion.style.display = 'block';
                    grupoLugar.style.display = 'none';
                    grupoEnlace.style.display = 'block';
                } else if (modalidad === 'HIBRIDA') {
                    // Ubicación y enlace
                    seccionUbicacion.style.display = 'block';
                    grupoLugar.style.display = 'block';
                    grupoEnlace.style.display = 'block';
                } else {
                    seccionUbicacion.style.display = 'none';
                    grupoLugar.style.display = 'none';
                    grupoEnlace.style.display = 'none';
                }
                return;
            }

            // Para SEMINARIO
            if (tipoOferta === 'SEMINARIO') {
                if (modalidad === 'PRESENCIAL') {
                    // Solo ubicación, sin enlace
                    seccionUbicacion.style.display = 'block';
                    grupoLugar.style.display = 'block';
                    grupoEnlace.style.display = 'none';
                } else if (modalidad === 'VIRTUAL') {
                    // Solo enlace, sin ubicación
                    seccionUbicacion.style.display = 'block';
                    grupoLugar.style.display = 'none';
                    grupoEnlace.style.display = 'block';
                } else if (modalidad === 'HIBRIDA') {
                    // Ubicación y enlace
                    seccionUbicacion.style.display = 'block';
                    grupoLugar.style.display = 'block';
                    grupoEnlace.style.display = 'block';
                } else {
                    seccionUbicacion.style.display = 'none';
                    grupoLugar.style.display = 'none';
                    grupoEnlace.style.display = 'none';
                }
                return;
            }
            
            // Caso por defecto: ocultar todo
            seccionUbicacion.style.display = 'none';
            grupoLugar.style.display = 'none';
            grupoEnlace.style.display = 'none';
        }
        
        // Función para calcular número de cuotas automáticamente
        function calcularNumeroCuotas() {
            const fechaInicio = document.getElementById('fechaInicio');
            const fechaFin = document.getElementById('fechaFin');
            const diaVencimiento = document.getElementById('diaVencimiento');
            const nrCuotas = document.getElementById('nrCuotas');
            
            if (!fechaInicio || !fechaFin || !diaVencimiento || !nrCuotas) return;
            
            const inicio = fechaInicio.value;
            const fin = fechaFin.value;
            const dia = parseInt(diaVencimiento.value);
            
            if (!inicio || !fin || !dia) return;
            
            const fechaInicioDate = new Date(inicio);
            const fechaFinDate = new Date(fin);
            
            // Calcular meses completos
            let meses = (fechaFinDate.getFullYear() - fechaInicioDate.getFullYear()) * 12;
            meses += fechaFinDate.getMonth() - fechaInicioDate.getMonth();
            
            // Ajustar según el día de vencimiento y el día de inicio
            const diaInicio = fechaInicioDate.getDate();
            const diaFinalizacion = fechaFinDate.getDate();
            
            // Si el curso inicia después del día de vencimiento, se pierde una cuota de ese mes
            let cuotas = meses;
            
            if (diaInicio > dia) {
                // Si el curso empieza después del día de vencimiento, no se paga ese mes
                // pero sí todos los siguientes hasta el mes de finalización
                cuotas = meses;
            } else {
                // Si el curso empieza antes o en el día de vencimiento, se paga ese mes
                cuotas = meses + 1;
            }
            
            // Si el curso termina antes del día de vencimiento del último mes, no se cuenta esa cuota
            if (diaFinalizacion < dia && cuotas > 1) {
                cuotas--;
            }
            
            // Mínimo 1 cuota
            cuotas = Math.max(1, cuotas);
            
            nrCuotas.value = cuotas;
        }
        
        // Función para generar videoconferencia
        window.generarVideoconferencia = function() {
            const tipoOferta = document.getElementById('tipoOferta').value;
            const nombreOferta = document.getElementById('nombre').value;
            
            if (!nombreOferta) {
                mostrarNotificacion('Por favor, ingresa el nombre de la oferta primero', 'warning');
                return;
            }
            
            // Validar fecha y hora según el tipo
            let fecha, hora;
            if (tipoOferta === 'CHARLA') {
                fecha = document.getElementById('fechaCharla').value;
                hora = document.getElementById('horaCharla').value;
                
                if (!fecha || !hora) {
                    mostrarNotificacion('Por favor, ingresa la fecha y hora de la charla', 'warning');
                    return;
                }
            } else if (tipoOferta === 'SEMINARIO') {
                fecha = document.getElementById('fechaInicio').value;
                hora = document.getElementById('horaSeminario').value;
                
                if (!fecha || !hora) {
                    mostrarNotificacion('Por favor, ingresa la fecha de inicio y la hora del seminario', 'warning');
                    return;
                }
            }
            
            // Obtener el primer disertante según el tipo
            let disertante = null;
            if (tipoOferta === 'CHARLA') {
                if (disertantesCharla.length > 0) {
                    disertante = disertantesCharla[0];
                }
            } else if (tipoOferta === 'SEMINARIO') {
                if (disertantesSeminario.length > 0) {
                    disertante = disertantesSeminario[0];
                }
            }
            
            if (!disertante) {
                mostrarNotificacion('Por favor, ingresa al menos un disertante primero', 'warning');
                return;
            }
            
            // Generar el nombre de la sala (similar a como se hace en clases)
            const roomName = nombreOferta.toLowerCase()
                .replace(/[áàäâ]/g, 'a')
                .replace(/[éèëê]/g, 'e')
                .replace(/[íìïî]/g, 'i')
                .replace(/[óòöô]/g, 'o')
                .replace(/[úùüû]/g, 'u')
                .replace(/ñ/g, 'n')
                .replace(/\s+/g, '-')
                .replace(/[^a-z0-9-]/g, '');
            
            const safeRoomName = 'aurea-charla-' + roomName;
            
            // URL hacia el HTML de Aurea que mostrará el iframe (será creado en el backend)
            // Pasar la fecha y hora como parámetros
            const videoUrl = `/charla/videoconferencia/${safeRoomName}?fecha=${fecha}&hora=${hora}&moderador=${encodeURIComponent(disertante)}`;
            
            // Establecer el enlace en el campo
            document.getElementById('enlace').value = window.location.origin + videoUrl;
            
            mostrarNotificacion(`Videoconferencia programada para ${fecha} ${hora}. Moderador: ${disertante}`, 'success');
            
            console.log('🎥 Videoconferencia generada:');
            console.log('   - Room: ' + safeRoomName);
            console.log('   - Moderador: ' + disertante);
            console.log('   - Fecha: ' + fecha);
            console.log('   - Hora: ' + hora);
            console.log('   - URL: ' + videoUrl);
        };

        function actualizarEncuentrosSeminario() {
            const tipoOferta = document.getElementById('tipoOferta')?.value;
            const preview = document.getElementById('encuentros-preview');
            const fechasList = document.getElementById('encuentros-fechas-list');
            const help = document.getElementById('help-encuentros');
            const numeroInput = document.getElementById('numeroEncuentros');
            const fechaInicio = document.getElementById('fechaInicio')?.value;
            const fechaFin = document.getElementById('fechaFin')?.value;

            if (!preview || !numeroInput || !fechasList) return;

            if (tipoOferta !== 'SEMINARIO') {
                preview.textContent = 'Completa fecha inicio, fecha fin y número de encuentros para ver el cronograma.';
                if (help) help.textContent = 'Debe ser menor o igual a los días entre fecha inicio y fecha fin.';
                fechasList.innerHTML = '';
                return;
            }

            if (!fechaInicio || !fechaFin) {
                preview.textContent = 'Completa fecha inicio y fecha fin para calcular los encuentros.';
                if (help) help.textContent = 'Debe ser menor o igual a los días entre fecha inicio y fecha fin.';
                fechasList.innerHTML = '';
                return;
            }

            const inicioObj = new Date(fechaInicio + 'T00:00:00');
            const finObj = new Date(fechaFin + 'T00:00:00');
            const diffDays = Math.floor((finObj - inicioObj) / (1000 * 60 * 60 * 24)) + 1;

            if (diffDays <= 0) {
                preview.textContent = 'Rango de fechas inválido.';
                fechasList.innerHTML = '';
                return;
            }

            numeroInput.max = diffDays;
            if (help) help.textContent = `Máximo ${diffDays} encuentros según el rango seleccionado.`;

            const numero = parseInt(numeroInput.value || '0', 10);
            if (!numero || numero <= 0) {
                preview.textContent = 'Ingresa el número de encuentros para ver las fechas.';
                fechasList.innerHTML = '';
                return;
            }
            if (numero > diffDays) {
                preview.textContent = 'El número de encuentros supera el rango disponible.';
                fechasList.innerHTML = '';
                return;
            }

            const existentes = Array.from(fechasList.querySelectorAll('input[name="fechasEncuentros"]'))
                .map((input) => input.value)
                .filter(Boolean);
            const fechas = [];
            for (let i = 0; i < numero; i++) {
                const d = new Date(inicioObj);
                d.setDate(inicioObj.getDate() + i);
                const yyyy = d.getFullYear();
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                fechas.push(`${yyyy}-${mm}-${dd}`);
            }

            preview.textContent = `Selecciona ${numero} fechas (entre ${fechaInicio} y ${fechaFin}).`;
            fechasList.innerHTML = fechas.map((f, idx) => {
                const valor = existentes[idx] || f;
                return `
                    <div class="form-group">
                        <label for="encuentro-fecha-${idx + 1}">Encuentro ${idx + 1}</label>
                        <input type="date"
                               id="encuentro-fecha-${idx + 1}"
                               name="fechasEncuentros"
                               class="form-control"
                               min="${fechaInicio}"
                               max="${fechaFin}"
                               value="${valor}"
                               required>
                    </div>
                `;
            }).join('');
        }

        document.addEventListener('DOMContentLoaded', () => {
            ['fechaInicio', 'fechaFin', 'numeroEncuentros', 'tipoOferta'].forEach((id) => {
                const el = document.getElementById(id);
                if (!el) return;
                el.addEventListener('change', actualizarEncuentrosSeminario);
                el.addEventListener('input', actualizarEncuentrosSeminario);
            });
            actualizarEncuentrosSeminario();
        });


            // Variables globales para docentes seleccionados
            let docentesSeleccionados = {
                curso: [],
                formacion: []
            };

            // Variable para rastrear event listeners ya agregados
            let docenteSearchListenersAdded = {
                'docente-search': false,
                'docente-search-formacion': false
            };

            // Función para inicializar búsqueda de docentes
            function inicializarBusquedaDocentes(inputId, resultsId, tableId) {
                console.log('🔧 Inicializando búsqueda de docentes para:', inputId);

                const searchInput = document.getElementById(inputId);
                const resultsDiv = document.getElementById(resultsId);

                if (!searchInput || !resultsDiv) {
                    console.warn('⚠️ No se encontraron elementos:', inputId, resultsId);
                    return;
                }

                console.log('✅ Elementos encontrados:', searchInput, resultsDiv);

                // Evitar agregar múltiples event listeners
                if (docenteSearchListenersAdded[inputId]) {
                    console.log('⏭️ Event listener ya agregado para:', inputId);
                    return;
                }

                let timeoutId;

                searchInput.addEventListener('input', function () {
                    console.log('📝 Input detectado:', this.value);
                    clearTimeout(timeoutId);
                    const query = this.value.trim();

                    timeoutId = setTimeout(() => {
                        buscarDocentes(query, resultsDiv, tableId);
                    }, 300);
                });

                // Agregar evento focus para mostrar todos los docentes al hacer click
                searchInput.addEventListener('focus', function () {
                    console.log('👁️ Focus en buscador de docentes');
                    const query = this.value.trim();
                    buscarDocentes(query, resultsDiv, tableId);
                });

                // Ocultar resultados al hacer click fuera
                document.addEventListener('click', function (e) {
                    if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
                        resultsDiv.style.display = 'none';
                    }
                });

                docenteSearchListenersAdded[inputId] = true;
                console.log('✅ Event listener agregado correctamente para:', inputId);
            }

            // Función para buscar docentes
            function buscarDocentes(query, resultsDiv, tableId) {
                console.log('🔍 Buscando docentes:', query);

                // Si no hay query, usar cadena vacía para obtener todos
                const searchQuery = query || '';

                // Buscar docentes reales desde la base de datos
                fetch(`/admin/docentes/buscar?q=${encodeURIComponent(searchQuery)}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Error en la respuesta del servidor');
                        }
                        return response.json();
                    })
                    .then(docentes => {
                        console.log('✅ Docentes encontrados:', docentes);
                        mostrarResultadosDocentes(docentes, resultsDiv, tableId);
                    })
                    .catch(error => {
                        console.error('❌ Error al buscar docentes:', error);
                        // Fallback con docentes simulados para desarrollo
                        const docentesSimulados = [
                            { id: 1, nombre: 'Dr. Juan Pérez', especialidad: 'Programación Java' },
                            { id: 2, nombre: 'Dra. María González', especialidad: 'Base de Datos' },
                            { id: 3, nombre: 'Ing. Carlos López', especialidad: 'Desarrollo Web' },
                            { id: 4, nombre: 'Dra. Ana Martínez', especialidad: 'Inteligencia Artificial' },
                            { id: 5, nombre: 'Ing. Roberto Silva', especialidad: 'Redes y Sistemas' }
                        ];

                        const resultados = docentesSimulados.filter(docente =>
                            docente.nombre.toLowerCase().includes(query.toLowerCase()) ||
                            docente.especialidad.toLowerCase().includes(query.toLowerCase())
                        );

                        mostrarResultadosDocentes(resultados, resultsDiv, tableId);
                    });
            }

            // Función para mostrar resultados de búsqueda
            function mostrarResultadosDocentes(docentes, resultsDiv, tableId) {
                resultsDiv.innerHTML = '';

                if (docentes.length === 0) {
                    resultsDiv.innerHTML = '<div class="no-results">No se encontraron docentes</div>';
                    resultsDiv.style.display = 'block';
                    return;
                }

                const ul = document.createElement('ul');
                ul.className = 'search-results-list';

                docentes.forEach(docente => {
                    const li = document.createElement('li');
                    li.className = 'search-result-item';
                    li.innerHTML = `
                    <div class="docente-info">
                        <span class="docente-nombre">${docente.nombre}</span>
                    </div>
                    <button type="button" class="btn-add-docente" onclick="agregarDocente('${docente.id}', '${docente.nombre}', '${tableId}')">
                        <i class="fas fa-plus"></i>
                    </button>
                `;
                    ul.appendChild(li);
                });

                resultsDiv.appendChild(ul);
                resultsDiv.style.display = 'block';
            }

            // Nota: agregarDocente está definido como window.agregarDocente más abajo (línea ~2303)

            // Función para remover docente
            function removerDocente(id, tableId, button) {
                const tipoSeccion = tableId.includes('formacion') ? 'formacion' : 'curso';

                // Remover de la lista
                docentesSeleccionados[tipoSeccion] = docentesSeleccionados[tipoSeccion].filter(d => d.id !== id);

                // Remover fila de la tabla
                const fila = button.closest('tr');
                fila.remove();

                console.log('❌ Docente removido');
            }

            // Array para almacenar categorías seleccionadas
            let categoriasSeleccionadas = [];

            // Función para añadir categoría seleccionada
            function añadirCategoriaSeleccionada() {
                const select = document.getElementById('categoria-select');
                const selectedValue = select.value;
                const selectedText = select.options[select.selectedIndex].text;

                if (!selectedValue || selectedValue === '') {
                    mostrarNotificacion('Por favor seleccione una categoría', 'warning');
                    return;
                }

                // Verificar si ya está seleccionada
                const yaSeleccionada = categoriasSeleccionadas.find(cat => cat.id === selectedValue);
                if (yaSeleccionada) {
                    mostrarNotificacion('Esta categoría ya ha sido seleccionada', 'warning');
                    return;
                }

                // Añadir a la lista
                categoriasSeleccionadas.push({
                    id: selectedValue,
                    nombre: selectedText
                });

                // Actualizar la visualización
                actualizarCategoriasChips();

                // Reset del select
                select.value = '';

                console.log('✅ Categoría añadida:', selectedText);
            }

            // Función para actualizar los chips de categorías
            function actualizarCategoriasChips() {
                const chipsContainer = document.getElementById('selected-chips');
                const selectedContainer = document.getElementById('selected-categories');

                if (!chipsContainer) return;

                // Limpiar chips existentes
                chipsContainer.innerHTML = '';

                if (categoriasSeleccionadas.length === 0) {
                    selectedContainer.style.display = 'none';
                    // Actualizar campo hidden del formulario
                    const formCategorias = document.getElementById('categorias');
                    if (formCategorias) {
                        formCategorias.value = '';
                    }
                    return;
                }

                // Mostrar contenedor
                selectedContainer.style.display = 'block';

                // Crear chips
                categoriasSeleccionadas.forEach((categoria, index) => {
                    const chip = document.createElement('span');
                    chip.className = 'categoria-chip';
                    chip.dataset.categoriaId = categoria.id; // Agregar el data attribute
                    chip.innerHTML = `
                    ${categoria.nombre}
                    <button type="button" class="chip-remove" onclick="removerCategoria(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                    chipsContainer.appendChild(chip);
                });

                // Actualizar el campo hidden del formulario principal con IDs separados por coma
                const formCategorias = document.getElementById('categorias');
                if (formCategorias) {
                    const ids = categoriasSeleccionadas.map(cat => cat.id).join(',');
                    formCategorias.value = ids;
                    console.log('Categorías actualizadas:', ids);
                }
            }

            // Función para actualizar campo hidden de categorías
            function actualizarCategoriaHidden() {
                const categoriasSeleccionadas = Array.from(document.querySelectorAll('#selected-chips .categoria-chip'))
                    .map(chip => chip.dataset.categoriaId);

                const formCategorias = document.getElementById('categorias');
                if (formCategorias) {
                    formCategorias.value = categoriasSeleccionadas.join(',');
                    console.log('Categorías actualizadas en hidden field:', formCategorias.value);
                }
            }

            // Función para actualizar campo hidden de certificado
            function actualizarCertificadoHidden() {
                const checkbox = document.getElementById('otorgaCertificado');
                const hiddenField = document.getElementById('otorgaCertificadoHidden');

                if (checkbox && hiddenField) {
                    hiddenField.value = checkbox.checked ? 'true' : 'false';
                    console.log('Certificado actualizado:', hiddenField.value);
                }
            }

            // Función para actualizar campos hidden de disertantes
            function actualizarDisertantesHidden(tipo) {
                const hiddenId = tipo === 'charla' ? 'disertantesCharlaHidden' : 'disertantesSeminarioHidden';
                const hiddenField = document.getElementById(hiddenId);

                if (hiddenField) {
                    const lista = tipo === 'charla' ? disertantesCharla : disertantesSeminario;
                    hiddenField.value = JSON.stringify(lista);
                }
            }

            // Función para actualizar campo hidden de horarios
            function actualizarHorariosHidden() {
                const hiddenField = document.getElementById('horarios');
                if (hiddenField) {
                    hiddenField.value = JSON.stringify(horariosSeleccionados);
                }
            }

            // Función para remover categoría
            function removerCategoria(index) {
                categoriasSeleccionadas.splice(index, 1);
                actualizarCategoriasChips();
                console.log('❌ Categoría removida, total:', categoriasSeleccionadas.length);
            }

            // Funciones para gestión de categorías
            let categoriasCache = [];

            function aplicarFiltroCategorias() {
                const input = document.getElementById('categorias-filter-input');
                const termino = input ? input.value.trim().toLowerCase() : '';

                if (!termino) {
                    mostrarCategorias(categoriasCache);
                    return;
                }

                const coincideNombre = categoriasCache.filter(categoria => {
                    const nombre = (categoria.nombre || '').toLowerCase();
                    return nombre.includes(termino);
                });

                if (coincideNombre.length > 0) {
                    mostrarCategorias(coincideNombre, categoriasCache.length, 'nombre');
                    return;
                }

                const coincideDescripcion = categoriasCache.filter(categoria => {
                    const descripcion = (categoria.descripcion || '').toLowerCase();
                    return descripcion.includes(termino);
                });

                mostrarCategorias(coincideDescripcion, categoriasCache.length, 'descripcion');
            }

        function cargarCategorias() {
            console.log('🔄 Cargando categorías...');
            
            const loadingDiv = document.getElementById('categoriasLoading');
            const errorDiv = document.getElementById('categoriasError');
            const table = document.getElementById('categoriasTable');
            
            if (loadingDiv) loadingDiv.style.display = 'block';
            if (errorDiv) errorDiv.style.display = 'none';
            if (table) table.style.display = 'none';
            
            fetch('/api/categorias')
                .then(response => response.json())
                .then(categorias => {
                    console.log('✅ Categorías cargadas:', categorias);
                    
                    if (loadingDiv) loadingDiv.style.display = 'none';
                    
                    categoriasCache = Array.isArray(categorias) ? categorias : [];
                    aplicarFiltroCategorias();
                    if (table) table.style.display = 'table';
                })
                .catch(error => {
                    console.error('❌ Error:', error);
                    if (loadingDiv) loadingDiv.style.display = 'none';
                    mostrarError('Error de conexión al cargar categorías');
                });
        }
        
        let categoriasSelectCache = [];

        function renderCategoriasSelect(listado) {
            const select = document.getElementById('categoria-select');
            if (!select) return;
            // Limpiar opciones existentes (excepto la primera)
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            listado.forEach(categoria => {
                const option = document.createElement('option');
                option.value = categoria.idCategoria;
                option.textContent = categoria.nombre;
                select.appendChild(option);
            });
        }

        function filtrarCategoriasSelect() {
            const input = document.getElementById('categoria-search');
            const query = (input && input.value ? input.value : '').toLowerCase().trim();
            if (!query) {
                renderCategoriasSelect(categoriasSelectCache);
                return;
            }
            const filtradas = categoriasSelectCache.filter(c => {
                const nombre = (c.nombre || '').toLowerCase();
                return nombre.includes(query);
            });
            renderCategoriasSelect(filtradas);
        }

        function cargarCategoriasSelect() {
            console.log('🔄 Cargando categorías para select...');
            
            fetch('/api/categorias')
                .then(response => response.json())
                .then(categorias => {
                    categoriasSelectCache = Array.isArray(categorias) ? categorias : [];
                    renderCategoriasSelect(categoriasSelectCache);
                    filtrarCategoriasSelect();
                })
                .catch(error => {
                    console.error('❌ Error al cargar categorías para select:', error);
                });
        }
        
        function mostrarCategorias(categorias, totalCategorias = null, filtroLabel = '') {
            const tbody = document.getElementById('categoriasTableBody');
            const contador = document.getElementById('contadorCategorias');

                if (!tbody) return;

                tbody.innerHTML = '';

                if (categorias && categorias.length > 0) {
                    categorias.forEach(categoria => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                        <td>${categoria.nombre}</td>
                        <td>${categoria.descripcion}</td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editarCategoria(${categoria.idCategoria})" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="eliminarCategoria(${categoria.idCategoria})" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                        tbody.appendChild(row);
                    });

                    if (contador) {
                        if (typeof totalCategorias === 'number' && totalCategorias !== categorias.length) {
                            const sufijo = filtroLabel ? ` (filtro por ${filtroLabel})` : '';
                            contador.textContent = `Mostrando ${categorias.length} de ${totalCategorias} categorías${sufijo}`;
                        } else {
                            contador.textContent = `Total: ${categorias.length} categorías`;
                        }
                    }
                } else {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colspan="3" class="text-center text-muted">No hay categorías registradas</td>';
                    tbody.appendChild(row);

                    if (contador) {
                        if (typeof totalCategorias === 'number') {
                            contador.textContent = `Mostrando 0 de ${totalCategorias} categorías`;
                        } else {
                            contador.textContent = 'Total: 0 categorías';
                        }
                    }
                }
            }

            function mostrarError(mensaje) {
                const errorDiv = document.getElementById('categoriasError');
                if (errorDiv) {
                    errorDiv.textContent = mensaje;
                    errorDiv.style.display = 'block';
                }
            }

            // Funciones globales para el modal
            window.categoriaModal = {
                hide: function () {
                    const modal = document.getElementById('categoriaModal');
                    if (modal) {
                        modal.style.display = 'none';
                    }
                }
            };

            // Controlador de categorías
            window.categoriaController = {
                _parseJsonResponse: function (response) {
                    if (response.ok) return response.json();
                    return response.json()
                        .catch(() => ({}))
                        .then(err => {
                            throw new Error(err.message || 'Error en la respuesta del servidor');
                        });
                },
                guardarCategoria: function () {
                    console.log('💾 Guardando categoría...');

                    const form = document.getElementById('categoriaForm');
                    const formData = new FormData(form);
                    const categoriaId = document.getElementById('categoriaId').value;

                    const categoria = {
                        nombre: formData.get('categoriaNombre'),
                        descripcion: formData.get('categoriaDescripcion')
                    };

                    // Validaciones básicas
                    if (!categoria.nombre || categoria.nombre.trim().length < 2) {
                        mostrarNotificacion('El nombre debe tener al menos 2 caracteres', 'error');
                        return;
                    }

                    if (!categoria.descripcion || categoria.descripcion.trim().length < 5) {
                        mostrarNotificacion('La descripcion debe tener al menos 5 caracteres', 'error');
                        return;
                    }

                    // Determinar si es creación o actualización
                    const url = categoriaId ? `/api/categorias/${categoriaId}` : '/api/categorias';
                    const method = categoriaId ? 'PUT' : 'POST';

                    if (categoriaId) {
                        categoria.id = parseInt(categoriaId);
                    }

                    fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(categoria)
                    })
                        .then(response => this._parseJsonResponse(response))
                        .then(data => {
                            console.log('✅ Categoría guardada:', data);
                            form.reset();
                            document.getElementById('categoriaId').value = '';
                            document.getElementById('btnGuardarText').textContent = 'Crear Categoría';
                            cargarCategorias();
                            cargarCategoriasSelect();
                            mostrarNotificacion(categoriaId ? 'Categoría actualizada exitosamente' : 'Categoría creada exitosamente', 'success');
                        })
                        .catch(error => {
                            console.error('❌ Error:', error);
                            mostrarNotificacion('Error al guardar categoría: ' + error.message, 'error');
                        });
                },

                cancelarEdicion: function () {
                    const form = document.getElementById('categoriaForm');
                    if (form) {
                        form.reset();
                        document.getElementById('categoriaId').value = '';
                        document.getElementById('btnGuardarText').textContent = 'Crear Categoría';
                        console.log('✅ Formulario cancelado y limpiado');
                    }
                }
            };

            // Funciones globales para botones
            window.editarCategoria = function (id) {
                console.log('✏️ Editando categoría:', id);

                fetch(`/api/categorias/${id}`)
                    .then(response => window.categoriaController._parseJsonResponse(response))
                    .then(categoria => {
                        const categoriaId = categoria.idCategoria || categoria.id;
                        document.getElementById('categoriaId').value = categoriaId;
                        document.getElementById('categoriaNombre').value = categoria.nombre || '';
                        document.getElementById('categoriaDescripcion').value = categoria.descripcion || '';
                        document.getElementById('btnGuardarText').textContent = 'Actualizar Categoría';

                        // Scroll al formulario
                        document.querySelector('.categoria-form-section').scrollIntoView({ behavior: 'smooth' });
                    })
                    .catch(error => {
                        console.error('Error al cargar categoría:', error);
                        mostrarNotificacion(error.message || 'Error al cargar la categoría para editar', 'error');
                    });
            };

            window.eliminarCategoria = function (id) {
                console.log('🗑️ Eliminando categoría:', id);

                ModalConfirmacion.show(
                    'Eliminar Categoría',
                    '¿Estás seguro de que deseas eliminar esta categoría?',
                    () => {
                        fetch(`/api/categorias/${id}`, {
                            method: 'DELETE'
                        })
                            .then(response => window.categoriaController._parseJsonResponse(response))
                            .then(data => {
                                if (data.success) {
                                    console.log('✅ Categoría eliminada');
                                    cargarCategorias();
                                    cargarCategoriasSelect();
                                    mostrarNotificacion(data.message || 'Categoría eliminada exitosamente', 'success');
                                } else {
                                    console.error('❌ Error:', data.message);
                                    mostrarNotificacion(data.message || 'Error al eliminar la categoría', 'error');
                                }
                            })
                            .catch(error => {
                                console.error('❌ Error:', error);
                                mostrarNotificacion(error.message || 'Error al eliminar categoría', 'error');
                            });
                    }
                );
            };

            // Función global para remover categoría (accesible desde onclick)
            window.removerCategoria = function (index) {
                categoriasSeleccionadas.splice(index, 1);
                actualizarCategoriasChips();
                console.log('❌ Categoría removida, total:', categoriasSeleccionadas.length);
            };

            // Funciones globales para docentes (accesibles desde onclick)
            window.agregarDocente = function (id, nombre, tableId) {
                const tabla = document.getElementById(tableId);
                const tbody = tabla.querySelector('tbody');

                // Verificar si el docente ya está agregado
                const tipoSeccion = tableId.includes('formacion') ? 'formacion' : 'curso';
                const yaAgregado = docentesSeleccionados[tipoSeccion].find(d => d.id === id);

                if (yaAgregado) {
                    mostrarNotificacion('Este docente ya ha sido agregado', 'warning');
                    return;
                }

                // Agregar a la lista de seleccionados
                docentesSeleccionados[tipoSeccion].push({ id, nombre });

                // Crear fila en la tabla
                const fila = document.createElement('tr');
                fila.innerHTML = `
                <td>${nombre}</td>
                <td>
                    <button type="button" class="btn-remove-docente" onclick="removerDocente('${id}', '${tableId}', this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;

                tbody.appendChild(fila);

                // Ocultar resultados de búsqueda
                const resultsDiv = document.querySelector('.search-results[style*="block"]');
                if (resultsDiv) {
                    resultsDiv.style.display = 'none';
                }

                // Limpiar campo de búsqueda
                const searchInput = tableId.includes('formacion') ?
                    document.getElementById('docente-search-formacion') :
                    document.getElementById('docente-search');
                if (searchInput) {
                    searchInput.value = '';
                }

                console.log('✅ Docente agregado:', nombre);

                // Actualizar campo hidden del formulario
                actualizarDocentesHidden(tipoSeccion);
            };

            window.removerDocente = function (id, tableId, button) {
                const tipoSeccion = tableId.includes('formacion') ? 'formacion' : 'curso';

                // Remover de la lista
                docentesSeleccionados[tipoSeccion] = docentesSeleccionados[tipoSeccion].filter(d => d.id !== id);

                // Remover fila de la tabla
                const fila = button.closest('tr');
                fila.remove();

                // Actualizar campo hidden del formulario
                actualizarDocentesHidden(tipoSeccion);

                console.log('❌ Docente removido');
            };

            // Función para actualizar campos hidden de docentes
            function actualizarDocentesHidden(tipoSeccion) {
                const fieldName = tipoSeccion === 'formacion' ? 'docentesFormacion' : 'docentesCurso';
                const hiddenField = document.getElementById(fieldName);

                if (hiddenField && docentesSeleccionados[tipoSeccion]) {
                    const ids = docentesSeleccionados[tipoSeccion].map(d => d.id).join(',');
                    hiddenField.value = ids;
                    console.log(`🔄 Campo ${fieldName} actualizado:`, ids);
                }
            }

            // Variables globales para disertantes
            let disertantesCharla = [];
            let disertantesSeminario = [];

            // Función global para agregar disertante
            window.agregarDisertante = function (tipo) {
                const inputId = tipo === 'charla' ? 'disertantesCharlaInput' : 'disertantesSeminarioInput';
                const listId = tipo === 'charla' ? 'disertantes-charla-list' : 'disertantes-seminario-list';
                const hiddenId = tipo === 'charla' ? 'disertantesCharlaHidden' : 'disertantesSeminarioHidden';

                const input = document.getElementById(inputId);
                const nombre = input.value.trim();

                if (!nombre) {
                    mostrarNotificacion('Por favor ingrese el nombre del disertante', 'warning');
                    return;
                }

                // Verificar si ya existe
                const listaActual = tipo === 'charla' ? disertantesCharla : disertantesSeminario;
                if (listaActual.includes(nombre)) {
                    mostrarNotificacion('Este disertante ya ha sido agregado', 'warning');
                    return;
                }

                // Agregar a la lista
                if (tipo === 'charla') {
                    disertantesCharla.push(nombre);
                } else {
                    disertantesSeminario.push(nombre);
                }

                // Actualizar la visualización
                actualizarDisertantesChips(tipo);

                // Limpiar el input
                input.value = '';

                console.log('✅ Disertante agregado:', nombre);
            };

            // Función para actualizar los chips de disertantes
            function actualizarDisertantesChips(tipo) {
                const listId = tipo === 'charla' ? 'disertantes-charla-list' : 'disertantes-seminario-list';
                const hiddenId = tipo === 'charla' ? 'disertantesCharlaHidden' : 'disertantesSeminarioHidden';
                const lista = tipo === 'charla' ? disertantesCharla : disertantesSeminario;

                const container = document.getElementById(listId);
                const hiddenInput = document.getElementById(hiddenId);

                if (!container || !hiddenInput) {
                    console.error('❌ Elementos no encontrados para tipo:', tipo);
                    return;
                }

                // Limpiar contenedor
                container.innerHTML = '';

                // Crear chips
                lista.forEach((nombre, index) => {
                    const chip = document.createElement('span');
                    chip.className = 'categoria-chip';
                    chip.innerHTML = `
                    ${nombre}
                    <button type="button" class="remove-chip" onclick="removerDisertante(${index}, '${tipo}')">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                    container.appendChild(chip);
                });

                // Actualizar input hidden
                hiddenInput.value = lista.join(',');

                console.log(`🔄 Chips actualizados para ${tipo}:`, lista.length);
            }

            // Función global para remover disertante
            window.removerDisertante = function (index, tipo) {
                if (tipo === 'charla') {
                    disertantesCharla.splice(index, 1);
                } else {
                    disertantesSeminario.splice(index, 1);
                }

                actualizarDisertantesChips(tipo);
                console.log('❌ Disertante removido');
            };

            // ================= GESTIÓN DE HORARIOS =================

            // Variable global para horarios
            var horariosSeleccionados = [];

            // Función global para agregar horario
            window.agregarHorario = function () {
                const dia = document.getElementById('dia-horario').value;
                const horaInicio = document.getElementById('hora-inicio').value;
                const horaFin = document.getElementById('hora-fin').value;

                // Validaciones
                if (!dia) {
                    mostrarNotificacion('Por favor seleccione un día', 'warning');
                    return;
                }

                if (!horaInicio || !horaFin) {
                    mostrarNotificacion('Por favor complete las horas de inicio y fin', 'warning');
                    return;
                }

                if (horaInicio >= horaFin) {
                    mostrarNotificacion('La hora de inicio debe ser anterior a la hora de fin', 'warning');
                    return;
                }

                const toMinutes = (valor) => {
                    if (!valor) return 0;
                    const partes = valor.toString().split(':');
                    const h = parseInt(partes[0] || '0', 10);
                    const m = parseInt(partes[1] || '0', 10);
                    return (h * 60) + m;
                };
                const nuevoInicio = toMinutes(horaInicio);
                const nuevoFin = toMinutes(horaFin);

                // Verificar conflictos de horario
                const conflicto = horariosSeleccionados.find(h => {
                    if (h.dia !== dia) return false;
                    const existenteInicio = toMinutes(h.horaInicio);
                    const existenteFin = toMinutes(h.horaFin);
                    return nuevoInicio < existenteFin && nuevoFin > existenteInicio;
                });

                if (conflicto) {
                    mostrarNotificacion('Existe un conflicto de horario en el mismo día', 'error');
                    return;
                }

                // Crear objeto horario
                const horario = {
                    dia: dia,
                    horaInicio: horaInicio,
                    horaFin: horaFin
                };

                // Agregar a la lista
                horariosSeleccionados.push(horario);

                // Actualizar visualización
                actualizarHorariosChips();

                // Limpiar formulario
                document.getElementById('dia-horario').value = '';
                document.getElementById('hora-inicio').value = '';
                document.getElementById('hora-fin').value = '';

                console.log('✅ Horario agregado:', horario);
            };

            // Función para actualizar chips de horarios
            function actualizarHorariosChips() {
                const container = document.getElementById('lista-horarios');
                const hiddenInput = document.getElementById('horarios');

                // Limpiar contenedor
                container.innerHTML = '';

                if (horariosSeleccionados.length === 0) {
                    container.innerHTML = '<p class="no-horarios">No hay horarios programados</p>';
                    hiddenInput.value = '';
                    return;
                }

                // ✅ ORDENAR horarios por día y hora antes de mostrar
                const DIAS_ORDEN = {
                    'LUNES': 1, 'MARTES': 2, 'MIERCOLES': 3, 'MIÉRCOLES': 3,
                    'JUEVES': 4, 'VIERNES': 5, 'SABADO': 6, 'SÁBADO': 6, 'DOMINGO': 7
                };

                horariosSeleccionados.sort((a, b) => {
                    const diaA = (a.dia || '').toUpperCase().trim();
                    const diaB = (b.dia || '').toUpperCase().trim();
                    const ordenA = DIAS_ORDEN[diaA] || 999;
                    const ordenB = DIAS_ORDEN[diaB] || 999;

                    // Si son días diferentes, ordenar por día
                    if (ordenA !== ordenB) {
                        return ordenA - ordenB;
                    }

                    // Si es el mismo día, ordenar por hora de inicio
                    const horaA = a.horaInicio || '';
                    const horaB = b.horaInicio || '';
                    return horaA.localeCompare(horaB);
                });

                // Crear chips para cada horario
                horariosSeleccionados.forEach((horario, index) => {
                    const chip = document.createElement('div');
                    chip.className = 'horario-chip';
                    chip.innerHTML = `
                    <div class="horario-info">
                        <strong>${horario.dia || 'Sin día'}</strong><br>
                        ${horario.horaInicio || '--:--'} - ${horario.horaFin || '--:--'}
                    </div>
                    <button type="button" class="remove-horario" onclick="removerHorario(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                    container.appendChild(chip);
                });

                // Actualizar input hidden con JSON
                hiddenInput.value = JSON.stringify(horariosSeleccionados);

                console.log('🔄 Horarios actualizados y ordenados:', horariosSeleccionados.length);
            }

            // Función global para remover horario
            window.removerHorario = function (index) {
                horariosSeleccionados.splice(index, 1);
                actualizarHorariosChips();
                console.log('❌ Horario removido');
            };

            // (Bloque de propuestas automáticas movido a static/js/gestionOfertas.js)

            /**
             * UTILIDAD: Wrapper para notificaciones (por si no tienes Toastr/Swal)
             * Si ya tienes una función mostrarNotificacion global, puedes borrar esto.
             */
            if (typeof window.mostrarNotificacion !== 'function') {
                window.mostrarNotificacion = function (mensaje, tipo) {
                    // Fallback simple por si no existe la librería de alertas
                    alert((tipo === 'error' ? '❌ ' : '✅ ') + mensaje);
                };
            }

            // ================= VALIDACIÓN Y ENVÍO DEL FORMULARIO =================

            // Función para validar formulario
            function validarFormulario(tipoOferta) {
                const titulo = document.getElementById('nombre').value.trim();
                const descripcion = document.getElementById('descripcion').value.trim();

                if (!titulo || !descripcion) {
                    mostrarNotificacion('Por favor complete el título y la descripción', 'error');
                    return false;
                }

                // Validación de fechas obligatorias
                const fechaInicio = document.getElementById('fechaInicio').value;
                const fechaFin = document.getElementById('fechaFin').value;

                if (!fechaInicio) {
                    mostrarNotificacion('Por favor seleccione la fecha de inicio', 'error');
                    return false;
                }

                if (!fechaFin) {
                    mostrarNotificacion('Por favor seleccione la fecha de fin', 'error');
                    return false;
                }

                // ✅ Validar que las fechas no sean pasadas
                const hoy = new Date();
                hoy.setHours(0, 0, 0, 0); // Resetear horas para comparar solo fechas
                const fechaInicioObj = new Date(fechaInicio + 'T00:00:00');
                const fechaFinObj = new Date(fechaFin + 'T00:00:00');

                if (fechaInicioObj < hoy) {
                    mostrarNotificacion('La fecha de inicio no puede ser anterior a hoy', 'error');
                    return false;
                }

                if (fechaFinObj < hoy) {
                    mostrarNotificacion('La fecha de fin no puede ser anterior a hoy', 'error');
                    return false;
                }

                // Validar que la fecha de inicio no sea posterior a la fecha de fin
                if (fechaInicioObj > fechaFinObj) {
                    mostrarNotificacion('La fecha de inicio no puede ser posterior a la fecha de fin', 'error');
                    return false;
                }
                // Validar costo
                const costoVal = document.getElementById('costoInscripcion') ? parseFloat(document.getElementById('costoInscripcion').value) : NaN;
                if (!isNaN(costoVal) && costoVal < 0) {
                    mostrarNotificacion('El costo debe ser mayor o igual a 0', 'error');
                    return false;
                }

                // Validaciones específicas según tipo
                switch (tipoOferta) {
                    case 'CURSO':
                    case 'FORMACION': {
                        const tipoKey = tipoOferta === 'CURSO' ? 'curso' : 'formacion';
                        const docentes = docentesSeleccionados[tipoKey] || [];
                        if (docentes.length === 0) {
                            mostrarNotificacion('Debe asignarse al menos un docente para la oferta', 'error');
                            return false;
                        }
                        if (!horariosSeleccionados || horariosSeleccionados.length === 0) {
                            mostrarNotificacion('Debe agregarse al menos un horario para la oferta', 'error');
                            return false;
                        }
                        break;
                    }

                    case 'CHARLA':
                    case 'SEMINARIO': {
                        // Validar que la fecha de inscripción termine ANTES de la fecha del evento
                        const fechaFinInscripcion = document.getElementById('fechaFinInscripcion')?.value;
                        const fechaEvento = tipoOferta === 'CHARLA'
                            ? document.getElementById('fechaCharla')?.value
                            : document.getElementById('fechaInicio')?.value;

                        if (fechaFinInscripcion && fechaEvento) {
                            const fechaFinInscripcionObj = new Date(fechaFinInscripcion + 'T00:00:00');
                            const fechaEventoObj = new Date(fechaEvento + 'T00:00:00');

                            if (fechaFinInscripcionObj >= fechaEventoObj) {
                                mostrarNotificacion(
                                    'La fecha de fin de inscripción debe ser ANTES de la fecha de la ' +
                                    (tipoOferta === 'CHARLA' ? 'charla' : 'seminario'),
                                    'error'
                                );
                                return false;
                            }
                        }

                        if (tipoOferta === 'SEMINARIO') {
                            const numeroEncuentros = parseInt(document.getElementById('numeroEncuentros')?.value || '0', 10);
                            const fechaInicio = document.getElementById('fechaInicio')?.value;
                            const fechaFin = document.getElementById('fechaFin')?.value;

                            if (!numeroEncuentros || numeroEncuentros <= 0) {
                                mostrarNotificacion('Debes indicar el número de encuentros del seminario', 'error');
                                return false;
                            }

                            if (fechaInicio && fechaFin) {
                                const inicioObj = new Date(fechaInicio + 'T00:00:00');
                                const finObj = new Date(fechaFin + 'T00:00:00');
                                const diffDays = Math.floor((finObj - inicioObj) / (1000 * 60 * 60 * 24)) + 1;
                                if (numeroEncuentros > diffDays) {
                                    mostrarNotificacion('El número de encuentros no puede superar los días entre fecha inicio y fecha fin', 'error');
                                    return false;
                                }

                                const fechasEncuentrosInputs = Array.from(document.querySelectorAll('input[name="fechasEncuentros"]'));
                                if (fechasEncuentrosInputs.length !== numeroEncuentros) {
                                    mostrarNotificacion('Debe indicar la fecha de cada encuentro del seminario', 'error');
                                    return false;
                                }

                                for (let i = 0; i < fechasEncuentrosInputs.length; i++) {
                                    const valor = fechasEncuentrosInputs[i].value;
                                    if (!valor) {
                                        mostrarNotificacion('Todos los encuentros deben tener una fecha asignada', 'error');
                                        return false;
                                    }
                                    const fechaEncuentro = new Date(valor + 'T00:00:00');
                                    if (fechaEncuentro < inicioObj || fechaEncuentro > finObj) {
                                        mostrarNotificacion('Las fechas de los encuentros deben estar entre la fecha de inicio y fin del seminario', 'error');
                                        return false;
                                    }
                                }
                            }
                        }

                        // IDs genéricos para lugar y enlace
                        const enlaceEl = document.getElementById('enlace');
                        const lugarEl = document.getElementById('lugar');

                        const enlace = enlaceEl ? enlaceEl.value.trim() : '';
                        const lugar = lugarEl ? lugarEl.value.trim() : '';

                        const modalidad = document.getElementById('modalidad').value;
                        const esVirtual = modalidad === 'VIRTUAL' || modalidad === 'HIBRIDA';
                        const esPresencial = modalidad === 'PRESENCIAL' || modalidad === 'HIBRIDA';

                        if (esVirtual) {
                            if (!enlace) {
                                mostrarNotificacion('Para modalidad Virtual o Híbrida debe de ingresar un enlace', 'error');
                                return false;
                            }
                            try {
                                new URL(enlace); // valida formato
                            } catch (e) {
                                mostrarNotificacion('El enlace proporcionado no es una URL válida', 'error');
                                return false;
                            }
                        }

                        if (esPresencial) {
                            if (!lugar) {
                                mostrarNotificacion('Para modalidad Presencial o Híbrida debe de ingresar un lugar', 'error');
                                return false;
                            }
                        }

                        const disertantes = tipoOferta === 'CHARLA' ? disertantesCharla : disertantesSeminario;

                        if (!disertantes || disertantes.length === 0) {
                            mostrarNotificacion('Se requiere al menos un disertante', 'error');
                            return false;
                        }
                        break;
                    }

                    default:
                    // no-op
                }

                return true;
            }

            // ================= ENVÍO AJAX Y NOTIFICACIONES =================

            // Función para enviar formulario con AJAX
            function enviarFormularioAjax() {
                console.log('🚀 Iniciando envío AJAX');

                const formulario = document.getElementById('oferta-form');
                const formData = new FormData(formulario);

                // Manejar cupos infinitos: si está vacío, enviar Integer.MAX_VALUE
                const cuposVal = formData.get('cupos');
                if (!cuposVal || cuposVal.trim() === '') {
                    formData.set('cupos', '2147483647');
                    console.log('♾️ Cupos establecidos como ilimitados (MAX_VALUE)');
                }

                // Debug: mostrar datos del formulario
                console.log('📋 Datos del formulario:');
                for (let [key, value] of formData.entries()) {
                    console.log(`  ${key}: ${value}`);
                }

                // Mostrar loading en el botón
                const btnSubmit = formulario.querySelector('button[type="submit"]');
                const textoOriginal = btnSubmit.innerHTML;
                btnSubmit.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Registrando...';
                btnSubmit.disabled = true;

                console.log('📡 Enviando request a /admin/ofertas/registrar');

                fetch('/admin/ofertas/registrar', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => {
                        console.log('📥 Respuesta recibida:', response.status);
                        return response.json();
                    })
                    .then(data => {
                        console.log('📊 Datos de respuesta:', data);

                        if (data.success) {
                            console.log('✅ Registro exitoso');
                            // Mostrar notificación de éxito
                            mostrarNotificacion('✅ ' + data.message, 'success');

                            // Limpiar formulario
                            limpiarFormularioCompleto();

                            // Cerrar formulario después de un momento
                            setTimeout(() => {
                                cerrarFormulario();
                            }, 1500);

                            // Actualizar tabla de ofertas
                            actualizarTablaOfertas();

                        } else {
                            console.log('❌ Error en registro:', data.message);
                            mostrarNotificacion('❌ ' + data.message, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('❌ Error en fetch:', error);
                        mostrarNotificacion('❌ Error al registrar la oferta. Inténtelo nuevamente.', 'error');
                    })
                    .finally(() => {
                        // Restaurar botón
                        btnSubmit.innerHTML = textoOriginal;
                        btnSubmit.disabled = false;
                    });
            }


        
        function limpiarCategoriasSeleccionadas() {
            categoriasSeleccionadas = [];
            const selectedContainer = document.getElementById('selected-categories');
            const selectedChips = document.getElementById('selected-chips');
            const formCategorias = document.getElementById('categorias');
            const select = document.getElementById('categoria-select');
            const searchInput = document.getElementById('categoria-search');
            if (selectedChips) selectedChips.innerHTML = '';
            if (selectedContainer) selectedContainer.style.display = 'none';
            if (formCategorias) formCategorias.value = '';
            if (select) select.selectedIndex = 0;
            if (searchInput) searchInput.value = '';
            if (typeof renderCategoriasSelect === 'function') {
                renderCategoriasSelect(categoriasSelectCache);
            }
        }

        // Función para limpiar formulario completo
        function limpiarFormularioCompleto() {
            const formulario = document.getElementById('oferta-form');
            formulario.reset();
            
            // Limpiar datos específicos
            limpiarDatosFormulario();
            limpiarCategoriasSeleccionadas();
            
            // Ocultar todas las secciones específicas
            const seccionesEspecificas = document.querySelectorAll('.tipo-specific');
            seccionesEspecificas.forEach(seccion => {
                seccion.style.display = 'none';
            });
            
            // Ocultar sección de horarios
            const seccionHorarios = document.getElementById('seccion-horarios');
            if (seccionHorarios) {
                seccionHorarios.style.display = 'none';
            }
            
            console.log('🧹 Formulario limpiado completamente');
        }
        
        // Función para cerrar formulario
        function cerrarFormulario() {
            const formContainer = document.getElementById('form-container');
            if (formContainer) {
                formContainer.classList.remove('show');
                setTimeout(() => {
                    formContainer.style.display = 'none';
                }, 500);
            }
        }
        
        // Variables de paginación
        let currentPage = 1;
        const itemsPerPage = 10;
        let allOfertas = [];
        let filteredOfertas = [];

            // Función para actualizar tabla de ofertas
            function actualizarTablaOfertas() {
                console.log('📊 Actualizando tabla de ofertas...');
                fetch('/admin/ofertas/listar')
                    .then(response => response.json())
                    .then(data => {
                        console.log('📥 Respuesta del servidor:', data);
                        if (data.success && data.data) {
                            // Guardar datos globales
                            allOfertas = data.data;
                            filteredOfertas = [...allOfertas]; // Inicialmente sin filtros adicionales

                            // Resetear a página 1
                            currentPage = 1;

                            // Renderizar
                            renderizarPaginaActual();

                            console.log('✅ Tabla actualizada con', data.data.length, 'ofertas');
                        }
                    })
                    .catch(error => {
                        console.error('❌ Error al actualizar tabla:', error);
                    });
            }

            // Funciones de paginación
            window.cambiarPagina = function (delta) {
                const totalPages = Math.ceil(filteredOfertas.length / itemsPerPage);
                const newPage = currentPage + delta;

                if (newPage >= 1 && newPage <= totalPages) {
                    currentPage = newPage;
                    renderizarPaginaActual();
                }
            };

            window.irAPagina = function (page) {
                currentPage = page;
                renderizarPaginaActual();
            };

            function renderizarPaginaActual() {
                const start = (currentPage - 1) * itemsPerPage;
                const end = start + itemsPerPage;
                const pageData = filteredOfertas.slice(start, end);

                actualizarTablaConDatos(pageData);
                actualizarControlesPaginacion();
                actualizarInfoPaginacion(start, end);
            }

            function actualizarControlesPaginacion() {
                const totalPages = Math.ceil(filteredOfertas.length / itemsPerPage);
                const btnPrev = document.getElementById('btn-prev');
                const btnNext = document.getElementById('btn-next');
                const pagesContainer = document.getElementById('pagination-pages');

                if (btnPrev) btnPrev.disabled = currentPage === 1;
                if (btnNext) btnNext.disabled = currentPage === totalPages || totalPages === 0;

                if (pagesContainer) {
                    pagesContainer.innerHTML = '';

                    // Lógica simple de paginación: mostrar rango alrededor de actual
                    let startPage = Math.max(1, currentPage - 2);
                    let endPage = Math.min(totalPages, startPage + 4);

                    if (endPage - startPage < 4) {
                        startPage = Math.max(1, endPage - 4);
                    }

                    for (let i = startPage; i <= endPage; i++) {
                        const btn = document.createElement('button');
                        btn.className = `btn-page ${i === currentPage ? 'active' : ''}`;
                        btn.textContent = i;
                        btn.onclick = () => irAPagina(i);
                        pagesContainer.appendChild(btn);
                    }
                }
            }

            function actualizarInfoPaginacion(start, end) {
                const infoDiv = document.getElementById('pagination-info');
                const total = filteredOfertas.length;
                const realEnd = Math.min(end, total);
                const realStart = total === 0 ? 0 : start + 1;

                if (infoDiv) {
                    infoDiv.textContent = `Mostrando ${realStart}-${realEnd} de ${total} ofertas`;
                }

                // Actualizar también el contador del header si existe
                actualizarContadorOfertas(total);
            }

            function aplicarFiltros() {
                const searchInput = document.getElementById('search-input').value.toLowerCase();
                const tipo = document.getElementById('filtro-tipo').value;
                const modalidad = document.getElementById('filtro-modalidad').value;
                const estado = document.getElementById('filtro-estado').value;
                const certificado = document.getElementById('filtro-certificado').value;

                filteredOfertas = allOfertas.filter(oferta => {
                    // Filtro por nombre
                    if (searchInput && !oferta.nombre.toLowerCase().includes(searchInput)) return false;

                    // Filtro por tipo
                    if (tipo && (oferta.tipo || oferta.tipoOferta) !== tipo) return false;

                    // Filtro por modalidad
                    if (modalidad && oferta.modalidad !== modalidad) return false;

                    // Filtro por estado
                    if (estado && oferta.estado !== estado) return false;

                    // Filtro por certificado
                    if (certificado) {
                        const tieneCertificado = oferta.certificado === true || oferta.certificado === 'true' || oferta.certificado === 'SI';
                        if (certificado === 'SI' && !tieneCertificado) return false;
                        if (certificado === 'NO' && tieneCertificado) return false;
                    }

                    return true;
                });

                currentPage = 1;
                renderizarPaginaActual();
            }

            function limpiarFiltros() {
                document.getElementById('search-input').value = '';
                document.getElementById('filtro-tipo').value = '';
                document.getElementById('filtro-modalidad').value = '';
                document.getElementById('filtro-estado').value = '';
                document.getElementById('filtro-certificado').value = '';

                filteredOfertas = [...allOfertas];
                currentPage = 1;
                renderizarPaginaActual();
            }

            // Función para actualizar tabla con nuevos datos
            function actualizarTablaConDatos(ofertas) {
                console.log('🔄 Actualizando tabla con', ofertas.length, 'ofertas');
                const tbody = document.querySelector('#ofertas-table tbody');
                if (!tbody) {
                    console.log('❌ No se encontró tbody de la tabla');
                    return;
                }

                tbody.innerHTML = '';

                if (ofertas.length === 0) {
                    tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-2x mb-2"></i><br>
                            No hay ofertas académicas registradas
                        </td>
                    </tr>
                `;
                    return;
                }

                ofertas.forEach((oferta, index) => {
                    console.log(`📋 Procesando oferta ${index + 1}:`, oferta.nombre);
                    const fila = document.createElement('tr');

                    const rawId = oferta.id ?? oferta.idOferta ?? oferta.id_oferta;
                    const idLiteral = rawId != null ? JSON.stringify(rawId) : 'null';
                    const dataId = rawId != null ? rawId : '';
                    const nombreLiteral = JSON.stringify(oferta.nombre || '');

                    fila.innerHTML = `
                    <td>${oferta.nombre || '-'}</td>
                    <td>${oferta.tipoOferta || oferta.tipo || '-'}</td>
                    <td>${oferta.modalidad || '-'}</td>
                    <td class="cupos-cell">
                        ${(oferta.cupos && oferta.cupos !== 2147483647) ?
                            `<span class="cupos-disponibles">${oferta.cupos}</span>` :
                            '<span class="cupos-ilimitados">∞</span>'
                        }
                    </td>
                    <td>${oferta.fechaInicio ? formatearFecha(oferta.fechaInicio) : '-'}</td>
                    <td>${oferta.fechaFin ? formatearFecha(oferta.fechaFin) : '-'}</td>
                    <td><span class="estado-badge">${oferta.estado || 'ACTIVA'}</span></td>
                    <td class="acciones-cell">
                        <button class="btn-accion btn-ver" title="Ver información" data-id="${dataId}" onclick="verDetalleOferta(${idLiteral})">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-accion btn-modificar" title="Modificar" data-id="${dataId}" onclick='modificarOferta(${idLiteral}, ${nombreLiteral})'>
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-accion btn-eliminar" title="Eliminar" data-id="${dataId}" onclick='eliminarOferta(${idLiteral}, ${nombreLiteral})'>
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                    tbody.appendChild(fila);
                });
            }
            // Función para actualizar contador de ofertas
            function actualizarContadorOfertas(total) {
                const contador = document.getElementById('total-ofertas');
                if (contador) {
                    contador.textContent = total;
                }
            }

            // ================= FUNCIONES PARA EL MODAL DE DETALLE =================

            // Variable global para almacenar el ID de la oferta actual
            let ofertaActualId = null;

            // Función global para abrir modal de detalle
            window.verDetalleOferta = function (id) {
                console.log('📋 FUNCIÓN verDetalleOferta EJECUTADA con ID:', id);
                console.log('- Tipo de ID:', typeof id);

                if (!id) {
                    console.error('❌ ID de oferta no válido:', id);
                    mostrarNotificacion('ID de oferta no válido', 'error');
                    return;
                }

                ofertaActualId = id;
                console.log('- ID almacenado:', ofertaActualId);

                // Obtener datos de la oferta desde el servidor
                console.log('🔗 Realizando fetch a:', `/admin/ofertas/${id}`);
                fetch(`/admin/ofertas/${id}`)
                    .then(response => {
                        console.log('📡 Respuesta recibida:', response.status, response.statusText);
                        if (!response.ok) {
                            throw new Error(`Error ${response.status}: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('✅ Datos de la oferta recibidos:', data);

                        // Verificar estructura de la respuesta
                        if (data.success && data.oferta) {
                            console.log('📋 Estructura correcta - cargando en modal...');
                            cargarDatosEnModal(data.oferta);
                        } else if (data.oferta) {
                            console.log('📋 Datos directos - cargando en modal...');
                            cargarDatosEnModal(data.oferta);
                        } else if (data) {
                            console.log('📋 Datos directos (sin wrapper) - cargando en modal...');
                            cargarDatosEnModal(data);
                        } else {
                            console.error('❌ Estructura de respuesta no reconocida:', data);
                            mostrarNotificacion('Error: Estructura de datos no válida', 'error');
                        }

                        // Mostrar el modal después de cargar los datos
                        const modal = document.getElementById('modalDetalleOferta');
                        if (modal) {
                            modal.style.display = 'flex';
                            document.body.style.overflow = 'hidden';
                            console.log('📱 Modal mostrado');
                        } else {
                            console.error('❌ Modal modalDetalleOferta no encontrado');
                        }
                    })
                    .catch(error => {
                        console.error('❌ Error al cargar detalle de la oferta:', error);
                        mostrarNotificacion('Error al cargar los datos de la oferta', 'error');
                    });
            };

            // Función para cargar datos en el modal
            function cargarDatosEnModal(oferta) {
                console.log('🔄 Cargando datos en el modal:', oferta);
                console.log('📊 Propiedades disponibles:', Object.keys(oferta));
                console.log('📝 Valores de campos clave:');
                console.log('  - nombre:', oferta.nombre);
                console.log('  - descripcion:', oferta.descripcion);
                console.log('  - tipo:', oferta.tipo);
                console.log('  - modalidad:', oferta.modalidad);
                console.log('  - estado:', oferta.estado);
                console.log('  - costoInscripcion:', oferta.costoInscripcion);
                console.log('  - cupos:', oferta.cupos);
                console.log('  - certificado:', oferta.certificado);

                // Verificar si oferta tiene datos
                if (!oferta) {
                    console.error('❌ Objeto oferta está vacío o undefined');
                    return;
                }

                // Información general - verificar que los elementos existen antes de asignar
                const nombre = oferta.nombre || '-';
                const nombreElement = document.getElementById('detalle-nombre');
                if (nombreElement) {
                    nombreElement.textContent = nombre;
                    console.log('✅ Nombre asignado:', nombre);
                } else {
                    console.error('❌ Elemento detalle-nombre no encontrado');
                }

                const tipo = oferta.tipo || '-';
                const tipoElement = document.getElementById('detalle-tipo');
                if (tipoElement) {
                    tipoElement.textContent = tipo;
                    tipoElement.className = `badge tipo-${tipo}`;
                    console.log('✅ Tipo asignado:', tipo);
                } else {
                    console.error('❌ Elemento detalle-tipo no encontrado');
                }

                const modalidad = oferta.modalidad || '-';
                const modalidadElement = document.getElementById('detalle-modalidad');
                if (modalidadElement) {
                    modalidadElement.textContent = modalidad;
                    modalidadElement.className = `badge modalidad-${modalidad}`;
                    console.log('✅ Modalidad asignada:', modalidad);
                } else {
                    console.error('❌ Elemento detalle-modalidad no encontrado');
                }

                const estado = oferta.estado || '-';
                const estadoElement = document.getElementById('detalle-estado');
                if (estadoElement) {
                    estadoElement.textContent = estado;
                    estadoElement.className = `badge estado-${estado}`;
                    console.log('✅ Estado asignado:', estado);
                } else {
                    console.error('❌ Elemento detalle-estado no encontrado');
                }

                // Descripción
                const descripcion = oferta.descripcion || 'Sin descripción disponible';
                const descripcionElement = document.getElementById('detalle-descripcion');
                if (descripcionElement) {
                    descripcionElement.innerHTML = descripcion;
                    console.log('✅ Descripción asignada:', descripcion ? 'Disponible' : 'No disponible');
                } else {
                    console.error('❌ Elemento detalle-descripcion no encontrado');
                }

                // Usar costoInscripcion que es el campo real de CursoDetalle
                const costo = oferta.costoInscripcion || oferta.costo || 0;
                const costoElement = document.getElementById('detalle-costo');
                if (costoElement) {
                    costoElement.textContent = costo ? `$${costo.toLocaleString()}` : '-';
                    console.log('✅ Costo asignado:', costo);
                } else {
                    console.error('❌ Elemento detalle-costo no encontrado');
                }

                // Fechas - usar los nombres exactos de LocalDate
                const fechaInicio = formatearFecha(oferta.fechaInicio) || '-';
                const fechaInicioElement = document.getElementById('detalle-fecha-inicio');
                if (fechaInicioElement) {
                    fechaInicioElement.textContent = fechaInicio;
                    console.log('✅ Fecha inicio asignada:', fechaInicio);
                } else {
                    console.error('❌ Elemento detalle-fecha-inicio no encontrado');
                }

                const fechaFin = formatearFecha(oferta.fechaFin) || '-';
                const fechaFinElement = document.getElementById('detalle-fecha-fin');
                if (fechaFinElement) {
                    fechaFinElement.textContent = fechaFin;
                    console.log('✅ Fecha fin asignada:', fechaFin);
                } else {
                    console.error('❌ Elemento detalle-fecha-fin no encontrado');
                }

                // Cupos
                const cupos = (oferta.cupos && oferta.cupos !== 2147483647) ? oferta.cupos : 'Sin límite';
                const capacidadMaxElement = document.getElementById('detalle-capacidad-max');
                if (capacidadMaxElement) {
                    capacidadMaxElement.textContent = cupos;
                    console.log('✅ Cupos asignados:', cupos);
                } else {
                    console.error('❌ Elemento detalle-capacidad-max no encontrado');
                }

                // Horarios
                const horariosContainer = document.getElementById('detalle-horarios-container');
                if (horariosContainer) {
                    if (oferta.horarios && oferta.horarios.length > 0) {
                        horariosContainer.innerHTML = oferta.horarios.map(h => {
                            // Formatear hora (cortar segundos si existen)
                            const inicio = h.horaInicio ? h.horaInicio.toString().substring(0, 5) : '??:??';
                            const fin = h.horaFin ? h.horaFin.toString().substring(0, 5) : '??:??';
                            return `<span class="badge" style="background-color: #6c757d; color: white; padding: 0.5em 0.8em; border-radius: 20px; font-weight: normal; font-size: 0.9em; display: inline-flex; align-items: center; gap: 0.4rem;">
                                    <i class="fas fa-calendar-day"></i> ${h.dia} 
                                    <i class="fas fa-clock" style="margin-left: 0.3rem;"></i> ${inicio} - ${fin}
                                 </span>`;
                        }).join('');
                        console.log('✅ Horarios asignados:', oferta.horarios.length);
                    } else {
                        horariosContainer.innerHTML = '<span class="text-muted">Sin horarios definidos</span>';
                    }
                }

                // Categorías
                const categoriasContainer = document.getElementById('detalle-categorias');
                if (categoriasContainer) {
                    if (oferta.categorias && oferta.categorias.length > 0) {
                        categoriasContainer.innerHTML = oferta.categorias.map(cat => {
                            const nombre = typeof cat === 'object' ? (cat.nombre || cat) : cat;
                            return `<span class="categoria-chip">${nombre}</span>`;
                        }).join('');
                    } else {
                        categoriasContainer.innerHTML = '<span class="text-muted">Sin categorías</span>';
                    }
                }

                // Imagen
                const imagenElement = document.getElementById('detalle-imagen');
                const sinImagenElement = document.getElementById('detalle-sin-imagen');
                if (imagenElement && sinImagenElement) {
                    const imagenSrc = oferta.imagenUrl || oferta.imagen;
                    if (imagenSrc) {
                        imagenElement.src = imagenSrc;
                        imagenElement.style.display = 'block';
                        sinImagenElement.style.display = 'none';
                    } else {
                        imagenElement.style.display = 'none';
                        sinImagenElement.style.display = 'flex';
                    }
                }

                // Certificación
                const certificado = oferta.certificado;
                const seccionCertificacion = document.getElementById('seccion-certificacion');
                if (seccionCertificacion) {
                    if (certificado === true || certificado === 'true' || certificado === 'Sí') {
                        seccionCertificacion.style.display = 'block';
                        const certificadoElement = document.getElementById('detalle-otorga-certificado');
                        if (certificadoElement) certificadoElement.textContent = 'Sí';
                    } else {
                        seccionCertificacion.style.display = 'none';
                    }
                }

                // Mostrar datos específicos según el tipo
                mostrarDatosEspecificosPorTipo(oferta, tipo);

                // Configurar botón de estado
                configurarBotonEstado(estado);

                console.log('✅ Carga de datos en modal completada');
            }

            // Función para mostrar datos específicos según el tipo
            function mostrarDatosEspecificosPorTipo(oferta, tipo) {
                // Ocultar todas las secciones específicas por tipo
                document.querySelectorAll('.tipo-especifico').forEach(seccion => {
                    seccion.style.display = 'none';
                });

                switch (tipo) {
                    case 'CURSO':
                        mostrarDatosCurso(oferta);
                        break;
                    case 'FORMACION':
                        mostrarDatosFormacion(oferta);
                        break;
                    case 'CHARLA':
                        mostrarDatosCharla(oferta);
                        break;
                    case 'SEMINARIO':
                        mostrarDatosSeminario(oferta);
                        break;
                    default:
                        console.log('⚠️ Tipo de oferta no reconocido:', tipo);
                }
            }

            // Funciones para mostrar datos específicos por tipo
            function mostrarDatosCurso(oferta) {
                const seccion = document.getElementById('datos-curso');
                seccion.style.display = 'block';

                // Temario
                document.getElementById('detalle-curso-temario').textContent = oferta.temario || 'Sin temario definido';

                // Docentes a Cargo
                const docentesContainer = document.getElementById('detalle-curso-docentes');
                if (oferta.docentes && oferta.docentes.length > 0) {
                    docentesContainer.innerHTML = oferta.docentes.map(docente => `
                    <div class="docente-item">
                        <i class="fas fa-user-tie"></i>
                        <div class="docente-info">
                            <div class="docente-nombre">${docente.nombre} ${docente.apellido || ''}</div>
                            ${docente.matricula ? `<div class="docente-especialidad">Matrícula: ${docente.matricula}</div>` : ''}
                        </div>
                    </div>
                `).join('');
                } else {
                    docentesContainer.innerHTML = '<span class="text-muted">Sin docentes asignados</span>';
                }

                console.log('📚 Datos de curso cargados');
            }

            function mostrarDatosFormacion(oferta) {
                const seccion = document.getElementById('datos-formacion');
                seccion.style.display = 'block';

                // Plan de Formación
                document.getElementById('detalle-formacion-plan').textContent = oferta.plan || 'Sin plan definido';

                // Docentes a Cargo
                const docentesContainer = document.getElementById('detalle-formacion-docentes');
                if (oferta.docentes && oferta.docentes.length > 0) {
                    docentesContainer.innerHTML = oferta.docentes.map(docente => `
                    <div class="docente-item">
                        <i class="fas fa-user-tie"></i>
                        <div class="docente-info">
                            <div class="docente-nombre">${docente.nombre} ${docente.apellido || ''}</div>
                            ${docente.matricula ? `<div class="docente-especialidad">Matrícula: ${docente.matricula}</div>` : ''}
                        </div>
                    </div>
                `).join('');
                } else {
                    docentesContainer.innerHTML = '<span class="text-muted">Sin docentes asignados</span>';
                }

                console.log('🎓 Datos de formación cargados');
            }

            function mostrarDatosCharla(oferta) {
                const seccion = document.getElementById('datos-charla');
                seccion.style.display = 'block';

                // Lugar
                document.getElementById('detalle-charla-lugar').textContent = oferta.lugar || '-';

                // Enlace
                const enlaceSpan = document.getElementById('detalle-charla-enlace');
                if (oferta.enlace) {
                    enlaceSpan.innerHTML = `<a href="${oferta.enlace}" target="_blank">${oferta.enlace}</a>`;
                } else {
                    enlaceSpan.textContent = '-';
                }

                // Público Objetivo
                document.getElementById('detalle-charla-publico').textContent = oferta.publicoObjetivo || 'No especificado';

                // Disertantes
                const disertantesContainer = document.getElementById('detalle-charla-disertantes');
                if (oferta.disertantes && oferta.disertantes.length > 0) {
                    disertantesContainer.innerHTML = oferta.disertantes.map(disertante => `
                    <div class="disertante-item">
                        <i class="fas fa-microphone"></i>
                        <div class="disertante-info">
                            <div class="disertante-nombre">${disertante}</div>
                        </div>
                    </div>
                `).join('');
                } else {
                    disertantesContainer.innerHTML = '<span class="text-muted">Sin disertantes asignados</span>';
                }

                console.log('🎤 Datos de charla cargados');
            }

            function mostrarDatosSeminario(oferta) {
                const seccion = document.getElementById('datos-seminario');
                seccion.style.display = 'block';

                // Lugar
                document.getElementById('detalle-seminario-lugar').textContent = oferta.lugar || '-';

                // Enlace
                const enlaceSpan = document.getElementById('detalle-seminario-enlace');
                if (oferta.enlace) {
                    enlaceSpan.innerHTML = `<a href="${oferta.enlace}" target="_blank">${oferta.enlace}</a>`;
                } else {
                    enlaceSpan.textContent = '-';
                }

                // Público Objetivo
                document.getElementById('detalle-seminario-publico').textContent = oferta.publicoObjetivo || 'No especificado';

                // Disertantes
                const disertantesContainer = document.getElementById('detalle-seminario-disertantes');
                if (oferta.disertantes && oferta.disertantes.length > 0) {
                    disertantesContainer.innerHTML = oferta.disertantes.map(disertante => `
                    <div class="disertante-item">
                        <i class="fas fa-chalkboard-teacher"></i>
                        <div class="disertante-info">
                            <div class="disertante-nombre">${disertante}</div>
                        </div>
                    </div>
                `).join('');
            } else {
                disertantesContainer.innerHTML = '<span class="text-muted">Sin disertantes asignados</span>';
            }
            
            console.log('🏛️ Datos de seminario cargados');
        }
        
        // Función para configurar botón de estado
        function configurarBotonEstado(estado) {
            const btnCambiarEstado = document.getElementById('btn-cambiar-estado');
            const iconEstado = document.getElementById('icon-estado');
            const textEstado = document.getElementById('text-estado');
            
            console.log('🎯 Configurando botón para estado:', estado);
            
            if (btnCambiarEstado && iconEstado && textEstado) {
                // Resetear estado del botón
                btnCambiarEstado.disabled = false;
                
                if (estado === 'ACTIVA' || estado === 'ENCURSO') {
                    btnCambiarEstado.className = 'btn-danger';  // Rojo para dar de baja
                    iconEstado.className = 'fas fa-times-circle';
                    textEstado.textContent = 'Dar de Baja';
                    console.log('🔴 Botón configurado para dar de baja');
                } else if (estado === 'DE_BAJA') {
                    btnCambiarEstado.className = 'btn-success';  // Verde para dar de alta
                    iconEstado.className = 'fas fa-check-circle';
                    textEstado.textContent = 'Dar de Alta';
                    console.log('🟢 Botón configurado para dar de alta');
                } else if (estado === 'FINALIZADA') {
                    btnCambiarEstado.className = 'btn-secondary';
                    iconEstado.className = 'fas fa-flag-checkered';
                    textEstado.textContent = 'Finalizada';
                    btnCambiarEstado.disabled = true;
                    console.log('🏁 Botón configurado como finalizada (deshabilitado)');
                } else {
                    btnCambiarEstado.className = 'btn-secondary';
                    iconEstado.className = 'fas fa-question-circle';
                    textEstado.textContent = estado;
                    console.log('⚠️ Estado desconocido:', estado);
                }
            } else {
                console.error('❌ No se pudieron encontrar los elementos del botón de estado');
                console.log('Elementos encontrados:', {
                    btnCambiarEstado: !!btnCambiarEstado,
                    iconEstado: !!iconEstado,
                    textEstado: !!textEstado
                });
            }
        }
        
        // Función global para cerrar modal
        window.cerrarModalDetalle = function() {
            const modal = document.getElementById('modalDetalleOferta');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
                ofertaActualId = null;
                console.log('🔚 Modal cerrado');
            }
        };
        
        // Función para cambiar estado de la oferta
        window.cambiarEstadoOferta = function() {
            if (!ofertaActualId) {
                const hiddenId = document.getElementById('idOfertaModificar')?.value;
                if (hiddenId) {
                    ofertaActualId = hiddenId;
                }
            }
            if (!ofertaActualId) {
                console.error('❌ No hay oferta seleccionada para cambiar estado');
                mostrarNotificacion('Error: No hay oferta seleccionada', 'error');
                return;
            }
            
            console.log('🔄 Cambiando estado de oferta con ID:', ofertaActualId);
            
            // Obtener elementos del DOM
            const btnCambiarEstado = document.getElementById('btn-cambiar-estado');
            const textEstado = document.getElementById('text-estado');
            
            // Verificar que el botón existe
            if (!btnCambiarEstado) {
                console.error('❌ Botón cambiar estado no encontrado');
                mostrarNotificacion('Error: Botón de estado no encontrado', 'error');
                return;
            }

                // Determinar acción y mensaje
                let tituloAccion = 'Cambiar Estado';
                let mensajeConfirmacion = '¿Está seguro de que desea cambiar el estado de esta oferta?';

                if (textEstado) {
                    const textoActual = textEstado.textContent.trim();
                    if (textoActual === 'Dar de Baja') {
                        tituloAccion = 'Dar de Baja';
                        mensajeConfirmacion = '¿Está seguro de que desea dar de baja esta oferta? No estará disponible para nuevas inscripciones.';
                    } else if (textoActual === 'Dar de Alta') {
                        tituloAccion = 'Activar Oferta';
                        mensajeConfirmacion = '¿Está seguro de que desea reactivar esta oferta?';
                    }
                }

                // Mostrar modal de confirmación
                ModalConfirmacion.show(
                    tituloAccion,
                    mensajeConfirmacion,
                    () => {
                        ejecutarCambioEstado(btnCambiarEstado);
                    }
                );
            };

            function ejecutarCambioEstado(btnCambiarEstado) {
                // Deshabilitar botón durante la operación
                const textoOriginal = btnCambiarEstado.innerHTML;
                btnCambiarEstado.disabled = true;
                btnCambiarEstado.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';

                const restaurarContenidoBoton = () => {
                    btnCambiarEstado.innerHTML = textoOriginal;
                };

                // Realizar petición al servidor
                const token = obtenerCsrfToken();
                const headerName = obtenerCsrfHeaderName();

                const headers = {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                };

                if (token && headerName) {
                    headers[headerName] = token;
                }

                fetch(`/admin/ofertas/cambiar-estado/${ofertaActualId}`, {
                    method: 'POST',
                    headers: headers,
                    credentials: 'same-origin'
                })
                    .then(response => {
                        console.log('📡 Respuesta del servidor:', response.status);
                        // No lanzar error aquí, siempre procesar la respuesta JSON
                        return response.json();
                    })
                    .then(data => {
                        console.log('✅ Respuesta procesada:', data);
                        console.log('📋 Detalles de la respuesta:', {
                            success: data.success,
                            message: data.message,
                            motivo: data.motivo,
                            nuevoEstado: data.nuevoEstado
                        });

                        if (data.success) {
                            console.log('🎉 Estado cambiado exitosamente a:', data.nuevoEstado);

                            restaurarContenidoBoton();

                            const iconEstadoActual = document.getElementById('icon-estado');
                            const textEstadoActual = document.getElementById('text-estado');

                            if (!iconEstadoActual || !textEstadoActual) {
                                console.warn('⚠️ No se pudieron recuperar los elementos del botón tras restaurar su contenido');
                            }

                            // Actualizar interfaz del botón usando la función centralizada
                            configurarBotonEstado(data.nuevoEstado);

                            // Actualizar badge de estado en el modal
                            const estadoElement = document.getElementById('detalle-estado');
                            if (estadoElement) {
                                estadoElement.textContent = data.nuevoEstado;
                                estadoElement.className = `badge estado-${data.nuevoEstado}`;
                            }

                            // Mostrar notificación de éxito
                            let mensaje = 'Estado actualizado correctamente';
                            if (data.nuevoEstado === 'ACTIVA' || data.nuevoEstado === 'ENCURSO') {
                                mensaje = 'Oferta activada correctamente';
                            } else if (data.nuevoEstado === 'DE_BAJA') {
                                mensaje = 'Oferta dada de baja correctamente';
                            }
                            mostrarNotificacion(mensaje, 'success');

                            console.log('🔄 Estado actualizado en la interfaz');

                            // Actualizar tabla de ofertas para reflejar el cambio
                            actualizarTablaOfertas();
                        } else {
                            console.error('❌ Error del servidor:', data.message || 'Error desconocido');
                            console.log('🔍 Motivo del error:', data.motivo);
                            console.log('🔍 Datos completos del error:', data);

                            // Crear mensaje detallado para alert
                            let mensajeDetallado = data.message || 'Error al cambiar estado';
                            if (data.motivo) {
                                switch (data.motivo) {
                                    case 'VALIDACION_BAJA':
                                        mensajeDetallado += '\n\nMotivo: La oferta tiene inscripciones activas';
                                        mensajeDetallado += '\n\nSugerencias:';
                                        mensajeDetallado += '\n- Cancela las inscripciones activas primero';
                                        mensajeDetallado += '\n- O edita la oferta para cambiar las fechas';
                                        mensajeDetallado += '\n- Espera a que termine la oferta naturalmente';
                                        break;
                                    case 'ESTADO_FINAL':
                                        mensajeDetallado += '\n\nMotivo: La fecha de finalización ya pasó';
                                        mensajeDetallado += '\n\nSugerencias:';
                                        mensajeDetallado += '\n- Las ofertas finalizadas no pueden cambiar de estado';
                                        mensajeDetallado += '\n- Crea una nueva oferta similar si necesitas reactivarla';
                                        break;
                                    case 'ERROR_SERVIDOR':
                                        mensajeDetallado += '\n\nMotivo: Error interno del servidor';
                                        mensajeDetallado += '\n\nSugerencias:';
                                        mensajeDetallado += '\n- Intenta nuevamente en unos segundos';
                                        mensajeDetallado += '\n- Si persiste, contacta al administrador';
                                        break;
                                    default:
                                        if (data.motivo !== 'ERROR_GENERAL') {
                                            mensajeDetallado += '\n\nMotivo: ' + data.motivo;
                                        }
                                }
                            }

                            // Mostrar el mensaje detallado
                            mostrarNotificacion(mensajeDetallado, 'error');

                            // Restaurar botón original
                            restaurarContenidoBoton();
                        }
                    })
                    .catch(error => {
                        console.error('❌ Error en la petición:', error);

                        // Mensaje de error más simple
                        mostrarNotificacion('Error de conexión al cambiar el estado de la oferta. Intenta nuevamente en unos segundos.', 'error');

                        // Restaurar botón original
                        restaurarContenidoBoton();
                    })
                    .finally(() => {
                        // Siempre rehabilitar el botón
                        btnCambiarEstado.disabled = false;
                    });
            };

            // Función para mostrar modal de error con motivo específico
            window.mostrarModalError = function (mensaje, tipoError) {
                console.log('🚨 Mostrando modal de error:', mensaje, tipoError);

                const modal = document.getElementById('modalErrorEstado');
                const errorIcon = document.getElementById('error-icon');
                const errorTitle = document.getElementById('error-title');
                const errorDescription = document.getElementById('error-description');
                const errorSuggestions = document.getElementById('error-suggestions');
                const errorSuggestionsList = document.getElementById('error-suggestions-list');

                if (!modal || !errorTitle || !errorDescription) {
                    console.error('❌ Elementos del modal de error no encontrados');
                    // Fallback a alert simple
                    mostrarNotificacion('Error: ' + mensaje + '. Motivo: ' + tipoError, 'error');
                    return;
                }

                // Configurar contenido según el tipo de error
                let mensajeFinal = mensaje;
                switch (tipoError) {
                    case 'VALIDACION_BAJA':
                        errorIcon.className = 'fas fa-users text-warning';
                        errorTitle.textContent = 'No se puede dar de baja la oferta';
                        errorDescription.textContent = mensaje;
                        mensajeFinal = mensaje + ' (La oferta tiene inscripciones activas)';

                        // Mostrar sugerencias específicas
                        if (errorSuggestions) {
                            errorSuggestions.style.display = 'block';
                            errorSuggestionsList.innerHTML = `
                            <li><i class="fas fa-user-minus"></i> Cancela las inscripciones activas primero</li>
                            <li><i class="fas fa-edit"></i> O edita la oferta para cambiar las fechas</li>
                            <li><i class="fas fa-clock"></i> Espera a que termine la oferta naturalmente</li>
                        `;
                        }
                        break;

                    case 'ESTADO_FINAL':
                        errorIcon.className = 'fas fa-flag text-danger';
                        errorTitle.textContent = 'Oferta en estado final';
                        errorDescription.textContent = mensaje;
                        mensajeFinal = mensaje + ' (La fecha de finalización ya pasó)';

                        if (errorSuggestions) {
                            errorSuggestions.style.display = 'block';
                            errorSuggestionsList.innerHTML = `
                            <li><i class="fas fa-info-circle"></i> Las ofertas finalizadas o canceladas no pueden cambiar de estado</li>
                            <li><i class="fas fa-plus"></i> Crea una nueva oferta similar si necesitas reactivarla</li>
                        `;
                        }
                        break;

                    case 'ERROR_SERVIDOR':
                        errorIcon.className = 'fas fa-server text-danger';
                        errorTitle.textContent = 'Error del sistema';
                        errorDescription.textContent = mensaje;
                        mensajeFinal = mensaje + ' (Error interno del servidor)';

                        if (errorSuggestions) {
                            errorSuggestions.style.display = 'block';
                            errorSuggestionsList.innerHTML = `
                            <li><i class="fas fa-refresh"></i> Intenta nuevamente en unos segundos</li>
                            <li><i class="fas fa-phone"></i> Si el problema persiste, contacta al administrador</li>
                        `;
                        }
                        break;

                    default:
                        errorIcon.className = 'fas fa-exclamation-triangle text-warning';
                        errorTitle.textContent = 'Error';
                        errorDescription.textContent = mensaje;
                        mensajeFinal = mensaje;
                        if (errorSuggestions) {
                            errorSuggestions.style.display = 'none';
                        }
                        break;
                }

                // Intentar mostrar el modal, usar alert como fallback
                try {
                    modal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                    console.log('✅ Modal de error mostrado');
                } catch (e) {
                    console.error('❌ Error mostrando modal, usando alert:', e);
                    mostrarNotificacion('Error: ' + mensajeFinal, 'error');
                }
            };

            // Función para cerrar modal de error
            window.cerrarModalError = function () {
                const modal = document.getElementById('modalErrorEstado');
                if (modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                    console.log('🔚 Modal de error cerrado');
                }
            };

            // Función para cerrar modal
            function cerrarModal() {
                const modal = document.getElementById('modalDetalleOferta');
                if (modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = 'auto'; // Restaurar scroll
                    console.log('🔚 Modal cerrado');
                }
            }

            // Función auxiliar para formatear fechas
            function formatearFecha(fecha) {
                if (!fecha) return null;
                try {
                    if (Array.isArray(fecha) && fecha.length >= 3) {
                        // Si es array [año, mes, día] - formato que devuelve LocalDate en JSON
                        const [año, mes, dia] = fecha;
                        const fechaObj = new Date(año, mes - 1, dia); // mes - 1 porque Date usa índice 0
                        return fechaObj.toLocaleDateString('es-ES', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric'
                        });
                    } else if (typeof fecha === 'string') {
                        // Si es string, asumimos formato ISO (yyyy-mm-dd)
                        return new Date(fecha + 'T00:00:00').toLocaleDateString('es-ES', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric'
                        });
                    } else if (fecha instanceof Date) {
                        return fecha.toLocaleDateString('es-ES', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric'
                        });
                    }
                    return null;
                } catch (e) {
                    console.error('Error formateando fecha:', e, fecha);
                    return null;
                }
            }

            // Cerrar modal al hacer clic fuera
            window.onclick = function (event) {
                const modal = document.getElementById('modalDetalleOferta');
                if (event.target === modal) {
                    cerrarModal();
                }
            };

            console.log('✅ Funciones del modal de detalle inicializadas');

            // ================= FUNCIÓN PARA MODIFICAR OFERTA =================

            // Variable global para rastrear si está en modo edición
            let modoEdicion = false;
            let idOfertaModificar = null;
            let estadoOfertaEnEdicion = null;

            // Variables para manejar eliminaciones
            let ofertaEliminarId = null;
            let ofertaEliminarNombre = '';

            function obtenerCsrfToken() {
                const metaToken = document.querySelector('meta[name="_csrf"]');
                if (metaToken) {
                    return metaToken.getAttribute('content');
                }
                const inputToken = document.querySelector('input[name="_csrf"]');
                return inputToken ? inputToken.value : null;
            }

            function obtenerCsrfHeaderName() {
                const metaHeader = document.querySelector('meta[name="_csrf_header"]');
                if (metaHeader) {
                    return metaHeader.getAttribute('content');
                }
                return 'X-CSRF-TOKEN';
            }

            function mostrarModalConfirmacion() {
                const modal = document.getElementById('confirmDeleteModal');
                if (modal) {
                    modal.style.display = 'flex';
                }
            }

            window.cerrarModalConfirmacion = function () {
                const modal = document.getElementById('confirmDeleteModal');
                if (modal) {
                    modal.style.display = 'none';
                }
                ofertaEliminarId = null;
                ofertaEliminarNombre = '';
            };

            window.cerrarModalVerOferta = function () {
                const modal = document.getElementById('modal-ver-oferta');
                if (modal) {
                    modal.style.display = 'none';
                }
            };

            window.eliminarOferta = function (id, nombre) {
                if (!id) {
                    console.error('❌ ID inválido para eliminar oferta');
                    mostrarNotificacion('No se pudo identificar la oferta a eliminar.', 'error');
                    return;
                }

                ModalConfirmacion.show(
                    'Eliminar Oferta',
                    `¿Estás seguro de que deseas eliminar la oferta académica "${nombre || 'seleccionada'}"?`,
                    () => {
                        ofertaEliminarId = id;
                        ejecutarEliminacion();
                    }
                );
            };

            window.eliminarOfertaDesdeModal = function () {
                if (!ofertaActualId) {
                    console.error('❌ No hay oferta seleccionada en el modal de detalle');
                    mostrarNotificacion('No se encontró la oferta seleccionada para eliminar.', 'error');
                    return;
                }

                const nombreDetalle = document.getElementById('detalle-nombre');
                const nombre = nombreDetalle ? nombreDetalle.textContent : ofertaEliminarNombre;
                eliminarOferta(ofertaActualId, nombre);
            };

            window.ejecutarEliminacion = function () {
                if (!ofertaEliminarId) {
                    console.error('❌ No hay oferta pendiente de eliminación');
                    mostrarNotificacion('No se pudo procesar la eliminación.', 'error');
                    return;
                }

                const idAEliminar = ofertaEliminarId;
                const token = obtenerCsrfToken();
                const headerName = obtenerCsrfHeaderName();

                const headers = {
                    'X-Requested-With': 'XMLHttpRequest'
                };

                if (token) {
                    headers[headerName] = token;
                }

                const btnConfirmar = document.getElementById('btn-confirmar-eliminar');
                const textoOriginal = btnConfirmar ? btnConfirmar.innerHTML : '';

                if (btnConfirmar) {
                    btnConfirmar.disabled = true;
                    btnConfirmar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Eliminando...';
                }

                fetch(`/admin/ofertas/eliminar/${idAEliminar}`, {
                    method: 'POST',
                    headers,
                    credentials: 'same-origin'
                })
                    .then(response => response.text().then(texto => ({
                        ok: response.ok,
                        status: response.status,
                        body: texto
                    })))
                    .then(({ ok, status, body }) => {
                        let data = {};
                        if (body) {
                            try {
                                data = JSON.parse(body);
                            } catch (err) {
                                console.warn('⚠️ No se pudo parsear la respuesta JSON:', err);
                            }
                        }

                        if (!ok) {
                            const mensaje = data.message || `Error al eliminar la oferta (código ${status})`;
                            mostrarNotificacion(`❌ ${mensaje}`, 'error');
                            throw new Error(mensaje);
                        }

                        mostrarNotificacion(data.message || 'Oferta eliminada correctamente', 'success');

                        cerrarModalConfirmacion();
                        cerrarModalDetalle();
                        cerrarModalVerOferta();

                        if (modoEdicion && idOfertaModificar && String(idOfertaModificar) === String(idAEliminar)) {
                            limpiarFormularioCompleto();
                            resetearModoEdicion();
                            cerrarFormulario();
                        }

                        if (ofertaActualId && String(ofertaActualId) === String(idAEliminar)) {
                            ofertaActualId = null;
                        }

                        ofertaEliminarId = null;
                        ofertaEliminarNombre = '';

                        actualizarTablaOfertas();
                    })
                    .catch(error => {
                        console.error('❌ Error durante la eliminación:', error);
                        mostrarNotificacion('❌ Error al eliminar la oferta. Inténtalo nuevamente.', 'error');
                    })
                    .finally(() => {
                        if (btnConfirmar) {
                            btnConfirmar.disabled = false;
                            btnConfirmar.innerHTML = textoOriginal;
                        }
                    });
            };

            /**
             * Función para modificar una oferta académica
             */
            window.modificarOferta = function (idOferta, nombreOferta) {
                console.log('🔄 Iniciando modificación de oferta:', idOferta, nombreOferta);

                // Primero obtenemos los datos de la oferta para verificar su estado y fechas
                fetch(`/admin/ofertas/${idOferta}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const oferta = data.oferta;
                            const fechaInicio = new Date(oferta.fechaInicio + 'T00:00:00');
                            const hoy = new Date();
                            hoy.setHours(0, 0, 0, 0); // Resetear horas para comparar solo fechas

                            let mensajeConfirmacion = `¿Estás seguro que quieres modificar la oferta "${nombreOferta}"?`;

                            // Lógica de advertencia solicitada
                            if (oferta.estado === 'ACTIVA' && fechaInicio < hoy) {
                                mensajeConfirmacion = `⚠️ ADVERTENCIA: Esta oferta está ACTIVA y su fecha de inicio (${oferta.fechaInicio}) ya ha pasado.\n\n¿Estás seguro que deseas modificar información de una oferta que ya está en curso?`;
                            } else if (oferta.estado === 'DE_BAJA') {
                                mensajeConfirmacion = `⚠️ ADVERTENCIA: Estás a punto de modificar una oferta que está DE BAJA.\n\n¿Estás seguro que deseas continuar?`;
                            }

                            // Mostrar confirmación
                            ModalConfirmacion.show(
                                'Modificar Oferta',
                                mensajeConfirmacion,
                                () => {
                                    console.log('✅ Usuario confirmó modificación');

                                    // Activar modo edición
                                    modoEdicion = true;
                                    idOfertaModificar = idOferta;
                                    estadoOfertaEnEdicion = oferta.estado;
                                    console.log('📝 Modo edición activado. Estado original:', estadoOfertaEnEdicion);

                                    // Cambiar el texto del botón submit
                                    const btnSubmit = document.getElementById('btn-submit-form');
                                    const btnSubmitText = document.getElementById('btn-submit-text');
                                    if (btnSubmit && btnSubmitText) {
                                        btnSubmitText.textContent = 'Guardar Modificaciones';
                                        btnSubmit.classList.add('btn-update');
                                    }

                                    // Poblar el formulario con los datos ya obtenidos
                                    poblarFormulario(oferta);

                                    // Mostrar el formulario
                                    mostrarFormulario();
                                }
                            );
                        } else {
                            mostrarNotificacion('Error al obtener los datos de la oferta para verificar.', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('❌ Error al verificar oferta:', error);
                        mostrarNotificacion('Error de conexión al verificar la oferta.', 'error');
                    });
            };

            /**
             * Función para cargar los datos de una oferta en el formulario
             */
            function cargarDatosOferta(idOferta) {
                console.log('📥 Cargando datos de la oferta:', idOferta);

                fetch(`/admin/ofertas/${idOferta}`)
                    .then(response => response.json())
                    .then(data => {
                        console.log('📋 Respuesta del servidor:', data);

                        if (data.success) {
                            poblarFormulario(data.oferta);
                        } else {
                            console.error('❌ Error al cargar datos:', data.message);
                            mostrarNotificacion('Error al cargar los datos de la oferta: ' + data.message, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('❌ Error en la petición:', error);
                        mostrarNotificacion('Error de conexión al cargar los datos de la oferta', 'error');
                    });
            }

            /**
             * Función para poblar el formulario con los datos de la oferta
             */
            function poblarFormulario(oferta) {
                console.log('📝 Poblando formulario con datos:', oferta);

                try {
                    const normalizarFecha = (valor) => {
                        if (!valor) return '';
                        const texto = valor.toString();
                        return texto.includes('T') ? texto.split('T')[0] : texto;
                    };

                    // Establecer ID de la oferta para modificar
                    if (document.getElementById('idOfertaModificar')) {
                        document.getElementById('idOfertaModificar').value = oferta.id || oferta.idOferta || '';
                    }

                    // Datos básicos (usando los IDs reales del formulario)
                    if (document.getElementById('nombre')) {
                        document.getElementById('nombre').value = oferta.nombre || '';
                    }
                    if (document.getElementById('descripcion')) {
                        document.getElementById('descripcion').value = oferta.descripcion || '';
                    }
                    if (document.getElementById('tipoOferta')) {
                        document.getElementById('tipoOferta').value = oferta.tipo || oferta.tipoOferta || '';
                    }
                    if (document.getElementById('modalidad')) {
                        document.getElementById('modalidad').value = oferta.modalidad || '';
                    }
                    if (document.getElementById('fechaInicio')) {
                        document.getElementById('fechaInicio').value = normalizarFecha(oferta.fechaInicio);
                    }
                    if (document.getElementById('fechaFin')) {
                        const fechaInicioInput = document.getElementById('fechaInicio');
                        const fechaFinInput = document.getElementById('fechaFin');
                        const fechaInicioVal = fechaInicioInput ? fechaInicioInput.value : '';
                        fechaFinInput.value = normalizarFecha(oferta.fechaFin);
                        if (fechaInicioVal) {
                            fechaFinInput.disabled = false;
                            fechaFinInput.setAttribute('min', fechaInicioVal);
                        }
                    }
                    if (document.getElementById('cupos')) {
                        const cuposVal = oferta.cupos;
                        // Si es MAX_VALUE (2147483647), dejar vacío para indicar "Sin límite"
                        if (cuposVal === 2147483647) {
                            document.getElementById('cupos').value = '';
                        } else {
                            document.getElementById('cupos').value = cuposVal || '';
                        }
                    }

                    // Certificado - manejar diferentes formatos
                    const certificadoField = document.getElementById('otorgaCertificado');
                    if (certificadoField && oferta.certificado !== undefined) {
                        if (typeof oferta.certificado === 'string') {
                            certificadoField.checked = oferta.certificado === 'true' || oferta.certificado === 'SI';
                        } else {
                            certificadoField.checked = oferta.certificado === true;
                        }
                    }

                    // Costo de inscripción general
                    if (document.getElementById('costoInscripcion')) {
                        document.getElementById('costoInscripcion').value = oferta.costoInscripcion || '';
                    }

                    // Imagen de presentación
                    const imagePreview = document.getElementById('image-preview');
                    if (imagePreview) {
                        if (oferta.imagenUrl) {
                            // Asegurar que la ruta sea correcta si viene relativa
                            const src = oferta.imagenUrl.startsWith('http') || oferta.imagenUrl.startsWith('/')
                                ? oferta.imagenUrl
                                : '/' + oferta.imagenUrl;
                            imagePreview.src = src;
                            imagePreview.style.display = 'block';
                        } else {
                            imagePreview.style.display = 'none';
                            imagePreview.src = '';
                        }
                    }

                    // Ubicación y Enlace para todos los tipos
                    if (document.getElementById('lugar')) {
                        document.getElementById('lugar').value = oferta.lugar || '';
                    }
                    if (document.getElementById('enlace')) {
                        document.getElementById('enlace').value = oferta.enlace || '';
                    }

                    // Mostrar campos específicos según el tipo
                    const tipoOferta = oferta.tipo || oferta.tipoOferta;
                    mostrarCamposEspecificos(tipoOferta);

                    // Dar tiempo a que se muestren los campos antes de poblarlos
                    setTimeout(() => {
                        // Campos específicos según el tipo
                        if (tipoOferta === 'CURSO') {
                            console.log('📚 Cargando datos de CURSO');
                            if (document.getElementById('temario')) {
                                document.getElementById('temario').value = oferta.temario || '';
                                console.log('✅ Temario cargado:', oferta.temario);
                            }
                            if (document.getElementById('costoCuota')) {
                                document.getElementById('costoCuota').value = oferta.costoCuota || '';
                            }
                            if (document.getElementById('nrCuotas')) {
                                document.getElementById('nrCuotas').value = oferta.nrCuotas || '';
                            }
                            if (document.getElementById('diaVencimiento')) {
                                document.getElementById('diaVencimiento').value = oferta.diaVencimiento || '';
                            }

                            // Fechas de inscripción para CURSO
                            if (document.getElementById('fechaInicioInscripcion')) {
                                document.getElementById('fechaInicioInscripcion').value = oferta.fechaInicioInscripcion || '';
                                console.log('✅ Fecha inicio inscripción cargada:', oferta.fechaInicioInscripcion);
                            }
                            if (document.getElementById('fechaFinInscripcion')) {
                                document.getElementById('fechaFinInscripcion').value = oferta.fechaFinInscripcion || '';
                                console.log('✅ Fecha fin inscripción cargada:', oferta.fechaFinInscripcion);
                            }

                            // Cargar docentes de CURSO
                            if (oferta.docentes && Array.isArray(oferta.docentes)) {
                                console.log('👨‍🏫 Cargando docentes de CURSO:', oferta.docentes.length);
                                docentesSeleccionados.curso = [];
                                const tablaCurso = document.getElementById('docentes-table');
                                if (tablaCurso) {
                                    const tbody = tablaCurso.querySelector('tbody');
                                    tbody.innerHTML = '';

                                    oferta.docentes.forEach(docente => {
                                        const id = docente.id;
                                        const nombre = `${docente.nombre} ${docente.apellido}`;
                                        docentesSeleccionados.curso.push({ id, nombre });

                                        const fila = document.createElement('tr');
                                        fila.innerHTML = `
                                        <td>${nombre}</td>
                                        <td>
                                            <button type="button" class="btn-remove" 
                                                    onclick="removerDocente('${id}', 'docentes-table', this)">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </td>
                                    `;
                                        tbody.appendChild(fila);
                                    });

                                    actualizarDocentesHidden('curso');
                                    console.log('✅ Docentes de CURSO cargados:', docentesSeleccionados.curso.length);
                                }
                            }

                        } else if (tipoOferta === 'FORMACION') {
                            console.log('🎓 Cargando datos de FORMACION');
                            if (document.getElementById('planFormacion')) {
                                document.getElementById('planFormacion').value = oferta.plan || '';
                                console.log('✅ Plan cargado:', oferta.plan);
                            }
                            if (document.getElementById('costoCuotaFormacion')) {
                                document.getElementById('costoCuotaFormacion').value = oferta.costoCuota || '';
                                console.log('✅ Costo cuota cargado:', oferta.costoCuota);
                            }
                            if (document.getElementById('nrCuotasFormacion')) {
                                document.getElementById('nrCuotasFormacion').value = oferta.nrCuotas || '';
                                console.log('✅ Nro cuotas cargado:', oferta.nrCuotas);
                            }
                            if (document.getElementById('diaVencimientoFormacion')) {
                                document.getElementById('diaVencimientoFormacion').value = oferta.diaVencimiento || '';
                                console.log('✅ Día vencimiento cargado:', oferta.diaVencimiento);
                            }

                            // Fechas de inscripción para FORMACION
                            if (document.getElementById('fechaInicioInscripcionFormacion')) {
                                document.getElementById('fechaInicioInscripcionFormacion').value = oferta.fechaInicioInscripcion || '';
                                console.log('✅ Fecha inicio inscripción cargada:', oferta.fechaInicioInscripcion);
                            }
                            if (document.getElementById('fechaFinInscripcionFormacion')) {
                                document.getElementById('fechaFinInscripcionFormacion').value = oferta.fechaFinInscripcion || '';
                                console.log('✅ Fecha fin inscripción cargada:', oferta.fechaFinInscripcion);
                            }

                            // Cargar docentes si existen
                            if (oferta.docentes && Array.isArray(oferta.docentes)) {
                                console.log('👨‍🏫 Cargando docentes:', oferta.docentes.length);
                                docentesSeleccionados.formacion = [];
                                const tablaFormacion = document.getElementById('docentes-table-formacion');
                                if (tablaFormacion) {
                                    const tbody = tablaFormacion.querySelector('tbody');
                                    tbody.innerHTML = '';

                                    oferta.docentes.forEach(docente => {
                                        const id = docente.id;
                                        const nombre = `${docente.nombre} ${docente.apellido}`;
                                        docentesSeleccionados.formacion.push({ id, nombre });

                                        const fila = document.createElement('tr');
                                        fila.innerHTML = `
                                        <td>${nombre}</td>
                                        <td>
                                            <button type="button" class="btn-remove" 
                                                    onclick="removerDocente('${id}', 'docentes-table-formacion', this)">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </td>
                                    `;
                                    tbody.appendChild(fila);
                                });
                                
                                actualizarDocentesHidden('formacion');
                                console.log('✅ Docentes cargados:', docentesSeleccionados.formacion.length);
                            }
                        }
                        
                    } else if (tipoOferta === 'CHARLA') {
                        console.log('🎤 Cargando datos de CHARLA');
                        
                        // Fecha de la charla
                        if (document.getElementById('fechaCharla')) {
                            document.getElementById('fechaCharla').value = oferta.fechaInicio || '';
                            console.log('✅ Fecha charla cargada:', oferta.fechaInicio);
                        }
                        
                        // Hora de inicio
                        if (document.getElementById('horaCharla') && oferta.horaInicio) {
                            const horaStr = oferta.horaInicio.toString().substring(0, 5);
                            document.getElementById('horaCharla').value = horaStr;
                            console.log('✅ Hora charla cargada:', horaStr);
                        }
                        
                        // Fechas de inscripción
                        if (document.getElementById('fechaInicioInscripcion')) {
                            document.getElementById('fechaInicioInscripcion').value = oferta.fechaInicioInscripcion || '';
                            console.log('✅ Fecha inicio inscripción cargada:', oferta.fechaInicioInscripcion);
                        }
                        if (document.getElementById('fechaFinInscripcion')) {
                            document.getElementById('fechaFinInscripcion').value = oferta.fechaFinInscripcion || '';
                            console.log('✅ Fecha fin inscripción cargada:', oferta.fechaFinInscripcion);
                        }
                        
                        if (document.getElementById('duracionEstimada')) {
                            document.getElementById('duracionEstimada').value = oferta.duracionEstimada || '';
                        }
                        if (document.getElementById('publicoObjetivo')) {
                            document.getElementById('publicoObjetivo').value = oferta.publicoObjetivo || '';
                            console.log('✅ Público objetivo cargado:', oferta.publicoObjetivo);
                        }
                        
                        // Cargar disertantes
                        if (oferta.disertantes && Array.isArray(oferta.disertantes)) {
                            // Limpiar disertantes de formato anidado [[...]]
                            disertantesCharla = oferta.disertantes.map(d => {
                                if (Array.isArray(d)) {
                                    return d[0]; // Extraer el primer elemento si es un array
                                }
                                return d;
                            }).filter(d => d); // Filtrar valores vacíos
                            actualizarDisertantesChips('charla');
                            console.log('✅ Disertantes charla cargados:', disertantesCharla);
                        }
                        
                    } else if (tipoOferta === 'SEMINARIO') {
                        console.log('🏛️ Cargando datos de SEMINARIO');
                        
                        if (document.getElementById('numeroEncuentros')) {
                            document.getElementById('numeroEncuentros').value = oferta.numeroEncuentros || '';
                            console.log('✅ Número de encuentros cargado:', oferta.numeroEncuentros);
                        }
                        
                        // Hora de inicio
                        if (document.getElementById('horaSeminario') && oferta.horaInicio) {
                            const horaStr = oferta.horaInicio.toString().substring(0, 5);
                            document.getElementById('horaSeminario').value = horaStr;
                            console.log('✅ Hora seminario cargada:', horaStr);
                        }
                        
                        // Fechas de inscripción
                        if (document.getElementById('fechaInicioInscripcion')) {
                            document.getElementById('fechaInicioInscripcion').value = oferta.fechaInicioInscripcion || '';
                            console.log('✅ Fecha inicio inscripción cargada:', oferta.fechaInicioInscripcion);
                        }
                        if (document.getElementById('fechaFinInscripcion')) {
                            document.getElementById('fechaFinInscripcion').value = oferta.fechaFinInscripcion || '';
                            console.log('✅ Fecha fin inscripción cargada:', oferta.fechaFinInscripcion);
                        }
                        
                        if (document.getElementById('duracionMinutos')) {
                            document.getElementById('duracionMinutos').value = oferta.duracionMinutos || '';
                        }
                        if (document.getElementById('publicoObjetivoSeminario')) {
                            document.getElementById('publicoObjetivoSeminario').value = oferta.publicoObjetivo || '';
                            console.log('✅ Público objetivo cargado:', oferta.publicoObjetivo);
                        }
                        if (typeof actualizarEncuentrosSeminario === 'function') {
                            actualizarEncuentrosSeminario();
                        }
                        
                        // Cargar disertantes
                        if (oferta.disertantes && Array.isArray(oferta.disertantes)) {
                            // Limpiar disertantes de formato anidado [[...]]
                            disertantesSeminario = oferta.disertantes.map(d => {
                                if (Array.isArray(d)) {
                                    return d[0]; // Extraer el primer elemento si es un array
                                }
                                return d;
                            }).filter(d => d); // Filtrar valores vacíos
                            actualizarDisertantesChips('seminario');
                            console.log('✅ Disertantes seminario cargados:', disertantesSeminario);
                        }
                    }
                    
                    console.log('Campos específicos cargados');
                }, 100);
                
                // Cargar categorías
                if (oferta.categorias && Array.isArray(oferta.categorias)) {
                    categoriasSeleccionadas = oferta.categorias.map(cat => ({
                        id: cat.id.toString(),
                        nombre: cat.nombre
                    }));
                    actualizarCategoriasChips();
                    console.log('Categorías cargadas:', categoriasSeleccionadas.length);
                }
                
                // Cargar horarios si existen
                if (oferta.horarios && Array.isArray(oferta.horarios)) {
                    console.log('Horarios recibidos:', oferta.horarios);
                    horariosSeleccionados = oferta.horarios.map(h => {
                        console.log('  - Horario individual:', h);
                        return {
                            dia: h.dia || h.diaSemana,
                            horaInicio: h.horaInicio,
                            horaFin: h.horaFin
                        };
                    });
                    actualizarHorariosChips();
                    console.log('Horarios cargados:', horariosSeleccionados.length, horariosSeleccionados);
                }
                
                // Actualizar visibilidad de campos según modalidad y tipo
                actualizarCamposModalidad();
                
                console.log('Formulario poblado exitosamente');
                
            } catch (error) {
                console.error('Error poblando formulario:', error);
                mostrarNotificacion('Error al cargar los datos en el formulario: ' + error.message, 'error');
            }
        }
        
        /**
         * Función para mostrar el formulario
         */
        function mostrarFormulario() {
            const formContainer = document.getElementById('form-container');
            if (formContainer) {
                formContainer.style.display = 'block';
                formContainer.classList.add('show');
                
                // ✅ Establecer fecha mínima como hoy
                const hoy = new Date().toISOString().split('T')[0];
                const fechaInicio = document.getElementById('fechaInicio');
                const fechaFin = document.getElementById('fechaFin');
                if (fechaInicio) fechaInicio.setAttribute('min', hoy);
                if (fechaFin) fechaFin.setAttribute('min', hoy);
                
                // Scroll hasta el formulario
                formContainer.scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        /**
         * Función para resetear el modo edición
         */
        function resetearModoEdicion() {
            modoEdicion = false;
            idOfertaModificar = null;
            estadoOfertaEnEdicion = null;
            
            // Resetear el botón submit
            const btnSubmit = document.getElementById('btn-submit-form');
            const btnSubmitText = document.getElementById('btn-submit-text');
            if (btnSubmit && btnSubmitText) {
                btnSubmitText.textContent = 'Registrar Oferta';
                btnSubmit.classList.remove('btn-update');
            }
            
            // Limpiar ID de oferta
            document.getElementById('idOfertaModificar').value = '';
            limpiarCategoriasSeleccionadas();
        }
        
        // Modificar la función de envío del formulario para manejar actualizaciones
        const formularioOriginal = document.getElementById('oferta-form');
        if (formularioOriginal) {
            // Interceptar el envío del formulario
            formularioOriginal.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Sincronizar campos calculados antes de validar/enviar
                const tipoOferta = document.getElementById('tipoOferta') ? document.getElementById('tipoOferta').value : '';
                
                console.log('🔍 Tipo de oferta:', tipoOferta);
                
                // Para CHARLA y SEMINARIO: copiar fechas específicas a campos generales PRIMERO
                if (tipoOferta === 'CHARLA') {
                    const fechaCharla = document.getElementById('fechaCharla')?.value;
                    console.log('📅 Fecha Charla:', fechaCharla);
                    if (fechaCharla) {
                        const inputFechaInicio = document.getElementById('fechaInicio');
                        const inputFechaFin = document.getElementById('fechaFin');
                        
                        // Habilitar campos antes de asignar valores (para que se envíen en FormData)
                        inputFechaInicio.disabled = false;
                        inputFechaFin.disabled = false;
                        
                        inputFechaInicio.value = fechaCharla;
                        inputFechaFin.value = fechaCharla;
                        console.log('✅ Copiado fechaCharla a fechaInicio y fechaFin:', fechaCharla);
                    } else {
                        console.error('❌ No se encontró fechaCharla');
                    }
                }
                
                actualizarHorariosHidden();
                actualizarDocentesHidden('curso');
                actualizarDocentesHidden('formacion');
                actualizarDisertantesHidden('charla');
                actualizarDisertantesHidden('seminario');
                actualizarCategoriaHidden();
                actualizarCertificadoHidden();

                    if (!validarFormulario(tipoOferta)) {
                        console.warn('Validación fallida, formulario no enviado');
                        return;
                    }

                if (modoEdicion) {
                    // Confirmación para modificar
                    ModalConfirmacion.show(
                        'Modificar Oferta',
                        '¿Está seguro que desea modificar los datos de esta oferta?',
                        () => {
                            console.log('Enviando actualización de oferta');
                            enviarActualizacionOferta();
                        }
                    );
                } else {
                    // Confirmación para registrar
                    ModalConfirmacion.show(
                        'Registrar Oferta',
                        '¿Está seguro que desea registrar esta nueva oferta?',
                        async () => {
                            console.log('Enviando nueva oferta');
                            enviarFormularioAjax(); // Función existente para crear
                        }
                    );
                }
            });
        }
        
        /**
         * Función para enviar actualización de oferta
         */
        function enviarActualizacionOferta() {
            console.log('Iniciando actualización de oferta');
            
            // Sincronizar fechas para CHARLA y SEMINARIO antes de crear FormData
            const tipoOferta = document.getElementById('tipoOferta')?.value;
            if (tipoOferta === 'CHARLA') {
                const fechaCharla = document.getElementById('fechaCharla')?.value;
                if (fechaCharla) {
                    const inputFechaInicio = document.getElementById('fechaInicio');
                    const inputFechaFin = document.getElementById('fechaFin');
                    
                    // Habilitar campos antes de asignar valores
                    inputFechaInicio.disabled = false;
                    inputFechaFin.disabled = false;
                    
                    inputFechaInicio.value = fechaCharla;
                    inputFechaFin.value = fechaCharla;
                    console.log('✅ [EDICIÓN] Copiado fechaCharla:', fechaCharla);
                }
            }
            
            const formulario = document.getElementById('oferta-form');
            const formData = new FormData(formulario);
            
            // Agregar el ID de la oferta
            if (typeof idOfertaModificar !== 'undefined' && idOfertaModificar) {
                formData.append('idOferta', idOfertaModificar);
            }
            
            // Mostrar loading
            const btnSubmit = document.getElementById('btn-submit-form');
            let textoOriginal = '';
            if (btnSubmit) {
                textoOriginal = btnSubmit.innerHTML;
                btnSubmit.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Actualizando...';
                btnSubmit.disabled = true;
            }
            
            fetch('/admin/ofertas/modificar', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                console.log('Respuesta del servidor:', data);
                
                if (data.success) {
                    console.log('Oferta actualizada exitosamente. Estado original era:', estadoOfertaEnEdicion);
                    mostrarNotificacion('Oferta actualizada exitosamente', 'success');
                    const idOfertaActual = (data.oferta && (data.oferta.id || data.oferta.idOferta))
                        || idOfertaModificar
                        || document.getElementById('idOfertaModificar')?.value
                        || ofertaActualId;
                    if (idOfertaActual) {
                        ofertaActualId = idOfertaActual;
                    }
                    
                    // Verificar si estaba DE_BAJA para ofrecer dar de alta
                    if (estadoOfertaEnEdicion === 'DE_BAJA') {
                        console.log('💡 Oferta estaba DE_BAJA, preguntando si activar...');
                        
                        setTimeout(() => {
                            ModalConfirmacion.show(
                                'Activar Oferta',
                                'La oferta se ha modificado correctamente. ¿Desea darla de alta ahora?',
                                () => {
                                    // Intentar dar de alta
                                    const token = obtenerCsrfToken();
                                    const headerName = obtenerCsrfHeaderName();
                                    const headers = {
                                        'Content-Type': 'application/json',
                                        'X-Requested-With': 'XMLHttpRequest'
                                    };
                                    if (token && headerName) headers[headerName] = token;
        
                                    const idParaCambiar = idOfertaActual
                                        || idOfertaModificar
                                        || document.getElementById('idOfertaModificar')?.value
                                        || ofertaActualId;
                                    if (!idParaCambiar) {
                                        mostrarNotificacion('Error: No se pudo determinar el ID de la oferta', 'error');
                                        return;
                                    }
                                    fetch(`/admin/ofertas/cambiar-estado/${idParaCambiar}`, {
                                        method: 'POST',
                                        headers: headers
                                    })
                                    .then(r => r.json())
                                    .then(resp => {
                                        if (resp.success) {
                                            mostrarNotificacion('Oferta activada correctamente', 'success');
                                            cargarOfertas();
                                        } else {
                                            mostrarNotificacion('No se pudo activar la oferta: ' + resp.message, 'warning');
                                        }
                                    });
                                }
                            );
                        }, 500);

                                limpiarFormularioCompleto();
                                resetearModoEdicion();
                                cerrarFormulario();
                                actualizarTablaOfertas();
                            } else {
                                limpiarFormularioCompleto();
                                resetearModoEdicion();
                                cerrarFormulario();
                                actualizarTablaOfertas();
                            }
                        } else {
                            console.error('Error al actualizar:', data.message);
                            mostrarNotificacion('Error al actualizar la oferta: ' + data.message, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error en la petición:', error);
                        mostrarNotificacion('Error de conexión al actualizar la oferta', 'error');
                    })
                    .finally(() => {
                        if (btnSubmit) {
                            btnSubmit.innerHTML = textoOriginal;
                            btnSubmit.disabled = false;
                        }
                    });
            }


            console.log('🔄 Sistema de modificación de ofertas inicializado');
        </script>


        <!-- Modal de Reportes -->
        <div id="report-modal" class="modal"
            style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);">
            <div class="modal-content"
                style="background-color: #fefefe; margin: 10% auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <span class="close-report-modal"
                    style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
                <h2 style="margin-top: 0; color: #333; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px;"><i
                        class="fas fa-file-invoice"></i> Generar Informe</h2>

                <form id="report-form" action="/admin/reportes/ofertas/descargar" method="get"
                    style="margin-top: 20px;">
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="report-formato"
                            style="display: block; margin-bottom: 5px; font-weight: 500;">Formato de salida:</label>
                        <select id="report-formato" name="formato" class="form-control"
                            style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="pdf">PDF (Documento portátil)</option>
                            <option value="excel">Excel (Hoja de cálculo)</option>
                        </select>
                    </div>

                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="report-nombre" style="display: block; margin-bottom: 5px; font-weight: 500;">Filtrar
                            por Nombre:</label>
                        <input type="text" id="report-nombre" name="nombre" class="form-control"
                            placeholder="Opcional..."
                            style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>

                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">Tipos de
                            Oferta:</label>
                        <div
                            style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; background: #f9fafb; padding: 12px; border-radius: 6px; border: 1px solid #e5e7eb;">
                            <label
                                style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin: 0; font-size: 0.95em;">
                                <input type="checkbox" name="tipos" value="Curso" checked
                                    style="width: 16px; height: 16px; accent-color: #2563eb; cursor: pointer;">
                                <span style="color: #4b5563;">Curso</span>
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin: 0; font-size: 0.95em;">
                                <input type="checkbox" name="tipos" value="Formación" checked
                                    style="width: 16px; height: 16px; accent-color: #2563eb; cursor: pointer;">
                                <span style="color: #4b5563;">Formación Prof.</span>
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin: 0; font-size: 0.95em;">
                                <input type="checkbox" name="tipos" value="Seminario" checked
                                    style="width: 16px; height: 16px; accent-color: #2563eb; cursor: pointer;">
                                <span style="color: #4b5563;">Seminario</span>
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin: 0; font-size: 0.95em;">
                                <input type="checkbox" name="tipos" value="Charla" checked
                                    style="width: 16px; height: 16px; accent-color: #2563eb; cursor: pointer;">
                                <span style="color: #4b5563;">Charla</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="report-estado"
                            style="display: block; margin-bottom: 5px; font-weight: 500;">Estado:</label>
                        <select id="report-estado" name="estado" class="form-control"
                            style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">Todos los estados</option>
                            <option value="BORRADOR">Borrador</option>
                            <option value="PUBLICADO">Publicado</option>
                            <option value="DE_BAJA">De Baja</option>
                        </select>
                    </div>

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Fecha de Inicio
                            (Rango):</label>
                        <div style="display: flex; gap: 10px;">
                            <div style="flex: 1;">
                                <small>Desde:</small>
                                <input type="date" name="fechaInicio" class="form-control"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div style="flex: 1;">
                                <small>Hasta:</small>
                                <input type="date" name="fechaFin" class="form-control"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                        </div>
                    </div>

                    <div class="form-actions"
                        style="text-align: right; margin-top: 25px; border-top: 1px solid #f0f0f0; padding-top: 15px;">
                        <button type="button" class="close-report-btn"
                            style="padding: 8px 16px; margin-right: 10px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancelar</button>
                        <button type="submit"
                            style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            <i class="fas fa-download"></i> Descargar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const reportModal = document.getElementById('report-modal');
                const btnShowReport = document.getElementById('btn-show-report-modal');
                const closeSpan = document.querySelector('.close-report-modal');
                const closeBtn = document.querySelector('.close-report-btn');

                if (btnShowReport) {
                    btnShowReport.onclick = function (e) {
                        e.preventDefault();
                        reportModal.style.display = "block";
                    }
                }

                function closeModal() {
                    reportModal.style.display = "none";
                }

                if (closeSpan) closeSpan.onclick = closeModal;
                if (closeBtn) closeBtn.onclick = closeModal;

                window.onclick = function (event) {
                    if (event.target == reportModal) {
                        closeModal();
                    }
                }

                // Validación del formulario de reportes
                const reportForm = document.getElementById('report-form');
                if (reportForm) {
                    reportForm.addEventListener('submit', function (e) {
                        const checkboxes = document.querySelectorAll('input[name="tipos"]:checked');

                        if (checkboxes.length === 0) {
                            e.preventDefault();
                            // Usar la función de notificación existente si está disponible, sino alert
                            if (typeof mostrarNotificacion === 'function') {
                                mostrarNotificacion('Debe seleccionar al menos un Tipo de Oferta para generar el reporte.', 'warning');
                            } else {
                                alert('Debe seleccionar al menos un Tipo de Oferta para generar el reporte.');
                            }
                        }
                    });
                }
            });
        </script>

        <script>
            window.__skipGestionOfertasInit = true;
        </script>
        <script src="/js/gestionOfertas.js"></script>

</body>

</html>
